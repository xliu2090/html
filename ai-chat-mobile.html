<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI å¯¹è¯å®¢æˆ·ç«¯</title>
  <style>
    /* ===== åŸºç¡€å˜é‡ä¸ä¸»é¢˜ ===== */
    :root {
      --bg: #ffffff;
      --fg: #1a1a1a;
      --muted: #8a8a8a;
      --accent: #10a37f;
      --bubble-user: #e9f7f2;
      --bubble-ai: #f5f5f5;
      --border: #e6e6e6;
    }
    .dark {
      --bg: #1e1e1e;
      --fg: #e0e0e0;
      --muted: #9b9b9b;
      --accent: #10a37f;
      --bubble-user: #19392f;
      --bubble-ai: #2a2a2a;
      --border: #333333;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei";
      background: var(--bg);
      color: var(--fg);
      -webkit-tap-highlight-color: transparent;
    }
    button, input, textarea, select { font: inherit; color: inherit; }

    /* ===== å¸ƒå±€ ===== */
    .app { display: flex; flex-direction: column; height: 100%; }
    .topbar {
      height: 48px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 10px;
      border-bottom: 1px solid var(--border);
    }
    .topbar .title { font-weight: 600; font-size: 14px; }
    .icon-btn {
      width: 44px; height: 44px;
      display: inline-flex; align-items: center; justify-content: center;
      border: none; background: transparent; color: var(--fg);
    }
    .messages {
      flex: 1; overflow-y: auto;
      padding: 12px 10px 80px;
      scroll-behavior: smooth;
    }
    .msg { margin: 8px 0; display: flex; }
    .msg.user { justify-content: flex-end; }
    .bubble {
      max-width: 88%;
      padding: 8px 10px;
      border-radius: 12px;
      position: relative;
      line-height: 1.5;
      word-wrap: break-word;
      border: 1px solid var(--border);
    }
    .msg.user .bubble { background: var(--bubble-user); }
    .msg.ai .bubble { background: var(--bubble-ai); }
    .bubble .copy-tag {
      position: absolute; right: 6px; top: -18px;
      font-size: 11px; color: var(--muted);
    }

    /* ===== Markdown æ ·å¼ ===== */
    .bubble h1,.bubble h2,.bubble h3 { margin: 6px 0; font-size: 1em; }
    .bubble ul { padding-left: 18px; margin: 6px 0; }
    .bubble a { color: var(--accent); text-decoration: none; }
    .bubble code { background: rgba(0,0,0,0.06); padding: 1px 4px; border-radius: 4px; }
    .dark .bubble code { background: rgba(255,255,255,0.08); }
    .code-block {
      border: 1px solid var(--border);
      border-radius: 8px; overflow: hidden; margin: 6px 0;
    }
    .code-head {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 8px; font-size: 12px; background: transparent;
    }
    .code-copy { border: none; background: transparent; color: var(--accent); }
    pre { margin: 0; padding: 8px; overflow-x: auto; background: transparent; }
    pre code { background: none; padding: 0; }

    /* ===== åº•éƒ¨è¾“å…¥æ  ===== */
    .composer {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 6px 10px calc(env(safe-area-inset-bottom) + 6px);
      border-top: 1px solid var(--border);
      background: var(--bg);
      display: flex; gap: 8px; align-items: flex-end;
    }
    textarea {
      flex: 1; min-height: 38px; max-height: 96px; resize: none;
      padding: 8px; border-radius: 10px; border: 1px solid var(--border);
      background: transparent;
    }
    .send-btn {
      width: 44px; height: 44px; border-radius: 10px;
      border: none; background: var(--accent); color: #fff;
    }

    /* ===== æŠ½å±‰/ä¾§æ  ===== */
    .sheet, .sidebar {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3);
      display: none;
    }
    .sheet.show, .sidebar.show { display: block; }
    .panel {
      position: absolute; left: 0; right: 0; bottom: 0;
      background: var(--bg); border-radius: 12px 12px 0 0;
      max-height: 70%; overflow-y: auto; padding: 12px;
    }
    .sidebar .panel {
      top: 0; bottom: 0; right: auto; width: 78%; border-radius: 0 12px 12px 0;
    }
    .section { margin-bottom: 12px; }
    .section h4 { margin: 8px 0; font-size: 14px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field input, .field select { padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); background: transparent; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .chip {
      border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px;
    }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .small { font-size: 12px; color: var(--muted); }

    /* ===== å¼•å¯¼ ===== */
    .guide {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .guide .card {
      background: var(--bg); border-radius: 12px; padding: 16px;
      width: 100%; max-width: 360px; border: 1px solid var(--border);
    }
    .toast {
      position: fixed; left: 50%; bottom: 90px; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px; border-radius: 999px; font-size: 12px;
      opacity: 0; transition: opacity .2s;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <button class="icon-btn" id="btnChats">â˜°</button>
      <div class="title" id="chatTitle">æ–°å¯¹è¯</div>
      <div>
        <button class="icon-btn" id="btnTheme">ğŸŒ“</button>
        <button class="icon-btn" id="btnSettings">âš™ï¸</button>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer" id="composer">
      <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
      <button class="send-btn" id="sendBtn">â¤</button>
    </div>
  </div>

  <!-- å¯¹è¯åˆ—è¡¨ -->
  <div class="sidebar" id="chatDrawer">
    <div class="panel">
      <div class="row" style="justify-content: space-between;">
        <strong>å¯¹è¯</strong>
        <button class="icon-btn" id="newChat">ï¼‹</button>
      </div>
      <div id="chatList"></div>
      <div class="section">
        <button class="chip" id="clearChats">æ¸…ç©ºæ‰€æœ‰å¯¹è¯</button>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div class="sheet" id="settingsSheet">
    <div class="panel">
      <div class="row" style="justify-content: space-between;">
        <strong>é…ç½®ä¸å·¥å…·</strong>
        <button class="icon-btn" id="closeSettings">âœ•</button>
      </div>

      <div class="section">
        <h4>API é…ç½®</h4>
        <div class="field">
          <input id="apiEndpoint" placeholder="API Endpoint (ç•™ç©ºä½¿ç”¨é»˜è®¤)" />
          <div class="row">
            <input id="apiKey" type="password" placeholder="API Key" style="flex:1" />
            <button class="chip" id="toggleKey">æ˜¾ç¤º</button>
          </div>
          <input id="modelName" placeholder="Model (å¦‚ gpt-4o-mini)" />
        </div>
      </div>

      <div class="section">
        <h4>System Prompt</h4>
        <div class="field">
          <textarea id="systemPrompt" placeholder="ä¸ºå½“å‰å¯¹è¯è®¾ç½® System Prompt" rows="2"></textarea>
          <div class="row" id="promptPresets"></div>
        </div>
      </div>

      <div class="section">
        <h4>å‚æ•°</h4>
        <div class="field">
          <label>Temperature: <span id="tempVal">1.0</span></label>
          <input id="temperature" type="range" min="0" max="2" step="0.1" />
          <input id="maxTokens" type="number" min="1" placeholder="Max Tokens" />
        </div>
      </div>

      <div class="section">
        <h4>æ•°æ®ç®¡ç†</h4>
        <div class="row">
          <button class="chip" id="exportChat">å¯¼å‡ºJSON</button>
          <button class="chip" id="exportChatMd">å¯¼å‡ºMarkdown</button>
          <button class="chip" id="exportAll">å¯¼å‡ºæ‰€æœ‰å¯¹è¯</button>
          <label class="chip" style="position: relative; overflow: hidden;">
            å¯¼å…¥å¯¹è¯
            <input type="file" id="importFile" accept="application/json" style="position:absolute; inset:0; opacity:0;" />
          </label>
        </div>
      </div>

      <div class="section">
        <h4>é«˜çº§æ“ä½œ</h4>
        <div class="row">
          <button class="chip" id="regen">é‡æ–°ç”Ÿæˆ</button>
          <button class="chip" id="stop">åœæ­¢ç”Ÿæˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é¦–æ¬¡å¼•å¯¼ -->
  <div class="guide" id="guide">
    <div class="card">
      <h3 style="margin-top:0">æ¬¢è¿ä½¿ç”¨</h3>
      <p class="small">è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Endpoint / Key / Modelã€‚æ”¯æŒ OpenAI å…¼å®¹æ¥å£ä¸ SSE æµå¼è¾“å‡ºã€‚</p>
      <button class="chip" id="openSettings">å»é…ç½®</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== æ•°æ®ä¸å·¥å…· =====
    const STORAGE_KEY = 'ai_chat_data_v1';
    const presets = [
      'ä½ æ˜¯ä¸€ä¸ªç²¾ç‚¼çš„ä¸­æ–‡åŠ©æ‰‹ã€‚',
      'ä½ æ˜¯ä¸€ä¸ªä»£ç ä¸“å®¶ï¼Œå›ç­”æ—¶ç»™å‡ºç®€æ´ç¤ºä¾‹ã€‚',
      'ä½ æ˜¯ä¸€ä¸ªäº§å“ç»ç†ï¼Œè¾“å‡ºæ¸…æ™°æ­¥éª¤ã€‚'
    ];
    const state = loadState();
    let controller = null;
    let streaming = false;
    let visibleCount = 60;

    const el = (id) => document.getElementById(id);
    const messagesEl = el('messages');

    function loadState() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
          config: { endpoint: '', key: '', model: 'gpt-4o-mini', temperature: 1, maxTokens: 1024 },
          theme: 'auto',
          chats: [],
          activeId: null
        };
      } catch {
        return { config: { endpoint: '', key: '', model: 'gpt-4o-mini', temperature: 1, maxTokens: 1024 }, theme: 'auto', chats: [], activeId: null };
      }
    }
    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function currentChat() { return state.chats.find(c => c.id === state.activeId); }
    function newChat() {
      const id = 'c_' + Date.now();
      state.chats.unshift({ id, title: 'æ–°å¯¹è¯', systemPrompt: '', messages: [], createdAt: Date.now() });
      state.activeId = id;
      saveState();
      renderChats();
      renderMessages();
    }

    // ===== ä¸»é¢˜ =====
    function applyTheme() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode = state.theme === 'auto' ? (prefersDark ? 'dark' : 'light') : state.theme;
      document.body.classList.toggle('dark', mode === 'dark');
    }
    applyTheme();

    // ===== Markdown æ¸²æŸ“ =====
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
    }
    function renderMarkdown(text) {
      const parts = text.split(/```/);
      let html = '';
      parts.forEach((part, i) => {
        if (i % 2 === 1) {
          const [lang, ...codeLines] = part.split('\n');
          const code = escapeHtml(codeLines.join('\n'));
          const language = escapeHtml(lang.trim() || 'text');
          html += `<div class="code-block"><div class="code-head"><span>${language}</span><button class="code-copy" data-code="${code}">å¤åˆ¶</button></div><pre><code>${code}</code></pre></div>`;
        } else {
          let segment = escapeHtml(part);
          segment = segment.replace(/^### (.*)$/gm, '<h3>$1</h3>')
                           .replace(/^## (.*)$/gm, '<h2>$1</h2>')
                           .replace(/^# (.*)$/gm, '<h1>$1</h1>')
                           .replace(/^\- (.*)$/gm, '<ul><li>$1</li></ul>')
                           .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                           .replace(/\*(.*?)\*/g, '<em>$1</em>')
                           .replace(/`([^`]+)`/g, '<code>$1</code>')
                           .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
          html += segment.replace(/\n/g, '<br/>');
        }
      });
      return html;
    }

    // ===== æ¸²æŸ“ =====
    function renderChats() {
      const list = el('chatList');
      list.innerHTML = '';
      state.chats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `<span>${chat.title}</span><button class="chip" data-id="${chat.id}">åˆ é™¤</button>`;
        item.querySelector('span').onclick = () => { state.activeId = chat.id; saveState(); renderMessages(); renderChats(); closeDrawer(); };
        item.querySelector('button').onclick = () => { state.chats = state.chats.filter(c => c.id !== chat.id); if (state.activeId === chat.id) state.activeId = state.chats[0]?.id || null; saveState(); renderChats(); renderMessages(); };
        list.appendChild(item);
      });
    }
    function renderMessages() {
      const chat = currentChat();
      if (!chat) return;
      el('chatTitle').textContent = chat.title;
      el('systemPrompt').value = chat.systemPrompt || '';
      const msgs = chat.messages.slice(-visibleCount);
      messagesEl.innerHTML = '';
      msgs.forEach(m => {
        const row = document.createElement('div');
        row.className = `msg ${m.role === 'user' ? 'user' : 'ai'}`;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = renderMarkdown(m.content || '');
        bubble.addEventListener('click', () => copyText(m.content));
        addLongPressCopy(bubble, m.content);
        row.appendChild(bubble);
        messagesEl.appendChild(row);
      });
      bindCodeCopy();
      if (isNearBottom()) scrollToBottom();
    }

    function bindCodeCopy() {
      document.querySelectorAll('.code-copy').forEach(btn => {
        btn.onclick = () => copyText(btn.dataset.code || '');
      });
    }

    // ===== è¾“å…¥ä¸æ»šåŠ¨ =====
    let resizeTimer;
    el('input').addEventListener('input', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(autoResize, 80);
    });
    function autoResize() {
      const ta = el('input');
      ta.style.height = 'auto';
      ta.style.height = Math.min(96, ta.scrollHeight) + 'px';
    }
    el('input').addEventListener('dblclick', () => { el('input').value = ''; autoResize(); });
    el('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    messagesEl.addEventListener('scroll', () => {
      if (messagesEl.scrollTop === 0 && visibleCount < currentChat().messages.length) {
        visibleCount += 30; renderMessages();
      }
    });

    // ä¸‹æ‹‰å›åˆ°é¡¶éƒ¨
    let touchStartY = 0;
    messagesEl.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
    messagesEl.addEventListener('touchmove', (e) => {
      const dy = e.touches[0].clientY - touchStartY;
      if (messagesEl.scrollTop === 0 && dy > 60) { showToast('å·²å›åˆ°é¡¶éƒ¨'); messagesEl.scrollTop = 0; }
    }, { passive: true });

    function isNearBottom() { return messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 120; }
    function scrollToBottom() { messagesEl.scrollTop = messagesEl.scrollHeight; }

    // ===== å‘é€ä¸æµå¼ =====
    async function sendMessage(regen = false) {
      const chat = currentChat();
      if (!chat) return;
      const input = el('input');
      const content = input.value.trim();
      if (!content && !regen) return;

      if (!state.config.key) { showToast('è¯·å…ˆé…ç½® API Key'); return; }

      if (!regen) {
        chat.messages.push({ role: 'user', content, ts: Date.now() });
        input.value = ''; autoResize();
      } else {
        const lastAssistantIndex = [...chat.messages].reverse().findIndex(m => m.role === 'assistant');
        if (lastAssistantIndex !== -1) chat.messages.splice(chat.messages.length - 1 - lastAssistantIndex, 1);
      }

      const assistantMsg = { role: 'assistant', content: '', ts: Date.now() };
      chat.messages.push(assistantMsg);
      chat.title = chat.title === 'æ–°å¯¹è¯' ? (chat.messages.find(m => m.role === 'user')?.content.slice(0, 12) || 'æ–°å¯¹è¯') : chat.title;
      saveState();
      renderMessages(); scrollToBottom();

      const payloadMsgs = [];
      if (chat.systemPrompt) payloadMsgs.push({ role: 'system', content: chat.systemPrompt });
      payloadMsgs.push(...chat.messages.filter(m => m.role !== 'assistant' || m.content));

      const endpoint = (state.config.endpoint || '').trim() || '/v1/chat/completions';
      const url = endpoint.startsWith('http') ? endpoint : endpoint;

      controller = new AbortController();
      streaming = true;
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.config.key
          },
          body: JSON.stringify({
            model: state.config.model,
            messages: payloadMsgs,
            temperature: state.config.temperature,
            max_tokens: Number(state.config.maxTokens) || 1024,
            stream: true
          }),
          signal: controller.signal
        });
        if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥: ' + res.status);
        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed.startsWith('data:')) continue;
            const data = trimmed.replace(/^data:\s*/, '');
            if (data === '[DONE]') { streaming = false; break; }
            try {
              const json = JSON.parse(data);
              const delta = json.choices?.[0]?.delta?.content || '';
              assistantMsg.content += delta;
              renderMessages();
              if (isNearBottom()) scrollToBottom();
            } catch { showToast('JSON è§£æé”™è¯¯'); }
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') showToast('ç½‘ç»œå¼‚å¸¸æˆ–è¯·æ±‚å¤±è´¥');
      } finally {
        streaming = false;
        saveState();
      }
    }

    function stopStream() {
      if (controller) controller.abort();
      streaming = false;
    }

    // ===== æ“ä½œ =====
    el('sendBtn').onclick = () => sendMessage();
    el('regen').onclick = () => sendMessage(true);
    el('stop').onclick = stopStream;

    // å¤åˆ¶ä¸é•¿æŒ‰
    function copyText(text) {
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶'));
    }
    function addLongPressCopy(node, text) {
      let timer;
      node.addEventListener('pointerdown', () => { timer = setTimeout(() => copyText(text), 500); });
      node.addEventListener('pointerup', () => clearTimeout(timer));
      node.addEventListener('pointerleave', () => clearTimeout(timer));
    }

    // ===== ä¾§æ ä¸é¢æ¿ =====
    const drawer = el('chatDrawer');
    const sheet = el('settingsSheet');
    const guide = el('guide');
    el('btnChats').onclick = () => drawer.classList.add('show');
    el('btnSettings').onclick = () => sheet.classList.add('show');
    el('closeSettings').onclick = () => sheet.classList.remove('show');
    drawer.onclick = (e) => { if (e.target === drawer) closeDrawer(); };
    sheet.onclick = (e) => { if (e.target === sheet) sheet.classList.remove('show'); };
    function closeDrawer() { drawer.classList.remove('show'); }
    el('openSettings').onclick = () => { guide.style.display = 'none'; sheet.classList.add('show'); };
    el('newChat').onclick = () => { newChat(); closeDrawer(); };
    el('clearChats').onclick = () => { state.chats = []; state.activeId = null; newChat(); closeDrawer(); };

    // ===== é…ç½®ç»‘å®š =====
    el('apiEndpoint').value = state.config.endpoint || '';
    el('apiKey').value = state.config.key || '';
    el('modelName').value = state.config.model || '';
    el('temperature').value = state.config.temperature || 1;
    el('maxTokens').value = state.config.maxTokens || 1024;
    el('tempVal').textContent = state.config.temperature.toFixed(1);
    el('systemPrompt').value = currentChat()?.systemPrompt || '';

    el('apiEndpoint').oninput = debounce(e => { state.config.endpoint = e.target.value.trim(); saveState(); }, 300);
    el('apiKey').oninput = debounce(e => { state.config.key = e.target.value.trim(); saveState(); }, 300);
    el('modelName').oninput = debounce(e => { state.config.model = e.target.value.trim(); saveState(); }, 300);
    el('temperature').oninput = (e) => { state.config.temperature = Number(e.target.value); el('tempVal').textContent = e.target.value; saveState(); };
    el('maxTokens').oninput = debounce(e => { state.config.maxTokens = Number(e.target.value); saveState(); }, 300);
    el('systemPrompt').oninput = debounce(e => { const chat = currentChat(); if (chat) { chat.systemPrompt = e.target.value; saveState(); } }, 300);

    el('toggleKey').onclick = () => {
      const keyInput = el('apiKey');
      keyInput.type = keyInput.type === 'password' ? 'text' : 'password';
      el('toggleKey').textContent = keyInput.type === 'password' ? 'æ˜¾ç¤º' : 'éšè—';
    };

    el('btnTheme').onclick = () => {
      state.theme = state.theme === 'auto' ? 'dark' : state.theme === 'dark' ? 'light' : 'auto';
      applyTheme(); saveState();
      showToast('ä¸»é¢˜: ' + state.theme);
    };

    presets.forEach(p => {
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.textContent = p.slice(0, 6) + '...';
      btn.onclick = () => { el('systemPrompt').value = p; el('systemPrompt').dispatchEvent(new Event('input')); };
      el('promptPresets').appendChild(btn);
    });

    // ===== æ•°æ®å¯¼å…¥å¯¼å‡º =====
    el('exportChat').onclick = () => {
      const chat = currentChat(); if (!chat) return;
      downloadFile(JSON.stringify(chat, null, 2), `chat_${chat.id}.json`);
    };
    el('exportChatMd').onclick = () => {
      const chat = currentChat(); if (!chat) return;
      downloadMarkdown(chatToMarkdown(chat), `chat_${chat.id}.md`);
    };
    el('exportAll').onclick = () => {
      downloadFile(JSON.stringify(state.chats, null, 2), 'all_chats.json');
    };
    el('importFile').onchange = async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (Array.isArray(data)) state.chats = data; else state.chats.unshift(data);
        state.activeId = state.chats[0]?.id || null;
        saveState(); renderChats(); renderMessages();
      } catch { showToast('å¯¼å…¥å¤±è´¥'); }
      e.target.value = '';
    };

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }
    function downloadMarkdown(content, filename) {
      const blob = new Blob([content], { type: 'text/markdown' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }
    function chatToMarkdown(chat) {
      const header = `# å¯¹è¯è®°å½•\n\n`;
      const body = chat.messages.map(m => {
        const role = m.role === 'user' ? 'ç”¨æˆ·' : m.role === 'assistant' ? 'AI' : 'ç³»ç»Ÿ';
        return `## ${role}\n\n${m.content}\n`;
      }).join('\n');
      return header + body;
    }

    // ===== è¾…åŠ© =====
    function debounce(fn, delay) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
    }
    function showToast(msg) {
      const t = el('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1200);
    }

    // ===== ç½‘ç»œæ£€æµ‹ =====
    window.addEventListener('offline', () => showToast('ç½‘ç»œå·²æ–­å¼€'));
    window.addEventListener('online', () => showToast('ç½‘ç»œå·²è¿æ¥'));

    // ===== é¦–æ¬¡åˆå§‹åŒ– =====
    if (!state.activeId) newChat();
    renderChats();
    renderMessages();
    if (!state.config.key) { guide.style.display = 'flex'; }

    // ===== è½¯é”®ç›˜é€‚é… =====
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        const offset = window.innerHeight - window.visualViewport.height;
        el('composer').style.transform = `translateY(-${offset}px)`;
      });
    }
  </script>
</body>
</html>
