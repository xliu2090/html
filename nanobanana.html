<!doctype html>        
<html lang="zh-CN">          
<head>          
  <meta charset="utf-8" />          
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />          
  <title>nanobanana pro绘图</title>          
  <style>          
    :root{          
      /* 明亮主题配色 */
      --bg:#F5F7FA; --card:#FFFFFF; --line:#E1E4E8;          
      --text:#1F2937; --muted:#6B7280;          
      --brand:#2563EB; --brand-light:#EFF6FF;           
      --radius:16px; --input-bg:#F9FAFB;          
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --sans: system-ui, -apple-system, sans-serif;          
    }          
    *{box-sizing:border-box}          
    body{          
      margin:0; font-family:var(--sans); color:var(--text);          
      background: var(--bg); min-height:100vh;          
      -webkit-font-smoothing: antialiased;          
    }          
    .wrap{max-width:720px; margin:0 auto; padding:20px 16px 60px;}          
    
    /* 顶部导航 */
    .head{          
      display:flex; align-items:center; justify-content:space-between;          
      padding-bottom:16px; margin-bottom:10px;          
    }          
    .brand{display:flex; align-items:center; gap:12px;}          
    .logo{          
      width:36px; height:36px; border-radius:10px;          
      background: linear-gradient(135deg, #3B82F6, #8B5CF6);          
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
    }          
    .title b{display:block; font-size:18px; font-weight: 700; color: #111827;}          
    .title span{font-size:13px; color:var(--muted);}          
    
    /* 主操作卡片 */
    .card{          
      background: var(--card); border:1px solid var(--line);          
      border-radius:var(--radius); padding:20px;          
      box-shadow: var(--shadow);
    }          

    /* 紧凑网格布局 */
    .settings-grid {
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 16px; margin-bottom: 16px;
    }
    
    .control-item { display: flex; flex-direction: column; gap: 6px; }
    .control-item label { font-size: 12px; color: var(--muted); font-weight: 600; }
    
    input, select, textarea {          
      width:100%; border-radius:10px; border:1px solid var(--line);          
      background: var(--input-bg); color:var(--text);          
      padding: 0 12px; height: 42px; font-size:14px; outline:none;          
      transition: all 0.2s;
    }     
    input:focus, select:focus, textarea:focus { 
      border-color: var(--brand); background: #fff; 
      box-shadow: 0 0 0 3px var(--brand-light);
    }
    
    /* 只读样式 */
    .readonly-input { 
      color: var(--brand); font-weight: bold; cursor: default; 
      background: var(--brand-light); border-color: transparent;
    }

    textarea{ height:auto; min-height:80px; padding:12px; resize:vertical; line-height:1.5; }          
    
    /* 按钮样式 */
    .btn{          
      border:none; border-radius:10px; padding:0 20px; height:46px; font-weight:600; cursor:pointer;          
      background: linear-gradient(90deg, #2563EB, #4F46E5); color:#fff;          
      font-size: 15px; width: 100%; margin-top: 20px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
      transition: transform 0.1s, opacity 0.2s;
    }          
    .btn:active { transform: scale(0.98); opacity: 0.9; }
    .btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
    
    /* 参考图上传框 */
    .upload-box {
      position:relative; width:100%; height:42px;
      border:1px dashed var(--line); border-radius:10px; 
      display:flex; align-items:center; justify-content:center; 
      color:var(--muted); font-size:13px; background:var(--input-bg);
      cursor: pointer; transition: all 0.2s;
    }
    .upload-box:hover { border-color: var(--brand); color: var(--brand); background: #fff; }

    /* 参考图缩略图 */
    .ref-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 10px; margin-top: 10px;
    }
    .ref-item {
      position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden;
      border: 1px solid var(--line); background: #f0f0f0;
    }
    .ref-item img { width: 100%; height: 100%; object-fit: cover; }
    .ref-del {
      position: absolute; top: 2px; right: 2px; width: 20px; height: 20px;
      background: rgba(255,255,255,0.9); color: #ef4444; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* 历史记录 */
    .history-section { margin-top: 40px; }
    .history-head { 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--line);
    }
    .hist-card { 
      background: var(--card); border-radius: 16px; overflow: hidden; 
      border: 1px solid var(--line); margin-bottom: 24px;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .hist-card img { width: 100%; display: block; background: #f9f9f9; min-height: 200px; object-fit: contain; }
    
    /* 图片底部信息栏 */
    .hist-meta { 
      padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; 
      border-top: 1px solid var(--line); background: #fdfdfd;
    }
    .meta-info { display: flex; flex-direction: column; gap: 2px; }
    .meta-title { font-size: 13px; font-weight: 600; color: var(--text); }
    .meta-res { font-size: 11px; color: var(--muted); font-family: monospace; }
    
    .actions-group { display: flex; gap: 12px; align-items: center; }
    .link-btn { color: var(--brand); text-decoration: none; font-weight: 500; font-size: 13px; cursor: pointer; transition: opacity 0.2s;}
    .link-btn:hover { opacity: 0.7; }
    .del-btn { color: #ef4444; font-size: 13px; cursor: pointer; transition: opacity 0.2s;}
    .del-btn:hover { opacity: 0.7; }

    /* 加载占位符样式 (Skeleton) */
    .loading-placeholder {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 300px; background: #F3F4F6; color: var(--muted); gap: 15px;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid #E5E7EB;
      border-left-color: var(--brand); border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* 登录弹窗 (明亮版) */
    #loginLayer {
        position: fixed; top:0; left:0; width:100%; height:100vh;
        background: rgba(255,255,255,0.6); z-index: 999;
        display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(15px);
    }
    .loginBox {
        width: 320px; padding: 30px;
        background: #fff; border: 1px solid var(--line);
        border-radius: 20px; text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .loginBox h3 { margin: 0 0 20px; color: #111; font-size: 20px; }
  </style>          
</head>  
<body>          

<div id="loginLayer">
    <div class="loginBox">
        <h3>欢迎回来</h3>
        <input id="u_name" type="text" placeholder="账号" style="margin-bottom:12px; text-align:center" />
        <input id="u_pass" type="password" placeholder="密码" style="margin-bottom:20px; text-align:center" />
        <button class="btn" id="btnLogin">立即登录</button>
        <div id="loginMsg" style="margin-top:10px; font-size:12px; color:#ef4444"></div>
    </div>
</div>

<div class="wrap">          
  <div class="head">          
    <div class="brand">          
      <div class="logo"></div>          
      <div class="title">          
        <b>AI 绘图工作台</b>          
        <span id="welcomeText">未登录</span>          
      </div>          
    </div>
    <div style="text-align:right">
         <div id="quotaText" style="font-size:13px; color:var(--brand); font-weight:700"></div>
         <div style="font-size:12px; color:var(--muted); cursor:pointer; margin-top:2px" id="logoutBtn">退出</div>
    </div>
  </div>    
  
  <div class="card">          
    
    <div class="settings-grid">
        <div class="control-item">
            <label>生成模型</label>
            <select id="modelSelect">
                <option value="gemini-3-pro-image-preview">Gemini 3 Pro</option>
                <option value="gemini-2.5-flash-image-preview">Gemini 2.5 Flash</option>
            </select>
        </div>

        <div class="control-item">
            <label>画面比例</label>
            <select id="ratio">          
              <option value="1:1">1:1 (正方形)</option>          
              <option value="16:9" selected>16:9 (横屏)</option>          
              <option value="9:16">9:16 (竖屏)</option>          
              <option value="4:3">4:3</option>          
              <option value="3:4">3:4</option>          
            </select>
        </div>

        <div class="control-item">
            <label>分辨率</label>
            <select id="res">          
              <option value="1K">标准 (1K)</option>          
              <option value="2K">高清 (2K)</option>
              <option value="4K" selected>超清 (4K)</option>
            </select> 
        </div>

        <div class="control-item">
            <label>参考图片 (可选)</label>
            <div class="upload-box">
                <input id="fileInput" type="file" accept="image/*" multiple style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer;" />
                <span>+ 上传图片 (Max 9)</span>
            </div>
        </div>
    </div>

    <div id="refGrid" class="ref-grid" style="display:none"></div>
        
    <div class="control-item" style="margin-top:16px;">
        <label>创意描述 (Prompt)</label>
        <textarea id="prompt" placeholder="在此输入画面描述，例如：阳光下的向日葵花海，吉卜力画风，色彩鲜艳..."></textarea>
    </div>

    <button class="btn" id="gen">开始生成图片</button>          
  </div>  

  <div class="history-section">
      <div class="history-head">
          <span style="font-size:16px; font-weight:700; color:var(--text)">生成结果 & 历史</span>
          <span id="clearHistory" style="font-size:13px; color:var(--muted); cursor:pointer">清空记录</span>
      </div>
      
      <div id="historyList"></div>
  </div>
</div>  

<script>          
(() => {
  // ================= 配置区 =================
  const USERS_DB = {
      "xliu2090": { 
          pwd: "123456kk", 
          key: "sk-ZA5sEkC0iK2huymcy99ZshEmS1eUVWkbSZkMdni8Tz8WeQGX", 
          limit: 50
      }
  };
  // 核心修改：改为 Base URL，不再写死完整路径
  const BASE_URL = "https://api.vectorengine.ai/v1beta/models/";       
  // =========================================

  let currentUser = null;
  let refImages = []; 
  const $ = (id) => document.getElementById(id);          
  const el = {          
    // 新增 modelSelect 引用
    model: $("modelSelect"),
    ratio: $("ratio"), res: $("res"), fileInput: $("fileInput"),          
    refGrid: $("refGrid"), prompt: $("prompt"), gen: $("gen"),          
    historyList: $("historyList"),
    loginLayer: $("loginLayer"), u_name: $("u_name"), u_pass: $("u_pass"), 
    btnLogin: $("btnLogin"), loginMsg: $("loginMsg"), 
    welcomeText: $("welcomeText"), quotaText: $("quotaText"), logoutBtn: $("logoutBtn"),
    clearHistory: $("clearHistory")
  };          

  // --- IndexedDB ---
  const DB_NAME = "AI_Art_Light";
  const STORE_NAME = "imgs";
  let dbInstance = null;

  function initDB() {
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
    };
    request.onsuccess = (e) => {
        dbInstance = e.target.result;
        loadHistory();
    };
  }

  function saveToDB(blob, meta) {
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    const item = { id: Date.now(), blob: blob, meta: meta, date: new Date().toLocaleString() };
    tx.objectStore(STORE_NAME).add(item);
  }

  function deleteItem(id, dom) {
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).delete(id);
    tx.oncomplete = () => dom.remove();
  }

  function clearAllDB() {
    if(!confirm("确认清空所有历史图片？")) return;
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).clear();
    tx.oncomplete = () => el.historyList.innerHTML = "";
  }

  function loadHistory() {
    if (!dbInstance) return;
    el.historyList.innerHTML = ""; 
    const tx = dbInstance.transaction([STORE_NAME], "readonly");
    const req = tx.objectStore(STORE_NAME).getAll();
    req.onsuccess = () => {
      const items = req.result.sort((a, b) => b.id - a.id);
      items.forEach(item => renderItem(item, null)); 
    };
  }

  function renderItem(item, replaceElem) {
    const url = URL.createObjectURL(item.blob); 
    
    const html = `
      <img src="${url}" class="gen-img" />
      <div class="hist-meta">
        <div class="meta-info">
            <span class="meta-title">${item.meta}</span>
            <span class="meta-res">读取分辨率...</span>
        </div>
        <div class="actions-group">
            <a href="${url}" target="_blank" class="link-btn">打开</a>
            <a href="${url}" download="img_${item.id}.png" class="link-btn">下载</a>
            <span class="del-btn">删除</span>
        </div>
      </div>
    `;

    const attachLogic = (container) => {
        const img = container.querySelector(".gen-img");
        const resSpan = container.querySelector(".meta-res");
        const delBtn = container.querySelector(".del-btn");

        const updateRes = () => {
             resSpan.textContent = `${img.naturalWidth} × ${img.naturalHeight} px`;
        };
        
        if (img.complete) {
            updateRes();
        } else {
            img.onload = updateRes;
        }

        delBtn.onclick = () => deleteItem(item.id, container);
    };

    if (replaceElem) {
        replaceElem.innerHTML = html;
        attachLogic(replaceElem);
    } else {
        const div = document.createElement("div");
        div.className = "hist-card";
        div.innerHTML = html;
        attachLogic(div);
        el.historyList.appendChild(div);
    }
  }

  // --- Logic ---
  function updateQuota() {
    if (!currentUser) return;
    const used = parseInt(localStorage.getItem("used_" + currentUser) || "0");
    const total = USERS_DB[currentUser].limit;
    el.quotaText.textContent = `剩余额度: ${total - used}`;
    el.welcomeText.textContent = currentUser;
  }

  el.btnLogin.onclick = () => {
      const u = el.u_name.value.trim();
      const p = el.u_pass.value.trim();
      if (USERS_DB[u] && USERS_DB[u].pwd === p) {
          currentUser = u;
          el.loginLayer.style.display = "none";
          updateQuota();
          initDB();
      } else {
          el.loginMsg.textContent = "账号或密码错误";
      }
  };

  el.logoutBtn.onclick = () => location.reload();

  el.fileInput.onchange = async () => {
    const files = Array.from(el.fileInput.files);
    if (!files.length) return;
    if (refImages.length + files.length > 9) return alert("最多9张");
    
    for (const f of files) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const b64 = e.target.result.split(',')[1];
            const mime = e.target.result.match(/:(.*?);/)[1];
            refImages.push({ mime, b64, url: e.target.result });
            renderRef();
        };
        reader.readAsDataURL(f);
    }
    el.fileInput.value = "";
  };

  function renderRef() {
      el.refGrid.style.display = refImages.length ? "grid" : "none";
      el.refGrid.innerHTML = refImages.map((img, i) => `
        <div class="ref-item">
            <img src="${img.url}">
            <div class="ref-del" onclick="removeRef(${i})">×</div>
        </div>
      `).join('');
  }
  window.removeRef = (i) => { refImages.splice(i, 1); renderRef(); };

  el.clearHistory.onclick = clearAllDB;

  el.gen.onclick = async () => {
    if (!currentUser) return;
    const prompt = el.prompt.value.trim();
    if (!prompt) return alert("请输入提示词");
    
    const used = parseInt(localStorage.getItem("used_" + currentUser) || "0");
    if (used >= USERS_DB[currentUser].limit) return alert("额度已用完");

    // 1. Loading 占位
    const loadingCard = document.createElement("div");
    loadingCard.className = "hist-card";
    loadingCard.innerHTML = `
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <div>AI 正在绘制中...</div>
        </div>
    `;
    el.historyList.prepend(loadingCard);

    el.gen.disabled = true;
    el.gen.textContent = "生成中...";

    const parts = [{ text: prompt }];
    refImages.forEach(img => parts.push({ inlineData: { mimeType: img.mime, data: img.b64 } }));

    // 核心修改：动态构建 URL
    // 获取当前下拉框的值 (带 preview)
    const currentModelId = el.model.value;
    const finalUrl = `${BASE_URL}${currentModelId}:generateContent`;

    try {
        const resp = await fetch(finalUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + USERS_DB[currentUser].key },
            body: JSON.stringify({
                contents: [{ parts }],
                generationConfig: { imageConfig: { aspectRatio: el.ratio.value, imageSize: el.res.value } }
            })
        });
        
        const json = await resp.json();
        
        let imgData = null;
        if (json.candidates) {
            for (let p of json.candidates[0].content.parts) {
                if (p.inlineData) { imgData = p.inlineData; break; }
            }
        }
        
        if (!imgData) throw new Error("生成失败，请调整提示词重试");

        const binary = atob(imgData.data);
        const array = new Uint8Array(binary.length);
        for(let i=0; i<binary.length; i++) array[i] = binary.charCodeAt(i);
        const blob = new Blob([array], {type: imgData.mimeType});
        const meta = `${el.ratio.value} · ${el.res.value}`;

        // 2. 替换为真图
        const item = { id: Date.now(), blob: blob, meta: meta };
        renderItem(item, loadingCard);
        
        saveToDB(blob, meta);
        localStorage.setItem("used_" + currentUser, used + 1);
        updateQuota();
        
    } catch (e) {
        loadingCard.remove();
        alert(e.message);
    } finally {
        el.gen.disabled = false;
        el.gen.textContent = "开始生成图片";
    }
  };
})();          
</script>  
</body>          
</html>
