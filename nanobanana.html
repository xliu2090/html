<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI 绘图系统</title>
  <style>
    :root{
      --bg: #F6F7FB;
      --card:#FFFFFF;
      --line: rgba(17, 24, 39, 0.10);
      --line-strong: rgba(17, 24, 39, 0.14);

      --text:#0F172A;
      --muted:#64748B;

      --brand:#2563EB;
      --brand-2:#1D4ED8;
      --brand-soft: rgba(37, 99, 235, 0.12);

      --danger:#EF4444;

      --radius:18px;
      --radius-sm:12px;

      --input-bg:#F8FAFC;

      --shadow-sm: 0 2px 10px rgba(2, 6, 23, 0.06);
      --shadow: 0 12px 30px rgba(2, 6, 23, 0.08);
      --shadow-2: 0 18px 50px rgba(2, 6, 23, 0.10);

      --ring: 0 0 0 4px var(--brand-soft);

      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(900px 600px at 100% 0%, rgba(99,102,241,.08), transparent 50%),
        linear-gradient(180deg, var(--bg), #F7F8FC);
    }

    a{color:inherit}
    ::selection{background: rgba(37, 99, 235, .18)}

    .wrap{
      max-width: 780px;
      margin: 0 auto;
      padding: 28px 16px 72px;
    }

    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px;
      margin-bottom: 18px;

      background: rgba(255,255,255,.70);
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 2px);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }

    .logo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1D4ED8, #2563EB);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.22);
      position: relative;
      overflow: hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:-40% -40% auto auto;
      width: 120%;
      height: 120%;
      transform: rotate(18deg);
      background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.25), rgba(255,255,255,.0));
      opacity: .8;
    }

    .title{min-width:0}
    .title b{
      display:block;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #0B1220;
      line-height: 1.15;
    }
    .title span{
      display:block;
      margin-top: 4px;
      font-size: 12.5px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 48vw;
    }

    #logoutBtn{
      font-size: 12.5px;
      color: var(--muted);
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      user-select:none;
    }
    #logoutBtn:hover{
      background: rgba(15, 23, 42, 0.04);
      border-color: var(--line);
      color: #0F172A;
    }
    #logoutBtn:active{transform: translateY(1px)}

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .settings-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    @media (max-width: 560px){
      .settings-grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .wrap{padding-top: 18px}
      .head{padding: 12px}
      .card{padding: 16px}
    }

    .control-item{
      display:flex;
      flex-direction:column;
      gap: 7px;
      min-width: 0;
    }

    .control-item label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
    }

    input, select, textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--input-bg);
      color: var(--text);
      padding: 0 12px;
      height: 44px;
      font-size: 14px;
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .05s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    }

    select{
      appearance:none;
      padding-right: 40px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(15,23,42,.55) 50%),
        linear-gradient(135deg, rgba(15,23,42,.55) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) 18px,
        calc(100% - 13px) 18px,
        0 0;
      background-size:
        5px 5px,
        5px 5px,
        100% 100%;
      background-repeat:no-repeat;
    }

    textarea{
      height:auto;
      min-height: 92px;
      padding: 12px;
      resize: vertical;
      line-height: 1.55;
    }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.65);
      background: #fff;
      box-shadow: var(--ring);
    }

    input::placeholder, textarea::placeholder{color: rgba(100,116,139,.85)}

    option:disabled{
      color: #94A3B8;
      font-style: italic;
    }

    .readonly-input{
      color: var(--brand);
      font-weight: 700;
      cursor: default;
      background: rgba(37,99,235,.08);
      border-color: transparent;
    }

    .btn{
      border:none;
      border-radius: 12px;
      padding: 0 18px;
      height: 48px;
      font-weight: 800;
      cursor:pointer;
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      color:#fff;
      font-size: 15px;
      width: 100%;
      margin-top: 18px;
      box-shadow:
        0 14px 30px rgba(37, 99, 235, 0.18),
        0 2px 0 rgba(255,255,255,.18) inset;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease, opacity .2s ease;
      letter-spacing: .2px;
    }
    .btn:hover{
      filter: brightness(1.02);
      box-shadow:
        0 18px 36px rgba(37, 99, 235, 0.20),
        0 2px 0 rgba(255,255,255,.18) inset;
      transform: translateY(-1px);
    }
    .btn:active{
      transform: translateY(0px) scale(0.99);
      opacity: .95;
    }
    .btn:disabled{
      background: linear-gradient(180deg, #CBD5E1, #94A3B8);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
      opacity: 1;
    }

    .upload-box{
      position:relative;
      width:100%;
      height:44px;
      border: 1px dashed rgba(100,116,139,.35);
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      background: rgba(248,250,252,.85);
      cursor: pointer;
      transition: border-color .2s ease, background .2s ease, color .2s ease, transform .08s ease;
      user-select:none;
    }
    .upload-box:hover{
      border-color: rgba(37,99,235,.55);
      color: var(--brand);
      background: #fff;
      transform: translateY(-1px);
    }
    .upload-box span{font-weight: 700; letter-spacing: .1px;}

    .ref-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .ref-item{
      position:relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #F1F5F9;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .ref-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(2,6,23,.08);
    }
    .ref-item img{width:100%; height:100%; object-fit: cover; display:block;}
    .ref-del{
      position:absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(255,255,255,.92);
      color: var(--danger);
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(2,6,23,.10);
      border: 1px solid rgba(2,6,23,.08);
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
    }
    .ref-del:hover{filter: brightness(.98); transform: scale(1.05)}
    .ref-del:active{transform: scale(.98)}

    .history-section{margin-top: 34px;}
    .history-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 14px;
      padding: 0 4px 10px;
      border-bottom: 1px solid var(--line);
    }
    #clearHistory{
      font-size: 13px;
      color: var(--muted);
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      user-select:none;
    }
    #clearHistory:hover{
      background: rgba(15, 23, 42, 0.04);
      border-color: var(--line);
      color: #0F172A;
    }
    #clearHistory:active{transform: translateY(1px)}

    .hist-card{
      background: rgba(255,255,255,.95);
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid var(--line);
      margin-bottom: 18px;
      box-shadow: var(--shadow-sm);
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      animation: slideIn 0.25s ease-out;
    }
    .hist-card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--line-strong);
    }
    @keyframes slideIn{
      from { opacity:0; transform: translateY(8px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .hist-card img{
      width:100%;
      display:block;
      background: #F8FAFC;
      min-height: 220px;
      object-fit: contain;
    }

    .gen-img{ cursor: pointer; }

    .hist-meta{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(248,250,252,.9), rgba(255,255,255,.96));
    }
    .meta-info{display:flex; flex-direction:column; gap: 3px; min-width:0;}
    .meta-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .meta-res{
      font-size: 11px;
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: .2px;
    }

    .actions-group{display:flex; gap: 10px; align-items:center; flex-shrink:0;}

    .link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(37,99,235,.22);
      background: rgba(37,99,235,.06);
      color: var(--brand);
      text-decoration:none;
      font-weight: 800;
      font-size: 12.5px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
      white-space: nowrap;
    }
    .link-btn:hover{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.30);
      transform: translateY(-1px);
    }
    .link-btn:active{transform: translateY(0px); filter: brightness(.98)}

    .del-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(239,68,68,.22);
      background: rgba(239,68,68,.06);
      color: var(--danger);
      font-size: 12.5px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
      white-space: nowrap;
    }
    .del-btn:hover{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.30);
      transform: translateY(-1px);
    }
    .del-btn:active{transform: translateY(0px); filter: brightness(.98)}

    .loading-placeholder{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height: 300px;
      background:
        radial-gradient(500px 250px at 40% 0%, rgba(37,99,235,.08), transparent 65%),
        linear-gradient(180deg, #F8FAFC, #F1F5F9);
      color: var(--muted);
      gap: 14px;
    }
    .spinner{
      width: 44px;
      height: 44px;
      border: 3px solid rgba(100,116,139,.22);
      border-top-color: rgba(37,99,235,.85);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
      background: rgba(255,255,255,.65);
    }
    @keyframes spin{100%{transform:rotate(360deg)}}

    #loginLayer{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.18);
      z-index: 999;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(14px);
      animation: fadeIn .18s ease-out;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .loginBox{
      width: 340px;
      padding: 26px 22px 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 22px;
      text-align:center;
      box-shadow: var(--shadow-2);
      position: relative;
      overflow:hidden;
      transform: translateY(0);
    }

    .loginBox::before{
      content:"";
      position:absolute;
      inset:-2px -2px auto -2px;
      height: 110px;
      background: radial-gradient(700px 120px at 50% 0%, rgba(37,99,235,.20), transparent 60%);
      pointer-events:none;
    }

    .loginBox h3{
      margin: 2px 0 16px;
      color: #0B1220;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .loginBox input[type="text"],
    .loginBox input[type="password"] {
      text-align:center;
      margin-bottom: 12px;
      height: 46px;
      border-radius: 14px;
      background: rgba(248,250,252,.9);
    }
    .loginBox input[type="password"] {margin-bottom: 18px}

    .remember-box {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      margin-bottom: 4px;
      padding-left: 4px;
    }
    #rememberMe {
      width: 16px;
      height: 16px;
      margin: 0 6px 0 0;
      box-shadow: none;
      background: transparent;
      border-color: var(--line-strong);
    }
    .remember-box label {
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }

    #loginMsg{
      margin-top: 10px;
      font-size: 12px;
      color: var(--danger);
      min-height: 16px;
    }

    /* 新增：自定义模型区域 */
    .custom-panel{
      display:none;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(248,250,252,.75);
      padding: 12px;
      gap: 10px;
    }
    .custom-row{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .custom-row > *{flex:1}
    .small-btn{
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(37,99,235,.22);
      background: rgba(37,99,235,.08);
      color: var(--brand);
      font-weight: 900;
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease;
    }
    .small-btn:hover{transform: translateY(-1px); filter: brightness(1.02)}
    .small-btn:active{transform: translateY(0px); filter: brightness(.98)}
    .pill-list{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
      font-size: 12px;
      color: var(--muted);
    }
    .pill b{color: var(--text)}
    .pill .x{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color: var(--danger);
      border: 1px solid rgba(239,68,68,.18);
      background: rgba(239,68,68,.06);
      font-weight: 900;
      user-select:none;
    }
    .pill .x:hover{filter: brightness(.98)}
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 6px;
    }

    /* 新增：错误展示 */
    .error-box{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(239,68,68,.22);
      background: rgba(239,68,68,.06);
      color: #991B1B;
      font-size: 12.5px;
      line-height: 1.5;
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important; scroll-behavior:auto !important;}
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0B1220;
        --card: rgba(15,23,42,.72);
        --line: rgba(148,163,184,.18);
        --line-strong: rgba(148,163,184,.26);
        --text:#E5E7EB;
        --muted:#A3B2C7;
        --input-bg: rgba(2,6,23,.35);
        --shadow-sm: 0 10px 30px rgba(0,0,0,.35);
        --shadow: 0 18px 60px rgba(0,0,0,.40);
        --shadow-2: 0 25px 90px rgba(0,0,0,.50);
      }

      body{
        background:
          radial-gradient(1200px 700px at 15% -10%, rgba(37,99,235,.22), transparent 55%),
          radial-gradient(900px 600px at 100% 0%, rgba(99,102,241,.16), transparent 50%),
          linear-gradient(180deg, #0B1220, #0A1020);
      }

      .head{
        background: rgba(15,23,42,.55);
        border-color: var(--line);
      }

      .card{background: rgba(15,23,42,.62)}
      .hist-card{background: rgba(15,23,42,.62)}
      .hist-meta{background: linear-gradient(180deg, rgba(2,6,23,.25), rgba(15,23,42,.35))}
      .upload-box{background: rgba(2,6,23,.25)}
      input,select,textarea{color: var(--text)}
      select{
        background-image:
          linear-gradient(45deg, transparent 50%, rgba(226,232,240,.65) 50%),
          linear-gradient(135deg, rgba(226,232,240,.65) 50%, transparent 50%),
          linear-gradient(to right, transparent, transparent);
      }
      #loginLayer{background: rgba(2,6,23,.55)}
      .loginBox{background: rgba(15,23,42,.78); border-color: rgba(148,163,184,.18)}
      .logo{box-shadow: 0 18px 40px rgba(37, 99, 235, 0.20)}

      .custom-panel{
        background: rgba(2,6,23,.20);
        border-color: rgba(148,163,184,.18);
      }
      .pill{background: rgba(15,23,42,.65)}
      .error-box{
        color: #FCA5A5;
        border-color: rgba(239,68,68,.22);
        background: rgba(239,68,68,.10);
      }
    }
  </style>
</head>

<body>
<div id="loginLayer">
  <div class="loginBox">
    <h3>欢迎回来</h3>
    <input id="u_name" type="text" placeholder="账号" />
    <input id="u_pass" type="password" placeholder="密码" />

    <div class="remember-box">
      <input type="checkbox" id="rememberMe">
      <label for="rememberMe">记住账号密码 </label>
    </div>

    <button class="btn" id="btnLogin">立即登录</button>
    <div id="loginMsg"></div>
  </div>
</div>

<div class="wrap">
  <div class="head">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>AI 绘图工作台</b>
        <span id="welcomeText">未登录</span>
      </div>
    </div>
    <div style="text-align:right">
      <div id="logoutBtn">退出</div>
    </div>
  </div>

  <div class="card">
    <div class="settings-grid">
      <div class="control-item">
        <label>生成模型</label>
        <select id="modelSelect">
          <option value="gemini-3-pro-image-preview">NanoBanana Pro</option>
          <option value="gemini-2.5-flash-image">NanoBanana（Flash）</option>
          <option value="__custom__">自定义...</option>
        </select>
      </div>

      <div class="control-item">
        <label>画面比例</label>
        <select id="ratio">
          <option value="1:1">1:1 (正方形)</option>
          <option value="16:9" selected>16:9 (横屏)</option>
          <option value="9:16">9:16 (竖屏)</option>
          <option value="4:3">4:3</option>
          <option value="3:4">3:4</option>
        </select>
      </div>

      <div class="control-item">
        <label>分辨率</label>
        <select id="res">
          <option value="1K">标准 (1K)</option>
          <option value="2K">高清 (2K)</option>
          <option value="4K" selected>超清 (4K)</option>
        </select>
      </div>

      <div class="control-item">
        <label>参考图片 (可选)</label>
        <div class="upload-box">
          <input id="fileInput" type="file" accept="image/*" multiple style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer;" />
          <span>+ 上传图片 (Max 9)</span>
        </div>
      </div>

      <!-- 新增：自定义模型面板（占满两列） -->
      <div class="control-item" style="grid-column: 1 / -1;">
        <div id="customPanel" class="custom-panel">
          <div class="custom-row">
            <div style="flex:1.2">
              <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--muted); font-weight:800;">自定义模型ID</label>
              <input id="customModelId" placeholder='例如：gemini-2.5-flash-image 或你服务端支持的模型ID' />
            </div>
            <div style="flex:1">
              <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--muted); font-weight:800;">显示名称（可选）</label>
              <input id="customModelName" placeholder="例如：我的模型A" />
            </div>
          </div>
          <div class="custom-row" style="margin-top:10px;">
            <button id="btnAddModel" class="small-btn" style="flex:0.5">添加到列表</button>
            <button id="btnUseTempModel" class="small-btn" style="flex:0.5">仅本次使用</button>
          </div>
          <div class="hint">
            说明：<b>添加到列表</b> 会保存到浏览器本地（localStorage），刷新仍可用。<br/>
            能力判断：若模型ID包含 <code>flash</code> 将按 Flash 规则限制（例如参考图≤3、分辨率仅 1K）。
          </div>
          <div id="customList" class="pill-list"></div>
        </div>
      </div>
    </div>

    <div id="refGrid" class="ref-grid" style="display:none"></div>

    <div class="control-item" style="margin-top:16px;">
      <label>创意描述 (Prompt)</label>
      <textarea id="prompt" placeholder="在此输入画面描述，例如：阳光下的向日葵花海，吉卜力画风，色彩鲜艳..."></textarea>
    </div>

    <button class="btn" id="gen">开始生成图片</button>
    <div id="errorBox" class="error-box"></div>
  </div>

  <div class="history-section">
    <div class="history-head">
      <span style="font-size:16px; font-weight:900; color:var(--text)">生成结果 & 历史</span>
      <span id="clearHistory">清空记录</span>
    </div>
    <div id="historyList"></div>
  </div>
</div>

<script>
(() => {
  // ================= 配置区 =================
  const USERS_DB = {
      "xliu2090": {
          pwd: "123456kk",
          key: "sk-j9fvH2UVUYyuWMUskDzyTQZdmx92zxruPudu6rxreA7ZEuEt",
          limit: 50
      }
  };
  // 你对接的服务地址（保持原样）
  const BASE_URL = "https://api.vectorengine.ai/v1beta/models/";
  // =========================================

  let currentUser = null;
  let refImages = [];
  let dbInstance = null;

  const $ = (id) => document.getElementById(id);
  const el = {
    model: $("modelSelect"),
    ratio: $("ratio"),
    res: $("res"),
    fileInput: $("fileInput"),
    refGrid: $("refGrid"),
    prompt: $("prompt"),
    gen: $("gen"),
    historyList: $("historyList"),
    loginLayer: $("loginLayer"),
    u_name: $("u_name"),
    u_pass: $("u_pass"),
    btnLogin: $("btnLogin"),
    loginMsg: $("loginMsg"),
    rememberMe: $("rememberMe"),
    welcomeText: $("welcomeText"),
    logoutBtn: $("logoutBtn"),
    clearHistory: $("clearHistory"),

    // 新增：自定义模型
    customPanel: $("customPanel"),
    customModelId: $("customModelId"),
    customModelName: $("customModelName"),
    btnAddModel: $("btnAddModel"),
    btnUseTempModel: $("btnUseTempModel"),
    customList: $("customList"),

    // 新增：错误展示
    errorBox: $("errorBox"),
  };

  // ===== IndexedDB =====
  const DB_NAME = "AI_Art_Light";
  const STORE_NAME = "imgs";

  function initDB() {
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
    };
    request.onsuccess = (e) => {
        dbInstance = e.target.result;
        loadHistory();
    };
  }

  function saveToDB(blob, meta) {
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    const item = { id: Date.now(), blob: blob, meta: meta, date: new Date().toLocaleString() };
    tx.objectStore(STORE_NAME).add(item);
  }

  function deleteItem(id, dom) {
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).delete(id);
    tx.oncomplete = () => dom.remove();
  }

  function clearAllDB() {
    if(!confirm("确认清空所有历史图片？")) return;
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).clear();
    tx.oncomplete = () => el.historyList.innerHTML = "";
  }

  function loadHistory() {
    if (!dbInstance) return;
    el.historyList.innerHTML = "";
    const tx = dbInstance.transaction([STORE_NAME], "readonly");
    const req = tx.objectStore(STORE_NAME).getAll();
    req.onsuccess = () => {
      const items = req.result.sort((a, b) => b.id - a.id);
      items.forEach(item => renderItem(item, null));
    };
  }

  function renderItem(item, replaceElem) {
    const url = URL.createObjectURL(item.blob);

    const html = `
      <img src="${url}" class="gen-img" />
      <div class="hist-meta">
        <div class="meta-info">
            <span class="meta-title">${escapeHtml(item.meta)}</span>
            <span class="meta-res">读取分辨率...</span>
        </div>
        <div class="actions-group">
            <a href="${url}" target="_blank" class="link-btn open-btn">打开</a>
            <a href="${url}" download="img_${item.id}.png" class="link-btn">下载</a>
            <span class="del-btn">删除</span>
        </div>
      </div>
    `;

    const attachLogic = (container) => {
        const img = container.querySelector(".gen-img");
        const resSpan = container.querySelector(".meta-res");
        const delBtn = container.querySelector(".del-btn");

        const updateRes = () => {
             resSpan.textContent = `${img.naturalWidth} × ${img.naturalHeight} px`;
        };

        if (img.complete) updateRes();
        else img.onload = updateRes;

        img.onclick = () => window.open(url, '_blank');
        delBtn.onclick = () => deleteItem(item.id, container);
    };

    if (replaceElem) {
        replaceElem.innerHTML = html;
        attachLogic(replaceElem);
    } else {
        const div = document.createElement("div");
        div.className = "hist-card";
        div.innerHTML = html;
        attachLogic(div);
        el.historyList.appendChild(div);
    }
  }

  // ===== 工具：安全输出 =====
  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function showError(msg) {
    el.errorBox.style.display = "block";
    el.errorBox.textContent = msg;
  }

  function clearError() {
    el.errorBox.style.display = "none";
    el.errorBox.textContent = "";
  }

  // ===== 自定义模型：保存/加载 =====
  const LS_CUSTOM_MODELS = "ai_art_custom_models_v1";

  function loadCustomModels() {
    try {
      const raw = localStorage.getItem(LS_CUSTOM_MODELS);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function saveCustomModels(list) {
    localStorage.setItem(LS_CUSTOM_MODELS, JSON.stringify(list || []));
  }

  function refreshModelSelect() {
    const selected = el.model.value;

    // 保留内置项
    const builtins = [
      { id: "gemini-3-pro-image-preview", name: "NanoBanana Pro" },
      { id: "gemini-2.5-flash-image", name: "NanoBanana（Flash）" },
    ];

    // 先清空
    el.model.innerHTML = "";

    // 内置
    builtins.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      el.model.appendChild(opt);
    });

    // 自定义列表
    const customs = loadCustomModels();
    if (customs.length) {
      const sep = document.createElement("option");
      sep.disabled = true;
      sep.textContent = "──────── 自定义模型 ────────";
      el.model.appendChild(sep);

      customs.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.name ? `${m.name} (${m.id})` : m.id;
        el.model.appendChild(opt);
      });
    }

    // 自定义入口
    const optCustom = document.createElement("option");
    optCustom.value = "__custom__";
    optCustom.textContent = "自定义...";
    el.model.appendChild(optCustom);

    // 尝试恢复选择
    const allValues = Array.from(el.model.options).map(o => o.value);
    if (allValues.includes(selected)) el.model.value = selected;
    else el.model.value = builtins[0].id;
  }

  function refreshCustomPills() {
    const customs = loadCustomModels();
    el.customList.innerHTML = customs.map(m => `
      <div class="pill" title="${escapeHtml(m.id)}">
        <b>${escapeHtml(m.name || "未命名")}</b>
        <span>${escapeHtml(m.id)}</span>
        <span class="x" data-id="${escapeHtml(m.id)}">×</span>
      </div>
    `).join("");

    // 绑定删除
    el.customList.querySelectorAll(".x").forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute("data-id");
        let list = loadCustomModels();
        list = list.filter(x => x.id !== id);
        saveCustomModels(list);
        refreshModelSelect();
        refreshCustomPills();
      };
    });
  }

  function normalizeModelId(id) {
    return String(id || "").trim();
  }

  function isFlashModel(modelId) {
    return String(modelId || "").toLowerCase().includes("flash");
  }

  function applyResLimitByModel(modelId) {
    const flash = isFlashModel(modelId);
    const opts = el.res.options;

    if (flash) {
      el.res.value = "1K";
      opts[1].disabled = true;
      opts[2].disabled = true;
      opts[1].text = "高清 (2K) - Flash 限制";
      opts[2].text = "超清 (4K) - Flash 限制";
    } else {
      opts[1].disabled = false;
      opts[2].disabled = false;
      opts[1].text = "高清 (2K)";
      opts[2].text = "超清 (4K)";
    }
  }

  function getSelectedModelId() {
    if (el.model.value === "__custom__") {
      return normalizeModelId(el.customModelId.value);
    }
    return el.model.value;
  }

  function getSelectedModelName(modelId) {
    // 如果是 select 里的项，直接用 text；如果是 __custom__，用输入的 name
    if (el.model.value === "__custom__") {
      const n = String(el.customModelName.value || "").trim();
      return n || "自定义模型";
    }
    const opt = el.model.options[el.model.selectedIndex];
    return opt ? opt.textContent : "模型";
  }

  function toggleCustomPanel() {
    const on = el.model.value === "__custom__";
    el.customPanel.style.display = on ? "block" : "none";

    // 选择变化时也更新分辨率限制
    const modelId = getSelectedModelId();
    if (modelId) applyResLimitByModel(modelId);
  }

  // ===== 逻辑：登录记住密码 =====
  const LS_USER = "ai_art_user";
  const LS_PASS = "ai_art_pass";
  const savedUser = localStorage.getItem(LS_USER);
  const savedPass = localStorage.getItem(LS_PASS);
  if (savedUser && savedPass) {
    el.u_name.value = savedUser;
    el.u_pass.value = savedPass;
    el.rememberMe.checked = true;
  }

  function updateUserInfo() {
    if (!currentUser) return;
    el.welcomeText.textContent = currentUser;
  }

  el.btnLogin.onclick = () => {
      const u = el.u_name.value.trim();
      const p = el.u_pass.value.trim();
      if (USERS_DB[u] && USERS_DB[u].pwd === p) {
          currentUser = u;

          if (el.rememberMe.checked) {
            localStorage.setItem(LS_USER, u);
            localStorage.setItem(LS_PASS, p);
          } else {
            localStorage.removeItem(LS_USER);
            localStorage.removeItem(LS_PASS);
          }

          el.loginLayer.style.display = "none";
          updateUserInfo();
          initDB();

          // 初始化模型列表
          refreshModelSelect();
          refreshCustomPills();
          toggleCustomPanel();
          applyResLimitByModel(getSelectedModelId());

      } else {
          el.loginMsg.textContent = "账号或密码错误";
      }
  };

  el.logoutBtn.onclick = () => location.reload();
  el.clearHistory.onclick = clearAllDB;

  // ===== 模型选择变化 =====
  el.model.onchange = () => {
    toggleCustomPanel();
    const modelId = getSelectedModelId();
    if (modelId) applyResLimitByModel(modelId);
  };

  // ===== 自定义模型按钮 =====
  el.btnAddModel.onclick = () => {
    clearError();
    const id = normalizeModelId(el.customModelId.value);
    const name = String(el.customModelName.value || "").trim();

    if (!id) return showError("请输入自定义模型ID。");
    if (id.includes(" ")) return showError("模型ID 不能包含空格。");

    let list = loadCustomModels();
    if (list.some(x => x.id === id)) return showError("该模型ID已存在于列表。");

    list.push({ id, name: name || "自定义模型" });
    saveCustomModels(list);

    refreshModelSelect();
    refreshCustomPills();

    // 选中新添加的模型
    el.model.value = id;
    toggleCustomPanel();
    applyResLimitByModel(id);
  };

  el.btnUseTempModel.onclick = () => {
    clearError();
    const id = normalizeModelId(el.customModelId.value);
    if (!id) return showError("请输入自定义模型ID。");
    if (id.includes(" ")) return showError("模型ID 不能包含空格。");

    // 不保存，只用于本次：select 仍在 __custom__
    applyResLimitByModel(id);
    showError("已设置“仅本次使用”的模型ID。点击生成即可。");
    setTimeout(clearError, 1800);
  };

  // ===== 参考图上传 =====
  el.fileInput.onchange = async () => {
    clearError();
    const files = Array.from(el.fileInput.files);
    if (!files.length) return;

    if (refImages.length + files.length > 9) {
      el.fileInput.value = "";
      return showError("最多只能上传 9 张参考图。");
    }

    for (const f of files) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const b64 = e.target.result.split(',')[1];
            const mime = e.target.result.match(/:(.*?);/)[1];
            refImages.push({ mime, b64, url: e.target.result });
            renderRef();
        };
        reader.readAsDataURL(f);
    }
    el.fileInput.value = "";
  };

  function renderRef() {
      el.refGrid.style.display = refImages.length ? "grid" : "none";
      el.refGrid.innerHTML = refImages.map((img, i) => `
        <div class="ref-item">
            <img src="${img.url}">
            <div class="ref-del" onclick="removeRef(${i})">×</div>
        </div>
      `).join('');
  }
  window.removeRef = (i) => { refImages.splice(i, 1); renderRef(); };

  // ===== 解析返回：尽量从 candidates 中找到图片 =====
  function extractImageFromResponse(json) {
    const candidates = json?.candidates || [];
    for (const c of candidates) {
      const parts = c?.content?.parts || [];
      for (const p of parts) {
        if (p?.inlineData?.data) return p.inlineData; // { mimeType, data }
      }
    }
    return null;
  }

  function extractTextFromResponse(json) {
    const candidates = json?.candidates || [];
    for (const c of candidates) {
      const parts = c?.content?.parts || [];
      for (const p of parts) {
        if (typeof p?.text === "string" && p.text.trim()) return p.text.trim();
      }
    }
    return "";
  }

  function getFinishReason(json) {
    const fr = json?.candidates?.[0]?.finishReason;
    return fr ? String(fr) : "";
  }

  function base64ToBlob(b64, mimeType) {
    const binary = atob(b64);
    const array = new Uint8Array(binary.length);
    for(let i=0; i<binary.length; i++) array[i] = binary.charCodeAt(i);
    return new Blob([array], {type: mimeType || "image/png"});
  }

  // ===== 生成 =====
  el.gen.onclick = async () => {
    clearError();
    if (!currentUser) return;

    const prompt = el.prompt.value.trim();
    if (!prompt) return showError("请输入提示词。");

    const used = parseInt(localStorage.getItem("used_" + currentUser) || "0", 10);
    if (used >= USERS_DB[currentUser].limit) return showError("额度已用完。");

    const modelId = getSelectedModelId();
    if (!modelId) return showError("请选择或输入有效的模型ID。");

    // Flash 限制参考图（经验上更稳定）
    const flash = isFlashModel(modelId);
    if (flash && refImages.length > 3) {
      return showError("当前模型像 Flash 类型：建议参考图不超过 3 张（已检测到超过 3 张）。请减少参考图或换 Pro 模型。");
    }

    // 1. Loading 占位
    const loadingCard = document.createElement("div");
    loadingCard.className = "hist-card";
    loadingCard.innerHTML = `
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <div>绘制中...</div>
        </div>
    `;
    el.historyList.prepend(loadingCard);

    el.gen.disabled = true;
    el.gen.textContent = "生成中...";

    // parts：文本 + 参考图
    const parts = [{ text: prompt }];
    refImages.forEach(img => parts.push({ inlineData: { mimeType: img.mime, data: img.b64 } }));

    const finalUrl = `${BASE_URL}${modelId}:generateContent`;

    try {
        const resp = await fetch(finalUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + USERS_DB[currentUser].key
            },
            body: JSON.stringify({
                contents: [{ parts }],
                generationConfig: {
                  responseModalities: ["IMAGE"], // 关键：明确要求返回图片
                  candidateCount: 1,
                  imageConfig: {
                    aspectRatio: el.ratio.value,
                    imageSize: el.res.value
                  }
                }
            })
        });

        let json = null;
        try {
          json = await resp.json();
        } catch {
          // 非 JSON
          const text = await resp.text().catch(() => "");
          throw new Error(`接口返回非 JSON。HTTP ${resp.status}. ${text ? "返回内容：" + text.slice(0, 300) : ""}`);
        }

        // HTTP 错误：展示真实原因
        if (!resp.ok) {
          const msg = json?.error?.message || JSON.stringify(json);
          throw new Error(`HTTP ${resp.status}：${msg}`);
        }

        // 成功：尝试取图
        const imgData = extractImageFromResponse(json);

        if (!imgData) {
          // 没有图片：可能是只回了文字、被安全策略拦截、或模型不支持
          const txt = extractTextFromResponse(json);
          const fr = getFinishReason(json);
          const hint = [
            "未返回图片。",
            fr ? `finishReason=${fr}` : "",
            txt ? `模型返回文字：${txt}` : "",
            "建议：",
            "1) 确认模型ID支持图片输出；",
            "2) 缩短提示词、减少参考图；",
            "3) 若是 Flash，参考图≤3 且分辨率 1K 更稳定；",
          ].filter(Boolean).join("\n");
          throw new Error(hint);
        }

        const blob = base64ToBlob(imgData.data, imgData.mimeType);

        const modelName = getSelectedModelName(modelId);
        const meta = `${modelName} · ${el.ratio.value} · ${el.res.value}`;

        // 替换为真图
        const item = { id: Date.now(), blob: blob, meta: meta };
        renderItem(item, loadingCard);

        saveToDB(blob, meta);
        localStorage.setItem("used_" + currentUser, used + 1);
        updateUserInfo();

    } catch (e) {
        loadingCard.remove();
        const msg = (e && e.message) ? e.message : String(e);
        showError(msg);
        console.error("Generate error:", e);
    } finally {
        el.gen.disabled = false;
        el.gen.textContent = "开始生成图片";
    }
  };

})();
</script>
</body>
</html>
