<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI 绘图系统</title>
  <style>
    :root{
      /* ===== 商用级：克制中性 + 质感阴影 + 统一间距 ===== */
      --bg: #F6F7FB;
      --card:#FFFFFF;
      --line: rgba(17, 24, 39, 0.10);
      --line-strong: rgba(17, 24, 39, 0.14);

      --text:#0F172A;
      --muted:#64748B;

      --brand:#2563EB;
      --brand-2:#1D4ED8;
      --brand-soft: rgba(37, 99, 235, 0.12);

      --danger:#EF4444;

      --radius:18px;
      --radius-sm:12px;

      --input-bg:#F8FAFC;

      --shadow-sm: 0 2px 10px rgba(2, 6, 23, 0.06);
      --shadow: 0 12px 30px rgba(2, 6, 23, 0.08);
      --shadow-2: 0 18px 50px rgba(2, 6, 23, 0.10);

      --ring: 0 0 0 4px var(--brand-soft);

      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(900px 600px at 100% 0%, rgba(99,102,241,.08), transparent 50%),
        linear-gradient(180deg, var(--bg), #F7F8FC);
    }

    a{color:inherit}
    ::selection{background: rgba(37, 99, 235, .18)}

    .wrap{
      max-width: 780px;
      margin: 0 auto;
      padding: 28px 16px 72px;
    }

    /* ===== 顶部导航 ===== */
    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px;
      margin-bottom: 18px;

      background: rgba(255,255,255,.70);
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 2px);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }

    .logo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1D4ED8, #2563EB);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.22);
      position: relative;
      overflow: hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:-40% -40% auto auto;
      width: 120%;
      height: 120%;
      transform: rotate(18deg);
      background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.25), rgba(255,255,255,.0));
      opacity: .8;
    }

    .title{min-width:0}
    .title b{
      display:block;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #0B1220;
      line-height: 1.15;
    }
    .title span{
      display:block;
      margin-top: 4px;
      font-size: 12.5px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 48vw;
    }

    #logoutBtn{
      font-size: 12.5px;
      color: var(--muted);
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      user-select:none;
    }
    #logoutBtn:hover{
      background: rgba(15, 23, 42, 0.04);
      border-color: var(--line);
      color: #0F172A;
    }
    #logoutBtn:active{transform: translateY(1px)}

    /* ===== 主操作卡片 ===== */
    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* 永远保持一行两个 */
    .settings-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    @media (max-width: 560px){
      .settings-grid{grid-template-columns: repeat(2, minmax(0, 1fr));} /* 强制两列 */
      .wrap{padding-top: 18px}
      .head{padding: 12px}
      .card{padding: 16px}
    }

    .control-item{
      display:flex;
      flex-direction:column;
      gap: 7px;
      min-width: 0;
    }

    .control-item label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
    }

    input, select, textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--input-bg);
      color: var(--text);
      padding: 0 12px;
      height: 44px;
      font-size: 14px;
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .05s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    }

    select{
      appearance:none;
      padding-right: 40px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(15,23,42,.55) 50%),
        linear-gradient(135deg, rgba(15,23,42,.55) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) 18px,
        calc(100% - 13px) 18px,
        0 0;
      background-size:
        5px 5px,
        5px 5px,
        100% 100%;
      background-repeat:no-repeat;
    }

    textarea{
      height:auto;
      min-height: 92px;
      padding: 12px;
      resize: vertical;
      line-height: 1.55;
    }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.65);
      background: #fff;
      box-shadow: var(--ring);
    }

    input::placeholder, textarea::placeholder{color: rgba(100,116,139,.85)}

    option:disabled{
      color: #94A3B8;
      font-style: italic;
    }

    .readonly-input{
      color: var(--brand);
      font-weight: 700;
      cursor: default;
      background: rgba(37,99,235,.08);
      border-color: transparent;
    }

    /* ===== 按钮 ===== */
    .btn{
      border:none;
      border-radius: 12px;
      padding: 0 18px;
      height: 48px;
      font-weight: 800;
      cursor:pointer;
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      color:#fff;
      font-size: 15px;
      width: 100%;
      margin-top: 18px;
      box-shadow:
        0 14px 30px rgba(37, 99, 235, 0.18),
        0 2px 0 rgba(255,255,255,.18) inset;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease, opacity .2s ease;
      letter-spacing: .2px;
    }
    .btn:hover{
      filter: brightness(1.02);
      box-shadow:
        0 18px 36px rgba(37, 99, 235, 0.20),
        0 2px 0 rgba(255,255,255,.18) inset;
      transform: translateY(-1px);
    }
    .btn:active{
      transform: translateY(0px) scale(0.99);
      opacity: .95;
    }
    .btn:disabled{
      background: linear-gradient(180deg, #CBD5E1, #94A3B8);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
      opacity: 1;
    }

    /* ===== 上传框 ===== */
    .upload-box{
      position:relative;
      width:100%;
      height:44px;
      border: 1px dashed rgba(100,116,139,.35);
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      background: rgba(248,250,252,.85);
      cursor: pointer;
      transition: border-color .2s ease, background .2s ease, color .2s ease, transform .08s ease;
      user-select:none;
    }
    .upload-box:hover{
      border-color: rgba(37,99,235,.55);
      color: var(--brand);
      background: #fff;
      transform: translateY(-1px);
    }
    .upload-box span{font-weight: 700; letter-spacing: .1px;}

    /* 参考图缩略图 */
    .ref-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .ref-item{
      position:relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #F1F5F9;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .ref-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(2,6,23,.08);
    }
    .ref-item img{width:100%; height:100%; object-fit: cover; display:block;}
    .ref-del{
      position:absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(255,255,255,.92);
      color: var(--danger);
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(2,6,23,.10);
      border: 1px solid rgba(2,6,23,.08);
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
    }
    .ref-del:hover{filter: brightness(.98); transform: scale(1.05)}
    .ref-del:active{transform: scale(.98)}

    /* ===== 历史 ===== */
    .history-section{margin-top: 34px;}
    .history-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 14px;
      padding: 0 4px 10px;
      border-bottom: 1px solid var(--line);
    }
    #clearHistory{
      font-size: 13px;
      color: var(--muted);
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      user-select:none;
    }
    #clearHistory:hover{
      background: rgba(15, 23, 42, 0.04);
      border-color: var(--line);
      color: #0F172A;
    }
    #clearHistory:active{transform: translateY(1px)}

    .hist-card{
      background: rgba(255,255,255,.95);
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid var(--line);
      margin-bottom: 18px;
      box-shadow: var(--shadow-sm);
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      animation: slideIn 0.25s ease-out;
    }
    .hist-card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--line-strong);
    }
    @keyframes slideIn{
      from { opacity:0; transform: translateY(8px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .hist-card img{
      width:100%;
      display:block;
      background: #F8FAFC;
      min-height: 220px;
      object-fit: contain;
    }

    /* 点击成图可预览 */
    .gen-img{ cursor: zoom-in; }

    .hist-meta{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(248,250,252,.9), rgba(255,255,255,.96));
    }
    .meta-info{display:flex; flex-direction:column; gap: 3px; min-width:0;}
    .meta-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .meta-res{
      font-size: 11px;
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: .2px;
    }

    .actions-group{display:flex; gap: 10px; align-items:center; flex-shrink:0;}

    .link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(37,99,235,.22);
      background: rgba(37,99,235,.06);
      color: var(--brand);
      text-decoration:none;
      font-weight: 800;
      font-size: 12.5px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
      white-space: nowrap;
    }
    .link-btn:hover{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.30);
      transform: translateY(-1px);
    }
    .link-btn:active{transform: translateY(0px); filter: brightness(.98)}

    .del-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(239,68,68,.22);
      background: rgba(239,68,68,.06);
      color: var(--danger);
      font-size: 12.5px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
      white-space: nowrap;
    }
    .del-btn:hover{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.30);
      transform: translateY(-1px);
    }
    .del-btn:active{transform: translateY(0px); filter: brightness(.98)}

    /* ===== Loading ===== */
    .loading-placeholder{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height: 300px;
      background:
        radial-gradient(500px 250px at 40% 0%, rgba(37,99,235,.08), transparent 65%),
        linear-gradient(180deg, #F8FAFC, #F1F5F9);
      color: var(--muted);
      gap: 14px;
    }
    .spinner{
      width: 44px;
      height: 44px;
      border: 3px solid rgba(100,116,139,.22);
      border-top-color: rgba(37,99,235,.85);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
      background: rgba(255,255,255,.65);
    }
    @keyframes spin{100%{transform:rotate(360deg)}}

    /* ===== 登录弹窗 ===== */
    #loginLayer{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.18);
      z-index: 999;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(14px);
      animation: fadeIn .18s ease-out;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .loginBox{
      width: 340px;
      padding: 26px 22px 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 22px;
      text-align:center;
      box-shadow: var(--shadow-2);
      position: relative;
      overflow:hidden;
      transform: translateY(0);
    }

    .loginBox::before{
      content:"";
      position:absolute;
      inset:-2px -2px auto -2px;
      height: 110px;
      background: radial-gradient(700px 120px at 50% 0%, rgba(37,99,235,.20), transparent 60%);
      pointer-events:none;
    }

    .loginBox h3{
      margin: 2px 0 16px;
      color: #0B1220;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .loginBox input{
      text-align:center;
      margin-bottom: 12px;
      height: 46px;
      border-radius: 14px;
      background: rgba(248,250,252,.9);
    }
    .loginBox input:last-of-type{margin-bottom: 18px}

    #loginMsg{
      margin-top: 10px;
      font-size: 12px;
      color: var(--danger);
      min-height: 16px;
    }

    /* ===== 图片预览弹窗（Lightbox） ===== */
    .viewer{
      position:fixed; inset:0;
      z-index: 2000;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
    }
    .viewer-backdrop{
      position:absolute; inset:0;
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(10px);
    }
    .viewer-panel{
      position:relative;
      width: min(980px, 92vw);
      max-height: 86vh;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(10px);
    }
    .viewer-img{
      display:block;
      width:100%;
      height:auto;
      max-height: 76vh;
      object-fit: contain;
      background: #0B1220;
    }
    .viewer-bar{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      padding: 12px 12px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(248,250,252,.9), rgba(255,255,255,.96));
    }
    .viewer-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 32px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.04);
      color: var(--text);
      font-weight: 800;
      font-size: 12.5px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      white-space: nowrap;
    }
    .viewer-btn:hover{
      background: rgba(15,23,42,.06);
      border-color: rgba(15,23,42,.18);
      transform: translateY(-1px);
    }
    .viewer-btn:active{ transform: translateY(0px); filter: brightness(.98) }
    .viewer-btn.primary{
      border-color: rgba(37,99,235,.22);
      background: rgba(37,99,235,.08);
      color: var(--brand);
    }

    /* 降低动效偏好 */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important; scroll-behavior:auto !important;}
    }

    /* 深色模式：依然克制 */
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0B1220;
        --card: rgba(15,23,42,.72);
        --line: rgba(148,163,184,.18);
        --line-strong: rgba(148,163,184,.26);
        --text:#E5E7EB;
        --muted:#A3B2C7;
        --input-bg: rgba(2,6,23,.35);
        --shadow-sm: 0 10px 30px rgba(0,0,0,.35);
        --shadow: 0 18px 60px rgba(0,0,0,.40);
        --shadow-2: 0 25px 90px rgba(0,0,0,.50);
      }

      body{
        background:
          radial-gradient(1200px 700px at 15% -10%, rgba(37,99,235,.22), transparent 55%),
          radial-gradient(900px 600px at 100% 0%, rgba(99,102,241,.16), transparent 50%),
          linear-gradient(180deg, #0B1220, #0A1020);
      }

      .head{
        background: rgba(15,23,42,.55);
        border-color: var(--line);
      }

      .card{background: rgba(15,23,42,.62)}
      .hist-card{background: rgba(15,23,42,.62)}
      .hist-meta{background: linear-gradient(180deg, rgba(2,6,23,.25), rgba(15,23,42,.35))}
      .upload-box{background: rgba(2,6,23,.25)}
      input,select,textarea{color: var(--text)}
      select{
        background-image:
          linear-gradient(45deg, transparent 50%, rgba(226,232,240,.65) 50%),
          linear-gradient(135deg, rgba(226,232,240,.65) 50%, transparent 50%),
          linear-gradient(to right, transparent, transparent);
      }
      #loginLayer{background: rgba(2,6,23,.55)}
      .loginBox{background: rgba(15,23,42,.78); border-color: rgba(148,163,184,.18)}
      .logo{box-shadow: 0 18px 40px rgba(37, 99, 235, 0.20)}

      .viewer-panel{
        background: rgba(15,23,42,.78);
        border-color: rgba(148,163,184,.18);
      }
      .viewer-bar{
        background: linear-gradient(180deg, rgba(2,6,23,.25), rgba(15,23,42,.35));
        border-top-color: rgba(148,163,184,.18);
      }
      .viewer-btn{
        border-color: rgba(148,163,184,.18);
        background: rgba(148,163,184,.08);
        color: var(--text);
      }
      .viewer-btn.primary{
        border-color: rgba(37,99,235,.28);
        background: rgba(37,99,235,.16);
        color: #BFDBFE;
      }
    }
  </style>
</head>

<body>
<div id="loginLayer">
  <div class="loginBox">
    <h3>欢迎回来</h3>
    <input id="u_name" type="text" placeholder="账号" />
    <input id="u_pass" type="password" placeholder="密码" />
    <button class="btn" id="btnLogin">立即登录</button>
    <div id="loginMsg"></div>
  </div>
</div>

<div class="wrap">
  <div class="head">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>AI 绘图工作台</b>
        <span id="welcomeText">未登录</span>
      </div>
    </div>
    <div style="text-align:right">
      <div id="logoutBtn">退出</div>
    </div>
  </div>

  <div class="card">
    <div class="settings-grid">
      <div class="control-item">
        <label>生成模型</label>
        <select id="modelSelect">
          <option value="gemini-3-pro-image-preview">NanoBanana Pro</option>
          <option value="gemini-2.5-flash-image-preview">NanoBanana</option>
        </select>
      </div>

      <div class="control-item">
        <label>画面比例</label>
        <select id="ratio">
          <option value="1:1">1:1 (正方形)</option>
          <option value="16:9" selected>16:9 (横屏)</option>
          <option value="9:16">9:16 (竖屏)</option>
          <option value="4:3">4:3</option>
          <option value="3:4">3:4</option>
        </select>
      </div>

      <div class="control-item">
        <label>分辨率</label>
        <select id="res">
          <option value="1K">标准 (1K)</option>
          <option value="2K">高清 (2K)</option>
          <option value="4K" selected>超清 (4K)</option>
        </select>
      </div>

      <div class="control-item">
        <label>参考图片 (可选)</label>
        <div class="upload-box">
          <input id="fileInput" type="file" accept="image/*" multiple style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer;" />
          <span>+ 上传图片 (Max 9)</span>
        </div>
      </div>
    </div>

    <div id="refGrid" class="ref-grid" style="display:none"></div>

    <div class="control-item" style="margin-top:16px;">
      <label>创意描述 (Prompt)</label>
      <textarea id="prompt" placeholder="在此输入画面描述，例如：阳光下的向日葵花海，吉卜力画风，色彩鲜艳..."></textarea>
    </div>

    <button class="btn" id="gen">开始生成图片</button>
  </div>

  <div class="history-section">
    <div class="history-head">
      <span style="font-size:16px; font-weight:900; color:var(--text)">生成结果 & 历史</span>
      <span id="clearHistory">清空记录</span>
    </div>
    <div id="historyList"></div>
  </div>
</div>

<!-- 图片预览弹窗（不新开页面） -->
<div id="imgViewer" class="viewer" aria-hidden="true">
  <div class="viewer-backdrop"></div>
  <div class="viewer-panel" role="dialog" aria-modal="true">
    <img id="viewerImg" class="viewer-img" alt="预览图">
    <div class="viewer-bar">
      <a id="viewerDownload" class="viewer-btn primary" download>下载</a>
      <span id="viewerClose" class="viewer-btn">关闭</span>
    </div>
  </div>
</div>

<script>
(() => {
  // ================= 配置区 =================
  const USERS_DB = {
      "xliu2090": {
          pwd: "123456kk",
          key: "sk-ZA5sEkC0iK2huymcy99ZshEmS1eUVWkbSZkMdni8Tz8WeQGX",
          limit: 50
      }
  };
  const BASE_URL = "https://api.vectorengine.ai/v1beta/models/";
  // =========================================

  let currentUser = null;
  let refImages = [];
  const $ = (id) => document.getElementById(id);
  const el = {
    model: $("modelSelect"),
    ratio: $("ratio"),
    res: $("res"),
    fileInput: $("fileInput"),
    refGrid: $("refGrid"), prompt: $("prompt"), gen: $("gen"),
    historyList: $("historyList"),
    loginLayer: $("loginLayer"), u_name: $("u_name"), u_pass: $("u_pass"),
    btnLogin: $("btnLogin"), loginMsg: $("loginMsg"),
    welcomeText: $("welcomeText"),
    logoutBtn: $("logoutBtn"),
    clearHistory: $("clearHistory")
  };

  // ===== 图片预览弹窗（Lightbox） =====
  const viewer = {
    layer: document.getElementById("imgViewer"),
    img: document.getElementById("viewerImg"),
    close: document.getElementById("viewerClose"),
    download: document.getElementById("viewerDownload"),
    backdrop: document.querySelector("#imgViewer .viewer-backdrop"),
  };

  function openViewer(url, filename) {
    viewer.img.src = url;
    viewer.download.href = url;
    viewer.download.download = filename || "image.png";
    viewer.layer.style.display = "flex";
    viewer.layer.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }

  function closeViewer() {
    viewer.layer.style.display = "none";
    viewer.layer.setAttribute("aria-hidden", "true");
    viewer.img.src = "";
    document.body.style.overflow = "";
  }

  viewer.close.onclick = closeViewer;
  viewer.backdrop.onclick = closeViewer;
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && viewer.layer.style.display === "flex") closeViewer();
  });

  // --- 模型切换时的分辨率限制逻辑 ---
  el.model.onchange = () => {
      const isFlash = el.model.value.includes("flash");
      const opts = el.res.options;

      if (isFlash) {
          el.res.value = "1K";
          opts[1].disabled = true;
          opts[2].disabled = true;
          opts[1].text = "高清 (2K) - 仅 Pro 可用";
          opts[2].text = "超清 (4K) - 仅 Pro 可用";
      } else {
          opts[1].disabled = false;
          opts[2].disabled = false;
          opts[1].text = "高清 (2K)";
          opts[2].text = "超清 (4K)";
      }
  };
  el.model.onchange();

  // --- IndexedDB ---
  const DB_NAME = "AI_Art_Light";
  const STORE_NAME = "imgs";
  let dbInstance = null;

  function initDB() {
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
    };
    request.onsuccess = (e) => {
        dbInstance = e.target.result;
        loadHistory();
    };
  }

  function saveToDB(blob, meta) {
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    const item = { id: Date.now(), blob: blob, meta: meta, date: new Date().toLocaleString() };
    tx.objectStore(STORE_NAME).add(item);
  }

  function deleteItem(id, dom) {
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).delete(id);
    tx.oncomplete = () => dom.remove();
  }

  function clearAllDB() {
    if(!confirm("确认清空所有历史图片？")) return;
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).clear();
    tx.oncomplete = () => el.historyList.innerHTML = "";
  }

  function loadHistory() {
    if (!dbInstance) return;
    el.historyList.innerHTML = "";
    const tx = dbInstance.transaction([STORE_NAME], "readonly");
    const req = tx.objectStore(STORE_NAME).getAll();
    req.onsuccess = () => {
      const items = req.result.sort((a, b) => b.id - a.id);
      items.forEach(item => renderItem(item, null));
    };
  }

  function renderItem(item, replaceElem) {
    const url = URL.createObjectURL(item.blob);

    const html = `
      <img src="${url}" class="gen-img" />
      <div class="hist-meta">
        <div class="meta-info">
            <span class="meta-title">${item.meta}</span>
            <span class="meta-res">读取分辨率...</span>
        </div>
        <div class="actions-group">
            <span class="link-btn open-btn" role="button" tabindex="0">打开</span>
            <a href="${url}" download="img_${item.id}.png" class="link-btn">下载</a>
            <span class="del-btn">删除</span>
        </div>
      </div>
    `;

    const attachLogic = (container) => {
        const img = container.querySelector(".gen-img");
        const resSpan = container.querySelector(".meta-res");
        const delBtn = container.querySelector(".del-btn");
        const openBtn = container.querySelector(".open-btn");

        const updateRes = () => {
             resSpan.textContent = `${img.naturalWidth} × ${img.naturalHeight} px`;
        };

        if (img.complete) updateRes();
        else img.onload = updateRes;

        // 点击图片本身：弹窗预览（不新开页面）
        img.onclick = () => openViewer(url, `img_${item.id}.png`);

        // 点击“打开”：弹窗预览（修复“没反应”）
        openBtn.onclick = () => openViewer(url, `img_${item.id}.png`);
        openBtn.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " ") openViewer(url, `img_${item.id}.png`);
        };

        delBtn.onclick = () => deleteItem(item.id, container);
    };

    if (replaceElem) {
        replaceElem.innerHTML = html;
        attachLogic(replaceElem);
    } else {
        const div = document.createElement("div");
        div.className = "hist-card";
        div.innerHTML = html;
        attachLogic(div);
        el.historyList.appendChild(div);
    }
  }

  // --- Logic ---
  function updateUserInfo() {
    if (!currentUser) return;
    el.welcomeText.textContent = currentUser;
  }

  el.btnLogin.onclick = () => {
      const u = el.u_name.value.trim();
      const p = el.u_pass.value.trim();
      if (USERS_DB[u] && USERS_DB[u].pwd === p) {
          currentUser = u;
          el.loginLayer.style.display = "none";
          updateUserInfo();
          initDB();
      } else {
          el.loginMsg.textContent = "账号或密码错误";
      }
  };

  el.logoutBtn.onclick = () => location.reload();

  el.fileInput.onchange = async () => {
    const files = Array.from(el.fileInput.files);
    if (!files.length) return;
    if (refImages.length + files.length > 9) return alert("最多9张");

    for (const f of files) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const b64 = e.target.result.split(',')[1];
            const mime = e.target.result.match(/:(.*?);/)[1];
            refImages.push({ mime, b64, url: e.target.result });
            renderRef();
        };
        reader.readAsDataURL(f);
    }
    el.fileInput.value = "";
  };

  function renderRef() {
      el.refGrid.style.display = refImages.length ? "grid" : "none";
      el.refGrid.innerHTML = refImages.map((img, i) => `
        <div class="ref-item">
            <img src="${img.url}">
            <div class="ref-del" onclick="removeRef(${i})">×</div>
        </div>
      `).join('');
  }
  window.removeRef = (i) => { refImages.splice(i, 1); renderRef(); };

  el.clearHistory.onclick = clearAllDB;

  el.gen.onclick = async () => {
    if (!currentUser) return;
    const prompt = el.prompt.value.trim();
    if (!prompt) return alert("请输入提示词");

    const used = parseInt(localStorage.getItem("used_" + currentUser) || "0");
    if (used >= USERS_DB[currentUser].limit) return alert("额度已用完");

    // 1. Loading 占位
    const loadingCard = document.createElement("div");
    loadingCard.className = "hist-card";
    loadingCard.innerHTML = `
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <div>AI 正在绘制中...</div>
        </div>
    `;
    el.historyList.prepend(loadingCard);

    el.gen.disabled = true;
    el.gen.textContent = "生成中...";

    const parts = [{ text: prompt }];
    refImages.forEach(img => parts.push({ inlineData: { mimeType: img.mime, data: img.b64 } }));

    const currentModelId = el.model.value;
    const finalUrl = `${BASE_URL}${currentModelId}:generateContent`;

    try {
        const resp = await fetch(finalUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + USERS_DB[currentUser].key },
            body: JSON.stringify({
                contents: [{ parts }],
                generationConfig: { imageConfig: { aspectRatio: el.ratio.value, imageSize: el.res.value } }
            })
        });

        const json = await resp.json();

        let imgData = null;
        if (json.candidates) {
            for (let p of json.candidates[0].content.parts) {
                if (p.inlineData) { imgData = p.inlineData; break; }
            }
        }

        if (!imgData) throw new Error("生成失败，请调整提示词重试");

        const binary = atob(imgData.data);
        const array = new Uint8Array(binary.length);
        for(let i=0; i<binary.length; i++) array[i] = binary.charCodeAt(i);
        const blob = new Blob([array], {type: imgData.mimeType});

        const modelName = el.model.options[el.model.selectedIndex].text;
        const meta = `${modelName} · ${el.ratio.value}`;

        // 2. 替换为真图
        const item = { id: Date.now(), blob: blob, meta: meta };
        renderItem(item, loadingCard);

        saveToDB(blob, meta);
        localStorage.setItem("used_" + currentUser, used + 1);
        updateUserInfo();

    } catch (e) {
        loadingCard.remove();
        alert(e.message);
    } finally {
        el.gen.disabled = false;
        el.gen.textContent = "开始生成图片";
    }
  };
})();
</script>
</body>
</html>
