<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI 绘图系统</title>
  <style>
    :root{
      --bg: #F6F7FB;
      --card:#FFFFFF;
      --line: rgba(17, 24, 39, 0.10);
      --line-strong: rgba(17, 24, 39, 0.14);

      --text:#0F172A;
      --muted:#64748B;

      --brand:#2563EB;
      --brand-2:#1D4ED8;
      --brand-soft: rgba(37, 99, 235, 0.12);

      --danger:#EF4444;

      --radius:18px;
      --radius-sm:12px;

      --input-bg:#F8FAFC;

      --shadow-sm: 0 2px 10px rgba(2, 6, 23, 0.06);
      --shadow: 0 12px 30px rgba(2, 6, 23, 0.08);
      --shadow-2: 0 18px 50px rgba(2, 6, 23, 0.10);

      --ring: 0 0 0 4px var(--brand-soft);

      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(900px 600px at 100% 0%, rgba(99,102,241,.08), transparent 50%),
        linear-gradient(180deg, var(--bg), #F7F8FC);
    }

    a{color:inherit}
    ::selection{background: rgba(37, 99, 235, .18)}

    .wrap{
      max-width: 780px;
      margin: 0 auto;
      padding: 28px 16px 72px;
    }

    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px;
      margin-bottom: 18px;

      background: rgba(255,255,255,.70);
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 2px);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }

    .logo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1D4ED8, #2563EB);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.22);
      position: relative;
      overflow: hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:-40% -40% auto auto;
      width: 120%;
      height: 120%;
      transform: rotate(18deg);
      background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.25), rgba(255,255,255,.0));
      opacity: .8;
    }

    .title{min-width:0}
    .title b{
      display:block;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #0B1220;
      line-height: 1.15;
    }
    .title span{
      display:block;
      margin-top: 4px;
      font-size: 12.5px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 48vw;
    }

    #logoutBtn{
      font-size: 12.5px;
      color: var(--muted);
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      user-select:none;
    }
    #logoutBtn:hover{
      background: rgba(15, 23, 42, 0.04);
      border-color: var(--line);
      color: #0F172A;
    }
    #logoutBtn:active{transform: translateY(1px)}

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .settings-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    @media (max-width: 560px){
      .settings-grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .wrap{padding-top: 18px}
      .head{padding: 12px}
      .card{padding: 16px}
    }

    .control-item{
      display:flex;
      flex-direction:column;
      gap: 7px;
      min-width: 0;
    }

    .control-item label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
    }

    input, select, textarea{
      width:100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--input-bg);
      color: var(--text);
      padding: 0 12px;
      height: 44px;
      font-size: 14px;
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .05s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    }

    select{
      appearance:none;
      padding-right: 40px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(15,23,42,.55) 50%),
        linear-gradient(135deg, rgba(15,23,42,.55) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) 18px,
        calc(100% - 13px) 18px,
        0 0;
      background-size:
        5px 5px,
        5px 5px,
        100% 100%;
      background-repeat:no-repeat;
    }

    textarea{
      height:auto;
      min-height: 92px;
      padding: 12px;
      resize: vertical;
      line-height: 1.55;
    }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.65);
      background: #fff;
      box-shadow: var(--ring);
    }

    input::placeholder, textarea::placeholder{color: rgba(100,116,139,.85)}

    option:disabled{
      color: #94A3B8;
      font-style: italic;
    }

    .btn{
      border:none;
      border-radius: 12px;
      padding: 0 18px;
      height: 48px;
      font-weight: 800;
      cursor:pointer;
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      color:#fff;
      font-size: 15px;
      width: 100%;
      margin-top: 18px;
      box-shadow:
        0 14px 30px rgba(37, 99, 235, 0.18),
        0 2px 0 rgba(255,255,255,.18) inset;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease, opacity .2s ease;
      letter-spacing: .2px;
    }
    .btn:hover{
      filter: brightness(1.02);
      box-shadow:
        0 18px 36px rgba(37, 99, 235, 0.20),
        0 2px 0 rgba(255,255,255,.18) inset;
      transform: translateY(-1px);
    }
    .btn:active{
      transform: translateY(0px) scale(0.99);
      opacity: .95;
    }

    .upload-box{
      position:relative;
      width:100%;
      height:44px;
      border: 1px dashed rgba(100,116,139,.35);
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      background: rgba(248,250,252,.85);
      cursor: pointer;
      transition: border-color .2s ease, background .2s ease, color .2s ease, transform .08s ease;
      user-select:none;
    }
    .upload-box:hover{
      border-color: rgba(37,99,235,.55);
      color: var(--brand);
      background: #fff;
      transform: translateY(-1px);
    }
    .upload-box span{font-weight: 700; letter-spacing: .1px;}

    .ref-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .ref-item{
      position:relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #F1F5F9;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .ref-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(2,6,23,.08);
    }
    .ref-item img{width:100%; height:100%; object-fit: cover; display:block; cursor:pointer;}
    .ref-del{
      position:absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(255,255,255,.92);
      color: var(--danger);
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(2,6,23,.10);
      border: 1px solid rgba(2,6,23,.08);
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
    }
    .ref-del:hover{filter: brightness(.98); transform: scale(1.05)}
    .ref-del:active{transform: scale(.98)}

    .history-section{margin-top: 34px;}
    .history-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 14px;
      padding: 0 4px 10px;
      border-bottom: 1px solid var(--line);
    }
    #clearHistory{
      font-size: 13px;
      color: var(--muted);
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      user-select:none;
    }
    #clearHistory:hover{
      background: rgba(15, 23, 42, 0.04);
      border-color: var(--line);
      color: #0F172A;
    }
    #clearHistory:active{transform: translateY(1px)}

    .hist-card{
      background: rgba(255,255,255,.95);
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid var(--line);
      margin-bottom: 18px;
      box-shadow: 0 2px 10px rgba(2,6,23,.06);
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      animation: slideIn 0.25s ease-out;
    }
    .hist-card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--line-strong);
    }
    @keyframes slideIn{
      from { opacity:0; transform: translateY(8px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .hist-card img.main-img{
      width:100%;
      display:block;
      background: #F8FAFC;
      min-height: 220px;
      object-fit: contain;
      cursor:pointer;
    }

    /* 折叠区 */
    .hist-details{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      background: rgba(248,250,252,.70);
      display:none;
    }
    .hist-card[data-expanded="1"] .hist-details{ display:block; }

    .prompt-label{
      font-size: 11px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .prompt-text{
      margin:0;
      font-size: 12.5px;
      color: var(--text);
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .ref-mini-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(54px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .ref-mini{
      aspect-ratio: 1;
      border-radius: 10px;
      overflow:hidden;
      border: 1px solid var(--line);
      background: #F1F5F9;
      box-shadow: 0 8px 16px rgba(2,6,23,.06);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .ref-mini:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(2,6,23,.08);
    }
    .ref-mini img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    .hist-meta{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(248,250,252,.9), rgba(255,255,255,.96));
    }
    .meta-info{display:flex; flex-direction:column; gap: 3px; min-width:0;}
    .meta-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .meta-res{
      font-size: 11px;
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: .2px;
    }

    .actions-group{display:flex; gap: 10px; align-items:center; flex-shrink:0; flex-wrap:wrap;}

    .link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(37,99,235,.22);
      background: rgba(37,99,235,.06);
      color: var(--brand);
      text-decoration:none;
      font-weight: 800;
      font-size: 12.5px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
      white-space: nowrap;
    }
    .link-btn:hover{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.30);
      transform: translateY(-1px);
    }
    .link-btn:active{transform: translateY(0px); filter: brightness(.98)}

    .toggle-btn{
      border-color: rgba(100,116,139,.22);
      background: rgba(100,116,139,.08);
      color: var(--muted);
      font-weight: 900;
    }
    .toggle-btn:hover{
      background: rgba(100,116,139,.12);
      border-color: rgba(100,116,139,.30);
    }

    .del-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid rgba(239,68,68,.22);
      background: rgba(239,68,68,.06);
      color: var(--danger);
      font-size: 12.5px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
      white-space: nowrap;
    }
    .del-btn:hover{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.30);
      transform: translateY(-1px);
    }
    .del-btn:active{transform: translateY(0px); filter: brightness(.98)}

    .loading-placeholder{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      min-height: 260px;
      background:
        radial-gradient(500px 250px at 40% 0%, rgba(37,99,235,.08), transparent 65%),
        linear-gradient(180deg, #F8FAFC, #F1F5F9);
      color: var(--muted);
      gap: 12px;
      text-align:center;
    }
    .spinner{
      width: 44px;
      height: 44px;
      border: 3px solid rgba(100,116,139,.22);
      border-top-color: rgba(37,99,235,.85);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
      background: rgba(255,255,255,.65);
    }
    @keyframes spin{100%{transform:rotate(360deg)}}

    /* 任务栏 */
    .task-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(248,250,252,.70);
      color: var(--muted);
      font-size: 12.5px;
    }
    .task-badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-weight: 900;
      color: var(--text);
      min-width: 0;
    }
    .task-dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(37,99,235,.85);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
      flex: 0 0 auto;
    }
    .task-actions{
      display:flex;
      gap: 8px;
      align-items:center;
      flex: 0 0 auto;
    }
    .tiny-btn{
      height: 30px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.8);
      color: var(--muted);
      font-weight: 900;
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease, background .2s ease;
      user-select:none;
      white-space: nowrap;
    }
    .tiny-btn:hover{transform: translateY(-1px); filter: brightness(1.01); background:#fff;}
    .tiny-btn:active{transform: translateY(0px); filter: brightness(.98)}
    .tiny-danger{
      border-color: rgba(239,68,68,.20);
      background: rgba(239,68,68,.06);
      color: #B91C1C;
    }
    .tiny-danger:hover{background: rgba(239,68,68,.10)}
    .loading-sub{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 800;
      flex-wrap: wrap;
      justify-content:center;
    }
    .sub-note{
      font-size: 12px;
      color: var(--muted);
      opacity:.95;
      text-align:center;
      padding: 0 18px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    #loginLayer{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.18);
      z-index: 999;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(14px);
      animation: fadeIn .18s ease-out;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .loginBox{
      width: 340px;
      padding: 26px 22px 22px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 22px;
      text-align:center;
      box-shadow: var(--shadow-2);
      position: relative;
      overflow:hidden;
      transform: translateY(0);
    }

    .loginBox::before{
      content:"";
      position:absolute;
      inset:-2px -2px auto -2px;
      height: 110px;
      background: radial-gradient(700px 120px at 50% 0%, rgba(37,99,235,.20), transparent 60%);
      pointer-events:none;
    }

    .loginBox h3{
      margin: 2px 0 16px;
      color: #0B1220;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .loginBox input[type="text"],
    .loginBox input[type="password"] {
      text-align:center;
      margin-bottom: 12px;
      height: 46px;
      border-radius: 14px;
      background: rgba(248,250,252,.9);
    }
    .loginBox input[type="password"] {margin-bottom: 18px}

    .remember-box {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      margin-bottom: 4px;
      padding-left: 4px;
    }
    #rememberMe {
      width: 16px;
      height: 16px;
      margin: 0 6px 0 0;
      box-shadow: none;
      background: transparent;
      border-color: var(--line-strong);
    }
    .remember-box label {
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }

    #loginMsg{
      margin-top: 10px;
      font-size: 12px;
      color: var(--danger);
      min-height: 16px;
    }

    /* 自定义模型区域 */
    .custom-panel{
      display:none;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(248,250,252,.75);
      padding: 12px;
      gap: 10px;
    }
    .custom-row{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .custom-row > *{flex:1}
    .small-btn{
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(37,99,235,.22);
      background: rgba(37,99,235,.08);
      color: var(--brand);
      font-weight: 900;
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease;
    }
    .small-btn:hover{transform: translateY(-1px); filter: brightness(1.02)}
    .small-btn:active{transform: translateY(0px); filter: brightness(.98)}
    .pill-list{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
      font-size: 12px;
      color: var(--muted);
    }
    .pill b{color: var(--text)}
    .pill .x{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color: var(--danger);
      border: 1px solid rgba(239,68,68,.18);
      background: rgba(239,68,68,.06);
      font-weight: 900;
      user-select:none;
    }
    .pill .x:hover{filter: brightness(.98)}
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 6px;
    }

    .error-box{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(239,68,68,.22);
      background: rgba(239,68,68,.06);
      color: #991B1B;
      font-size: 12.5px;
      line-height: 1.5;
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important; scroll-behavior:auto !important;}
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0B1220;
        --card: rgba(15,23,42,.72);
        --line: rgba(148,163,184,.18);
        --line-strong: rgba(148,163,184,.26);
        --text:#E5E7EB;
        --muted:#A3B2C7;
        --input-bg: rgba(2,6,23,.35);
        --shadow-sm: 0 10px 30px rgba(0,0,0,.35);
        --shadow: 0 18px 60px rgba(0,0,0,.40);
        --shadow-2: 0 25px 90px rgba(0,0,0,.50);
      }

      body{
        background:
          radial-gradient(1200px 700px at 15% -10%, rgba(37,99,235,.22), transparent 55%),
          radial-gradient(900px 600px at 100% 0%, rgba(99,102,241,.16), transparent 50%),
          linear-gradient(180deg, #0B1220, #0A1020);
      }

      .head{
        background: rgba(15,23,42,.55);
        border-color: var(--line);
      }

      .card{background: rgba(15,23,42,.62)}
      .hist-card{background: rgba(15,23,42,.62)}
      .hist-details{background: rgba(2,6,23,.18)}
      .hist-meta{background: linear-gradient(180deg, rgba(2,6,23,.25), rgba(15,23,42,.35))}
      .upload-box{background: rgba(2,6,23,.25)}
      input,select,textarea{color: var(--text)}
      select{
        background-image:
          linear-gradient(45deg, transparent 50%, rgba(226,232,240,.65) 50%),
          linear-gradient(135deg, rgba(226,232,240,.65) 50%, transparent 50%),
          linear-gradient(to right, transparent, transparent);
      }
      #loginLayer{background: rgba(2,6,23,.55)}
      .loginBox{background: rgba(15,23,42,.78); border-color: rgba(148,163,184,.18)}
      .logo{box-shadow: 0 18px 40px rgba(37, 99, 235, 0.20)}
      .custom-panel{
        background: rgba(2,6,23,.20);
        border-color: rgba(148,163,184,.18);
      }
      .pill{background: rgba(15,23,42,.65)}
      .error-box{
        color: #FCA5A5;
        border-color: rgba(239,68,68,.22);
        background: rgba(239,68,68,.10);
      }
      .task-bar{
        background: rgba(2,6,23,.18);
        border-color: rgba(148,163,184,.18);
      }
      .tiny-btn{background: rgba(15,23,42,.5); border-color: rgba(148,163,184,.18); color: var(--muted);}
      .tiny-btn:hover{background: rgba(15,23,42,.75)}
      .toggle-btn{
        border-color: rgba(148,163,184,.18);
        background: rgba(148,163,184,.10);
        color: var(--muted);
      }
    }
  </style>
</head>

<body>
<div id="loginLayer">
  <div class="loginBox">
    <h3>欢迎回来</h3>
    <input id="u_name" type="text" placeholder="账号" />
    <input id="u_pass" type="password" placeholder="密码" />

    <div class="remember-box">
      <input type="checkbox" id="rememberMe">
      <label for="rememberMe">记住账号密码 </label>
    </div>

    <button class="btn" id="btnLogin">立即登录</button>
    <div id="loginMsg"></div>
  </div>
</div>

<div class="wrap">
  <div class="head">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>AI 绘图工作台</b>
        <span id="welcomeText">未登录</span>
      </div>
    </div>
    <div style="text-align:right">
      <div id="logoutBtn">退出</div>
    </div>
  </div>

  <div class="card">
    <div class="settings-grid">
      <div class="control-item">
        <label>生成模型</label>
        <select id="modelSelect">
          <option value="gemini-3-pro-image-preview">NanoBanana Pro</option>
          <option value="gemini-2.5-flash-image">NanoBanana（Flash）</option>
          <option value="__custom__">自定义...</option>
        </select>
      </div>

      <div class="control-item">
        <label>画面比例</label>
        <select id="ratio">
          <option value="1:1">1:1 (正方形)</option>
          <option value="16:9" selected>16:9 (横屏)</option>
          <option value="21:9">21:9 (超宽屏)</option>
          <option value="9:16">9:16 (竖屏)</option>
          <option value="4:3">4:3</option>
          <option value="3:4">3:4</option>
        </select>
      </div>

      <div class="control-item">
        <label>分辨率</label>
        <select id="res">
          <option value="1K">标准 (1K)</option>
          <option value="2K">高清 (2K)</option>
          <option value="4K" selected>超清 (4K)</option>
        </select>
      </div>

      <div class="control-item">
        <label>参考图片 (可选)</label>
        <div class="upload-box">
          <input id="fileInput" type="file" accept="image/*" multiple style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer;" />
          <span>+ 上传图片（无限制，注意手机内存）</span>
        </div>
      </div>

      <div class="control-item" style="grid-column: 1 / -1;">
        <div id="customPanel" class="custom-panel">
          <div class="custom-row">
            <div style="flex:1.2">
              <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--muted); font-weight:800;">自定义模型ID</label>
              <input id="customModelId" placeholder='例如：gemini-2.5-flash-image 或你服务端支持的模型ID' />
            </div>
            <div style="flex:1">
              <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--muted); font-weight:800;">显示名称（可选）</label>
              <input id="customModelName" placeholder="例如：我的模型A" />
            </div>
          </div>
          <div class="custom-row" style="margin-top:10px;">
            <button id="btnAddModel" class="small-btn" style="flex:0.5">添加到列表</button>
            <button id="btnUseTempModel" class="small-btn" style="flex:0.5">仅本次使用</button>
          </div>
          <div class="hint">
            说明：<b>添加到列表</b> 会保存到浏览器本地（localStorage），刷新仍可用。<br/>
            能力判断：若模型ID包含 <code>flash</code> 将按 Flash 规则限制（例如参考图≤3、分辨率仅 1K）——这里不再强制限制，只做提示。
          </div>
          <div id="customList" class="pill-list"></div>
        </div>
      </div>
    </div>

    <div id="refGrid" class="ref-grid" style="display:none"></div>

    <div class="control-item" style="margin-top:16px;">
      <label>创意描述 (Prompt)</label>
      <textarea id="prompt" placeholder="在此输入画面描述，例如：阳光下的向日葵花海，吉卜力画风，色彩鲜艳..."></textarea>
    </div>

    <button class="btn" id="gen">开始生成图片</button>

    <div class="task-bar" id="taskBar" style="display:none;">
      <div class="task-badge" style="min-width:0;">
        <span class="task-dot"></span>
        <span id="taskCount" style="white-space:nowrap;">进行中：0</span>
        <span id="bgHint" style="font-weight:700; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          · 后台会自动恢复
        </span>
      </div>
      <div class="task-actions">
        <span id="autoSaveHint">参数已自动保存</span>
        <button id="cancelAll" class="tiny-btn tiny-danger">取消全部</button>
      </div>
    </div>

    <div id="errorBox" class="error-box"></div>
  </div>

  <div class="history-section">
    <div class="history-head">
      <span style="font-size:16px; font-weight:900; color:var(--text)">生成结果 & 历史</span>
      <span id="clearHistory">清空记录</span>
    </div>
    <div id="historyList"></div>
  </div>
</div>

<script>
(() => {
  // ================= 配置区 =================
  const USERS_DB = {
      "xliu2090": {
          pwd: "123456kk",
          key: "sk-j9fvH2UVUYyuWMUskDzyTQZdmx92zxruPudu6rxreA7ZEuEt"
      }
  };
  const BASE_URL = "https://api.vectorengine.ai/v1beta/models/";
  // =========================================

  let currentUser = null;
  let refImages = []; // { mime, blob, url }
  let dbInstance = null;

  // 多任务：任务管理
  let inFlight = 0;
  const tasks = new Map(); // taskId -> { controller, card }
  let wakeLock = null;

  const $ = (id) => document.getElementById(id);
  const el = {
    model: $("modelSelect"),
    ratio: $("ratio"),
    res: $("res"),
    fileInput: $("fileInput"),
    refGrid: $("refGrid"),
    prompt: $("prompt"),
    gen: $("gen"),
    historyList: $("historyList"),
    loginLayer: $("loginLayer"),
    u_name: $("u_name"),
    u_pass: $("u_pass"),
    btnLogin: $("btnLogin"),
    loginMsg: $("loginMsg"),
    rememberMe: $("rememberMe"),
    welcomeText: $("welcomeText"),
    logoutBtn: $("logoutBtn"),
    clearHistory: $("clearHistory"),
    customPanel: $("customPanel"),
    customModelId: $("customModelId"),
    customModelName: $("customModelName"),
    btnAddModel: $("btnAddModel"),
    btnUseTempModel: $("btnUseTempModel"),
    customList: $("customList"),
    errorBox: $("errorBox"),
    taskBar: $("taskBar"),
    taskCount: $("taskCount"),
    autoSaveHint: $("autoSaveHint"),
    cancelAll: $("cancelAll"),
    bgHint: $("bgHint"),
  };

  // ===== IndexedDB =====
  const DB_NAME = "AI_Art_Light";
  const DB_VER = 2;
  const STORE_IMGS = "imgs";
  const STORE_TASKS = "tasks";

  let dbReadyResolve, dbReadyReject;
  const dbReady = new Promise((res, rej) => { dbReadyResolve = res; dbReadyReject = rej; });

  function initDB() {
    const request = indexedDB.open(DB_NAME, DB_VER);
    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_IMGS)) db.createObjectStore(STORE_IMGS, { keyPath: "id" });
      if (!db.objectStoreNames.contains(STORE_TASKS)) {
        const s = db.createObjectStore(STORE_TASKS, { keyPath: "taskId" });
        try { s.createIndex("byUser", "user", { unique: false }); } catch {}
      }
    };
    request.onsuccess = (e) => {
      dbInstance = e.target.result;
      dbReadyResolve(true);
      loadHistory();
    };
    request.onerror = () => {
      dbReadyReject(request.error);
      showError("IndexedDB 初始化失败，历史/后台恢复功能不可用。");
    };
  }

  function idbTx(storeName, mode="readonly") {
    if (!dbInstance) throw new Error("DB not ready");
    return dbInstance.transaction([storeName], mode).objectStore(storeName);
  }

  function saveToDB(blob, record) {
    // record: { meta, prompt, refs, date? }
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_IMGS], "readwrite");
    const item = {
      id: Date.now(),
      blob,
      meta: record?.meta || "",
      prompt: record?.prompt || "",
      refs: Array.isArray(record?.refs) ? record.refs : [],
      date: record?.date || new Date().toLocaleString()
    };
    tx.objectStore(STORE_IMGS).add(item);
  }

  function deleteItem(id, dom) {
    if (!dbInstance) return;
    const tx = dbInstance.transaction([STORE_IMGS], "readwrite");
    tx.objectStore(STORE_IMGS).delete(id);
    tx.oncomplete = () => {
      cleanupCardUrls(dom);
      dom.remove();
    };
  }

  function clearAllDB() {
    if(!confirm("确认清空所有历史图片？")) return;
    if (!dbInstance) return;

    const cards = Array.from(el.historyList.querySelectorAll(".hist-card"));
    cards.forEach(c => cleanupCardUrls(c));

    const tx = dbInstance.transaction([STORE_IMGS], "readwrite");
    tx.objectStore(STORE_IMGS).clear();
    tx.oncomplete = () => { el.historyList.innerHTML = ""; };
  }

  function loadHistory() {
    if (!dbInstance) return;
    el.historyList.innerHTML = "";
    const tx = dbInstance.transaction([STORE_IMGS], "readonly");
    const req = tx.objectStore(STORE_IMGS).getAll();
    req.onsuccess = () => {
      const items = (req.result || []).sort((a, b) => b.id - a.id);
      items.forEach(item => renderHistoryItem(item, null));
    };
  }

  // tasks store
  function putTask(taskRecord) {
    if (!dbInstance) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const store = idbTx(STORE_TASKS, "readwrite");
      const req = store.put(taskRecord);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  function delTask(taskId) {
    if (!dbInstance) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const store = idbTx(STORE_TASKS, "readwrite");
      const req = store.delete(taskId);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  function getAllTasksByUser(user) {
    if (!dbInstance) return Promise.resolve([]);
    return new Promise((resolve) => {
      const store = idbTx(STORE_TASKS, "readonly");
      let req;
      try {
        const idx = store.index("byUser");
        req = idx.getAll(user);
      } catch {
        req = store.getAll();
      }
      req.onsuccess = () => {
        const all = req.result || [];
        resolve(all.filter(x => x && x.user === user));
      };
      req.onerror = () => resolve([]);
    });
  }

  // ===== 工具 =====
  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function showError(msg) {
    el.errorBox.style.display = "block";
    el.errorBox.textContent = msg;
  }

  function clearError() {
    el.errorBox.style.display = "none";
    el.errorBox.textContent = "";
  }

  function openImageInNewTab(src) {
    try {
      window.open(src, "_blank", "noopener");
    } catch {
      // fallback
      const a = document.createElement("a");
      a.href = src;
      a.target = "_blank";
      a.rel = "noopener";
      a.click();
    }
  }

  // ===== URL 管理（避免长时间占用内存）=====
  function registerUrl(card, url) {
    if (!card) return;
    if (!card._objectUrls) card._objectUrls = [];
    card._objectUrls.push(url);
  }
  function cleanupCardUrls(card) {
    try {
      const arr = card?._objectUrls || [];
      arr.forEach(u => { try { URL.revokeObjectURL(u); } catch {} });
      if (card) card._objectUrls = [];
    } catch {}
  }

  // ===== refs 懒加载（展开时才生成缩略图）=====
  function ensureRefsRendered(card, refs, targetEl) {
    if (!targetEl) return;
    if (targetEl.dataset.rendered === "1") return;
    targetEl.dataset.rendered = "1";

    if (!Array.isArray(refs) || refs.length === 0) {
      targetEl.innerHTML = "";
      return;
    }

    const grid = document.createElement("div");
    grid.className = "ref-mini-grid";

    refs.forEach((r, idx) => {
      const u = URL.createObjectURL(r.blob);
      registerUrl(card, u);

      const box = document.createElement("div");
      box.className = "ref-mini";
      box.title = "点击单独打开";

      const im = document.createElement("img");
      im.src = u;
      im.alt = "ref_" + idx;

      box.appendChild(im);
      box.onclick = () => openImageInNewTab(u);

      grid.appendChild(box);
    });

    targetEl.appendChild(grid);
  }

  function setCardExpanded(card, expanded, toggleBtn, refs, refsHolder) {
    card.dataset.expanded = expanded ? "1" : "0";
    if (toggleBtn) toggleBtn.textContent = expanded ? "收起" : "查看Prompt/参考图";
    if (expanded) ensureRefsRendered(card, refs, refsHolder);
  }

  // ===== History 卡片（成品图点击：单独打开；Prompt/参考图默认折叠）=====
  function renderHistoryItem(item, replaceElem) {
    const container = replaceElem || document.createElement("div");
    container.className = "hist-card";
    container.dataset.expanded = "0";

    // 若复用旧卡片，先清理旧 URL
    cleanupCardUrls(container);

    const mainUrl = URL.createObjectURL(item.blob);
    registerUrl(container, mainUrl);

    const metaLine = item.meta || "生成结果";
    const promptText = item.prompt ? String(item.prompt) : "(无 Prompt)";
    const refs = Array.isArray(item.refs) ? item.refs : [];
    const dateText = item.date || "";

    container.innerHTML = `
      <img src="${mainUrl}" class="main-img" alt="generated" />
      <div class="hist-meta">
        <div class="meta-info">
          <span class="meta-title">${escapeHtml(metaLine)}</span>
          <span class="meta-res">读取分辨率...</span>
        </div>
        <div class="actions-group">
          <button class="link-btn toggle-btn" data-toggle="1">查看Prompt/参考图</button>
          <a href="${mainUrl}" target="_blank" rel="noopener" class="link-btn">打开</a>
          <a href="${mainUrl}" download="img_${item.id || Date.now()}.png" class="link-btn">下载</a>
          <span class="del-btn" data-del="1">删除</span>
        </div>
      </div>
      <div class="hist-details">
        <div class="prompt-label">
          <span>Prompt</span>
          <span style="font-weight:800; color: var(--muted); font-size:11px;">${escapeHtml(dateText)}</span>
        </div>
        <p class="prompt-text">${escapeHtml(promptText)}</p>
        <div class="refs-holder" data-rendered="0"></div>
      </div>
    `;

    // 分辨率
    const img = container.querySelector("img.main-img");
    const resSpan = container.querySelector(".meta-res");
    const toggleBtn = container.querySelector('[data-toggle="1"]');
    const delBtn = container.querySelector('[data-del="1"]');
    const refsHolder = container.querySelector(".refs-holder");

    const updateRes = () => { resSpan.textContent = `${img.naturalWidth} × ${img.naturalHeight} px`; };
    if (img.complete) updateRes(); else img.onload = updateRes;

    // ✅ 成品图点击：单独打开（不卡）
    img.onclick = () => openImageInNewTab(mainUrl);

    // ✅ 默认折叠，点按钮展开
    toggleBtn.onclick = () => {
      const expanded = container.dataset.expanded === "1";
      setCardExpanded(container, !expanded, toggleBtn, refs, refsHolder);
    };

    // 删除
    delBtn.onclick = () => deleteItem(item.id, container);

    if (!replaceElem) el.historyList.appendChild(container);
  }

  // ===== 任务卡（生成中/失败：也带折叠区；refs 懒加载）=====
  function createTaskCard(rec, statusText, subText, showRetry) {
    const card = document.createElement("div");
    card.className = "hist-card";
    card.dataset.taskId = String(rec.taskId);
    card.dataset.expanded = "0";

    cleanupCardUrls(card);

    const promptText = rec.prompt ? String(rec.prompt) : "(无 Prompt)";
    const refs = Array.isArray(rec.refs) ? rec.refs : [];

    card.innerHTML = `
      <div class="loading-placeholder">
        <div class="spinner"></div>
        <div class="loading-sub">
          <span>${escapeHtml(statusText)}</span>
          <button class="tiny-btn tiny-danger" data-cancel="1">取消</button>
          ${showRetry ? `<button class="tiny-btn" data-retry="1">立即重试</button>` : ``}
        </div>
        <div class="sub-note">${escapeHtml(subText || "")}</div>
      </div>

      <div class="hist-meta">
        <div class="meta-info">
          <span class="meta-title">${escapeHtml(rec.modelName || "模型")} · ${escapeHtml(rec.ratio || "")} · ${escapeHtml(rec.res || "")}</span>
          <span class="meta-res">${escapeHtml(showRetry ? "失败" : "进行中...")}</span>
        </div>
        <div class="actions-group">
          <button class="link-btn toggle-btn" data-toggle="1">查看Prompt/参考图</button>
          <span class="del-btn" data-cancel="2">删除任务</span>
        </div>
      </div>

      <div class="hist-details">
        <div class="prompt-label">
          <span>Prompt</span>
          <span style="font-weight:800; color: var(--muted); font-size:11px;">${showRetry ? "失败" : "任务中"}</span>
        </div>
        <p class="prompt-text">${escapeHtml(promptText)}</p>
        <div class="refs-holder" data-rendered="0"></div>
      </div>
    `;

    const toggleBtn = card.querySelector('[data-toggle="1"]');
    const refsHolder = card.querySelector(".refs-holder");

    toggleBtn.onclick = () => {
      const expanded = card.dataset.expanded === "1";
      setCardExpanded(card, !expanded, toggleBtn, refs, refsHolder);
    };

    return card;
  }

  function cancelOneTask(taskId, card) {
    const t = tasks.get(taskId);
    if (t) { try { t.controller.abort(); } catch {} }

    try { cleanupCardUrls(card); card.remove(); } catch {}
    tasks.delete(taskId);
    delTask(taskId).catch(()=>{});

    inFlight = Math.max(0, inFlight - 1);
    updateTaskBar();

    showError("已取消该任务。");
    setTimeout(clearError, 900);
  }

  function cancelAllTasks() {
    for (const [taskId, t] of tasks.entries()) {
      try { t.controller.abort(); } catch {}
      try { cleanupCardUrls(t.card); t.card.remove(); } catch {}
      tasks.delete(taskId);
      delTask(taskId).catch(()=>{});
    }
    inFlight = 0;
    updateTaskBar();
    showError("已取消全部进行中的任务。");
    setTimeout(clearError, 1200);
  }
  el.cancelAll.onclick = cancelAllTasks;

  // ===== 自定义模型：保存/加载 =====
  const LS_CUSTOM_MODELS = "ai_art_custom_models_v1";
  function loadCustomModels() {
    try {
      const raw = localStorage.getItem(LS_CUSTOM_MODELS);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function saveCustomModels(list) {
    localStorage.setItem(LS_CUSTOM_MODELS, JSON.stringify(list || []));
  }
  function refreshModelSelect() {
    const selected = el.model.value;

    const builtins = [
      { id: "gemini-3-pro-image-preview", name: "NanoBanana Pro" },
      { id: "gemini-2.5-flash-image", name: "NanoBanana（Flash）" },
    ];

    el.model.innerHTML = "";
    builtins.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      el.model.appendChild(opt);
    });

    const customs = loadCustomModels();
    if (customs.length) {
      const sep = document.createElement("option");
      sep.disabled = true;
      sep.textContent = "──────── 自定义模型 ────────";
      el.model.appendChild(sep);

      customs.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.name ? `${m.name} (${m.id})` : m.id;
        el.model.appendChild(opt);
      });
    }

    const optCustom = document.createElement("option");
    optCustom.value = "__custom__";
    optCustom.textContent = "自定义...";
    el.model.appendChild(optCustom);

    const allValues = Array.from(el.model.options).map(o => o.value);
    if (allValues.includes(selected)) el.model.value = selected;
    else el.model.value = builtins[0].id;
  }
  function refreshCustomPills() {
    const customs = loadCustomModels();
    el.customList.innerHTML = customs.map(m => `
      <div class="pill" title="${escapeHtml(m.id)}">
        <b>${escapeHtml(m.name || "未命名")}</b>
        <span>${escapeHtml(m.id)}</span>
        <span class="x" data-id="${escapeHtml(m.id)}">×</span>
      </div>
    `).join("");

    el.customList.querySelectorAll(".x").forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute("data-id");
        let list = loadCustomModels();
        list = list.filter(x => x.id !== id);
        saveCustomModels(list);
        refreshModelSelect();
        refreshCustomPills();
        saveSettingsDebounced();
      };
    });
  }

  function normalizeModelId(id) { return String(id || "").trim(); }
  function isFlashModel(modelId) { return String(modelId || "").toLowerCase().includes("flash"); }

  function applyResLimitByModel(modelId) {
    const opts = el.res.options;
    opts[1].disabled = false;
    opts[2].disabled = false;
    opts[1].text = "高清 (2K)";
    opts[2].text = "超清 (4K)";
  }

  function getSelectedModelId() {
    if (el.model.value === "__custom__") return normalizeModelId(el.customModelId.value);
    return el.model.value;
  }

  function getSelectedModelName(modelId) {
    if (el.model.value === "__custom__") {
      const n = String(el.customModelName.value || "").trim();
      return n || "自定义模型";
    }
    const opt = el.model.options[el.model.selectedIndex];
    return opt ? opt.textContent : (modelId || "模型");
  }

  function toggleCustomPanel() {
    const on = el.model.value === "__custom__";
    el.customPanel.style.display = on ? "block" : "none";
    const modelId = getSelectedModelId();
    if (modelId) applyResLimitByModel(modelId);
  }

  // ===== 自动保存/恢复上次参数（按账号）=====
  const LS_SETTINGS_PREFIX = "ai_art_last_settings_v4_";
  function getSettingsKey() { return currentUser ? (LS_SETTINGS_PREFIX + currentUser) : null; }
  function safeJsonParse(raw, fallback) { try { return raw ? JSON.parse(raw) : fallback; } catch { return fallback; } }
  function getAllModelValues() { return Array.from(el.model.options).map(o => o.value); }

  function saveSettings() {
    if (!currentUser) return;
    const key = getSettingsKey();
    if (!key) return;

    const modelId = getSelectedModelId();
    const data = {
      modelId: modelId || "",
      modelSelectValue: el.model.value || "",
      ratio: el.ratio.value || "16:9",
      res: el.res.value || "4K",
      customModelId: el.customModelId.value || "",
      customModelName: el.customModelName.value || "",
      savedAt: Date.now()
    };
    localStorage.setItem(key, JSON.stringify(data));
    el.autoSaveHint.textContent = "参数已自动保存";
  }

  let saveTimer = null;
  function saveSettingsDebounced(delay = 250) {
    if (!currentUser) return;
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => saveSettings(), delay);
  }

  function loadSettings() {
    if (!currentUser) return;
    const key = getSettingsKey();
    const raw = key ? localStorage.getItem(key) : null;
    const data = safeJsonParse(raw, null);
    if (!data) return;

    refreshModelSelect();

    el.customModelId.value = data.customModelId || "";
    el.customModelName.value = data.customModelName || "";

    const values = getAllModelValues();
    if (data.modelId && values.includes(data.modelId)) {
      el.model.value = data.modelId;
    } else if (data.modelSelectValue === "__custom__" || (data.modelId && !values.includes(data.modelId))) {
      el.model.value = "__custom__";
      if (data.modelId) el.customModelId.value = data.modelId;
    } else if (data.modelSelectValue && values.includes(data.modelSelectValue)) {
      el.model.value = data.modelSelectValue;
    }

    if (data.ratio) el.ratio.value = data.ratio;
    if (data.res) el.res.value = data.res;

    toggleCustomPanel();
    const modelId = getSelectedModelId();
    if (modelId) applyResLimitByModel(modelId);

    saveSettingsDebounced(10);
  }

  // ===== 参考图上传（点击单独打开）=====
  el.fileInput.onchange = async () => {
    clearError();
    const files = Array.from(el.fileInput.files);
    if (!files.length) return;

    for (const f of files) {
      const url = URL.createObjectURL(f);
      refImages.push({ mime: f.type || "image/png", blob: f, url });
    }
    renderRefGrid();
    el.fileInput.value = "";
  };

  function renderRefGrid() {
    el.refGrid.style.display = refImages.length ? "grid" : "none";
    el.refGrid.innerHTML = "";

    refImages.forEach((img, i) => {
      const box = document.createElement("div");
      box.className = "ref-item";

      const im = document.createElement("img");
      im.src = img.url;
      im.alt = "ref";
      im.title = "点击单独打开";
      im.onclick = () => openImageInNewTab(img.url);

      const del = document.createElement("div");
      del.className = "ref-del";
      del.textContent = "×";
      del.onclick = (e) => {
        e.stopPropagation();
        try { URL.revokeObjectURL(refImages[i]?.url); } catch {}
        refImages.splice(i, 1);
        renderRefGrid();
      };

      box.appendChild(im);
      box.appendChild(del);
      el.refGrid.appendChild(box);
    });
  }

  // ===== API 解析 =====
  function extractImageFromResponse(json) {
    const candidates = json?.candidates || [];
    for (const c of candidates) {
      const parts = c?.content?.parts || [];
      for (const p of parts) {
        if (p?.inlineData?.data) return p.inlineData;
      }
    }
    return null;
  }
  function extractTextFromResponse(json) {
    const candidates = json?.candidates || [];
    for (const c of candidates) {
      const parts = c?.content?.parts || [];
      for (const p of parts) {
        if (typeof p?.text === "string" && p.text.trim()) return p.text.trim();
      }
    }
    return "";
  }
  function getFinishReason(json) {
    const fr = json?.candidates?.[0]?.finishReason;
    return fr ? String(fr) : "";
  }
  function base64ToBlob(b64, mimeType) {
    const binary = atob(b64);
    const array = new Uint8Array(binary.length);
    for(let i=0; i<binary.length; i++) array[i] = binary.charCodeAt(i);
    return new Blob([array], {type: mimeType || "image/png"});
  }
  function blobToBase64Data(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const dataUrl = String(reader.result || "");
          const b64 = dataUrl.split(",")[1] || "";
          resolve(b64);
        } catch (e) { reject(e); }
      };
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(blob);
    });
  }

  // ===== 任务栏/后台提示/Wake Lock =====
  function updateUserInfo() {
    if (!currentUser) return;
    el.welcomeText.textContent = `${currentUser} · 多任务进行中 ${inFlight}`;
  }
  function updateBgHint() {
    if (!currentUser) return;
    if (document.visibilityState === "hidden") el.bgHint.textContent = "· 已后台：回来会自动恢复";
    else el.bgHint.textContent = "· 后台会自动恢复";
  }
  function updateTaskBar() {
    if (!currentUser) { el.taskBar.style.display = "none"; return; }
    el.taskBar.style.display = "flex";
    el.taskCount.textContent = `进行中：${inFlight}`;
    updateUserInfo();
    updateWakeLock();
  }
  async function updateWakeLock() {
    const can = ("wakeLock" in navigator);
    if (!can) return;

    if (document.visibilityState === "visible" && inFlight > 0) {
      try {
        if (!wakeLock) {
          wakeLock = await navigator.wakeLock.request("screen");
          wakeLock.addEventListener("release", () => { wakeLock = null; });
        }
      } catch {}
    } else {
      try {
        if (wakeLock) { await wakeLock.release(); wakeLock = null; }
      } catch {}
    }
  }

  // ===== 执行任务 =====
  async function runTaskFromRecord(rec, card) {
    if (!currentUser) return;
    clearError();

    if (tasks.has(rec.taskId)) return;

    const controller = new AbortController();
    tasks.set(rec.taskId, { controller, card });

    inFlight += 1;
    updateTaskBar();

    const cancelBtn1 = card.querySelector('[data-cancel="1"]');
    const cancelBtn2 = card.querySelector('[data-cancel="2"]');
    if (cancelBtn1) cancelBtn1.onclick = () => cancelOneTask(rec.taskId, card);
    if (cancelBtn2) cancelBtn2.onclick = () => cancelOneTask(rec.taskId, card);

    const parts = [{ text: rec.prompt }];
    const refs = Array.isArray(rec.refs) ? rec.refs : [];
    for (const r of refs) {
      const b64 = await blobToBase64Data(r.blob);
      parts.push({ inlineData: { mimeType: r.mime, data: b64 } });
    }

    const finalUrl = `${BASE_URL}${rec.modelId}:generateContent`;
    const payload = {
      contents: [{ parts }],
      generationConfig: {
        responseModalities: ["IMAGE"],
        candidateCount: 1,
        imageConfig: { aspectRatio: rec.ratio, imageSize: rec.res }
      }
    };

    const fetchOnce = async (useKeepAlive) => {
      return fetch(finalUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + USERS_DB[currentUser].key
        },
        signal: controller.signal,
        keepalive: !!useKeepAlive,
        body: JSON.stringify(payload)
      });
    };

    try {
      let resp;
      try { resp = await fetchOnce(refs.length === 0); }
      catch { resp = await fetchOnce(false); }

      let json = null;
      try { json = await resp.json(); }
      catch {
        const text = await resp.text().catch(() => "");
        throw new Error(`接口返回非 JSON。HTTP ${resp.status}. ${text ? "返回内容：" + text.slice(0, 300) : ""}`);
      }

      if (!resp.ok) {
        const msg = json?.error?.message || JSON.stringify(json);
        throw new Error(`HTTP ${resp.status}：${msg}`);
      }

      const imgData = extractImageFromResponse(json);
      if (!imgData) {
        const txt = extractTextFromResponse(json);
        const fr = getFinishReason(json);
        const hint = [
          "未返回图片。",
          fr ? `finishReason=${fr}` : "",
          txt ? `模型返回文字：${txt}` : "",
          "提示：手机切后台可能会中断网络；任务已保存，回来会自动恢复/可点“立即重试”。"
        ].filter(Boolean).join("\n");
        throw new Error(hint);
      }

      const blob = base64ToBlob(imgData.data, imgData.mimeType);
      const meta = `${rec.modelName} · ${rec.ratio} · ${rec.res}`;
      const dateStr = new Date().toLocaleString();

      // 替换为历史卡（默认折叠）
      const item = {
        id: Date.now(),
        blob,
        meta,
        prompt: rec.prompt,
        refs: rec.refs || [],
        date: dateStr,
      };
      renderHistoryItem(item, card);

      // 保存历史（含 prompt + refs）
      saveToDB(blob, { meta, prompt: rec.prompt, refs: rec.refs || [], date: dateStr });

      // 删除任务记录
      await delTask(rec.taskId).catch(()=>{});

    } catch (e) {
      if (e && (e.name === "AbortError" || String(e).includes("AbortError"))) {
        // cancelled
      } else {
        const msg = (e && e.message) ? e.message : String(e);

        // 失败卡：可重试 + 折叠区
        cleanupCardUrls(card);
        const failCard = createTaskCard(rec, "任务失败（已保留，可自动恢复）", msg, true);
        card.replaceWith(failCard);
        card = failCard;

        const cancelBtn1 = card.querySelector('[data-cancel="1"]');
        const cancelBtn2 = card.querySelector('[data-cancel="2"]');
        const retryBtn = card.querySelector('[data-retry="1"]');

        if (cancelBtn1) cancelBtn1.onclick = () => cancelOneTask(rec.taskId, card);
        if (cancelBtn2) cancelBtn2.onclick = () => cancelOneTask(rec.taskId, card);
        if (retryBtn) retryBtn.onclick = () => {
          const newCard = createTaskCard(rec, "恢复任务中...", "正在重试请求…", false);
          card.replaceWith(newCard);
          runTaskFromRecord(rec, newCard).catch(()=>{});
        };

        showError("任务失败但已保存：回到前台/刷新会自动继续（必要时重试）。");
        setTimeout(clearError, 1800);
      }
    } finally {
      tasks.delete(rec.taskId);
      inFlight = Math.max(0, inFlight - 1);
      updateTaskBar();
    }
  }

  // ===== 发起新任务 =====
  async function startNewTask() {
    clearError();
    if (!currentUser) return;

    const prompt = el.prompt.value.trim();
    if (!prompt) return showError("请输入提示词。");

    saveSettingsDebounced(10);
    try { await dbReady; } catch {}

    const modelId = getSelectedModelId();
    if (!modelId) return showError("请选择或输入有效的模型ID。");

    if (isFlashModel(modelId) && refImages.length > 3) {
      showError("提示：当前模型像 Flash 类型，参考图过多/高分辨率可能不稳定。已继续提交任务。");
      setTimeout(clearError, 1600);
    }

    const ratioSnap = el.ratio.value;
    const resSnap = el.res.value;
    const modelNameSnap = getSelectedModelName(modelId);
    const refsSnap = refImages.map(x => ({ mime: x.mime, blob: x.blob }));

    const taskId = Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    const taskRecord = {
      taskId,
      user: currentUser,
      createdAt: Date.now(),
      modelId,
      modelName: modelNameSnap,
      ratio: ratioSnap,
      res: resSnap,
      prompt,
      refs: refsSnap
    };

    await putTask(taskRecord).catch(()=>{});

    const card = createTaskCard(
      taskRecord,
      "绘制中...",
      "手机进入后台/锁屏可能会暂停网络。\n任务已保存：回来后会自动继续（必要时自动重试），不会丢失。",
      false
    );
    el.historyList.prepend(card);

    // ✅ 生成后清空 prompt
    el.prompt.value = "";

    runTaskFromRecord(taskRecord, card).catch(()=>{});
  }
  el.gen.onclick = startNewTask;

  // ===== 恢复未完成任务 =====
  async function resumePendingTasks() {
    if (!currentUser) return;
    try { await dbReady; } catch {}

    const pending = await getAllTasksByUser(currentUser);
    if (!pending.length) return;

    for (const rec of pending) {
      if (!rec || !rec.taskId) continue;
      if (tasks.has(rec.taskId)) continue;

      const card = createTaskCard(rec, "恢复任务中...", "正在继续之前的请求…", false);
      el.historyList.prepend(card);
      runTaskFromRecord(rec, card).catch(() => {});
    }
  }

  document.addEventListener("visibilitychange", () => {
    updateBgHint();
    if (document.visibilityState === "visible") resumePendingTasks();
    updateWakeLock();
  });
  window.addEventListener("pageshow", () => {
    updateBgHint();
    resumePendingTasks();
    updateWakeLock();
  });

  // ===== 登录记住密码 =====
  const LS_USER = "ai_art_user";
  const LS_PASS = "ai_art_pass";
  const savedUser = localStorage.getItem(LS_USER);
  const savedPass = localStorage.getItem(LS_PASS);
  if (savedUser && savedPass) {
    el.u_name.value = savedUser;
    el.u_pass.value = savedPass;
    el.rememberMe.checked = true;
  }

  el.btnLogin.onclick = () => {
    const u = el.u_name.value.trim();
    const p = el.u_pass.value.trim();

    if (USERS_DB[u] && USERS_DB[u].pwd === p) {
      currentUser = u;

      if (el.rememberMe.checked) {
        localStorage.setItem(LS_USER, u);
        localStorage.setItem(LS_PASS, p);
      } else {
        localStorage.removeItem(LS_USER);
        localStorage.removeItem(LS_PASS);
      }

      el.loginLayer.style.display = "none";
      el.loginMsg.textContent = "";

      refreshModelSelect();
      refreshCustomPills();
      toggleCustomPanel();
      applyResLimitByModel(getSelectedModelId());

      updateUserInfo();
      updateBgHint();
      updateTaskBar();

      initDB();

      dbReady.then(() => {
        loadHistory();
        loadSettings();
        saveSettingsDebounced(10);
        resumePendingTasks();
      }).catch(()=>{});

    } else {
      el.loginMsg.textContent = "账号或密码错误";
    }
  };

  // ===== 退出 / 清空历史 =====
  el.logoutBtn.onclick = () => location.reload();
  el.clearHistory.onclick = clearAllDB;

  // ===== 自动保存：绑定变更事件 =====
  function bindAutoSave() {
    const onQuick = () => saveSettingsDebounced(10);
    el.model.addEventListener("change", onQuick);
    el.ratio.addEventListener("change", onQuick);
    el.res.addEventListener("change", onQuick);

    el.customModelId.addEventListener("input", () => saveSettingsDebounced(350));
    el.customModelName.addEventListener("input", () => saveSettingsDebounced(350));
  }
  bindAutoSave();

  el.model.onchange = () => {
    toggleCustomPanel();
    const modelId = getSelectedModelId();
    if (modelId) applyResLimitByModel(modelId);
    saveSettingsDebounced(10);
  };

  // ===== 自定义模型按钮 =====
  el.btnAddModel.onclick = () => {
    clearError();
    const id = normalizeModelId(el.customModelId.value);
    const name = String(el.customModelName.value || "").trim();

    if (!id) return showError("请输入自定义模型ID。");
    if (id.includes(" ")) return showError("模型ID 不能包含空格。");

    let list = loadCustomModels();
    if (list.some(x => x.id === id)) return showError("该模型ID已存在于列表。");

    list.push({ id, name: name || "自定义模型" });
    saveCustomModels(list);

    refreshModelSelect();
    refreshCustomPills();

    el.model.value = id;
    toggleCustomPanel();
    applyResLimitByModel(id);

    saveSettingsDebounced(10);
  };

  el.btnUseTempModel.onclick = () => {
    clearError();
    const id = normalizeModelId(el.customModelId.value);
    if (!id) return showError("请输入自定义模型ID。");
    if (id.includes(" ")) return showError("模型ID 不能包含空格。");

    el.model.value = "__custom__";
    toggleCustomPanel();
    applyResLimitByModel(id);

    saveSettingsDebounced(10);

    showError("已设置“仅本次使用”的模型ID。点击生成即可。");
    setTimeout(clearError, 1800);
  };

  // ===== 取消全部 =====
  el.cancelAll.onclick = cancelAllTasks;

  // ===== 初始化显示 =====
  updateBgHint();
})();
</script>
</body>
</html>
