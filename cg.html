<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>Mobile AI Chat Client (å•æ–‡ä»¶)</title>

  <!-- PWA Manifest (data URL, single-file) -->
  <link id="manifestLink" rel="manifest" href="" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='180' height='180' rx='40' fill='%23111827'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='92' fill='%23ffffff'%3EAI%3C/text%3E%3C/svg%3E" />

  <style>
    :root{
      --bg: #0b1020;
      --bg2:#0f172a;
      --card:#111827;
      --card2:#0b1224;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --muted2:#6b7280;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --accent:#5b8cff;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;

      --radius: 16px;
      --radius2: 22px;
      --tap: 44px;

      --fontScale: 1;
      --kb: 0px;          /* keyboard offset from visualViewport */
      --composerH: 120px; /* dynamic measured composer height */
    }

    [data-theme="light"]{
      --bg:#f6f7fb;
      --bg2:#eef2ff;
      --card:#ffffff;
      --card2:#f8fafc;
      --fg:#0f172a;
      --muted:#475569;
      --muted2:#64748b;
      --border: rgba(2,6,23,.12);
      --shadow: 0 10px 25px rgba(2,6,23,.10);
    }

    html,body{
      height:100%;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Noto Sans CJK SC", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      font-size: calc(16px * var(--fontScale));
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overscroll-behavior: none;
    }
    body{ margin:0; }
    * { box-sizing: border-box; }
    button, input, textarea, select { font: inherit; color: inherit; }
    a{ color: var(--accent); text-decoration: none; }
    a:active{ opacity:.8; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    /* âœ… å…³é”®ï¼šç”¨ dvh é€‚é…ç§»åŠ¨ç«¯åœ°å€æ /åº•æ å˜åŒ– */
    #app{
      height: 100vh;
      height: 100dvh;
      display:flex;
      flex-direction:column;
      padding-top: env(safe-area-inset-top);
      background: linear-gradient(180deg, var(--bg2), var(--bg));
    }

    .topbar{
      position: sticky;
      top: env(safe-area-inset-top);
      z-index: 20;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      padding-left: max(12px, env(safe-area-inset-left));
      padding-right: max(12px, env(safe-area-inset-right));
      background: color-mix(in oklab, var(--card) 85%, transparent);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .topbar .left, .topbar .right{ display:flex; align-items:center; gap:8px; }
    .topbar .titleWrap{
      flex:1; min-width: 0;
      display:flex; flex-direction:column;
      align-items:center; gap:2px;
    }
    .topbar .title{
      font-weight: 650;
      letter-spacing: .2px;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
    }
    .topbar .subtitle{
      font-size:.78em;
      color: var(--muted);
      max-width:100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
    }

    .iconBtn{
      width: var(--tap);
      height: var(--tap);
      border:0;
      border-radius: 999px;
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .iconBtn:active{
      background: color-mix(in oklab, var(--accent) 16%, transparent);
      transform: translateY(1px);
    }
    .icon{ font-size: 20px; line-height: 1; opacity: .95; }

    .main{
      position:relative;
      flex:1;
      min-height:0; /* âœ… å…³é”®ï¼šè®©å†…éƒ¨æ»šåŠ¨åŒºåŸŸæ­£å¸¸å·¥ä½œ */
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .messages{
      flex:1;
      overflow:auto;
      padding: 14px 12px;
      padding-left: max(12px, env(safe-area-inset-left));
      padding-right: max(12px, env(safe-area-inset-right));
      /* âœ… å…³é”®ï¼šåº•éƒ¨ç•™å‡º composer + é”®ç›˜ç©ºé—´ï¼Œé¿å…é®æŒ¡/ç‚¹ä¸åˆ° */
      padding-bottom: calc(var(--composerH) + 14px + var(--kb));
      scroll-behavior:smooth;
    }

    .dayline{
      text-align:center;
      margin: 10px 0 14px;
      color: var(--muted2);
      font-size:.82em;
    }

    .msg{
      display:flex;
      flex-direction:column;
      margin: 10px 0;
      gap: 6px;
      max-width: 100%;
      position: relative;
    }
    .msgRow{ display:flex; gap: 10px; }
    .msg.ai .msgRow{ justify-content:flex-start; }
    .msg.user .msgRow{ justify-content:flex-end; }

    .bubble{
      max-width: 92%;
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      padding: 10px 12px;
      box-shadow: var(--shadow);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }
    .msg.user .bubble{
      background: color-mix(in oklab, var(--accent) 22%, var(--card) 78%);
      border-color: color-mix(in oklab, var(--accent) 35%, var(--border));
    }
    .msg.ai .bubble{ background: color-mix(in oklab, var(--card) 94%, transparent); }
    .bubble:active{ filter: brightness(1.02); }

    .meta{
      font-size:.78em;
      color: var(--muted2);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: flex-end;
    }
    .msg.ai .meta{ justify-content:flex-start; }
    .pill{
      border:1px solid var(--border);
      padding: 3px 8px;
      border-radius: 999px;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      white-space:nowrap;
    }

    /* âœ… é»˜è®¤ä¸æ˜¾ç¤ºæŒ‰é’®ï¼Œç‚¹å‡»æ¶ˆæ¯æ‰æ˜¾ç¤º */
    .actionsRow{ display:none; gap: 6px; margin-top: -2px; flex-wrap:wrap; }
    .msg.showActions .actionsRow{ display:flex; }
    .actBtn{
      min-width: 44px;
      height: 36px;
      padding: 0 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--card) 90%, transparent);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .actBtn:active{
      transform: translateY(1px);
      background: color-mix(in oklab, var(--accent) 18%, var(--card) 82%);
    }
    .actBtn.danger{
      border-color: color-mix(in oklab, var(--danger) 45%, var(--border));
      color: color-mix(in oklab, var(--danger) 85%, var(--fg));
    }

    /* âœ… Composerï¼šå›ºå®šåœ¨åº•éƒ¨ + éšé”®ç›˜æŠ¬èµ· */
    .composer{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 30; /* âœ… ä¿è¯ä¸ä¼šè¢«æ¶ˆæ¯è¦†ç›–å¯¼è‡´ç‚¹ä¸åˆ° */
      transform: translateY(calc(-1 * var(--kb)));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      padding-left: max(10px, env(safe-area-inset-left));
      padding-right: max(10px, env(safe-area-inset-right));
      background: color-mix(in oklab, var(--card) 88%, transparent);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
    }
    .composerInner{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .modelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modelChip{
      height: 36px;
      max-width: 100%;
      border-radius: 999px;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 0 12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .modelChip:active{
      transform: translateY(1px);
      background: color-mix(in oklab, var(--accent) 14%, var(--card2) 86%);
    }
    .modelChipText{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 70vw;
    }
    .composerRow{
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }

    .inputWrap{
      flex:1;
      position:relative;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      box-shadow: 0 8px 20px rgba(0,0,0,.12);
      overflow:hidden;
    }
    textarea{
      width:100%;
      min-height: 44px;
      max-height: 160px;
      resize:none;
      border:0;
      outline:none;
      padding: 10px 12px;
      background: transparent;
      color: var(--fg);
      line-height: 1.35;
    }
    textarea::placeholder{ color: var(--muted2); }
    .hintLine{
      font-size:.78em;
      color: var(--muted2);
      padding: 0 12px 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .hintLine .leftHint{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .hintLine .rightHint{ white-space:nowrap; }

    .sendBtn, .stopBtn{ position:relative; z-index: 2; } /* âœ… è¿›ä¸€æ­¥ä¿è¯å¯ç‚¹ */
    .sendBtn{
      width: var(--tap);
      height: var(--tap);
      border-radius: 16px;
      border: 1px solid color-mix(in oklab, var(--accent) 40%, var(--border));
      background: color-mix(in oklab, var(--accent) 30%, var(--card) 70%);
      box-shadow: var(--shadow);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      flex: 0 0 auto;
    }
    .sendBtn:active{ transform: translateY(1px); filter: brightness(1.03); }
    .sendBtn[disabled]{ opacity:.45; filter:saturate(.7); }

    .stopBtn{
      width: var(--tap);
      height: var(--tap);
      border-radius: 16px;
      border: 1px solid color-mix(in oklab, var(--danger) 40%, var(--border));
      background: color-mix(in oklab, var(--danger) 18%, var(--card) 82%);
      box-shadow: var(--shadow);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      display:none;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      flex: 0 0 auto;
    }
    .stopBtn.show{ display:flex; }

    /* Sidebar */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 50;
    }
    .backdrop.show{ opacity: 1; pointer-events:auto; }

    .sidebar{
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: min(86vw, 340px);
      transform: translateX(-102%);
      transition: transform .22s ease;
      z-index: 60;
      padding-top: env(safe-area-inset-top);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      border-right: 1px solid var(--border);
      backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
    }
    .sidebar.show{ transform: translateX(0); }

    .sideHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .sideHeader .sideTitle{ font-weight: 700; }
    .sideBody{ overflow:auto; padding: 10px; flex:1; }
    .sessionItem{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: color-mix(in oklab, var(--card2) 94%, transparent);
      padding: 10px 10px;
      margin-bottom: 10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .sessionItem:active{
      transform: translateY(1px);
      background: color-mix(in oklab, var(--accent) 12%, var(--card2) 88%);
    }
    .sessionItem.active{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
      background: color-mix(in oklab, var(--accent) 12%, var(--card2) 88%);
    }
    .sessionTitle{
      font-weight: 650;
      margin-bottom: 4px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
    }
    .sessionMeta{
      font-size:.78em;
      color: var(--muted2);
      display:flex;
      justify-content:space-between;
      gap: 8px;
    }
    .sideFooter{
      padding: 10px;
      border-top: 1px solid var(--border);
      display:flex;
      gap: 10px;
    }
    .primaryBtn{
      flex:1;
      height: 44px;
      border-radius: 14px;
      border: 1px solid color-mix(in oklab, var(--accent) 45%, var(--border));
      background: color-mix(in oklab, var(--accent) 22%, var(--card) 78%);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .ghostBtn{
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .primaryBtn:active, .ghostBtn:active{ transform: translateY(1px); }

    /* Drawer (Settings) */
    .drawer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: min(82vh, 720px);
      transform: translateY(102%);
      transition: transform .22s ease;
      z-index: 70;
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      border-top: 1px solid var(--border);
      box-shadow: 0 -20px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .drawer.show{ transform: translateY(0); }

    .drawerHandle{
      width: 42px;
      height: 5px;
      border-radius: 999px;
      background: color-mix(in oklab, var(--muted2) 50%, transparent);
      margin: 10px auto 2px;
      opacity: .8;
    }
    .drawerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .drawerHeader .drawerTitle{ font-weight: 800; }
    .tabs{
      display:flex;
      gap: 8px;
      padding: 10px 12px;
      overflow:auto;
      border-bottom: 1px solid var(--border);
    }
    .tab{
      flex:0 0 auto;
      height: 36px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      gap: 6px;
    }
    .tab.active{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
      background: color-mix(in oklab, var(--accent) 14%, var(--card2) 86%);
    }

    .drawerBody{ flex:1; overflow:auto; padding: 12px; }
    .section{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      padding: 12px;
      margin-bottom: 12px;
    }
    .section h3{ margin: 0 0 10px 0; font-size: 1.02em; letter-spacing:.1px; }
    .row{ display:flex; gap: 10px; align-items:center; margin: 10px 0; flex-wrap:wrap; }
    .row > label{ flex: 0 0 120px; color: var(--muted); font-size:.92em; }
    .row .grow{ flex: 1 1 auto; min-width: 180px; }
    .row input[type="text"], .row input[type="password"], .row input[type="number"], .row select, .row textarea{
      width:100%;
      height: 42px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      padding: 0 10px;
      outline:none;
    }
    .row textarea{
      height: 96px;
      padding: 10px;
      resize: vertical;
      min-height: 90px;
      max-height: 240px;
    }
    .row input:focus, .row select:focus, .row textarea:focus{
      border-color: color-mix(in oklab, var(--accent) 60%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 18%, transparent);
    }
    .small{ font-size:.82em; color: var(--muted2); line-height: 1.45; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 380px){
      .split{ grid-template-columns: 1fr; }
      .row > label{ flex-basis: 100%; }
    }
    .inlineBtns{ display:flex; gap: 10px; flex-wrap:wrap; }
    .btn{
      height: 42px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 45%, var(--border));
      background: color-mix(in oklab, var(--accent) 20%, var(--card) 80%);
    }
    .btn.danger{
      border-color: color-mix(in oklab, var(--danger) 45%, var(--border));
      background: color-mix(in oklab, var(--danger) 12%, var(--card) 88%);
    }
    .btn:active{ transform: translateY(1px); }

    .chipRow{ display:flex; gap: 8px; flex-wrap:wrap; margin-top: 8px; }
    .chip{
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      font-size: .9em;
    }
    .chip:active{ transform: translateY(1px); }

    /* Action sheet */
    .sheet{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      transform: translateY(102%);
      transition: transform .18s ease;
      z-index: 80;
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      background: color-mix(in oklab, var(--card) 94%, transparent);
      border-top: 1px solid var(--border);
      box-shadow: 0 -20px 50px rgba(0,0,0,.35);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .sheet.show{ transform: translateY(0); }
    .sheet .sheetHead{
      padding: 10px 12px 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid var(--border);
    }
    .sheet .sheetTitle{ font-weight: 800; }
    .sheet .sheetBody{ padding: 10px; }
    .sheetItem{
      height: 52px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      margin: 8px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .sheetItem:active{ transform: translateY(1px); }
    .sheetItem.danger{ border-color: color-mix(in oklab, var(--danger) 45%, var(--border)); }
    .sheetItem .left{ display:flex; gap: 10px; align-items:center; }
    .sheetItem .sIcon{ width: 28px; text-align:center; opacity:.95; }
    .sheetItem .right{ color: var(--muted2); font-size:.85em; }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      /* âœ… å…³é”®ï¼štoast æ°¸è¿œåœ¨ composer ä¸Šæ–¹ï¼Œå¹¶éšé”®ç›˜æŠ¬èµ· */
      bottom: calc(var(--composerH) + 12px + var(--kb));
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events:none;
      transition: all .22s ease;
      z-index: 90;
      max-width: min(92vw, 520px);
      background: color-mix(in oklab, var(--card) 92%, rgba(0,0,0,.12));
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast .tText{ font-size:.92em; overflow:hidden; text-overflow: ellipsis; white-space:nowrap; }
    .toast .tBtn{
      height: 34px;
      padding: 0 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }

    /* Onboarding modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 100;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      padding-top: calc(18px + env(safe-area-inset-top));
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    .modal.show{ display:flex; }
    .modalCard{
      width: min(96vw, 520px);
      max-height: 86vh;
      overflow:auto;
      border-radius: 22px;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--card) 94%, transparent);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
    }
    .modalCard h2{ margin: 6px 0 6px; font-size: 1.2em; letter-spacing:.2px; }
    .modalCard p{ margin: 8px 0; color: var(--muted); line-height:1.55; }
    .modalCard .modalBtns{ display:flex; gap: 10px; margin-top: 12px; flex-wrap:wrap; }
    .divider{ height: 1px; background: var(--border); margin: 12px 0; }

    /* âœ… Typingï¼šå›ºå®šåœ¨ composer ä¸Šæ–¹ï¼Œä¸å å¸ƒå±€ï¼Œä¹Ÿä¸ä¼šè¢«é®æŒ¡ */
    .typing{
      position: fixed;
      left: max(12px, env(safe-area-inset-left));
      right: max(12px, env(safe-area-inset-right));
      bottom: calc(var(--composerH) + 8px + var(--kb));
      z-index: 25;
      display:flex;
      gap:8px;
      align-items:center;
      color: var(--muted2);
      font-size:.9em;
      pointer-events:none;
    }
    .dots{ display:flex; gap:4px; align-items:center; }
    .dot{
      width: 6px; height: 6px; border-radius: 99px;
      background: color-mix(in oklab, var(--muted2) 70%, transparent);
      animation: bounce 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .12s; }
    .dot:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%, 100%{ transform: translateY(0); opacity:.65; }
      50%{ transform: translateY(-4px); opacity:1; }
    }

    /* Markdown */
    .md{ line-height: 1.55; word-wrap: break-word; }
    .md p{ margin: 8px 0; }
    .md h1, .md h2, .md h3{ margin: 10px 0 6px; line-height:1.25; }
    .md h1{ font-size:1.25em; }
    .md h2{ font-size:1.16em; }
    .md h3{ font-size:1.06em; }
    .md ul, .md ol{ margin: 8px 0 8px 1.1em; padding:0; }
    .md li{ margin: 4px 0; }
    .md blockquote{
      margin: 10px 0;
      padding: 8px 10px;
      border-left: 3px solid color-mix(in oklab, var(--accent) 55%, var(--border));
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      border-radius: 12px;
      color: color-mix(in oklab, var(--fg) 92%, var(--muted2));
    }
    .md hr{ border:0; height:1px; background: var(--border); margin: 12px 0; }
    .md code.inline{
      padding: 2px 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card2) 92%, transparent);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.92em;
    }
    .codeBlock{
      margin: 10px 0;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background: color-mix(in oklab, var(--card2) 92%, transparent);
    }
    .codeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      color: var(--muted2);
      font-size:.82em;
    }
    .codeTop .lang{ text-transform: lowercase; }
    .codeTop .copyCode{
      height: 30px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    pre{
      margin:0;
      padding: 10px 12px;
      overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.9em;
      line-height:1.55;
      white-space: pre;
    }
    .tok-com{ color: color-mix(in oklab, var(--muted2) 85%, var(--fg)); }
    .tok-str{ color: color-mix(in oklab, #22c55e 70%, var(--fg)); }
    .tok-key{ color: color-mix(in oklab, var(--accent) 75%, var(--fg)); font-weight: 650; }
    .tok-num{ color: color-mix(in oklab, #f59e0b 75%, var(--fg)); }
    .tok-tag{ color: color-mix(in oklab, #a78bfa 75%, var(--fg)); }
    .tok-attr{ color: color-mix(in oklab, #38bdf8 75%, var(--fg)); }

    .muted{ color: var(--muted); }
    .dangerText{ color: color-mix(in oklab, var(--danger) 85%, var(--fg)); }
  </style>
</head>

<body>
<div id="app" data-theme="dark">
  <!-- ========================= Top Bar ========================= -->
  <header class="topbar">
    <div class="left">
      <button class="iconBtn" id="btnMenu" aria-label="ä¼šè¯åˆ—è¡¨">
        <span class="icon">â˜°</span>
      </button>
    </div>

    <div class="titleWrap">
      <div class="title" id="sessionTitle">æ–°ä¼šè¯</div>
      <div class="subtitle" id="sessionSub">ç¦»çº¿ Â· æœªé…ç½® API</div>
    </div>

    <div class="right">
      <button class="iconBtn" id="btnInfo" aria-label="ä¿¡æ¯ä¸ç»Ÿè®¡"><span class="icon">â“˜</span></button>
      <button class="iconBtn" id="btnSettings" aria-label="è®¾ç½®"><span class="icon">âš™ï¸</span></button>
    </div>
  </header>

  <!-- ========================= Sidebar ========================= -->
  <div class="backdrop" id="backdrop"></div>
  <aside class="sidebar" id="sidebar" aria-label="ä¼šè¯åˆ—è¡¨ä¾§è¾¹æ ">
    <div class="sideHeader">
      <div class="sideTitle">ä¼šè¯</div>
      <button class="iconBtn" id="btnCloseSidebar" aria-label="å…³é—­"><span class="icon">âœ•</span></button>
    </div>

    <div class="sideBody" id="sessionList"></div>

    <div class="sideFooter">
      <button class="primaryBtn" id="btnNewSession">ï¼‹ æ–°å»º</button>
      <button class="ghostBtn" id="btnMoreSession">â‹¯</button>
    </div>
  </aside>

  <!-- ========================= Main ========================= -->
  <main class="main" id="main">
    <div class="messages" id="messages"></div>

    <div class="typing" id="typing" style="display:none;">
      <div class="dots" aria-hidden="true">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
      <div>ç”Ÿæˆä¸­â€¦</div>
    </div>
  </main>

  <!-- ========================= Composer (fixed) ========================= -->
  <footer class="composer" id="composer">
    <div class="composerInner">
      <div class="modelRow">
        <button class="modelChip" id="modelChip" aria-label="é€‰æ‹©æ¨¡å‹">
          <span>ğŸ¤–</span>
          <span class="modelChipText" id="modelChipText">æœªè®¾ç½®æ¨¡å‹</span>
          <span class="muted" style="opacity:.8;">â–¾</span>
        </button>
      </div>

      <div class="composerRow">
        <div class="inputWrap">
          <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦ï¼ˆEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰" autocomplete="off" spellcheck="false"></textarea>
          <div class="hintLine">
            <div class="leftHint" id="draftHint">æç¤ºï¼šåŒå‡»è¾“å…¥æ¡†å°è¯•ä»å‰ªè´´æ¿ç²˜è´´</div>
            <div class="rightHint" id="counterHint">0å­— Â· ~0 tokens</div>
          </div>
        </div>
        <button class="stopBtn" id="stopBtn" aria-label="åœæ­¢ç”Ÿæˆ">â¹</button>
        <button class="sendBtn" id="sendBtn" aria-label="å‘é€">ğŸ“¤</button>
      </div>
    </div>
  </footer>

  <!-- ========================= Settings Drawer ========================= -->
  <section class="drawer" id="settingsDrawer" aria-label="è®¾ç½®æŠ½å±‰">
    <div class="drawerHandle"></div>
    <div class="drawerHeader">
      <div class="drawerTitle">è®¾ç½®</div>
      <button class="iconBtn" id="btnCloseSettings" aria-label="å…³é—­è®¾ç½®"><span class="icon">âœ•</span></button>
    </div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="api">ğŸ”‘ API</button>
      <button class="tab" data-tab="prompt">ğŸ§© Prompt</button>
      <button class="tab" data-tab="theme">ğŸ¨ å¤–è§‚</button>
      <button class="tab" data-tab="data">ğŸ“¦ æ•°æ®</button>
      <button class="tab" data-tab="help">â“ å¸®åŠ©</button>
    </div>

    <div class="drawerBody">
      <!-- API -->
      <div class="tabPane" data-tabpane="api">
        <div class="section">
          <h3>å¿«æ·é¢„è®¾</h3>
          <div class="row">
            <label>é¢„è®¾</label>
            <div class="grow">
              <select id="presetSelect"></select>
            </div>
          </div>
          <div class="small">è¯´æ˜ï¼šæœ¬å®¢æˆ·ç«¯æŒ‰ <span class="muted">OpenAI Chat Completions (å…¼å®¹æ ¼å¼)</span> è°ƒç”¨ï¼š<code class="inline">POST {baseUrl}/v1/chat/completions</code>ã€‚</div>
        </div>

        <div class="section">
          <h3>è¿æ¥é…ç½®</h3>

          <div class="row">
            <label>Base URL</label>
            <div class="grow">
              <input id="baseUrl" type="text" placeholder="https://api.openai.com" />
              <div class="small">è‡ªåŠ¨è¡¥é½ï¼šæœ«å°¾æ— éœ€åŠ  <code class="inline">/v1</code>ï¼Œç¨‹åºä¼šæ‹¼åˆ° <code class="inline">/v1/chat/completions</code>ã€‚</div>
            </div>
          </div>

          <div class="row">
            <label>API Key</label>
            <div class="grow">
              <input id="apiKey" type="password" placeholder="sk-..." />
              <div class="small">
                <label style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                  <input type="checkbox" id="rememberKey" />
                  <span>åœ¨æœ¬æœºä¿å­˜ API Keyï¼ˆlocalStorageï¼‰</span>
                </label>
                <div class="small">æç¤ºï¼šlocalStorage ä»…ä¸ºæœ¬åœ°ä¿å­˜ï¼ŒéåŠ å¯†ä¿é™©ç®±ï¼›åœ¨å…±äº«è®¾å¤‡ä¸Šå»ºè®®å…³é—­ä¿å­˜ã€‚</div>
              </div>
            </div>
          </div>

          <div class="row">
            <label>Model</label>
            <div class="grow">
              <input id="model" type="text" placeholder="gpt-4o-mini / deepseek-chat / ..." />
            </div>
          </div>

          <div class="row">
            <label>Extra Headers</label>
            <div class="grow">
              <input id="extraHeaders" type="text" placeholder='å¯é€‰ï¼š{"X-foo":"bar"}' />
              <div class="small">å¯å¡« JSONï¼šç”¨äºæŸäº›ä»£ç†éœ€è¦é¢å¤–å¤´å­—æ®µã€‚</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>é‡‡æ ·å‚æ•°</h3>
          <div class="split">
            <div class="row">
              <label>temperature</label>
              <div class="grow">
                <input id="temperature" type="number" min="0" max="2" step="0.1" />
              </div>
            </div>
            <div class="row">
              <label>top_p</label>
              <div class="grow">
                <input id="topP" type="number" min="0" max="1" step="0.05" />
              </div>
            </div>
          </div>
          <div class="row">
            <label>max_tokens</label>
            <div class="grow">
              <input id="maxTokens" type="number" min="1" max="200000" step="1" />
              <div class="small">ç•™ç©ºè¡¨ç¤ºä¸ä¼  max_tokensï¼ˆäº¤ç”±æœåŠ¡ç«¯é»˜è®¤ï¼‰ã€‚</div>
            </div>
          </div>

          <div class="inlineBtns">
            <button class="btn primary" id="btnSaveApi">ä¿å­˜é…ç½®</button>
            <button class="btn" id="btnTestApi">æµ‹è¯•è¿æ¥</button>
          </div>

          <div class="divider"></div>
          <h3>é…ç½®å¯¼å…¥ / å¯¼å‡ºï¼ˆJSONï¼‰</h3>
          <div class="inlineBtns">
            <button class="btn" id="btnExportConfig">å¯¼å‡ºé…ç½®</button>
            <button class="btn" id="btnImportConfig">å¯¼å…¥é…ç½®</button>
            <input class="sr-only" type="file" id="fileImportConfig" accept="application/json" />
          </div>
          <div class="small">å¯¼å‡ºçš„â€œé…ç½®â€åªåŒ…å« API/ä¸»é¢˜/æç¤ºè¯ç­‰ï¼Œä¸å«èŠå¤©å†…å®¹ã€‚</div>
        </div>
      </div>

      <!-- Prompt -->
      <div class="tabPane" data-tabpane="prompt" style="display:none;">
        <div class="section">
          <h3>å…¨å±€ System Prompt</h3>
          <div class="row">
            <label>é»˜è®¤</label>
            <div class="grow">
              <textarea id="globalSystemPrompt" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šã€ä¸¥è°¨ã€ç®€æ´çš„åŠ©æ‰‹â€¦"></textarea>
              <div class="small">å°†ä½œä¸ºæ¯ä¸ªä¼šè¯çš„é»˜è®¤ç³»ç»Ÿæç¤ºè¯ï¼ˆè‹¥ä¼šè¯å•ç‹¬è®¾ç½®åˆ™è¦†ç›–ï¼‰ã€‚</div>
            </div>
          </div>
          <div class="inlineBtns">
            <button class="btn primary" id="btnSaveGlobalPrompt">ä¿å­˜</button>
            <button class="btn" id="btnApplyToSession">åº”ç”¨åˆ°å½“å‰ä¼šè¯</button>
          </div>
        </div>

        <div class="section">
          <h3>å½“å‰ä¼šè¯ System Prompt</h3>
          <div class="row">
            <label>ä¼šè¯ä¸“å±</label>
            <div class="grow">
              <textarea id="sessionSystemPrompt" placeholder="ç•™ç©ºè¡¨ç¤ºä½¿ç”¨å…¨å±€é»˜è®¤"></textarea>
              <div class="small">åªå¯¹å½“å‰ä¼šè¯ç”Ÿæ•ˆã€‚</div>
            </div>
          </div>
          <div class="inlineBtns">
            <button class="btn primary" id="btnSaveSessionPrompt">ä¿å­˜</button>
            <button class="btn danger" id="btnClearSessionPrompt">æ¸…é™¤ä¼šè¯ Prompt</button>
          </div>
        </div>

        <div class="section">
          <h3>æ¨¡æ¿å¿«æ·é€‰æ‹©</h3>
          <div class="small">ç‚¹å‡»æ¨¡æ¿å°†å¡«å…¥â€œå½“å‰ä¼šè¯ System Promptâ€ã€‚</div>
          <div class="chipRow" id="promptChips"></div>
        </div>
      </div>

      <!-- Theme -->
      <div class="tabPane" data-tabpane="theme" style="display:none;">
        <div class="section">
          <h3>æ·±æµ…è‰²æ¨¡å¼</h3>
          <div class="row">
            <label>æ¨¡å¼</label>
            <div class="grow">
              <select id="themeMode">
                <option value="system">è·Ÿéšç³»ç»Ÿ</option>
                <option value="dark">æ·±è‰²</option>
                <option value="light">æµ…è‰²</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label>ä¸»é¢˜è‰²</label>
            <div class="grow">
              <input id="accentColor" type="text" placeholder="#5b8cff" />
              <div class="small">æ”¯æŒ HEXï¼ˆå¦‚ <code class="inline">#5b8cff</code>ï¼‰ã€‚</div>
            </div>
          </div>

          <div class="row">
            <label>å­—ä½“å¤§å°</label>
            <div class="grow">
              <input id="fontScale" type="number" min="0.85" max="1.35" step="0.05" />
              <div class="small">å»ºè®®ï¼š0.95ï½1.15ã€‚</div>
            </div>
          </div>

          <div class="inlineBtns">
            <button class="btn primary" id="btnSaveTheme">ä¿å­˜å¤–è§‚</button>
            <button class="btn" id="btnResetTheme">é‡ç½®é»˜è®¤</button>
          </div>
        </div>
      </div>

      <!-- Data -->
      <div class="tabPane" data-tabpane="data" style="display:none;">
        <div class="section">
          <h3>ä¼šè¯ç®¡ç†</h3>
          <div class="inlineBtns">
            <button class="btn" id="btnRenameSession">é‡å‘½åå½“å‰ä¼šè¯</button>
            <button class="btn danger" id="btnClearSession">æ¸…ç©ºå½“å‰å¯¹è¯</button>
          </div>
          <div class="small">æç¤ºï¼šè¾“å…¥æ¡†æ”¯æŒå¿«æ·æŒ‡ä»¤ï¼š<code class="inline">/clear</code> æ¸…ç©ºå½“å‰ä¼šè¯ã€‚</div>
        </div>

        <div class="section">
          <h3>å…¨éƒ¨æ•°æ®å¯¼å…¥ / å¯¼å‡º</h3>
          <div class="inlineBtns">
            <button class="btn primary" id="btnExportAll">å¯¼å‡ºå…¨éƒ¨</button>
            <button class="btn" id="btnImportAll">å¯¼å…¥å…¨éƒ¨</button>
            <input class="sr-only" type="file" id="fileImportAll" accept="application/json" />
            <button class="btn danger" id="btnWipeAll">æŠ¹æ‰æœ¬æœºæ•°æ®</button>
          </div>
          <div class="small">â€œå…¨éƒ¨æ•°æ®â€åŒ…å«ï¼šä¼šè¯èŠå¤©è®°å½•ã€è®¾ç½®ã€æ¨¡æ¿ã€åå¥½ç­‰ã€‚</div>
        </div>

        <div class="section">
          <h3>Prompt æ¨¡æ¿ï¼ˆå¯æ‰©å±•ï¼‰</h3>
          <div class="row">
            <label>æ¨¡æ¿ JSON</label>
            <div class="grow">
              <textarea id="templateJson" placeholder='[{ "name":"å†™ä½œåŠ©æ‰‹","prompt":"..." }, ...]'></textarea>
              <div class="small">ä¿å­˜åæ¨¡æ¿åŒºä¼šåˆ·æ–°ã€‚</div>
            </div>
          </div>
          <div class="inlineBtns">
            <button class="btn primary" id="btnSaveTemplates">ä¿å­˜æ¨¡æ¿</button>
            <button class="btn" id="btnResetTemplates">æ¢å¤å†…ç½®æ¨¡æ¿</button>
          </div>
        </div>
      </div>

      <!-- Help -->
      <div class="tabPane" data-tabpane="help" style="display:none;">
        <div class="section">
          <h3>ä½¿ç”¨è¯´æ˜ï¼ˆå†…ç½®ï¼‰</h3>
          <div class="small">
            <p><b>1) é¦–æ¬¡ä½¿ç”¨ï¼š</b>è®¾ç½® â†’ â€œğŸ”‘ APIâ€ å¡« Base URL / Key / Modelã€‚</p>
            <p><b>2) å‘é€ï¼š</b>Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œã€‚</p>
            <p><b>3) æ¶ˆæ¯æ“ä½œï¼š</b>ç‚¹å‡»æ¶ˆæ¯æ˜¾ç¤ºæŒ‰é’®ï¼›é•¿æŒ‰å¼¹å‡ºèœå•ã€‚</p>
            <p><b>4) PWAï¼š</b>æµè§ˆå™¨èœå•â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========================= Action Sheet ========================= -->
  <section class="sheet" id="actionSheet" aria-label="æ“ä½œèœå•">
    <div class="sheetHead">
      <div class="sheetTitle" id="sheetTitle">æ“ä½œ</div>
      <button class="iconBtn" id="btnCloseSheet" aria-label="å…³é—­"><span class="icon">âœ•</span></button>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </section>

  <!-- ========================= Toast ========================= -->
  <div class="toast" id="toast">
    <div class="tText" id="toastText">æç¤º</div>
    <button class="tBtn" id="toastBtn" style="display:none;">æ“ä½œ</button>
  </div>

  <!-- ========================= Onboarding ========================= -->
  <div class="modal" id="onboarding">
    <div class="modalCard">
      <h2>é¦–æ¬¡ä½¿ç”¨ï¼šé…ç½® API</h2>
      <p>ä½ è¿˜æ²¡æœ‰å®Œæˆ API é…ç½®ã€‚è¯·æ‰“å¼€è®¾ç½® â†’ â€œğŸ”‘ APIâ€ï¼Œå¡«å†™ Base URL / API Key / Modelã€‚</p>
      <div class="divider"></div>
      <p class="small">ä¹Ÿå¯ä»¥å…ˆé€‰â€œå¿«æ·é¢„è®¾â€ï¼Œå†è¾“å…¥è‡ªå·±çš„ API Keyã€‚</p>
      <div class="modalBtns">
        <button class="btn primary" id="btnGoSettings">å»è®¾ç½®</button>
        <button class="btn" id="btnLater">ç¨å</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';

  const LS_KEY = 'mchat_v1';
  const LS_DRAFT_KEY = 'mchat_drafts_v1';
  const LS_VOLATILE_KEY = 'mchat_volatile_v1';
  const APP_VER = 1;

  const DEFAULT_TEMPLATES = [
    { name: "ä»£ç å®¡é˜…", prompt: "ä½ æ˜¯èµ„æ·±å·¥ç¨‹å¸ˆã€‚è¯·ç”¨è¦ç‚¹æ–¹å¼å®¡é˜…ä»£ç ï¼šæŒ‡å‡ºæ½œåœ¨ bugã€è¾¹ç•Œæ¡ä»¶ã€æ€§èƒ½é—®é¢˜ä¸å¯ç»´æŠ¤æ€§å»ºè®®ï¼Œå¹¶ç»™å‡ºæ”¹è¿›åçš„ä»£ç ç‰‡æ®µã€‚" },
    { name: "å†™ä½œæ¶¦è‰²", prompt: "ä½ æ˜¯ä¸­æ–‡å†™ä½œç¼–è¾‘ã€‚è¯·åœ¨ä¸æ”¹å˜åŸæ„çš„å‰æä¸‹æ¶¦è‰²ï¼Œä½¿è¡¨è¾¾æ›´æ¸…æ™°ã€è‡ªç„¶ã€æœ‰å±‚æ¬¡ã€‚è¾“å‡ºï¼šä¿®æ”¹åçš„æ­£æ–‡ + å…³é”®æ”¹åŠ¨è¯´æ˜ã€‚" },
    { name: "ç¿»è¯‘ï¼ˆä¸­è‹±ï¼‰", prompt: "ä½ æ˜¯ä¸“ä¸šç¿»è¯‘ã€‚è¯·è¿›è¡Œå‡†ç¡®ã€è‡ªç„¶çš„ä¸­è‹±äº’è¯‘ï¼›ä¸“æœ‰åè¯ä¿ç•™åŸæ–‡å¹¶åœ¨æ‹¬å·ç»™å‡ºè§£é‡Šã€‚" },
    { name: "äº§å“ç»ç†", prompt: "ä½ æ˜¯äº§å“ç»ç†ã€‚è¯·è¾“å‡ºï¼šéœ€æ±‚æ¾„æ¸…é—®é¢˜ã€ç”¨æˆ·æ•…äº‹ã€åŠŸèƒ½åˆ—è¡¨ã€è¾¹ç•Œ/å¼‚å¸¸ã€åŸ‹ç‚¹ä¸éªŒæ”¶æ ‡å‡†ã€‚" },
    { name: "ä¸¥æ ¼æ¨¡å¼", prompt: "ä½ å›ç­”æ—¶è¯·ï¼š1) å…ˆç»™ç»“è®ºï¼›2) å†ç»™ä¾æ®ï¼›3) ä¸ç¡®å®šçš„å†…å®¹æ˜ç¡®æ ‡æ³¨ï¼›4) ä¸è¦ç¼–é€ äº‹å®ä¸æ¥æºã€‚" }
  ];

  const PRESETS = [
    { id: 'openai', name: 'OpenAIï¼ˆå®˜æ–¹ï¼‰', baseUrl: 'https://api.openai.com', model: 'gpt-4o-mini', extraHeaders: '', note: 'éœ€è¦ OpenAI API Key' },
    { id: 'openrouter', name: 'OpenRouterï¼ˆå…¼å®¹ï¼‰', baseUrl: 'https://openrouter.ai/api', model: 'openai/gpt-4o-mini', extraHeaders: '{"HTTP-Referer":"https://example.com","X-Title":"MobileChat"}', note: 'OpenAI å…¼å®¹ï¼›å¯èƒ½éœ€è¦ Referer/Title' },
    { id: 'deepseek', name: 'DeepSeekï¼ˆå…¼å®¹ï¼‰', baseUrl: 'https://api.deepseek.com', model: 'deepseek-chat', extraHeaders: '', note: 'OpenAI å…¼å®¹æ¥å£' },
    { id: 'moonshot', name: 'Moonshotï¼ˆKimiï¼Œå…¼å®¹ï¼‰', baseUrl: 'https://api.moonshot.cn', model: 'moonshot-v1-8k', extraHeaders: '', note: 'OpenAI å…¼å®¹æ¥å£' },
    { id: 'together', name: 'Togetherï¼ˆå…¼å®¹ï¼‰', baseUrl: 'https://api.together.xyz', model: 'meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo', extraHeaders: '', note: 'OpenAI å…¼å®¹æ¥å£' },
    { id: 'anthropic_proxy', name: 'Claudeï¼ˆé€šè¿‡ OpenAI å…¼å®¹ä»£ç†ï¼‰', baseUrl: 'https://your-openai-compatible-gateway.example', model: 'claude-3-5-sonnet', extraHeaders: '', note: 'Claude åŸç”Ÿä¸èµ° /chat/completionsï¼›å»ºè®®ç”¨å…¼å®¹ç½‘å…³' }
  ];

  const el = (id) => document.getElementById(id);

  const app = el('app');
  const messagesEl = el('messages');
  const inputEl = el('input');
  const sendBtn = el('sendBtn');
  const stopBtn = el('stopBtn');
  const typingEl = el('typing');
  const sessionTitleEl = el('sessionTitle');
  const sessionSubEl = el('sessionSub');

  const sidebar = el('sidebar');
  const backdrop = el('backdrop');
  const sessionListEl = el('sessionList');

  const settingsDrawer = el('settingsDrawer');
  const tabsEl = el('tabs');

  const actionSheet = el('actionSheet');
  const sheetBody = el('sheetBody');
  const sheetTitle = el('sheetTitle');

  const toast = el('toast');
  const toastText = el('toastText');
  const toastBtn = el('toastBtn');

  const onboarding = el('onboarding');

  const presetSelect = el('presetSelect');
  const baseUrlEl = el('baseUrl');
  const apiKeyEl = el('apiKey');
  const rememberKeyEl = el('rememberKey');
  const modelEl = el('model');
  const extraHeadersEl = el('extraHeaders');
  const temperatureEl = el('temperature');
  const topPEl = el('topP');
  const maxTokensEl = el('maxTokens');

  const globalSystemPromptEl = el('globalSystemPrompt');
  const sessionSystemPromptEl = el('sessionSystemPrompt');
  const promptChipsEl = el('promptChips');

  const themeModeEl = el('themeMode');
  const accentColorEl = el('accentColor');
  const fontScaleEl = el('fontScale');

  const templateJsonEl = el('templateJson');

  const draftHintEl = el('draftHint');
  const counterHintEl = el('counterHint');

  const composerEl = el('composer');
  const modelChip = el('modelChip');
  const modelChipText = el('modelChipText');

  const now = () => Date.now();

  function uid(prefix='id'){
    return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function safeJsonParse(s, fallback=null){ try{ return JSON.parse(s); } catch { return fallback; } }
  function escapeHtml(str){
    return (str ?? '').replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }
  function trimUrl(u){ return (u || '').trim().replace(/\/+$/,''); }
  function isProbablyConfigured(st){
    const u = trimUrl(st.settings.baseUrl);
    const k = (st.settings.apiKey || '').trim();
    const m = (st.settings.model || '').trim();
    return !!(u && k && m);
  }
  function approxTokens(text){
    const len = (text || '').length;
    return Math.max(1, Math.ceil(len / 4));
  }
  function formatDate(ts){
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = (d.getMonth()+1).toString().padStart(2,'0');
    const dd = d.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function formatClock(ts){
    const d = new Date(ts);
    const hh = d.getHours().toString().padStart(2,'0');
    const mm = d.getMinutes().toString().padStart(2,'0');
    return `${hh}:${mm}`;
  }

  function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function readFileAsText(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result || ''));
      fr.onerror = () => reject(fr.error);
      fr.readAsText(file, 'utf-8');
    });
  }

  const state = loadState();

  const runtime = {
    aborter: null,
    isStreaming: false,
    streamMsgId: null,
    lastError: null,
    lastSendContext: null,
    longPressTimer: null,
    longPressMoved: false,
    activeActionMsgId: null,
    editTarget: null,
    toastTimer: null
  };

  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    const parsed = safeJsonParse(raw, null);
    const vol = safeJsonParse(localStorage.getItem(LS_VOLATILE_KEY), {}) || {};

    const base = {
      ver: APP_VER,
      settings: {
        baseUrl: 'https://api.openai.com',
        apiKey: '',
        rememberKey: false,
        model: 'gpt-4o-mini',
        extraHeaders: '',
        temperature: 0.7,
        top_p: 1,
        max_tokens: '',
        themeMode: 'system',
        accent: '#5b8cff',
        fontScale: 1.0,
        lastPreset: 'openai'
      },
      globalSystemPrompt: '',
      templates: DEFAULT_TEMPLATES.slice(),
      sessions: {},
      activeSessionId: '',
      sendHistory: []
    };

    const st = Object.assign(base, parsed || {});
    st.settings = Object.assign(base.settings, (parsed?.settings || {}));
    st.templates = Array.isArray(st.templates) && st.templates.length ? st.templates : DEFAULT_TEMPLATES.slice();

    if (!st.settings.rememberKey && vol?.apiKey) st.settings.apiKey = vol.apiKey;

    if (!st.activeSessionId || !st.sessions || !st.sessions[st.activeSessionId]) {
      const sid = createSessionObject('æ–°ä¼šè¯');
      st.sessions[sid.id] = sid;
      st.activeSessionId = sid.id;
    }
    return st;
  }

  function saveState(){
    const clone = structuredCloneSafe(state);
    if (!clone.settings.rememberKey) {
      const vol = { apiKey: clone.settings.apiKey || '' };
      localStorage.setItem(LS_VOLATILE_KEY, JSON.stringify(vol));
      clone.settings.apiKey = '';
    } else {
      localStorage.removeItem(LS_VOLATILE_KEY);
    }
    localStorage.setItem(LS_KEY, JSON.stringify(clone));
  }
  function structuredCloneSafe(obj){ return JSON.parse(JSON.stringify(obj)); }

  function loadDrafts(){ return safeJsonParse(localStorage.getItem(LS_DRAFT_KEY), {}) || {}; }
  function saveDrafts(drafts){ localStorage.setItem(LS_DRAFT_KEY, JSON.stringify(drafts)); }

  function activeSession(){ return state.sessions[state.activeSessionId]; }

  function createSessionObject(title='æ–°ä¼šè¯'){
    const id = uid('s');
    return { id, title, createdAt: now(), updatedAt: now(), systemPrompt: '', messages: [] };
  }

  function newSession(){
    const s = createSessionObject('æ–°ä¼šè¯');
    state.sessions[s.id] = s;
    state.activeSessionId = s.id;
    runtime.editTarget = null;
    saveState();
    renderAll();
    closeSidebar();
    focusInput();
  }

  function renameSession(sessionId, newTitle){
    const s = state.sessions[sessionId];
    if (!s) return;
    s.title = (newTitle || '').trim() || 'æœªå‘½åä¼šè¯';
    s.updatedAt = now();
    saveState();
    renderAll();
  }

  function clearSessionMessages(sessionId){
    const s = state.sessions[sessionId];
    if (!s) return;
    s.messages = [];
    s.updatedAt = now();
    runtime.editTarget = null;
    saveState();
    renderAll();
  }

  function upsertMessage(sessionId, msg){
    const s = state.sessions[sessionId];
    if (!s) return;
    const i = s.messages.findIndex(m => m.id === msg.id);
    if (i >= 0) s.messages[i] = msg;
    else s.messages.push(msg);
    s.updatedAt = now();
  }

  function removeMessage(sessionId, msgId){
    const s = state.sessions[sessionId];
    if (!s) return;
    s.messages = s.messages.filter(m => m.id !== msgId);
    s.updatedAt = now();
  }

  function autoNameIfNeeded(sessionId){
    const s = state.sessions[sessionId];
    if (!s) return;
    if (s.title && s.title !== 'æ–°ä¼šè¯') return;
    const firstUser = s.messages.find(m => m.role === 'user' && (m.content||'').trim());
    if (!firstUser) return;
    const t = (firstUser.content || '').trim().replace(/\s+/g,' ');
    const short = t.length > 18 ? t.slice(0, 18) + 'â€¦' : t;
    s.title = short || 'æ–°ä¼šè¯';
  }

  /* -------------------------- Markdown Rendering -------------------------- */
  function renderMarkdown(src){
    const text = String(src ?? '');
    const parts = [];
    let last = 0;
    const fenceRe = /```(\w+)?\n([\s\S]*?)```/g;
    let m;
    while ((m = fenceRe.exec(text)) !== null) {
      if (m.index > last) parts.push({ type:'md', text: text.slice(last, m.index) });
      parts.push({ type:'code', lang: (m[1]||'').trim(), code: m[2] });
      last = m.index + m[0].length;
    }
    if (last < text.length) parts.push({ type:'md', text: text.slice(last) });

    return parts.map(p => p.type === 'code' ? renderCodeBlock(p.code, p.lang) : renderMdBlock(p.text)).join('');
  }

  function inlineFormat(s){
    let t = escapeHtml(s);
    t = t.replace(/`([^`]+)`/g, (_, code) => `<code class="inline">${code}</code>`);
    t = t.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
    t = t.replace(/(^|[^*])\*([^*]+)\*(?!\*)/g, '$1<i>$2</i>');
    t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (_, txt, url) => {
      const safeUrl = escapeHtml(url);
      return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${txt}</a>`;
    });
    return t;
  }

  /* âœ… ä¿®å¤ï¼šæ®µè½ç¼“å†²æ”¹ä¸ºå‡½æ•°å†…å±€éƒ¨ï¼Œé¿å…æ¸²æŸ“ä¸²å‘³ */
  function renderMdBlock(blockText){
    const lines = String(blockText ?? '').replace(/\r\n/g,'\n').split('\n');
    const out = [];
    let i = 0;
    let pbuf = [];

    function flushParagraph(){
      if (!pbuf.length) return;
      const joined = pbuf.join('\n').trimEnd();
      if (joined.trim()) out.push(`<p>${inlineFormat(joined).replace(/\n/g,'<br/>')}</p>`);
      pbuf = [];
    }

    while (i < lines.length) {
      const line = lines[i];

      if (/^\s*(---|\*\*\*|___)\s*$/.test(line)) {
        flushParagraph();
        out.push('<hr/>');
        i++; continue;
      }

      const hm = /^(#{1,3})\s+(.+)$/.exec(line);
      if (hm) {
        flushParagraph();
        const level = hm[1].length;
        out.push(`<h${level}>${inlineFormat(hm[2].trim())}</h${level}>`);
        i++; continue;
      }

      if (/^\s*>\s+/.test(line)) {
        flushParagraph();
        const qb = [];
        while (i < lines.length && /^\s*>\s+/.test(lines[i])) {
          qb.push(lines[i].replace(/^\s*>\s+/, ''));
          i++;
        }
        out.push(`<blockquote>${inlineFormat(qb.join('\n')).replace(/\n/g,'<br/>')}</blockquote>`);
        continue;
      }

      if (/^\s*([-*])\s+/.test(line)) {
        flushParagraph();
        const items = [];
        while (i < lines.length && /^\s*([-*])\s+/.test(lines[i])) {
          items.push(lines[i].replace(/^\s*([-*])\s+/, ''));
          i++;
        }
        out.push('<ul>' + items.map(it => `<li>${inlineFormat(it)}</li>`).join('') + '</ul>');
        continue;
      }

      if (/^\s*\d+\.\s+/.test(line)) {
        flushParagraph();
        const items = [];
        while (i < lines.length && /^\s*\d+\.\s+/.test(lines[i])) {
          items.push(lines[i].replace(/^\s*\d+\.\s+/, ''));
          i++;
        }
        out.push('<ol>' + items.map(it => `<li>${inlineFormat(it)}</li>`).join('') + '</ol>');
        continue;
      }

      if (!line.trim()) {
        flushParagraph();
        i++; continue;
      }

      pbuf.push(line);
      i++;
    }

    flushParagraph();
    return `<div class="md">${out.join('')}</div>`;
  }

  function renderCodeBlock(code, lang){
    const raw = String(code ?? '');
    const langNorm = (lang || '').trim().toLowerCase() || 'text';
    const highlighted = highlightCode(raw, langNorm);
    const safeLang = escapeHtml(langNorm);
    return `
      <div class="codeBlock">
        <div class="codeTop">
          <div class="lang">${safeLang}</div>
          <button class="copyCode" data-copy="code">å¤åˆ¶</button>
        </div>
        <pre><code data-lang="${safeLang}">${highlighted}</code></pre>
      </div>
    `;
  }

  function highlightCode(code, lang){
    const keywordsJS = ['const','let','var','function','return','async','await','if','else','for','while','break','continue','switch','case','default','try','catch','finally','throw','new','class','extends','super','this','import','from','export','true','false','null','undefined','typeof','instanceof','in','of'];
    const keywordsPY = ['def','return','if','elif','else','for','while','break','continue','try','except','finally','raise','class','import','from','as','True','False','None','with','lambda','yield','pass','global','nonlocal','and','or','not','in','is'];
    const esc = escapeHtml;

    let re; let kw = null;
    if (['js','javascript','ts','typescript','json'].includes(lang)) {
      kw = keywordsJS;
      re = /\/\*[\s\S]*?\*\/|\/\/[^\n]*|"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*'|`(?:\\.|[^`\\])*`|\b\d+(\.\d+)?\b|\b[A-Za-z_$][\w$]*\b/g;
    } else if (['py','python'].includes(lang)) {
      kw = keywordsPY;
      re = /#[^\n]*|"(?:\\.|[^"\\])*"|\'(?:\\.|[^\'\\])*\'|\b\d+(\.\d+)?\b|\b[A-Za-z_]\w*\b/g;
    } else if (['html','xml'].includes(lang)) {
      const s = esc(code)
        .replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="tok-com">$1</span>')
        .replace(/(&lt;\/?)([a-zA-Z][\w:-]*)([^&]*?)(\/?&gt;)/g, (m, p1, tag, rest, p4) => {
          const r = rest.replace(/([\w:-]+)(=)("[^"]*"|'[^']*')/g, '<span class="tok-attr">$1</span>$2<span class="tok-str">$3</span>');
          return `<span class="tok-tag">${p1}${tag}</span>${r}<span class="tok-tag">${p4}</span>`;
        });
      return s;
    } else if (['css'].includes(lang)) {
      re = /\/\*[\s\S]*?\*\/|"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*'|\b\d+(\.\d+)?(px|em|rem|%|vh|vw)?\b|\b[a-zA-Z-]+\b/g;
      kw = ['display','flex','grid','position','absolute','relative','fixed','sticky','color','background','border','padding','margin','width','height'];
    } else {
      return esc(code);
    }

    let out = '';
    let last = 0;
    while (true) {
      const m = re.exec(code);
      if (!m) break;
      const idx = m.index;
      out += esc(code.slice(last, idx));
      const tok = m[0];

      if ((lang === 'python' || lang === 'py') && tok.startsWith('#')) out += `<span class="tok-com">${esc(tok)}</span>`;
      else if ((['js','javascript','ts','typescript','json','css'].includes(lang)) && (tok.startsWith('//') || tok.startsWith('/*'))) out += `<span class="tok-com">${esc(tok)}</span>`;
      else if (tok.startsWith('"') || tok.startsWith("'") || tok.startsWith('`')) out += `<span class="tok-str">${esc(tok)}</span>`;
      else if (/^\d/.test(tok)) out += `<span class="tok-num">${esc(tok)}</span>`;
      else if (kw && kw.includes(tok)) out += `<span class="tok-key">${esc(tok)}</span>`;
      else out += esc(tok);

      last = idx + tok.length;
    }
    out += esc(code.slice(last));
    return out;
  }

  function bindCodeCopy(root){
    root.querySelectorAll('button.copyCode').forEach(btn => {
      btn.onclick = async () => {
        const codeEl = btn.closest('.codeBlock')?.querySelector('pre code');
        const txt = codeEl ? codeEl.textContent : '';
        try{
          await navigator.clipboard.writeText(txt);
          showToast('å·²å¤åˆ¶ä»£ç ', null, null, 1200);
        }catch{
          showToast('å¤åˆ¶å¤±è´¥ï¼šå‰ªè´´æ¿æƒé™å—é™', null, null, 1800);
        }
      };
    });
  }

  /* -------------------------- Rendering -------------------------- */
  function renderAll(){
    applyTheme();
    renderSessionList();
    renderCurrentSession();
    updateHeaderStatus();
    hydrateSettingsUI();
    updateModelChip();
    updateCounter();
    scheduleComposerMetrics(); /* âœ… æ¯æ¬¡æ¸²æŸ“åæµ‹é‡ composer é«˜åº¦ */
  }

  function renderSessionList(){
    const keys = Object.keys(state.sessions).map(k => state.sessions[k]).sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
    sessionListEl.innerHTML = keys.map(s => {
      const active = s.id === state.activeSessionId;
      const last = s.messages?.length ? s.messages[s.messages.length - 1] : null;
      const t = last ? formatClock(last.createdAt) : formatDate(s.createdAt);
      const count = s.messages?.length || 0;
      return `
        <div class="sessionItem ${active ? 'active':''}" data-sid="${escapeHtml(s.id)}">
          <div class="sessionTitle">${escapeHtml(s.title || 'æœªå‘½åä¼šè¯')}</div>
          <div class="sessionMeta"><span>${count} æ¡</span><span>${escapeHtml(t)}</span></div>
        </div>
      `;
    }).join('');

    sessionListEl.querySelectorAll('.sessionItem').forEach(item => {
      item.onclick = () => {
        const sid = item.getAttribute('data-sid');
        if (!sid || !state.sessions[sid]) return;
        state.activeSessionId = sid;
        runtime.editTarget = null;
        saveState();
        renderAll();
        closeSidebar();
        focusInput();
      };
    });
  }

  function renderCurrentSession(){
    const s = activeSession();
    if (!s) return;
    sessionTitleEl.textContent = s.title || 'æœªå‘½åä¼šè¯';

    let lastDay = '';
    let html = '';
    for (const msg of s.messages) {
      const day = formatDate(msg.createdAt || now());
      if (day !== lastDay){
        lastDay = day;
        html += `<div class="dayline">${escapeHtml(day)}</div>`;
      }
      html += renderMessage(msg);
    }
    messagesEl.innerHTML = html;

    messagesEl.querySelectorAll('.msg').forEach(node => {
      const mid = node.getAttribute('data-mid');

      node.addEventListener('click', (ev) => {
        const target = ev.target;
        if (target.closest('button')) return;
        messagesEl.querySelectorAll('.msg.showActions').forEach(n => { if (n !== node) n.classList.remove('showActions'); });
        node.classList.toggle('showActions');
      });

      bindLongPress(node, mid);
    });

    messagesEl.querySelectorAll('[data-act]').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const act = btn.getAttribute('data-act');
        const mid = btn.getAttribute('data-mid');
        handleMsgAction(act, mid);
      });
    });

    bindCodeCopy(messagesEl);
    scrollToBottom(true);
    hydrateSessionPromptUI();
  }

  function renderMessage(msg){
    const role = msg.role;
    const content = msg.content || '';
    const ts = msg.createdAt || now();
    const token = msg.meta?.tokens ?? approxTokens(content);
    const ms = msg.meta?.ms;
    const metaBits = [formatClock(ts)];
    if (ms != null) metaBits.push(`${ms}ms`);
    metaBits.push(`~${token}t`);

    const actionBtns = role === 'assistant'
      ? `
        <div class="actionsRow">
          <button class="actBtn" data-act="copy" data-mid="${escapeHtml(msg.id)}">å¤åˆ¶</button>
          <button class="actBtn" data-act="translate" data-mid="${escapeHtml(msg.id)}">ç¿»è¯‘</button>
          <button class="actBtn" data-act="regen" data-mid="${escapeHtml(msg.id)}">é‡æ–°ç”Ÿæˆ</button>
          <button class="actBtn danger" data-act="delete" data-mid="${escapeHtml(msg.id)}">åˆ é™¤</button>
        </div>
      `
      : `
        <div class="actionsRow">
          <button class="actBtn" data-act="copy" data-mid="${escapeHtml(msg.id)}">å¤åˆ¶</button>
          <button class="actBtn" data-act="translate" data-mid="${escapeHtml(msg.id)}">ç¿»è¯‘</button>
          <button class="actBtn" data-act="edit" data-mid="${escapeHtml(msg.id)}">ç¼–è¾‘é‡å‘</button>
          <button class="actBtn danger" data-act="delete" data-mid="${escapeHtml(msg.id)}">åˆ é™¤</button>
        </div>
      `;

    const inner = renderMarkdown(content);
    return `
      <div class="msg ${role === 'user' ? 'user':'ai'}" data-mid="${escapeHtml(msg.id)}">
        <div class="msgRow"><div class="bubble">${inner}</div></div>
        ${actionBtns}
        <div class="meta"><span class="pill">${escapeHtml(metaBits.join(' Â· '))}</span></div>
      </div>
    `;
  }

  function scrollToBottom(force=false){
    const nearBottom = messagesEl.scrollHeight - (messagesEl.scrollTop + messagesEl.clientHeight) < 140;
    if (force || nearBottom) messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function updateHeaderStatus(){
    const online = navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿';
    const cfg = isProbablyConfigured(state) ? 'å·²é…ç½® API' : 'æœªé…ç½® API';
    const model = (state.settings.model || '').trim() || 'æœªæŒ‡å®šæ¨¡å‹';
    sessionSubEl.textContent = `${online} Â· ${cfg} Â· ${model}`;
  }

  function updateModelChip(){
    const m = (state.settings.model || '').trim();
    modelChipText.textContent = m || 'æœªè®¾ç½®æ¨¡å‹';
  }

  function focusInput(){ setTimeout(() => inputEl?.focus(), 60); }

  /* -------------------------- Long Press -------------------------- */
  function bindLongPress(node, msgId){
    node.addEventListener('pointerdown', () => {
      runtime.longPressMoved = false;
      if (runtime.longPressTimer) clearTimeout(runtime.longPressTimer);
      runtime.longPressTimer = setTimeout(() => {
        if (!runtime.longPressMoved) openMsgSheet(msgId);
      }, 420);
    });
    node.addEventListener('pointermove', () => {
      runtime.longPressMoved = true;
      if (runtime.longPressTimer) clearTimeout(runtime.longPressTimer);
    }, {passive:true});
    node.addEventListener('pointerup', () => { if (runtime.longPressTimer) clearTimeout(runtime.longPressTimer); });
    node.addEventListener('pointercancel', () => { if (runtime.longPressTimer) clearTimeout(runtime.longPressTimer); });
  }

  function getMsgById(mid){
    const s = activeSession();
    return s?.messages?.find(m => m.id === mid) || null;
  }

  function openMsgSheet(mid){
    const msg = getMsgById(mid);
    if (!msg) return;

    sheetTitle.textContent = msg.role === 'user' ? 'ç”¨æˆ·æ¶ˆæ¯' : 'AI æ¶ˆæ¯';
    sheetBody.innerHTML = '';

    const items = [];
    items.push({ key:'copy', icon:'â§‰', text:'å¤åˆ¶å†…å®¹', hint:'å¤åˆ¶åˆ°å‰ªè´´æ¿' });
    items.push({ key:'translate', icon:'ğŸŒ', text:'ç¿»è¯‘', hint:'ç¿»è¯‘æˆä¸­/è‹±' });

    if (msg.role === 'user') items.push({ key:'edit', icon:'âœ', text:'ç¼–è¾‘å¹¶é‡å‘', hint:'ä»æ­¤å¤„é‡æ–°ç”Ÿæˆ' });
    else items.push({ key:'regen', icon:'â†»', text:'é‡æ–°ç”Ÿæˆ', hint:'åŸºäºåŒä¸€ä¸Šä¸‹æ–‡' });

    items.push({ key:'delete', icon:'ğŸ—‘', text:'åˆ é™¤æ­¤æ¡', hint:'ä»å¯¹è¯ä¸­ç§»é™¤', danger:true });

    items.forEach(it => {
      const div = document.createElement('div');
      div.className = 'sheetItem' + (it.danger ? ' danger' : '');
      div.innerHTML = `
        <div class="left"><div class="sIcon">${it.icon}</div><div>${escapeHtml(it.text)}</div></div>
        <div class="right">${escapeHtml(it.hint || '')}</div>
      `;
      div.onclick = () => { closeSheet(); handleMsgAction(it.key, mid); };
      sheetBody.appendChild(div);
    });

    openSheet();
  }

  function openSheet(){
    actionSheet.classList.add('show');
    backdrop.classList.add('show');
  }
  function closeSheet(){
    actionSheet.classList.remove('show');
    syncBackdrop();
  }

  /* -------------------------- Actions -------------------------- */
  async function handleMsgAction(action, mid){
    const s = activeSession();
    const msg = getMsgById(mid);
    if (!s || !msg) return;

    if (action === 'copy') {
      try{ await navigator.clipboard.writeText(msg.content || ''); showToast('å·²å¤åˆ¶æ¶ˆæ¯', null, null, 1200); }
      catch{ showToast('å¤åˆ¶å¤±è´¥ï¼šå‰ªè´´æ¿æƒé™å—é™', null, null, 1800); }
      return;
    }

    if (action === 'translate') {
      openTranslateSheet(mid);
      return;
    }

    if (action === 'delete') {
      if (runtime.isStreaming) stopStreaming();
      removeMessage(s.id, mid);
      saveState();
      renderAll();
      return;
    }

    if (action === 'edit') {
      inputEl.value = msg.content || '';
      autosizeInput();
      runtime.editTarget = { msgId: mid, mode:'edit-resend' };
      showToast('å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼šå‘é€åå°†ä»æ­¤å¤„é‡ç®—', 'å–æ¶ˆ', () => {
        runtime.editTarget = null;
        showToast('å·²å–æ¶ˆç¼–è¾‘æ¨¡å¼', null, null, 1200);
      }, 3500);
      focusInput();
      updateCounter();
      scheduleComposerMetrics();
      return;
    }

    if (action === 'regen') {
      if (runtime.isStreaming) stopStreaming();
      await regenerateFromAssistant(mid);
      return;
    }
  }

  function openTranslateSheet(mid){
    const msg = getMsgById(mid);
    if (!msg) return;

    sheetTitle.textContent = 'ç¿»è¯‘';
    sheetBody.innerHTML = '';

    const items = [
      { key:'to_zh', icon:'ğŸ‡¨ğŸ‡³', text:'ç¿»è¯‘æˆä¸­æ–‡', hint:'ä¿æŒåŸæ„' },
      { key:'to_en', icon:'ğŸ‡ºğŸ‡¸', text:'Translate to English', hint:'Keep meaning' }
    ];

    items.forEach(it => {
      const div = document.createElement('div');
      div.className = 'sheetItem';
      div.innerHTML = `
        <div class="left"><div class="sIcon">${it.icon}</div><div>${escapeHtml(it.text)}</div></div>
        <div class="right">${escapeHtml(it.hint)}</div>
      `;
      div.onclick = () => {
        closeSheet();
        const raw = msg.content || '';
        if (it.key === 'to_zh') sendUserMessage(`è¯·æŠŠä¸‹é¢å†…å®¹ç¿»è¯‘æˆä¸­æ–‡ï¼Œä¿æŒåŸæ„ï¼Œå°½é‡è‡ªç„¶ï¼š\n\n${raw}`);
        if (it.key === 'to_en') sendUserMessage(`Please translate the following into natural English, preserving the meaning:\n\n${raw}`);
      };
      sheetBody.appendChild(div);
    });

    openSheet();
  }

  async function regenerateFromAssistant(assistantMsgId){
    const s = activeSession();
    if (!s) return;
    const idx = s.messages.findIndex(m => m.id === assistantMsgId);
    if (idx < 0) return;

    const rev = s.messages.slice(0, idx).reverse();
    const revUser = rev.find(m => m.role === 'user');
    if (!revUser) { showToast('æ‰¾ä¸åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ', null, null, 1800); return; }

    s.messages = s.messages.slice(0, idx);
    saveState();
    renderAll();

    await sendUserMessage(revUser.content || '', { resendContext: true });
  }

  /* -------------------------- Input -------------------------- */
  function autosizeInput(){
    inputEl.style.height = 'auto';
    inputEl.style.height = clamp(inputEl.scrollHeight, 44, 160) + 'px';
  }

  function updateCounter(){
    const t = inputEl.value || '';
    const chars = t.length;
    const toks = chars ? approxTokens(t) : 0;
    counterHintEl.textContent = `${chars}å­— Â· ~${toks} tokens`;

    if (runtime.editTarget) {
      draftHintEl.textContent = `ç¼–è¾‘æ¨¡å¼ï¼šå‘é€åå°†ä»æŒ‡å®šæ¶ˆæ¯é‡æ–°ç”Ÿæˆï¼ˆç‚¹å‡»æç¤ºå¯å–æ¶ˆï¼‰`;
      draftHintEl.style.cursor = 'pointer';
      draftHintEl.onclick = () => { runtime.editTarget = null; updateCounter(); showToast('å·²å–æ¶ˆç¼–è¾‘æ¨¡å¼', null, null, 1200); };
    } else {
      draftHintEl.textContent = 'æç¤ºï¼šåŒå‡»è¾“å…¥æ¡†å°è¯•ä»å‰ªè´´æ¿ç²˜è´´';
      draftHintEl.style.cursor = 'default';
      draftHintEl.onclick = null;
    }

    sendBtn.disabled = runtime.isStreaming || !t.trim();
  }

  const debounce = (fn, ms=200) => {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  };

  const saveDraftDebounced = debounce(() => {
    const drafts = loadDrafts();
    drafts[state.activeSessionId] = inputEl.value || '';
    saveDrafts(drafts);
  }, 220);

  function restoreDraft(){
    const drafts = loadDrafts();
    inputEl.value = drafts[state.activeSessionId] || '';
    autosizeInput();
    updateCounter();
    scheduleComposerMetrics();
  }

  function pushSendHistory(text){
    const t = (text || '').trim();
    if (!t) return;
    state.sendHistory = state.sendHistory || [];
    state.sendHistory = [t, ...state.sendHistory.filter(x => x !== t)].slice(0, 50);
  }

  /* -------------------------- Viewport / Keyboard -------------------------- */
  function updateViewportOffset(){
    const vv = window.visualViewport;
    let offset = 0;
    if (vv) {
      offset = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
    }
    document.documentElement.style.setProperty('--kb', offset + 'px');
    scheduleComposerMetrics();
  }

  let composerRaf = 0;
  function scheduleComposerMetrics(){
    if (composerRaf) cancelAnimationFrame(composerRaf);
    composerRaf = requestAnimationFrame(() => {
      composerRaf = 0;
      updateComposerMetrics();
    });
  }

  function updateComposerMetrics(){
    const rect = composerEl.getBoundingClientRect();
    const h = Math.max(80, Math.round(rect.height));
    document.documentElement.style.setProperty('--composerH', h + 'px');
  }

  /* -------------------------- Theme -------------------------- */
  function hexToRgb(hex){
    const h = (hex || '').trim();
    const m = /^#?([0-9a-f]{6})$/i.exec(h);
    if (!m) return null;
    const n = parseInt(m[1], 16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }

  function applyTheme(){
    const mode = state.settings.themeMode || 'system';
    let theme = mode;
    if (mode === 'system') theme = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    app.setAttribute('data-theme', theme);

    const acc = (state.settings.accent || '#5b8cff').trim();
    const rgb = hexToRgb(acc);
    if (rgb) document.documentElement.style.setProperty('--accent', acc);

    const fs = clamp(parseFloat(state.settings.fontScale || 1), 0.85, 1.35);
    document.documentElement.style.setProperty('--fontScale', String(fs));

    const meta = document.querySelector('meta[name="theme-color"]');
    const themeColor = theme === 'light' ? '#ffffff' : '#111827';
    if (meta) meta.setAttribute('content', themeColor);
  }

  /* -------------------------- Settings UI -------------------------- */
  function populatePresets(){
    presetSelect.innerHTML = PRESETS.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('');
  }
  function applyPreset(presetId){
    const p = PRESETS.find(x => x.id === presetId);
    if (!p) return;
    baseUrlEl.value = p.baseUrl;
    modelEl.value = p.model;
    extraHeadersEl.value = p.extraHeaders || '';
    state.settings.lastPreset = presetId;
    showToast(`å·²é€‰æ‹©é¢„è®¾ï¼š${p.name}`, null, null, 1200);
  }

  function hydrateSettingsUI(){
    presetSelect.value = state.settings.lastPreset || 'openai';
    baseUrlEl.value = state.settings.baseUrl || '';
    apiKeyEl.value = state.settings.apiKey || '';
    rememberKeyEl.checked = !!state.settings.rememberKey;
    modelEl.value = state.settings.model || '';
    extraHeadersEl.value = state.settings.extraHeaders || '';
    temperatureEl.value = state.settings.temperature ?? 0.7;
    topPEl.value = state.settings.top_p ?? 1;
    maxTokensEl.value = state.settings.max_tokens ?? '';

    globalSystemPromptEl.value = state.globalSystemPrompt || '';
    themeModeEl.value = state.settings.themeMode || 'system';
    accentColorEl.value = state.settings.accent || '#5b8cff';
    fontScaleEl.value = state.settings.fontScale ?? 1.0;

    templateJsonEl.value = JSON.stringify(state.templates || [], null, 2);
    renderPromptChips();
    hydrateSessionPromptUI();
  }

  function hydrateSessionPromptUI(){
    const s = activeSession();
    if (sessionSystemPromptEl) sessionSystemPromptEl.value = s?.systemPrompt || '';
  }

  function renderPromptChips(){
    if (!promptChipsEl) return;
    promptChipsEl.innerHTML = '';
    (state.templates || []).forEach(t => {
      const chip = document.createElement('button');
      chip.className = 'chip';
      chip.textContent = t.name || 'æ¨¡æ¿';
      chip.onclick = () => { sessionSystemPromptEl.value = t.prompt || ''; showToast(`å·²å¡«å…¥æ¨¡æ¿ï¼š${t.name}`, null, null, 1200); };
      promptChipsEl.appendChild(chip);
    });
  }

  /* -------------------------- Sidebar / Drawer / Backdrop -------------------------- */
  function syncBackdrop(){
    const show = sidebar.classList.contains('show') || settingsDrawer.classList.contains('show') || actionSheet.classList.contains('show') || onboarding.classList.contains('show');
    if (show) backdrop.classList.add('show');
    else backdrop.classList.remove('show');
  }

  function openSidebar(){ sidebar.classList.add('show'); syncBackdrop(); }
  function closeSidebar(){ sidebar.classList.remove('show'); syncBackdrop(); }

  function openSettings(tab='api'){ settingsDrawer.classList.add('show'); switchTab(tab); syncBackdrop(); }
  function closeSettings(){ settingsDrawer.classList.remove('show'); syncBackdrop(); }

  function switchTab(tabName){
    tabsEl.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.getAttribute('data-tab') === tabName));
    settingsDrawer.querySelectorAll('.tabPane').forEach(p => p.style.display = p.getAttribute('data-tabpane') === tabName ? '' : 'none');
  }

  /* -------------------------- Toast -------------------------- */
  function showToast(text, btnText=null, btnHandler=null, ms=2200){
    clearTimeout(runtime.toastTimer);
    toastText.textContent = text;
    if (btnText && btnHandler) {
      toastBtn.style.display = '';
      toastBtn.textContent = btnText;
      toastBtn.onclick = () => { toast.classList.remove('show'); btnHandler(); };
    } else {
      toastBtn.style.display = 'none';
      toastBtn.onclick = null;
    }
    toast.classList.add('show');
    runtime.toastTimer = setTimeout(() => toast.classList.remove('show'), ms);
  }

  /* -------------------------- API helpers -------------------------- */
  function buildMessagesForRequest(sessionId){
    const s = state.sessions[sessionId];
    if (!s) return [];
    const sys = (s.systemPrompt || '').trim() || (state.globalSystemPrompt || '').trim();
    const msgs = [];
    if (sys) msgs.push({ role:'system', content: sys });
    for (const m of s.messages) {
      if (!m.content) continue;
      if (m.role === 'user' || m.role === 'assistant' || m.role === 'system') msgs.push({ role: m.role, content: m.content });
    }
    return msgs;
  }

  function buildRequestPayload(messages){
    const st = state.settings;
    const body = { model: (st.model || '').trim(), messages, stream: true };
    const temp = parseFloat(st.temperature);
    if (!Number.isNaN(temp)) body.temperature = temp;
    const topP = parseFloat(st.top_p);
    if (!Number.isNaN(topP)) body.top_p = topP;

    const mt = (st.max_tokens ?? '').toString().trim();
    if (mt) {
      const n = parseInt(mt, 10);
      if (!Number.isNaN(n) && n > 0) body.max_tokens = n;
    }
    return body;
  }

  function buildHeaders(){
    const st = state.settings;
    const headers = { 'Content-Type': 'application/json' };
    const key = (st.apiKey || '').trim();
    if (key) headers['Authorization'] = `Bearer ${key}`;

    const extra = (st.extraHeaders || '').trim();
    if (extra) {
      const obj = safeJsonParse(extra, null);
      if (obj && typeof obj === 'object') {
        for (const [k,v] of Object.entries(obj)) headers[k] = String(v);
      }
    }
    return headers;
  }

  function buildEndpoint(){
    const base = trimUrl(state.settings.baseUrl);
    if (!base) return '';
    return base + '/v1/chat/completions';
  }

  async function safeReadText(res){ try{ return await res.text(); }catch{ return ''; } }

  /* -------------------------- Streaming -------------------------- */
  async function sendUserMessage(text, opts = {}){
    const content = (text || '').trim();
    if (!content) return;

    if (!isProbablyConfigured(state)) {
      onboarding.classList.add('show');
      syncBackdrop();
      showToast('è¯·å…ˆé…ç½® API', 'å»è®¾ç½®', () => openSettings('api'), 3500);
      return;
    }

    const s = activeSession();
    const sid = s.id;

    if (content.startsWith('/')) { if (handleCommand(content)) return; }

    if (runtime.editTarget && runtime.editTarget.mode === 'edit-resend') {
      const targetId = runtime.editTarget.msgId;
      const idx = s.messages.findIndex(m => m.id === targetId && m.role === 'user');
      if (idx >= 0) {
        s.messages[idx].content = content;
        s.messages[idx].createdAt = now();
        s.messages[idx].meta = { tokens: approxTokens(content) };
        s.messages = s.messages.slice(0, idx + 1);
        runtime.editTarget = null;
      } else runtime.editTarget = null;
    } else if (!opts.resendContext) {
      const um = { id: uid('m'), role:'user', content, createdAt: now(), meta: { tokens: approxTokens(content) } };
      upsertMessage(sid, um);
      autoNameIfNeeded(sid);
    }

    pushSendHistory(content);
    inputEl.value = '';
    autosizeInput();
    updateCounter();
    saveDraftDebounced();
    saveState();
    renderAll();

    const am = { id: uid('m'), role:'assistant', content:'', createdAt: now(), meta: {} };
    upsertMessage(sid, am);
    runtime.streamMsgId = am.id;
    runtime.isStreaming = true;
    runtime.lastError = null;

    typingEl.style.display = '';
    stopBtn.classList.add('show');
    sendBtn.disabled = true;
    saveState();
    renderAll();

    const requestMessages = buildMessagesForRequest(sid);
    const payload = buildRequestPayload(requestMessages);
    const url = buildEndpoint();
    const headers = buildHeaders();

    const controller = new AbortController();
    runtime.aborter = controller;
    const t0 = performance.now();

    runtime.lastSendContext = { sid, url, headers, payload, assistantMsgId: am.id };

    try{
      const res = await fetch(url, { method:'POST', headers, body: JSON.stringify(payload), signal: controller.signal });

      if (!res.ok) {
        const txt = await safeReadText(res);
        throw new Error(`HTTP ${res.status}ï¼š${txt || res.statusText || 'è¯·æ±‚å¤±è´¥'}`);
      }
      if (!res.body) throw new Error('å“åº”ä¸æ”¯æŒæµå¼ï¼ˆres.body ä¸ºç©ºï¼‰');

      await consumeOpenAISSEStream(res.body, (delta) => {
        if (!runtime.isStreaming) return;
        const s2 = state.sessions[sid];
        if (!s2) return;
        const m = s2.messages.find(x => x.id === am.id);
        if (!m) return;
        m.content += delta;
        scheduleLiveRender(am.id);
      });

      finalizeStream(true, Math.round(performance.now() - t0));
    } catch (err) {
      if (err?.name === 'AbortError') finalizeStream(false, Math.round(performance.now() - t0), 'å·²åœæ­¢ç”Ÿæˆ');
      else finalizeStream(false, Math.round(performance.now() - t0), err?.message || String(err));
    }
  }

  const liveRenderQueue = new Set();
  let liveRaf = 0;

  function scheduleLiveRender(mid){
    liveRenderQueue.add(mid);
    if (!liveRaf) {
      liveRaf = requestAnimationFrame(() => {
        liveRaf = 0;
        for (const id of liveRenderQueue) liveRenderMessage(id);
        liveRenderQueue.clear();
      });
    }
  }

  function liveRenderMessage(mid){
    const node = messagesEl.querySelector(`.msg[data-mid="${CSS.escape(mid)}"] .bubble`);
    const msg = getMsgById(mid);
    if (!node || !msg) return;
    node.innerHTML = renderMarkdown(msg.content || '');
    bindCodeCopy(node);
    scrollToBottom(false);
  }

  async function consumeOpenAISSEStream(body, onDelta){
    const reader = body.getReader();
    const decoder = new TextDecoder('utf-8');
    let buf = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream:true });

      let idx;
      while ((idx = buf.indexOf('\n')) !== -1) {
        const line = buf.slice(0, idx).trimEnd();
        buf = buf.slice(idx + 1);
        if (!line) continue;
        if (!line.startsWith('data:')) continue;

        const data = line.replace(/^data:\s*/, '');
        if (data === '[DONE]') return;

        const j = safeJsonParse(data, null);
        if (!j) continue;

        const delta = j?.choices?.[0]?.delta?.content ?? j?.choices?.[0]?.message?.content ?? '';
        if (delta) onDelta(delta);
      }
    }
  }

  function finalizeStream(ok, elapsedMs, note=''){
    const sid = runtime.lastSendContext?.sid || state.activeSessionId;
    const mid = runtime.streamMsgId;

    runtime.isStreaming = false;
    runtime.aborter = null;
    typingEl.style.display = 'none';
    stopBtn.classList.remove('show');
    updateCounter();

    const s = state.sessions[sid];
    if (s && mid) {
      const m = s.messages.find(x => x.id === mid);
      if (m) {
        m.meta = m.meta || {};
        m.meta.ms = elapsedMs;
        m.meta.tokens = approxTokens(m.content || '');
        if (!ok && note) {
          const errLine = `\n\n> âš ï¸ ${note}\n`;
          m.content = (m.content || '') + errLine;
          m.meta.tokens = approxTokens(m.content || '');
          runtime.lastError = note;
          showToast('è¯·æ±‚å¤±è´¥', 'é‡è¯•', () => retryLast(), 4200);
        }
      }
    }
    saveState();
    renderAll();
  }

  function stopStreaming(){
    try{ runtime.aborter?.abort(); }catch{}
    runtime.isStreaming = false;
    typingEl.style.display = 'none';
    stopBtn.classList.remove('show');
    updateCounter();
  }

  async function retryLast(){
    const ctx = runtime.lastSendContext;
    if (!ctx) return;

    const s = state.sessions[ctx.sid];
    if (!s) return;

    s.messages = s.messages.filter(m => m.id !== ctx.assistantMsgId);

    const am = { id: uid('m'), role:'assistant', content:'', createdAt: now(), meta:{} };
    upsertMessage(ctx.sid, am);
    runtime.streamMsgId = am.id;

    saveState();
    renderAll();

    runtime.isStreaming = true;
    typingEl.style.display = '';
    stopBtn.classList.add('show');
    sendBtn.disabled = true;

    const controller = new AbortController();
    runtime.aborter = controller;
    const t0 = performance.now();

    try{
      const res = await fetch(ctx.url, { method:'POST', headers: ctx.headers, body: JSON.stringify(ctx.payload), signal: controller.signal });
      if (!res.ok) {
        const txt = await safeReadText(res);
        throw new Error(`HTTP ${res.status}ï¼š${txt || res.statusText || 'è¯·æ±‚å¤±è´¥'}`);
      }
      if (!res.body) throw new Error('å“åº”ä¸æ”¯æŒæµå¼ï¼ˆres.body ä¸ºç©ºï¼‰');

      await consumeOpenAISSEStream(res.body, (delta) => {
        if (!runtime.isStreaming) return;
        const s2 = state.sessions[ctx.sid];
        const m = s2?.messages?.find(x => x.id === am.id);
        if (!m) return;
        m.content += delta;
        scheduleLiveRender(am.id);
      });

      finalizeStream(true, Math.round(performance.now() - t0));
    } catch (err) {
      if (err?.name === 'AbortError') finalizeStream(false, Math.round(performance.now() - t0), 'å·²åœæ­¢ç”Ÿæˆ');
      else finalizeStream(false, Math.round(performance.now() - t0), err?.message || String(err));
    }
  }

  /* -------------------------- Commands -------------------------- */
  function handleCommand(cmd){
    const c = cmd.trim().toLowerCase();
    if (c === '/clear') { clearSessionMessages(state.activeSessionId); showToast('å·²æ¸…ç©ºå½“å‰ä¼šè¯', null, null, 1200); return true; }
    if (c === '/help') { openSettings('help'); return true; }
    if (c === '/settings') { openSettings('api'); return true; }
    showToast('æœªçŸ¥æŒ‡ä»¤ï¼š/clear /help /settings', null, null, 2200);
    return true;
  }

  /* -------------------------- API Settings actions -------------------------- */
  function saveApiSettings(){
    state.settings.baseUrl = trimUrl(baseUrlEl.value);
    state.settings.apiKey = (apiKeyEl.value || '').trim();
    state.settings.rememberKey = !!rememberKeyEl.checked;
    state.settings.model = (modelEl.value || '').trim();
    state.settings.extraHeaders = (extraHeadersEl.value || '').trim();
    state.settings.temperature = parseFloat(temperatureEl.value || '0.7');
    state.settings.top_p = parseFloat(topPEl.value || '1');
    state.settings.max_tokens = (maxTokensEl.value || '').toString().trim();

    saveState();
    updateHeaderStatus();
    updateModelChip();
    showToast('å·²ä¿å­˜ API é…ç½®', null, null, 1200);
  }

  async function testApi(){
    saveApiSettings();
    if (!isProbablyConfigured(state)) { showToast('è¯·è¡¥å…¨ Base URL / API Key / Model', null, null, 2200); return; }

    const url = buildEndpoint();
    const headers = buildHeaders();
    const body = buildRequestPayload([{role:'system', content:'You are a helpful assistant.'},{role:'user', content:'Reply with the single word: OK'}]);
    body.stream = false;

    const t0 = performance.now();
    try{
      const res = await fetch(url, { method:'POST', headers, body: JSON.stringify(body) });
      if (!res.ok) { const txt = await safeReadText(res); throw new Error(`HTTP ${res.status}ï¼š${txt || res.statusText}`); }
      const j = await res.json().catch(() => null);
      const content = j?.choices?.[0]?.message?.content || '';
      const ms = Math.round(performance.now() - t0);
      showToast(`è¿æ¥æ­£å¸¸ï¼ˆ${ms}msï¼‰ï¼š${content.trim().slice(0, 40) || 'OK'}`, null, null, 2400);
    }catch(err){
      showToast(`æµ‹è¯•å¤±è´¥ï¼š${err?.message || String(err)}`, null, null, 3500);
    }
  }

  function exportConfig(){
    const cfg = { ver: APP_VER, settings: structuredCloneSafe(state.settings), globalSystemPrompt: state.globalSystemPrompt || '', templates: structuredCloneSafe(state.templates || []) };
    if (!cfg.settings.rememberKey) cfg.settings.apiKey = '';
    downloadJson(`mchat_config_${formatDate(now())}.json`, cfg);
    showToast('å·²å¯¼å‡ºé…ç½® JSON', null, null, 1400);
  }

  function importConfigFromObject(cfg){
    if (!cfg || typeof cfg !== 'object') throw new Error('é…ç½®æ ¼å¼é”™è¯¯');
    if (cfg.settings) {
      state.settings = Object.assign(state.settings, cfg.settings);
      if (!state.settings.rememberKey && cfg.settings.apiKey) state.settings.apiKey = cfg.settings.apiKey;
    }
    if (typeof cfg.globalSystemPrompt === 'string') state.globalSystemPrompt = cfg.globalSystemPrompt;
    if (Array.isArray(cfg.templates)) state.templates = cfg.templates;

    saveState();
    renderAll();
  }

  function exportAll(){ downloadJson(`mchat_all_${formatDate(now())}.json`, structuredCloneSafe(state)); showToast('å·²å¯¼å‡ºå…¨éƒ¨æ•°æ®', null, null, 1400); }

  function importAllFromObject(all){
    if (!all || typeof all !== 'object') throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
    downloadJson(`mchat_backup_before_import_${formatDate(now())}.json`, structuredCloneSafe(state));

    state.ver = all.ver || APP_VER;
    state.settings = Object.assign(state.settings, all.settings || {});
    state.globalSystemPrompt = all.globalSystemPrompt || '';
    state.templates = Array.isArray(all.templates) ? all.templates : DEFAULT_TEMPLATES.slice();
    state.sessions = all.sessions && typeof all.sessions === 'object' ? all.sessions : {};
    state.activeSessionId = all.activeSessionId || '';
    state.sendHistory = Array.isArray(all.sendHistory) ? all.sendHistory : [];

    if (!state.activeSessionId || !state.sessions[state.activeSessionId]) {
      const sid = createSessionObject('æ–°ä¼šè¯');
      state.sessions[sid.id] = sid;
      state.activeSessionId = sid.id;
    }
    saveState();
    renderAll();
  }

  function wipeAll(){
    downloadJson(`mchat_backup_before_wipe_${formatDate(now())}.json`, structuredCloneSafe(state));
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_DRAFT_KEY);
    localStorage.removeItem(LS_VOLATILE_KEY);
    location.reload();
  }

  function saveGlobalPrompt(){ state.globalSystemPrompt = globalSystemPromptEl.value || ''; saveState(); showToast('å·²ä¿å­˜å…¨å±€ System Prompt', null, null, 1200); }
  function saveSessionPrompt(){
    const s = activeSession(); if (!s) return;
    s.systemPrompt = sessionSystemPromptEl.value || '';
    s.updatedAt = now();
    saveState();
    showToast('å·²ä¿å­˜ä¼šè¯ System Prompt', null, null, 1200);
  }
  function applyGlobalToSession(){
    const s = activeSession(); if (!s) return;
    s.systemPrompt = state.globalSystemPrompt || '';
    s.updatedAt = now();
    saveState();
    renderAll();
    showToast('å·²åº”ç”¨åˆ°å½“å‰ä¼šè¯', null, null, 1200);
  }

  function saveTemplates(){
    const t = safeJsonParse(templateJsonEl.value || '', null);
    if (!Array.isArray(t)) { showToast('æ¨¡æ¿ JSON æ ¼å¼ä¸æ­£ç¡®ï¼ˆåº”ä¸ºæ•°ç»„ï¼‰', null, null, 2200); return; }
    state.templates = t.map(x => ({ name: String(x?.name || 'æ¨¡æ¿'), prompt: String(x?.prompt || '') }));
    saveState();
    renderAll();
    showToast('å·²ä¿å­˜æ¨¡æ¿', null, null, 1200);
  }
  function resetTemplates(){ state.templates = DEFAULT_TEMPLATES.slice(); saveState(); renderAll(); showToast('å·²æ¢å¤å†…ç½®æ¨¡æ¿', null, null, 1200); }

  /* -------------------------- Model Picker (bottom chip) -------------------------- */
  function openModelPicker(){
    sheetTitle.textContent = 'é€‰æ‹©æ¨¡å‹';
    sheetBody.innerHTML = '';

    const current = (state.settings.model || '').trim();
    const models = [];
    if (current) models.push(current);
    PRESETS.forEach(p => { if (p.model && !models.includes(p.model)) models.push(p.model); });

    models.forEach(m => {
      const div = document.createElement('div');
      div.className = 'sheetItem';
      div.innerHTML = `
        <div class="left"><div class="sIcon">ğŸ¤–</div><div>${escapeHtml(m)}</div></div>
        <div class="right">${m === current ? 'å½“å‰' : ''}</div>
      `;
      div.onclick = () => {
        closeSheet();
        state.settings.model = m;
        modelEl.value = m;
        saveState();
        renderAll();
        showToast('å·²åˆ‡æ¢æ¨¡å‹ï¼š' + m, null, null, 1400);
      };
      sheetBody.appendChild(div);
    });

    const divEdit = document.createElement('div');
    divEdit.className = 'sheetItem';
    divEdit.innerHTML = `
      <div class="left"><div class="sIcon">âš™ï¸</div><div>å»è®¾ç½®é‡Œç¼–è¾‘æ¨¡å‹â€¦</div></div>
      <div class="right">API</div>
    `;
    divEdit.onclick = () => {
      closeSheet();
      openSettings('api');
      setTimeout(() => modelEl?.focus(), 80);
    };
    sheetBody.appendChild(divEdit);

    openSheet();
  }

  /* -------------------------- Info Sheet -------------------------- */
  function openInfoSheet(){
    const s = activeSession();
    const msgs = s?.messages || [];
    const totalChars = msgs.reduce((a,m) => a + (m.content||'').length, 0);
    const totalTokens = msgs.reduce((a,m) => a + (m.meta?.tokens ?? approxTokens(m.content||'')), 0);
    const lastMs = msgs.slice().reverse().find(m => m.role==='assistant' && m.meta?.ms != null)?.meta?.ms;

    sheetTitle.textContent = 'ä¿¡æ¯ä¸ç»Ÿè®¡';
    sheetBody.innerHTML = `
      <div class="section" style="margin:8px;">
        <div class="small">
          <p><b>ä¼šè¯ï¼š</b>${escapeHtml(s?.title || 'â€”')}</p>
          <p><b>æ¶ˆæ¯æ•°ï¼š</b>${msgs.length}</p>
          <p><b>å­—ç¬¦æ•°ï¼š</b>${totalChars}</p>
          <p><b>Token ä¼°ç®—ï¼š</b>~${totalTokens}</p>
          <p><b>æœ€è¿‘ä¸€æ¬¡è€—æ—¶ï¼š</b>${lastMs != null ? lastMs + 'ms' : 'â€”'}</p>
          <p><b>ç½‘ç»œï¼š</b>${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}</p>
          <p><b>æ¥å£ï¼š</b><code class="inline">${escapeHtml(buildEndpoint() || 'æœªé…ç½®')}</code></p>
        </div>
      </div>
    `;
    openSheet();
  }

  /* -------------------------- PWA -------------------------- */
  function setupManifest(){
    const theme = app.getAttribute('data-theme') || 'dark';
    const bg = theme === 'light' ? '#ffffff' : '#111827';
    const manifest = {
      name: "Mobile AI Chat",
      short_name: "AI Chat",
      start_url: ".",
      display: "standalone",
      background_color: bg,
      theme_color: bg,
      icons: [{ src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192'%3E%3Crect width='192' height='192' rx='44' fill='%23111827'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='96' fill='%23ffffff'%3EAI%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" }]
    };
    const dataUrl = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
    el('manifestLink').setAttribute('href', dataUrl);
  }

  function setupServiceWorkerBestEffort(){
    if (!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE = 'mchat-singlefile-v1';
      self.addEventListener('install', (e) => {
        e.waitUntil((async () => {
          const cache = await caches.open(CACHE);
          try { await cache.addAll([self.registration.scope]); } catch {}
          self.skipWaiting();
        })());
      });
      self.addEventListener('activate', (e) => {
        e.waitUntil((async () => {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => k !== CACHE ? caches.delete(k) : null));
          self.clients.claim();
        })());
      });
      self.addEventListener('fetch', (e) => {
        const req = e.request;
        if (req.method !== 'GET') return;
        e.respondWith((async () => {
          const cache = await caches.open(CACHE);
          const cached = await cache.match(req, { ignoreSearch:true });
          if (cached) return cached;
          try{
            const res = await fetch(req);
            if (res && res.ok) cache.put(req, res.clone());
            return res;
          }catch{
            return cached || Response.error();
          }
        })());
      });
    `;
    try{
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(() => {});
    }catch{}
  }

  /* -------------------------- Events -------------------------- */
  el('btnMenu').onclick = () => openSidebar();
  el('btnCloseSidebar').onclick = () => closeSidebar();
  el('btnSettings').onclick = () => openSettings('api');
  el('btnCloseSettings').onclick = () => closeSettings();
  el('btnInfo').onclick = () => openInfoSheet();

  el('btnNewSession').onclick = () => newSession();
  el('btnMoreSession').onclick = () => openSessionMoreSheet();

  backdrop.onclick = () => {
    closeSidebar();
    closeSettings();
    closeSheet();
    onboarding.classList.remove('show');
    syncBackdrop();
  };

  tabsEl.querySelectorAll('.tab').forEach(tab => {
    const name = tab.getAttribute('data-tab');
    tab.addEventListener('click', () => switchTab(name));
  });

  populatePresets();
  presetSelect.addEventListener('change', () => applyPreset(presetSelect.value));

  el('btnSaveApi').onclick = () => saveApiSettings();
  el('btnTestApi').onclick = () => testApi();

  el('btnExportConfig').onclick = () => exportConfig();
  el('btnImportConfig').onclick = () => el('fileImportConfig').click();
  el('fileImportConfig').addEventListener('change', async (ev) => {
    const file = ev.target.files?.[0];
    ev.target.value = '';
    if (!file) return;
    try{
      const txt = await readFileAsText(file);
      importConfigFromObject(JSON.parse(txt));
      showToast('é…ç½®å¯¼å…¥æˆåŠŸ', null, null, 1400);
    }catch(err){
      showToast('é…ç½®å¯¼å…¥å¤±è´¥ï¼š' + (err?.message || String(err)), null, null, 3200);
    }
  });

  el('btnSaveGlobalPrompt')?.addEventListener('click', () => saveGlobalPrompt());
  el('btnApplyToSession')?.addEventListener('click', () => applyGlobalToSession());
  el('btnSaveSessionPrompt')?.addEventListener('click', () => saveSessionPrompt());
  el('btnClearSessionPrompt')?.addEventListener('click', () => { sessionSystemPromptEl.value=''; saveSessionPrompt(); });

  el('btnSaveTheme')?.addEventListener('click', () => {
    state.settings.themeMode = themeModeEl.value;
    state.settings.accent = accentColorEl.value.trim() || '#5b8cff';
    state.settings.fontScale = parseFloat(fontScaleEl.value || '1') || 1;
    saveState(); renderAll();
    showToast('å·²ä¿å­˜å¤–è§‚è®¾ç½®', null, null, 1200);
  });
  el('btnResetTheme')?.addEventListener('click', () => {
    state.settings.themeMode = 'system';
    state.settings.accent = '#5b8cff';
    state.settings.fontScale = 1.0;
    saveState(); renderAll();
    showToast('å·²é‡ç½®å¤–è§‚', null, null, 1200);
  });

  el('btnRenameSession')?.addEventListener('click', () => promptRenameCurrent());
  el('btnClearSession')?.addEventListener('click', () => { clearSessionMessages(state.activeSessionId); showToast('å·²æ¸…ç©ºå½“å‰ä¼šè¯', null, null, 1200); });

  el('btnExportAll')?.addEventListener('click', () => exportAll());
  el('btnImportAll')?.addEventListener('click', () => el('fileImportAll').click());
  el('fileImportAll')?.addEventListener('change', async (ev) => {
    const file = ev.target.files?.[0];
    ev.target.value = '';
    if (!file) return;
    try{
      const txt = await readFileAsText(file);
      importAllFromObject(JSON.parse(txt));
      showToast('å¯¼å…¥æˆåŠŸï¼ˆå·²è‡ªåŠ¨å¤‡ä»½æ—§æ•°æ®ï¼‰', null, null, 1800);
    }catch(err){
      showToast('å¯¼å…¥å¤±è´¥ï¼š' + (err?.message || String(err)), null, null, 3200);
    }
  });
  el('btnWipeAll')?.addEventListener('click', () => wipeAll());

  el('btnSaveTemplates')?.addEventListener('click', () => saveTemplates());
  el('btnResetTemplates')?.addEventListener('click', () => resetTemplates());

  el('btnCloseSheet').onclick = () => closeSheet();

  el('btnGoSettings').onclick = () => { onboarding.classList.remove('show'); openSettings('api'); syncBackdrop(); };
  el('btnLater').onclick = () => { onboarding.classList.remove('show'); syncBackdrop(); showToast('ç¨åå¯åœ¨å³ä¸Šè§’ âš™ï¸ è®¾ç½® API', null, null, 2200); };

  inputEl.addEventListener('input', () => {
    autosizeInput();
    updateCounter();
    saveDraftDebounced();
    scheduleComposerMetrics();
  });

  let lastTap = 0;
  inputEl.addEventListener('pointerup', async () => {
    const t = Date.now();
    if (t - lastTap < 320) {
      try{
        const clip = await navigator.clipboard.readText();
        if (clip) {
          const before = inputEl.value;
          inputEl.value = before ? (before + '\n' + clip) : clip;
          autosizeInput();
          updateCounter();
          saveDraftDebounced();
          scheduleComposerMetrics();
          showToast('å·²ä»å‰ªè´´æ¿ç²˜è´´', null, null, 1200);
        }
      }catch{
        showToast('æ— æ³•è¯»å–å‰ªè´´æ¿ï¼ˆæƒé™é™åˆ¶ï¼‰', null, null, 1600);
      }
    }
    lastTap = t;
  });

  inputEl.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' && !ev.shiftKey) {
      ev.preventDefault();
      if (!sendBtn.disabled) sendBtn.click();
    }
  });

  sendBtn.onclick = () => sendUserMessage(inputEl.value || '');
  stopBtn.onclick = () => stopStreaming();

  modelChip.onclick = () => openModelPicker();

  window.addEventListener('online', () => { updateHeaderStatus(); showToast('å·²è”ç½‘', null, null, 1200); });
  window.addEventListener('offline', () => { updateHeaderStatus(); showToast('å·²ç¦»çº¿', null, null, 1600); });

  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', updateViewportOffset);
    window.visualViewport.addEventListener('scroll', updateViewportOffset);
  }
  window.addEventListener('resize', updateViewportOffset);

  if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
      if ((state.settings.themeMode || 'system') === 'system') {
        applyTheme();
        setupManifest();
      }
    });
  }

  document.addEventListener('click', (ev) => {
    if (ev.target.closest('.msg')) return;
    messagesEl.querySelectorAll('.msg.showActions').forEach(n => n.classList.remove('showActions'));
  });

  function openSessionMoreSheet(){
    const s = activeSession();
    sheetTitle.textContent = 'ä¼šè¯æ“ä½œ';
    sheetBody.innerHTML = '';

    const items = [
      { key:'rename', icon:'âœ', text:'é‡å‘½åå½“å‰ä¼šè¯', hint:'è‡ªå®šä¹‰æ ‡é¢˜' },
      { key:'clear', icon:'ğŸ§¹', text:'æ¸…ç©ºå½“å‰å¯¹è¯', hint:'ä¿ç•™ä¼šè¯ä½†åˆ é™¤æ¶ˆæ¯', danger:true }
    ];

    items.forEach(it => {
      const div = document.createElement('div');
      div.className = 'sheetItem' + (it.danger ? ' danger' : '');
      div.innerHTML = `
        <div class="left"><div class="sIcon">${it.icon}</div><div>${escapeHtml(it.text)}</div></div>
        <div class="right">${escapeHtml(it.hint)}</div>
      `;
      div.onclick = () => {
        closeSheet();
        if (it.key === 'rename') promptRenameCurrent();
        if (it.key === 'clear') clearSessionMessages(state.activeSessionId);
      };
      sheetBody.appendChild(div);
    });

    openSheet();
  }

  function promptRenameCurrent(){
    const s = activeSession();
    if (!s) return;

    sheetTitle.textContent = 'é‡å‘½åä¼šè¯';
    sheetBody.innerHTML = `
      <div class="section" style="margin:8px;">
        <div class="small muted">è¾“å…¥æ–°æ ‡é¢˜ï¼š</div>
        <div class="row" style="margin-top:10px;">
          <div class="grow"><input id="renameInput" type="text" style="height:44px;" value="${escapeHtml(s.title || '')}" /></div>
        </div>
        <div class="inlineBtns" style="margin-top:10px;">
          <button class="btn primary" id="btnRenameOk">ä¿å­˜</button>
          <button class="btn" id="btnRenameCancel">å–æ¶ˆ</button>
        </div>
      </div>
    `;
    openSheet();
    setTimeout(() => {
      const inp = document.getElementById('renameInput');
      inp?.focus();
      document.getElementById('btnRenameOk')?.addEventListener('click', () => { renameSession(s.id, inp.value); closeSheet(); });
      document.getElementById('btnRenameCancel')?.addEventListener('click', () => closeSheet());
    }, 50);
  }

  function init(){
    setupManifest();
    setupServiceWorkerBestEffort();
    updateViewportOffset();
    renderAll();
    restoreDraft();

    if (!isProbablyConfigured(state)) {
      onboarding.classList.add('show');
      syncBackdrop();
    }

    // iOS: prevent accidental zoom on double-tap (except input)
    document.addEventListener('dblclick', (e) => {
      if (e.target === inputEl) return;
      e.preventDefault();
    }, { passive:false });
  }

  init();
})();
</script>
</body>
</html>
