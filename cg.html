<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Claude Mobile UI (Stream + Thinking + IndexedDB + Upload + Search)</title>
  <style>
    :root{
      --bg: #F7F4EE;
      --panel: #FFFFFF;
      --ink: #1f1f1f;
      --muted: rgba(0,0,0,.50);
      --hairline: rgba(0,0,0,.08);
      --shadow: 0 10px 28px rgba(0,0,0,.10);
      --shadow-soft: 0 8px 24px rgba(0,0,0,.08);
      --accent: #D98A70;
      --btn: rgba(0,0,0,.06);
      --btn-hover: rgba(0,0,0,.09);
      --radius-xl: 22px;
      --serif: ui-serif, "Iowan Old Style", "Palatino Linotype", Palatino, Georgia, "Times New Roman", serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* 可自定义字体大小（设置里改） */
      --bubble-font: 15px;
      --prompt-font: 18px;
      --sidebar-item: 15px;
      --sidebar-title: 28px;
      --sidebar-sub: 12px;

      /* ✅ 修复 iOS 100vh：JS 会动态写入 */
      --app-height: 100vh;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--sans);
      overflow:hidden;
    }

    .app{
      height: var(--app-height);
      display:flex;
      flex-direction:column;
      position:relative;
      touch-action: pan-y;
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* Topbar */
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px;
      gap:10px;
      background: transparent;
      flex: 0 0 auto;
    }
    .topbar .left, .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 100px;
    }
    .brand{
      font-weight:850;
      font-size:22px;
      letter-spacing:.2px;
      user-select:none;
    }
    .iconbtn{
      width:38px;
      height:38px;
      border-radius: 12px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(6px);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: background .15s ease, transform .08s ease;
      user-select:none;
    }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn:hover{ background: rgba(255,255,255,.55); }

    /* Main */
    .main{
      flex:1;
      min-height:0;
      display:flex;
      justify-content:center;
      padding: 0 12px 0;
    }
    .chatwrap{
      width:100%;
      max-width: 760px;
      min-height:0;
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 6px 2px 10px;
    }

    /* Empty state */
    .empty{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(0,0,0,.38);
      font-family: var(--serif);
      font-size: 34px;
      letter-spacing: .2px;
      user-select:none;
      padding: 14px;
      text-align:center;
    }

    /* Load earlier */
    .loadEarlier{
      width: 100%;
      display:flex;
      justify-content:center;
      padding: 10px 0 4px;
    }
    .loadEarlier button{
      height: 38px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      cursor:pointer;
      font-weight: 950;
      user-select:none;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }

    /* Bubbles */
    .bubble{
      width: fit-content;
      max-width: 92%;
      padding: 12px 14px;
      border-radius: 16px;
      margin: 8px 0;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.70);
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      word-break: break-word;
      font-size: var(--bubble-font);
      line-height: 1.55;
      position: relative;
    }
    .bubble.user{
      margin-left:auto;
      background:#fff;
    }
    .bubble.assistant{ margin-right:auto; }
    .bubble.muted{
      color: rgba(0,0,0,.55);
      font-style: italic;
    }

    /* Bubble header + actions */
    .bubbleTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .bubbleLabel{
      font-size: 12px;
      font-weight: 950;
      color: rgba(0,0,0,.55);
      user-select:none;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bubbleLabel .caret{
      display:inline-block;
      width: 10px;
      opacity:.55;
      transform: translateY(-1px);
    }
    .bubbleActions{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
    }
    .actionBtn{
      width:34px;
      height:34px;
      border-radius: 12px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.45);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, opacity .15s ease;
      user-select:none;
      padding:0;
    }
    .actionBtn:hover{ background: rgba(255,255,255,.70); }
    .actionBtn:active{ transform: scale(.98); }
    .actionBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .bubbleBody{
      white-space: normal;
      word-break: break-word;
    }

    /* Markdown rendering */
    .bubbleBody p{ margin: 0 0 10px; }
    .bubbleBody p:last-child{ margin-bottom: 0; }
    .bubbleBody h1,.bubbleBody h2,.bubbleBody h3,.bubbleBody h4,.bubbleBody h5,.bubbleBody h6{
      margin: 8px 0 10px;
      line-height: 1.2;
    }
    .bubbleBody h1{ font-size: 1.35em; }
    .bubbleBody h2{ font-size: 1.25em; }
    .bubbleBody h3{ font-size: 1.15em; }
    .bubbleBody ul,.bubbleBody ol{ margin: 6px 0 10px 22px; padding:0; }
    .bubbleBody li{ margin: 3px 0; }
    .bubbleBody a{ color: rgba(0,0,0,.78); text-decoration: underline; }
    .bubbleBody code{
      font-family: var(--mono);
      font-size: 0.95em;
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.08);
      padding: 1px 6px;
      border-radius: 8px;
    }
    .bubbleBody pre{
      margin: 8px 0 10px;
      padding: 10px 10px;
      border-radius: 14px;
      overflow:auto;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
    }
    .bubbleBody pre code{
      border: none;
      background: transparent;
      padding: 0;
      border-radius: 0;
      display:block;
      white-space: pre;
    }
    .bubbleBody blockquote{
      margin: 6px 0 10px;
      padding: 6px 10px;
      border-left: 3px solid rgba(0,0,0,.18);
      background: rgba(0,0,0,.02);
      border-radius: 10px;
    }
    .bubbleBody hr{
      border:0;
      height:1px;
      background: rgba(0,0,0,.10);
      margin: 10px 0;
    }

    /* Thinking bubble */
    .bubble.thinking{ background: rgba(0,0,0,.03); }
    .bubble.thinking .bubbleBody{
      font-family: var(--mono);
      font-size: var(--bubble-font);
      color: rgba(0,0,0,.68);
    }
    .bubble.thinking.collapsed .bubbleBody{ display:none; }

    /* Inline editor */
    .editWrap{ margin-top: 8px; }
    .editArea{
      width:100%;
      min-height: 90px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.14);
      outline:none;
      font-size: 14px;
      font-family: var(--sans);
      resize: vertical;
      background:#fff;
    }
    .editActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .smallBtn{
      height:38px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      cursor:pointer;
      font-weight: 950;
      user-select:none;
    }
    .smallBtn.primary{
      background: rgba(217,138,112,.22);
      border-color: rgba(217,138,112,.45);
    }

    /* Attachments (composer) */
    .attachBar{
      display:none;
      gap:8px;
      flex-wrap: wrap;
      padding: 6px 2px 2px;
      align-items:center;
    }
    .attachBar.show{ display:flex; }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 8px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
      max-width: 100%;
    }
    .chip .name{
      font-size: 12px;
      font-weight: 900;
      color: rgba(0,0,0,.70);
      max-width: 220px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip .x{
      width:24px;height:24px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .thumb{
      width:38px;height:38px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.10);
      object-fit: cover;
      background: rgba(255,255,255,.55);
    }

    /* Attachments (bubble) */
    .attachList{
      margin-top: 10px;
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }
    .attachCard{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      max-width: 100%;
    }
    .attachCard .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .attachCard .fn{
      font-size: 12px;
      font-weight: 950;
      color: rgba(0,0,0,.72);
      max-width: 260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .attachCard .sz{
      font-size: 11px;
      font-weight: 850;
      color: rgba(0,0,0,.45);
    }
    .attachCard a{
      font-size: 12px;
      font-weight: 950;
      color: rgba(0,0,0,.72);
      text-decoration: underline;
      user-select:none;
      white-space: nowrap;
    }

    /* ✅ Composer：底部 safe-area + 不被 home indicator 吃掉 */
    .composer{
      flex: 0 0 auto;
      display:flex;
      justify-content:center;
      padding: 0 12px calc(12px + env(safe-area-inset-bottom));
    }
    .composerCard{
      width:100%;
      max-width: 760px;
      background: var(--panel);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px 14px;
    }
    .prompt{
      width:100%;
      border:0;
      outline:none;
      font-size: var(--prompt-font);
      padding: 8px 6px 10px;
      color: var(--ink);
      background: transparent;
      font-family: var(--sans);
    }
    .prompt::placeholder{ color: rgba(0,0,0,.35); }
    .composerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-top: 6px;
    }
    .composerLeft, .composerRight{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .miniBtn{
      width:44px;height:44px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: var(--btn);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: background .15s ease, transform .08s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
    }
    .miniBtn:hover{ background: var(--btn-hover); }
    .miniBtn:active{ transform: scale(.98); }
    .miniBtn.active{
      background: rgba(217,138,112,.20);
      border-color: rgba(217,138,112,.55);
    }
    .miniBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .modelSelect{ position:relative; min-width: 0; }
    .modelBtn{
      height:44px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: transparent;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      color: rgba(0,0,0,.72);
      font-weight: 900;
      white-space: nowrap;
      transition: opacity .15s ease;
      max-width: 300px;
      min-width: 0;
    }
    .modelBtn:disabled{ opacity:.55; cursor:not-allowed; }
    #modelText{
      display:inline-block;
      max-width: 220px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: bottom;
    }
    .chev{ opacity:.6; flex: 0 0 auto; }

    .sendBtn{
      width:44px;height:44px;
      border-radius: 14px;
      border:0;
      cursor:pointer;
      display:grid;
      place-items:center;
      background: rgba(217,138,112,.55);
      box-shadow: 0 8px 18px rgba(217,138,112,.25);
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
      flex: 0 0 auto;
    }
    .sendBtn:hover{ filter: saturate(1.1); }
    .sendBtn:active{ transform: scale(.98); }
    .sendBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .sendBtn.stop{
      background: rgba(0,0,0,.70);
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
    }

    .dropdown{
      position:absolute;
      right:0;
      bottom: 54px;
      width: 340px;
      background:#fff;
      border:1px solid var(--hairline);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index: 60;
    }
    .dropdown.open{ display:block; }
    .ddItem{
      padding: 12px 12px;
      font-size: 14px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .ddItem:hover{ background: rgba(0,0,0,.04); }
    .ddItem .meta{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .ddItem .name{ font-weight:900; color: rgba(0,0,0,.78); }
    .ddItem .id{
      font-size:12px;
      color: rgba(0,0,0,.45);
      font-weight:800;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 250px;
    }
    .tag{
      font-size: 12px;
      font-weight: 900;
      color: rgba(0,0,0,.45);
      white-space:nowrap;
    }
    .ddDivider{
      height:1px;
      background: rgba(0,0,0,.08);
      margin: 0 12px;
    }
    .ddFooter{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
      color: rgba(0,0,0,.72);
      font-weight: 950;
    }
    .ddFooter:hover{ background: rgba(0,0,0,.04); }

    /* Drawer (left sidebar) */
    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.22);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 80;
    }
    .backdrop.show{ opacity:1; pointer-events:auto; }
    .drawer{
      position:absolute;
      top:0; left:0;
      height:100%;
      width: min(86vw, 380px);
      background: var(--bg);
      border-right: 1px solid rgba(0,0,0,.08);
      transform: translateX(-102%);
      transition: transform .22s ease;
      z-index: 90;
      display:flex;
      flex-direction:column;
      padding-top: env(safe-area-inset-top);
    }
    .drawer.open{ transform: translateX(0); }
    .drawerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px 10px;
    }
    .drawerHeader .title{
      font-family: var(--serif);
      font-size: var(--sidebar-title);
      font-weight: 900;
      letter-spacing:.2px;
      user-select:none;
    }
    .drawerBody{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 4px 10px 14px;
    }
    .navItem{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 10px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      color: rgba(0,0,0,.78);
    }
    .navItem:hover{ background: rgba(0,0,0,.04); }
    .navItem .label{ font-size: var(--sidebar-item); font-weight: 900; }

    .sectionTitle{
      margin: 14px 10px 8px;
      font-size: var(--sidebar-sub);
      letter-spacing: .8px;
      color: rgba(0,0,0,.42);
      font-weight: 900;
      user-select:none;
    }

    .divider{
      height:1px;
      background: rgba(0,0,0,.06);
      margin: 10px 10px;
    }

    /* Chat list items */
    .chatItem{
      padding: 10px 10px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      border: 1px solid transparent;
    }
    .chatItem:hover{ background: rgba(0,0,0,.04); }
    .chatItem.active{
      background: rgba(217,138,112,.12);
      border-color: rgba(217,138,112,.35);
    }
    .chatTitle{
      font-size: var(--sidebar-item);
      font-weight: 900;
      color: rgba(0,0,0,.80);
      line-height: 1.1;
      margin-bottom: 6px;
    }
    .chatMeta{
      font-size: 11px;
      font-weight: 800;
      color: rgba(0,0,0,.45);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    /* Modal base */
    .modalBackdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.28);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 120;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(720px, 92vw);
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      max-height: min(84vh, 720px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal h3{
      margin: 6px 0 8px;
      font-size: 16px;
      font-weight: 950;
    }
    .modal p{
      margin: 0 0 10px;
      color: rgba(0,0,0,.62);
      font-size: 13px;
      line-height: 1.35;
    }
    .modal label{
      display:block;
      margin: 10px 0 6px;
      font-size: 12px;
      font-weight: 950;
      color: rgba(0,0,0,.62);
    }
    .modal input, .modal textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.14);
      outline:none;
      font-size: 14px;
      font-family: var(--sans);
      resize: vertical;
    }
    .modalRow{
      display:flex;
      gap:10px;
      margin-top: 12px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .btn{
      height:40px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      cursor:pointer;
      font-weight: 950;
      user-select:none;
    }
    .btn.primary{
      background: rgba(217,138,112,.22);
      border-color: rgba(217,138,112,.45);
    }
    .row2{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .row2 > div{ flex:1; min-width: 220px; }

    .toggleRow{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
      user-select:none;
    }
    .toggleRow strong{ font-weight: 950; color: rgba(0,0,0,.72); }
    .toggleRow small{ color: rgba(0,0,0,.52); font-weight: 800; }
    .toggleRow input{ transform: scale(1.15); }

    .rangeRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
      margin-top: 10px;
    }
    .rangeRow .val{
      font-weight: 950;
      color: rgba(0,0,0,.70);
      min-width: 44px;
      text-align:right;
      user-select:none;
    }
    .rangeRow input[type="range"]{ width: 100%; }

    .sr{ position:absolute; left:-9999px; }

    /* Toast */
    .toast{
      position:absolute;
      left: 50%;
      bottom: calc(78px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.80);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      box-shadow: 0 10px 28px rgba(0,0,0,.16);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 200;
      max-width: min(92vw, 520px);
      text-align:center;
      user-select:none;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* ✅ 颜色选择控件更像按钮 */
    input[type="color"]{
      height: 46px;
      padding: 6px 8px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.14);
      background: #fff;
    }

    @media (max-width: 420px){
      .empty{ font-size: 30px; }
      :root{ --sidebar-title: 26px; }
      #modelText{ max-width: 180px; }
      .chip .name{ max-width: 160px; }
      .attachCard .fn{ max-width: 210px; }
    }
  </style>
</head>

<body>
  <div class="app" id="app">

    <!-- Drawer + backdrop -->
    <div class="backdrop" id="backdrop" aria-hidden="true"></div>

    <!-- 侧边栏：只保留历史记录 -->
    <aside class="drawer" id="drawer" aria-label="Side menu">
      <div class="drawerHeader">
        <div class="title">Claude</div>
        <button class="iconbtn" id="drawerClose" aria-label="Close menu" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 6.5h16M4 12h16M4 17.5h16" stroke="rgba(0,0,0,.65)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="drawerBody">
        <div class="navItem" id="newChatBtn">
          <div class="miniBtn" style="width:38px;height:38px;border-radius:12px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 5v14M5 12h14" stroke="rgba(0,0,0,.7)" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="label">New chat</div>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">Recents</div>
        <div id="chatList"></div>

        <div class="divider"></div>
        <div style="height:18px;"></div>
      </div>
    </aside>

    <!-- Settings modal -->
    <div class="modalBackdrop" id="settingsModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
        <h3>设置</h3>
        <p>数据保存在本机（IndexedDB）。导出/导入不包含 Key；附件 Blob 不随导出文件走（可按需扩展）。</p>

        <label for="keyInput">API Key</label>
        <input id="keyInput" placeholder="sk-..." autocomplete="off" />

        <div class="row2">
          <div>
            <label for="translateModelInput">翻译模型</label>
            <input id="translateModelInput" placeholder="gemini-2.5-flash-lite" autocomplete="off" />
          </div>
          <div>
            <label for="searchModelInput">联网搜索模型</label>
            <input id="searchModelInput" placeholder="gpt-5-search-api" autocomplete="off" />
          </div>
        </div>

        <label>字体大小</label>
        <div class="rangeRow">
          <input id="fontSizeRange" type="range" min="13" max="20" step="1" />
          <div class="val" id="fontSizeVal">15</div>
        </div>

        <!-- ✅ 新增：主题颜色 -->
        <label>主题颜色</label>
        <div class="row2">
          <div>
            <label for="bgColorInput">背景色</label>
            <input id="bgColorInput" type="color" />
          </div>
          <div>
            <label for="textColorInput">文字颜色</label>
            <input id="textColorInput" type="color" />
          </div>
        </div>

        <!-- ✅ 新增：流式自动滚动开关（默认关闭=不自动滚动） -->
        <div class="toggleRow">
          <div>
            <strong>流式时自动滚动</strong><br/>
            <small>关闭后：生成过程中不会自动跳到底部</small>
          </div>
          <input type="checkbox" id="streamScrollToggle" />
        </div>

        <label for="sysInput">System 指令</label>
        <textarea id="sysInput" rows="7"></textarea>

        <div class="modalRow">
          <button class="btn" id="exportBtn">导出</button>
          <button class="btn" id="importBtn">导入</button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
          <button class="btn" id="resetSysBtn">重置</button>
          <button class="btn" id="modelsBtn">模型管理</button>
          <button class="btn" id="clearAllChatsBtn">清空会话</button>
          <button class="btn" id="clearKeyBtn">清空 Key</button>
          <button class="btn" id="settingsCancel">关闭</button>
          <button class="btn primary" id="settingsSave">保存</button>
        </div>
      </div>
    </div>

    <!-- Model manager modal (列表) -->
    <div class="modalBackdrop" id="modelManagerModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Models">
        <h3>模型管理</h3>
        <p>选择/新增/改名/删除模型。</p>
        <div id="modelManagerList"></div>
        <div class="modalRow">
          <button class="btn" id="mmAddBtn">新增模型</button>
          <button class="btn" id="mmCloseManagerBtn">关闭</button>
        </div>
      </div>
    </div>

    <!-- Model editor modal (单个) -->
    <div class="modalBackdrop" id="modelModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Model Editor">
        <h3 id="modelModalTitle">Model</h3>
        <p id="modelModalDesc">新增/编辑模型。</p>

        <div class="row2">
          <div>
            <label for="mmLabel">显示名称</label>
            <input id="mmLabel" placeholder="例如：Opus 4.5 / Gemini 3 Pro" />
          </div>
          <div>
            <label for="mmBaseId">模型 ID（Base）</label>
            <input id="mmBaseId" placeholder="例如：claude-sonnet-... 或 gpt-..." />
          </div>
        </div>

        <label for="mmThinkingId">Thinking 模型 ID（可选）</label>
        <input id="mmThinkingId" placeholder="例如：...-thinking（没有就留空）" />

        <div class="toggleRow">
          <div>
            <strong>Thinking-only</strong><br/>
            <small>开启后：该模型永远视为 Thinking</small>
          </div>
          <input type="checkbox" id="mmThinkingOnly" />
        </div>

        <div class="modalRow">
          <button class="btn" id="mmDeleteBtn" style="display:none;">删除</button>
          <button class="btn" id="mmCancelBtn">关闭</button>
          <button class="btn primary" id="mmSaveBtn">保存</button>
        </div>
      </div>
    </div>

    <!-- Top bar -->
    <header class="topbar">
      <div class="left">
        <button class="iconbtn" id="menuBtn" aria-label="Open menu" title="Menu">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="4" y="4" width="16" height="16" rx="3" stroke="rgba(0,0,0,.65)" stroke-width="2"/>
            <path d="M8 12.2l2.4 2.4L16.5 8.5" stroke="rgba(0,0,0,.65)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="brand">Claude</div>
      </div>

      <!-- 右上角：设置 + 加号（新聊天） -->
      <div class="right">
        <button class="iconbtn" id="settingsBtn" aria-label="Settings" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 10a6 6 0 1 1 12 0v9l-2-1-2 1-2-1-2 1-2-1-2 1v-9Z"
                  stroke="rgba(0,0,0,.65)" stroke-width="2" stroke-linejoin="round"/>
            <path d="M10 11h.01M14 11h.01" stroke="rgba(0,0,0,.65)" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </button>

        <button class="iconbtn" id="topPlusBtn" aria-label="New chat" title="New chat">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="rgba(0,0,0,.65)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main -->
    <main class="main">
      <div class="chatwrap" id="chatwrap" aria-label="Chat messages">
        <div class="empty" id="emptyState">Hello, night owl</div>
      </div>
    </main>

    <!-- Composer -->
    <footer class="composer">
      <div class="composerCard">
        <div class="attachBar" id="attachBar"></div>

        <label class="sr" for="prompt">Prompt</label>
        <input id="prompt" class="prompt" placeholder="How can I help you today?" autocomplete="off" />

        <div class="composerRow">
          <div class="composerLeft">
            <button class="miniBtn" id="plusBtn" aria-label="Upload" title="Upload">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="rgba(0,0,0,.6)" stroke-width="2.2" stroke-linecap="round"/>
              </svg>
            </button>

            <button class="miniBtn" id="clockBtn" aria-label="Thinking toggle" title="Thinking">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 8v5l3 2" stroke="rgba(0,0,0,.6)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="rgba(0,0,0,.55)" stroke-width="2"/>
              </svg>
            </button>

            <button class="miniBtn" id="webBtn" aria-label="Web Search toggle" title="Web Search (Shift+Click to set model)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 21a9 9 0 1 0-9-9 9 9 0 0 0 9 9Z" stroke="rgba(0,0,0,.58)" stroke-width="2"/>
                <path d="M3 12h18" stroke="rgba(0,0,0,.58)" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 3c3 3 3 15 0 18" stroke="rgba(0,0,0,.58)" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 3c-3 3-3 15 0 18" stroke="rgba(0,0,0,.58)" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>

            <input id="filePicker" type="file" multiple accept="image/*,.txt,.md,.json,.csv,.log,.pdf,.doc,.docx,.ppt,.pptx" style="display:none;" />
          </div>

          <div class="composerRight">
            <div class="modelSelect">
              <button class="modelBtn" id="modelBtn" aria-haspopup="listbox" aria-expanded="false">
                <span id="modelText">Model</span>
                <svg class="chev" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="rgba(0,0,0,.55)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="dropdown" id="dropdown" role="listbox" aria-label="Model select"></div>
            </div>

            <button class="sendBtn" id="sendBtn" aria-label="Send" title="Send" disabled>
              <svg id="sendIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 4l7 7-7 7" stroke="rgba(0,0,0,.65)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 11h13" stroke="rgba(0,0,0,.65)" stroke-width="2.2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </footer>

    <div class="toast" id="toast">已复制</div>
  </div>

<script>
/***********************
 * ✅ 修复 iOS 底部显示不全：动态设置 app 高度（含键盘/地址栏变化）
 ***********************/
(function setupAppHeight(){
  const setH = ()=>{
    const vv = window.visualViewport;
    const h = vv ? vv.height : window.innerHeight;
    document.documentElement.style.setProperty('--app-height', h + 'px');
  };
  setH();
  window.addEventListener('resize', setH);
  window.addEventListener('orientationchange', setH);
  if (window.visualViewport){
    window.visualViewport.addEventListener('resize', setH);
    window.visualViewport.addEventListener('scroll', setH);
  }
})();

/***********************
 * Config
 ***********************/
const VE_BASE_URL = "https://api.vectorengine.ai/v1";
const VE_KEY_STORAGE = "ve_api_key";
const SYS_PROMPT_STORAGE = "ve_system_prompt";

const STORE_KEY = "ve_chats_store_v3";                 // legacy localStorage key (migrate -> IndexedDB)
const CUSTOM_MODELS_KEY = "ve_custom_models_v1";
const MODEL_ALIASES_KEY = "ve_model_aliases_v1";
const UI_STATE_KEY = "ve_ui_state_v5";                 // ✅ bump version (+ streamAutoScroll)
const TRANSLATE_MODEL_STORAGE = "ve_translate_model";
const DEFAULT_TRANSLATE_MODEL = "gemini-2.5-flash-lite";
const SEARCH_MODEL_STORAGE = "ve_search_model";
const DEFAULT_SEARCH_MODEL = "gpt-5-search-api";

const THEME_KEY = "ve_theme_v1";                       // ✅ 新增：主题
const DEFAULT_THEME = { bg: "#F7F4EE", ink: "#1f1f1f" };

const DEFAULT_FONT_SIZE = 15; // px
const CONTEXT_MAX_MESSAGES = 40; // 发送到模型的上下文条数（含 user/assistant，不含 system）

/***********************
 * IndexedDB (Chats + Files)
 ***********************/
const DB_NAME = "ve_chat_db_v1";
const DB_VER = 1;
let _db = null;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains("chats")) db.createObjectStore("chats", { keyPath: "id" });
      if (!db.objectStoreNames.contains("files")) db.createObjectStore("files", { keyPath: "id" });
      if (!db.objectStoreNames.contains("meta")) db.createObjectStore("meta", { keyPath: "key" });
    };
    req.onsuccess = () => { _db = req.result; resolve(_db); };
    req.onerror = () => reject(req.error);
  });
}
function os(name, mode="readonly"){ return _db.transaction(name, mode).objectStore(name); }

function idbGet(store, key){
  return new Promise((resolve, reject)=>{
    const req = os(store).get(key);
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
function idbPut(store, value){
  return new Promise((resolve, reject)=>{
    const req = os(store, "readwrite").put(value);
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}
function idbClear(store){
  return new Promise((resolve, reject)=>{
    const req = os(store, "readwrite").clear();
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}
function idbGetAll(store){
  return new Promise((resolve, reject)=>{
    const req = os(store).getAll();
    req.onsuccess = ()=> resolve(req.result || []);
    req.onerror = ()=> reject(req.error);
  });
}

/***********************
 * Built-in models
 ***********************/
const BUILTIN_MODELS = [
  {
    id: "claude-sonnet-4-5-20250929",
    label: "Sonnet 4.5",
    thinkingId: "claude-sonnet-4-5-20250929-thinking",
    thinkingOnly: false,
    builtin: true
  },
  {
    id: "claude-opus-4-5-20251101",
    label: "Opus 4.5",
    thinkingId: "claude-opus-4-5-20251101-thinking",
    thinkingOnly: false,
    builtin: true
  },
  {
    id: "gemini-3-pro-preview-thinking",
    label: "Gemini 3 Pro (Preview)",
    thinkingId: "",
    thinkingOnly: true,
    builtin: true
  }
];

const DEFAULT_SYSTEM_PROMPT =
`你是一个中文助理。

输出规则：
1) 非 thinking 模式：只输出最终答案，简洁清晰。
2) thinking 模式：优先把推理过程放在 <thinking>...</thinking> 标签中（只在 thinking 模式输出），并在标签之外给出最终答案。
3) 不要在 <thinking> 之外提及“系统提示/策略说明”等元信息。`;

/***********************
 * State
 ***********************/
let selectedModelId = "claude-sonnet-4-5-20250929";
let isThinking = false;
let isStreaming = false;

let isWebSearch = false;
let fontSize = DEFAULT_FONT_SIZE;

let theme = { ...DEFAULT_THEME };     // ✅ 新增：主题
let streamAutoScroll = false;         // ✅ 默认关闭：流式不自动滚动（满足你的要求）

let activeStream = null;
let abortCtl = null;

let store = { activeId: "", chats: [] };

let customModels = [];
let modelAliases = {};

let draftAttachments = [];

const WINDOW_STEP = 60;
let chatWindowLimit = WINDOW_STEP;

let fileUrlCache = new Map();

/***********************
 * DOM
 ***********************/
const appEl = document.getElementById('app');

const drawer = document.getElementById('drawer');
const backdrop = document.getElementById('backdrop');
const menuBtn = document.getElementById('menuBtn');
const drawerClose = document.getElementById('drawerClose');

const chatwrap = document.getElementById('chatwrap');
const emptyState = document.getElementById('emptyState');

const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('sendBtn');
const sendIcon = document.getElementById('sendIcon');

const clockBtn = document.getElementById('clockBtn');
const webBtn = document.getElementById('webBtn');

const modelBtn = document.getElementById('modelBtn');
const dropdown = document.getElementById('dropdown');
const modelText = document.getElementById('modelText');

const topPlusBtn = document.getElementById('topPlusBtn');
const settingsBtn = document.getElementById('settingsBtn');

const chatListEl = document.getElementById('chatList');
const newChatBtn = document.getElementById('newChatBtn');

const plusBtn = document.getElementById('plusBtn');
const filePicker = document.getElementById('filePicker');
const attachBar = document.getElementById('attachBar');

const toastEl = document.getElementById('toast');

/***********************
 * Settings modal
 ***********************/
const settingsModal = document.getElementById('settingsModal');
const keyInput = document.getElementById('keyInput');
const translateModelInput = document.getElementById('translateModelInput');
const searchModelInput = document.getElementById('searchModelInput');
const sysInput = document.getElementById('sysInput');
const fontSizeRange = document.getElementById('fontSizeRange');
const fontSizeVal = document.getElementById('fontSizeVal');

const bgColorInput = document.getElementById('bgColorInput');          // ✅ 新增
const textColorInput = document.getElementById('textColorInput');      // ✅ 新增
const streamScrollToggle = document.getElementById('streamScrollToggle'); // ✅ 新增

const settingsCancel = document.getElementById('settingsCancel');
const settingsSave = document.getElementById('settingsSave');
const resetSysBtn = document.getElementById('resetSysBtn');
const clearAllChatsBtn = document.getElementById('clearAllChatsBtn');
const clearKeyBtn = document.getElementById('clearKeyBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const modelsBtn = document.getElementById('modelsBtn');

/***********************
 * Model manager modal
 ***********************/
const modelManagerModal = document.getElementById('modelManagerModal');
const modelManagerList = document.getElementById('modelManagerList');
const mmAddBtn = document.getElementById('mmAddBtn');
const mmCloseManagerBtn = document.getElementById('mmCloseManagerBtn');

/***********************
 * Model editor modal
 ***********************/
const modelModal = document.getElementById('modelModal');
const modelModalTitle = document.getElementById('modelModalTitle');
const modelModalDesc = document.getElementById('modelModalDesc');
const mmLabel = document.getElementById('mmLabel');
const mmBaseId = document.getElementById('mmBaseId');
const mmThinkingId = document.getElementById('mmThinkingId');
const mmThinkingOnly = document.getElementById('mmThinkingOnly');
const mmDeleteBtn = document.getElementById('mmDeleteBtn');
const mmCancelBtn = document.getElementById('mmCancelBtn');
const mmSaveBtn = document.getElementById('mmSaveBtn');

let modelModalMode = "add";
let modelModalTargetId = "";
let modelModalIsBuiltin = false;

/***********************
 * Helpers
 ***********************/
function nowTs(){ return Date.now(); }
function safeParseJSON(s, fallback){ try { return JSON.parse(s); } catch { return fallback; } }
function uid(){ return "m_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8); }
function formatTime(ts){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${y}-${m}-${day} ${hh}:${mm}`;
}
function clampTitle(s){
  const t = (s || "").trim().replace(/\s+/g," ");
  if (!t) return "New chat";
  return t.length > 18 ? t.slice(0,18) + "…" : t;
}
function bytesToSize(bytes){
  if (!bytes && bytes !== 0) return "";
  const units = ["B","KB","MB","GB"];
  let n = bytes;
  let i = 0;
  while (n >= 1024 && i < units.length-1){ n/=1024; i++; }
  return (i === 0 ? `${n} ${units[i]}` : `${n.toFixed(1)} ${units[i]}`);
}

function showToast(msg){
  toastEl.textContent = msg || "OK";
  toastEl.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toastEl.classList.remove("show"), 1200);
}

async function copyToClipboard(text){
  const t = (text || "").toString();
  if (!t) return;
  try{
    await navigator.clipboard.writeText(t);
    showToast("已复制");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = t;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try { document.execCommand("copy"); showToast("已复制"); } catch { showToast("复制失败"); }
    ta.remove();
  }
}

function getApiKey(){ return (localStorage.getItem(VE_KEY_STORAGE) || "").trim(); }
function getSystemPrompt(){
  const v = (localStorage.getItem(SYS_PROMPT_STORAGE) || "").trim();
  return v || DEFAULT_SYSTEM_PROMPT;
}
function getTranslateModel(){
  const v = (localStorage.getItem(TRANSLATE_MODEL_STORAGE) || "").trim();
  return v || DEFAULT_TRANSLATE_MODEL;
}
function getSearchModel(){
  const v = (localStorage.getItem(SEARCH_MODEL_STORAGE) || "").trim();
  return v || DEFAULT_SEARCH_MODEL;
}

function isNearBottom(el, threshold=80){
  return (el.scrollHeight - el.scrollTop - el.clientHeight) < threshold;
}
function scrollToBottom(){
  chatwrap.scrollTop = chatwrap.scrollHeight;
}

/***********************
 * ✅ Theme (bg + ink)
 ***********************/
function loadTheme(){
  const t = safeParseJSON(localStorage.getItem(THEME_KEY) || "", null);
  if (t && typeof t === "object"){
    if (typeof t.bg === "string" && t.bg.trim()) theme.bg = t.bg.trim();
    if (typeof t.ink === "string" && t.ink.trim()) theme.ink = t.ink.trim();
  }
}
function saveTheme(){
  localStorage.setItem(THEME_KEY, JSON.stringify(theme));
}
function applyTheme(){
  document.documentElement.style.setProperty("--bg", theme.bg);
  document.documentElement.style.setProperty("--ink", theme.ink);
}

/***********************
 * Font size apply
 ***********************/
function applyFontSize(){
  const fs = Math.max(13, Math.min(20, Number(fontSize) || DEFAULT_FONT_SIZE));
  fontSize = fs;

  document.documentElement.style.setProperty("--bubble-font", fs + "px");
  document.documentElement.style.setProperty("--prompt-font", (fs + 3) + "px");
  document.documentElement.style.setProperty("--sidebar-item", fs + "px");

  fontSizeRange.value = String(fs);
  fontSizeVal.textContent = String(fs);
  saveUIState();
}

/***********************
 * Markdown renderer (safe: escape HTML first)
 ***********************/
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function safeLinkUrl(url){
  try{
    const u = new URL(url, location.href);
    if (u.protocol === "http:" || u.protocol === "https:") return u.href;
    return "";
  }catch{ return ""; }
}
function renderInline(md){
  let s = escapeHtml(md);

  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, text, url)=>{
    const safe = safeLinkUrl(url.trim());
    if (!safe) return `${text}`;
    return `<a href="${escapeHtml(safe)}" target="_blank" rel="noopener noreferrer">${text}</a>`;
  });

  s = s.replace(/`([^`]+)`/g, (_, code)=> `<code>${escapeHtml(code)}</code>`);
  s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
  s = s.replace(/(^|[^\*])\*([^*\n]+)\*([^\*]|$)/g, "$1<em>$2</em>$3");
  s = s.replace(/^\s*---\s*$/gm, "<hr/>");

  return s;
}
function renderMarkdown(md){
  const text = (md ?? "").toString().replace(/\r\n/g, "\n");
  if (!text.trim()) return "";

  const parts = text.split("```");
  let html = "";
  for (let i = 0; i < parts.length; i++){
    const chunk = parts[i];
    const isCode = i % 2 === 1;
    if (isCode){
      const lines = chunk.replace(/^\n/,"").split("\n");
      let code = lines.slice(1).join("\n");
      if (lines.length === 1){ code = lines[0]; }
      html += `<pre><code>${escapeHtml(code)}</code></pre>`;
    } else {
      const lines = chunk.split("\n");
      let inUl = false, inOl = false, inBq = false;
      let para = [];

      const flushPara = ()=>{
        if (para.length){
          const p = renderInline(para.join("\n")).replace(/\n/g,"<br/>");
          html += `<p>${p}</p>`;
          para = [];
        }
      };
      const closeLists = ()=>{
        if (inUl){ html += `</ul>`; inUl = false; }
        if (inOl){ html += `</ol>`; inOl = false; }
      };
      const closeBq = ()=>{
        if (inBq){ html += `</blockquote>`; inBq = false; }
      };

      for (let ln of lines){
        const raw = ln;
        const trimmed = raw.trimEnd();

        if (!trimmed.trim()){
          flushPara();
          closeLists();
          closeBq();
          continue;
        }

        const hm = trimmed.match(/^(#{1,6})\s+(.*)$/);
        if (hm){
          flushPara(); closeLists(); closeBq();
          const level = hm[1].length;
          html += `<h${level}>${renderInline(hm[2])}</h${level}>`;
          continue;
        }

        const bqm = trimmed.match(/^>\s?(.*)$/);
        if (bqm){
          flushPara(); closeLists();
          if (!inBq){ html += `<blockquote>`; inBq = true; }
          html += `<p>${renderInline(bqm[1])}</p>`;
          continue;
        } else {
          closeBq();
        }

        const ulm = trimmed.match(/^[-*]\s+(.*)$/);
        if (ulm){
          flushPara();
          if (inOl){ html += `</ol>`; inOl = false; }
          if (!inUl){ html += `<ul>`; inUl = true; }
          html += `<li>${renderInline(ulm[1])}</li>`;
          continue;
        }

        const olm = trimmed.match(/^\d+\.\s+(.*)$/);
        if (olm){
          flushPara();
          if (inUl){ html += `</ul>`; inUl = false; }
          if (!inOl){ html += `<ol>`; inOl = true; }
          html += `<li>${renderInline(olm[1])}</li>`;
          continue;
        }

        closeLists();
        para.push(raw);
      }

      flushPara();
      closeLists();
      closeBq();
    }
  }
  return html;
}

/***********************
 * Models: load/save/merge
 ***********************/
function loadModels(){
  customModels = safeParseJSON(localStorage.getItem(CUSTOM_MODELS_KEY) || "[]", []);
  if (!Array.isArray(customModels)) customModels = [];
  customModels = customModels
    .filter(m => m && typeof m === "object" && (m.id || "").trim())
    .map(m => ({
      id: String(m.id).trim(),
      label: String(m.label || "Custom Model").trim(),
      thinkingId: String(m.thinkingId || "").trim(),
      thinkingOnly: !!m.thinkingOnly,
      builtin: false
    }));

  modelAliases = safeParseJSON(localStorage.getItem(MODEL_ALIASES_KEY) || "{}", {});
  if (!modelAliases || typeof modelAliases !== "object") modelAliases = {};
}
function saveModels(){
  localStorage.setItem(CUSTOM_MODELS_KEY, JSON.stringify(customModels));
  localStorage.setItem(MODEL_ALIASES_KEY, JSON.stringify(modelAliases));
}
function getAllModels(){
  const map = new Map();
  for (const b of BUILTIN_MODELS) map.set(b.id, { ...b });
  for (const c of customModels) map.set(c.id, { ...c });
  return Array.from(map.values());
}
function getModelById(id){
  const all = getAllModels();
  return all.find(m => m.id === id) || null;
}
function getModelLabel(m){
  if (!m) return "Model";
  if (m.builtin && modelAliases[m.id]) return String(modelAliases[m.id]).trim() || m.label;
  return m.label || "Model";
}
function modelSupportsThinkingToggle(m){
  return !!(m && !m.thinkingOnly && m.thinkingId && m.thinkingId.trim());
}
function effectiveThinking(){
  const m = getModelById(selectedModelId);
  if (!m) return false;
  if (m.thinkingOnly) return true;
  if (modelSupportsThinkingToggle(m)) return !!isThinking;
  return false;
}
function currentModelId(){
  const m = getModelById(selectedModelId);
  if (!m) return selectedModelId;
  if (m.thinkingOnly) return m.id;
  if (modelSupportsThinkingToggle(m)) return isThinking ? m.thinkingId : m.id;
  return m.id;
}

function applyModelCapabilities(){
  const m = getModelById(selectedModelId);

  if (!m) {
    isThinking = false;
    clockBtn.disabled = true;
    clockBtn.classList.remove("active");
  } else if (m.thinkingOnly) {
    isThinking = true;
    clockBtn.disabled = true;
    clockBtn.classList.add("active");
  } else if (modelSupportsThinkingToggle(m)) {
    clockBtn.disabled = false;
    clockBtn.classList.toggle("active", !!isThinking);
  } else {
    isThinking = false;
    clockBtn.disabled = true;
    clockBtn.classList.remove("active");
  }

  refreshModelText();
  saveUIState();
}

function refreshModelText(){
  const m = getModelById(selectedModelId);
  const name = getModelLabel(m);
  const t = effectiveThinking() ? " · Thinking" : "";
  const s = isWebSearch ? " · Search" : "";
  modelText.textContent = name + t + s;
}

/***********************
 * UI State
 ***********************/
function loadUIState(){
  const ui = safeParseJSON(localStorage.getItem(UI_STATE_KEY) || "{}", {});
  if (ui && typeof ui === "object") {
    if (typeof ui.selectedModelId === "string") selectedModelId = ui.selectedModelId;
    if (typeof ui.isThinking === "boolean") isThinking = ui.isThinking;
    if (typeof ui.isWebSearch === "boolean") isWebSearch = ui.isWebSearch;
    if (typeof ui.fontSize === "number") fontSize = ui.fontSize;

    // ✅ 新增
    if (typeof ui.streamAutoScroll === "boolean") streamAutoScroll = ui.streamAutoScroll;
  }
  if (!getModelById(selectedModelId)) {
    selectedModelId = BUILTIN_MODELS[0].id;
    isThinking = false;
  }
}
function saveUIState(){
  localStorage.setItem(UI_STATE_KEY, JSON.stringify({
    selectedModelId,
    isThinking,
    isWebSearch,
    fontSize,
    streamAutoScroll
  }));
}

/***********************
 * Store ops (IndexedDB)
 ***********************/
function normalizeChat(c){
  const chat = c && typeof c === "object" ? c : {};
  if (!Array.isArray(chat.messages)) chat.messages = [];
  chat.messages = chat.messages.map(m => ({
    id: m.id || uid(),
    role: m.role || "user",
    content: m.content || "",
    reasoning: m.reasoning || "",
    thinking: !!m.thinking,
    pending: !!m.pending,
    contentZh: m.contentZh || "",
    reasoningZh: m.reasoningZh || "",
    attachments: Array.isArray(m.attachments) ? m.attachments : [],
    interrupted: !!m.interrupted
  }));
  chat.title = chat.title || "New chat";
  chat.createdAt = chat.createdAt || nowTs();
  chat.updatedAt = chat.updatedAt || nowTs();
  chat.id = chat.id || ("c_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8));
  return chat;
}

async function migrateLegacyLocalStorageIfNeeded(){
  const raw = localStorage.getItem(STORE_KEY);
  if (!raw) return;
  const legacy = safeParseJSON(raw, null);
  if (!legacy || !Array.isArray(legacy.chats)) {
    localStorage.removeItem(STORE_KEY);
    return;
  }
  const chats = legacy.chats.map(normalizeChat);
  for (const c of chats){
    await idbPut("chats", c);
  }
  await idbPut("meta", { key: "activeId", value: legacy.activeId || "" });
  localStorage.removeItem(STORE_KEY);
}

async function loadStoreFromDB(){
  const chats = (await idbGetAll("chats")).map(normalizeChat);
  chats.sort((a,b)=> b.updatedAt - a.updatedAt);
  store.chats = chats;

  const active = (await idbGet("meta", "activeId"))?.value || "";
  store.activeId = active && store.chats.find(c => c.id === active) ? active : (store.chats[0]?.id || "");

  if (!store.activeId) {
    createNewChat();
  }
}

let _persistTimer = null;
let _persistQueue = new Set();

function schedulePersistChat(chat){
  if (!chat || !chat.id) return;
  _persistQueue.add(chat.id);
  if (_persistTimer) return;
  _persistTimer = setTimeout(async ()=>{
    _persistTimer = null;
    const ids = Array.from(_persistQueue);
    _persistQueue.clear();
    try{
      for (const id of ids){
        const c = store.chats.find(x => x.id === id);
        if (c) await idbPut("chats", c);
      }
      await idbPut("meta", { key: "activeId", value: store.activeId || "" });
    }catch(e){
      console.error("persist failed", e);
    }
  }, 350);
}

function getActiveChat(){ return store.chats.find(c => c.id === store.activeId) || null; }
function getChatById(id){ return store.chats.find(c => c.id === id) || null; }

function touchChat(chat){
  chat.updatedAt = nowTs();
  store.chats = [chat, ...store.chats.filter(c => c.id !== chat.id)];
}
function maybeUpdateTitle(chat){
  if (chat.title && chat.title !== "New chat") return;
  const firstUser = chat.messages.find(m => m.role === "user" && (m.content||"").trim());
  if (firstUser) chat.title = clampTitle(firstUser.content);
}
function findMsg(chat, msgId){
  return (chat?.messages || []).find(m => m.id === msgId) || null;
}

function createNewChat(){
  const id = "c_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  const chat = normalizeChat({ id, title: "New chat", createdAt: nowTs(), updatedAt: nowTs(), messages: [] });
  store.chats.unshift(chat);
  store.activeId = id;
  chatWindowLimit = WINDOW_STEP;
  schedulePersistChat(chat);
  renderSidebar();
  renderChat(true);
}

function setActiveChat(id){
  const chat = store.chats.find(c => c.id === id);
  if (!chat) return;
  store.activeId = id;
  chatWindowLimit = WINDOW_STEP;
  schedulePersistChat(chat);
  renderSidebar();
  renderChat(true);
  closeDrawer();
}

/***********************
 * Drawer
 ***********************/
function openDrawer(){ drawer.classList.add('open'); backdrop.classList.add('show'); }
function closeDrawer(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); }
menuBtn.addEventListener('click', openDrawer);
drawerClose.addEventListener('click', closeDrawer);
backdrop.addEventListener('click', closeDrawer);
newChatBtn.addEventListener('click', ()=>{
  createNewChat();
  closeDrawer();
});

/***********************
 * Swipe gestures
 ***********************/
(function setupSwipe(){
  let sx = 0, sy = 0, st = 0;
  let tracking = false;

  function isInteractiveTarget(t){
    if (!t) return false;
    const tag = (t.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "button" || t.closest?.(".dropdown") || t.closest?.(".modal") || t.closest?.("a");
  }

  appEl.addEventListener("touchstart", (e)=>{
    if (!e.touches || e.touches.length !== 1) return;
    const t = e.target;
    if (isInteractiveTarget(t)) return;
    tracking = true;
    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
    st = Date.now();
  }, { passive:true });

  appEl.addEventListener("touchend", (e)=>{
    if (!tracking) return;
    tracking = false;
    if (!e.changedTouches || e.changedTouches.length !== 1) return;

    const dx = e.changedTouches[0].clientX - sx;
    const dy = e.changedTouches[0].clientY - sy;
    const dt = Date.now() - st;

    const adx = Math.abs(dx);
    const ady = Math.abs(dy);

    if (adx < 70) return;
    if (adx < ady * 1.4) return;
    if (dt > 800) return;

    const drawerOpen = drawer.classList.contains("open");
    if (!drawerOpen && dx < -70) {
      openDrawer();
    } else if (drawerOpen && dx > 70) {
      closeDrawer();
    }
  }, { passive:true });
})();

/***********************
 * Sidebar render
 ***********************/
function renderChatsList(){
  chatListEl.innerHTML = "";
  const chats = [...store.chats].sort((a,b)=> b.updatedAt - a.updatedAt);

  if (!chats.length) {
    const div = document.createElement("div");
    div.style.padding = "10px";
    div.style.color = "rgba(0,0,0,.45)";
    div.style.fontWeight = "800";
    div.textContent = "No chats yet";
    chatListEl.appendChild(div);
    return;
  }

  for (const c of chats) {
    const item = document.createElement("div");
    item.className = "chatItem" + (c.id === store.activeId ? " active" : "");
    item.addEventListener("click", ()=> setActiveChat(c.id));

    const t = document.createElement("div");
    t.className = "chatTitle";
    t.textContent = c.title || "New chat";

    const meta = document.createElement("div");
    meta.className = "chatMeta";

    const left = document.createElement("span");
    left.textContent = `${c.messages?.length || 0} msgs`;

    const right = document.createElement("span");
    right.textContent = formatTime(c.updatedAt);

    meta.appendChild(left);
    meta.appendChild(right);

    item.appendChild(t);
    item.appendChild(meta);
    chatListEl.appendChild(item);
  }
}

function renderSidebar(){
  renderChatsList();
}

/***********************
 * Model manager render (in modal)
 ***********************/
function renderModelManager(){
  modelManagerList.innerHTML = "";
  const models = getAllModels();

  for (const m of models){
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.style.gap = "10px";
    row.style.padding = "10px 10px";
    row.style.borderRadius = "14px";
    row.style.border = "1px solid rgba(0,0,0,.08)";
    row.style.background = (m.id === selectedModelId) ? "rgba(217,138,112,.10)" : "rgba(0,0,0,.02)";
    row.style.margin = "8px 0";
    row.style.cursor = "pointer";
    row.addEventListener("click", ()=>{
      if (isStreaming) return;
      selectedModelId = m.id;
      applyModelCapabilities();
      renderModelManager();
      renderModelDropdown();
      showToast("已切换模型");
    });

    const left = document.createElement("div");
    left.style.minWidth = "0";

    const name = document.createElement("div");
    name.style.fontWeight = "950";
    name.style.color = "rgba(0,0,0,.78)";
    name.textContent = getModelLabel(m) + (m.id === selectedModelId ? " ✓" : "");

    const id = document.createElement("div");
    id.style.fontSize = "12px";
    id.style.fontWeight = "850";
    id.style.color = "rgba(0,0,0,.45)";
    id.style.whiteSpace = "nowrap";
    id.style.overflow = "hidden";
    id.style.textOverflow = "ellipsis";
    id.textContent = m.id + (m.thinkingOnly ? "  (thinking-only)" : (m.thinkingId ? "" : "  (no thinking)"));

    left.appendChild(name);
    left.appendChild(id);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flex = "0 0 auto";

    const mk = (title, svg) => {
      const b = document.createElement("button");
      b.className = "actionBtn";
      b.title = title;
      b.innerHTML = svg;
      b.addEventListener("click", (e)=>{
        e.stopPropagation();
      });
      return b;
    };

    const editBtn = mk("Edit", `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-3L16.5 4.5a2 2 0 0 0-3 0L3 15v5Z" stroke="rgba(0,0,0,.72)" stroke-width="2" stroke-linejoin="round"/>
        <path d="M13.5 6.5l4 4" stroke="rgba(0,0,0,.72)" stroke-width="2" stroke-linecap="round"/>
      </svg>
    `);
    editBtn.addEventListener("click", ()=> openModelModalEdit(m));
    right.appendChild(editBtn);

    if (!m.builtin){
      const delBtn = mk("Delete", `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M6 7h12M9 7V5h6v2M8 7l1 14h6l1-14" stroke="rgba(0,0,0,.72)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `);
      delBtn.addEventListener("click", ()=> openModelModalEdit(m));
      right.appendChild(delBtn);
    }

    row.appendChild(left);
    row.appendChild(right);
    modelManagerList.appendChild(row);
  }
}

/***********************
 * Dropdown render
 ***********************/
function renderModelDropdown(){
  dropdown.innerHTML = "";
  const models = getAllModels();

  for (const m of models) {
    const item = document.createElement("div");
    item.className = "ddItem";
    item.dataset.modelId = m.id;

    const meta = document.createElement("div");
    meta.className = "meta";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = getModelLabel(m) + (m.id === selectedModelId ? " ✓" : "");

    const id = document.createElement("div");
    id.className = "id";
    id.textContent = m.id;

    meta.appendChild(name);
    meta.appendChild(id);

    const tag = document.createElement("div");
    tag.className = "tag";
    if (m.thinkingOnly) tag.textContent = "Thinking-only";
    else if (m.thinkingId) tag.textContent = "Base/Thinking";
    else tag.textContent = "Base only";

    item.appendChild(meta);
    item.appendChild(tag);

    item.addEventListener("click", ()=>{
      if (isStreaming) return;
      selectedModelId = m.id;
      dropdown.classList.remove("open");
      modelBtn.setAttribute("aria-expanded","false");
      applyModelCapabilities();
      renderModelDropdown();
    });

    dropdown.appendChild(item);
  }

  const div = document.createElement("div");
  div.className = "ddDivider";
  dropdown.appendChild(div);

  const manage = document.createElement("div");
  manage.className = "ddFooter";
  manage.innerHTML = `<span>模型管理…</span><span style="opacity:.55;">›</span>`;
  manage.addEventListener("click", ()=>{
    dropdown.classList.remove("open");
    modelBtn.setAttribute("aria-expanded","false");
    openModelManager();
  });
  dropdown.appendChild(manage);
}
function toggleDropdown(){
  if (isStreaming) return;
  const isOpen = dropdown.classList.toggle('open');
  modelBtn.setAttribute('aria-expanded', String(isOpen));
}
modelBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  toggleDropdown();
});
document.addEventListener('click', ()=>{
  dropdown.classList.remove('open');
  modelBtn.setAttribute('aria-expanded', 'false');
});

/***********************
 * Clock toggle (thinking)
 ***********************/
clockBtn.addEventListener('click', ()=>{
  if (isStreaming) return;
  const m = getModelById(selectedModelId);
  if (!m) return;

  if (m.thinkingOnly) {
    isThinking = true;
    applyModelCapabilities();
    return;
  }
  if (!modelSupportsThinkingToggle(m)) {
    isThinking = false;
    applyModelCapabilities();
    return;
  }
  isThinking = !isThinking;
  applyModelCapabilities();
});

/***********************
 * Web Search toggle
 ***********************/
function applyWebSearchState(){
  webBtn.classList.toggle("active", !!isWebSearch);
  refreshModelText();
  saveUIState();
}
webBtn.addEventListener("click", (e)=>{
  if (isStreaming) return;
  if (e.shiftKey) {
    const cur = getSearchModel();
    const picked = window.prompt("联网搜索模型 ID（保存到设置）", cur);
    if (picked === null) return;
    const val = (picked || "").trim() || cur;
    localStorage.setItem(SEARCH_MODEL_STORAGE, val);
    showToast("已保存搜索模型");
  } else {
    isWebSearch = !isWebSearch;
  }
  applyWebSearchState();
});

/***********************
 * Attachments
 ***********************/
function renderAttachBar(){
  attachBar.innerHTML = "";
  attachBar.classList.toggle("show", draftAttachments.length > 0);

  for (const a of draftAttachments){
    const chip = document.createElement("div");
    chip.className = "chip";

    if (a.isImage){
      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = a.name || "image";
      img.src = URL.createObjectURL(a.blob);
      setTimeout(()=> { try{ URL.revokeObjectURL(img.src); }catch{} }, 2000);
      chip.appendChild(img);
    } else {
      const icon = document.createElement("div");
      icon.style.width = "38px";
      icon.style.height = "38px";
      icon.style.borderRadius = "12px";
      icon.style.border = "1px solid rgba(0,0,0,.10)";
      icon.style.display = "grid";
      icon.style.placeItems = "center";
      icon.style.background = "rgba(255,255,255,.55)";
      icon.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M7 3h7l3 3v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="rgba(0,0,0,.6)" stroke-width="2"/>
          <path d="M14 3v4h4" stroke="rgba(0,0,0,.6)" stroke-width="2"/>
        </svg>`;
      chip.appendChild(icon);
    }

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = a.name || "file";

    const x = document.createElement("div");
    x.className = "x";
    x.title = "Remove";
    x.textContent = "×";
    x.addEventListener("click", ()=>{
      draftAttachments = draftAttachments.filter(x => x.id !== a.id);
      renderAttachBar();
      syncSendState();
    });

    chip.appendChild(name);
    chip.appendChild(x);
    attachBar.appendChild(chip);
  }
}

plusBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  filePicker.value = "";
  filePicker.click();
});

filePicker.addEventListener("change", async ()=>{
  const files = Array.from(filePicker.files || []);
  if (!files.length) return;

  for (const f of files){
    const id = "f_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
    const isImage = /^image\//.test(f.type || "");
    let text = "";
    const isTextLike =
      /^(text\/|application\/json)/.test(f.type || "") ||
      /\.(txt|md|json|csv|log)$/i.test(f.name || "");
    if (isTextLike && f.size <= 200 * 1024){
      try{
        text = await f.text();
        if (text.length > 20000) text = text.slice(0,20000) + "\n…(truncated)";
      }catch{}
    }

    draftAttachments.push({
      id,
      name: f.name || "file",
      type: f.type || "",
      size: f.size || 0,
      lastModified: f.lastModified || 0,
      isImage,
      blob: f,
      text
    });
  }

  renderAttachBar();
  syncSendState();
});

/***********************
 * File helpers (IndexedDB)
 ***********************/
async function putFileRecord(att){
  const rec = {
    id: att.id,
    name: att.name,
    type: att.type,
    size: att.size,
    lastModified: att.lastModified,
    blob: att.blob
  };
  await idbPut("files", rec);
}

function revokeAllFileUrls(){
  for (const url of fileUrlCache.values()){
    try{ URL.revokeObjectURL(url); }catch{}
  }
  fileUrlCache.clear();
}

async function getFileBlob(fileId){
  const rec = await idbGet("files", fileId);
  return rec?.blob || null;
}

async function getFileUrl(fileId){
  if (fileUrlCache.has(fileId)) return fileUrlCache.get(fileId);
  const blob = await getFileBlob(fileId);
  if (!blob) return "";
  const url = URL.createObjectURL(blob);
  fileUrlCache.set(fileId, url);
  return url;
}

function blobToDataURL(blob){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = ()=> reject(r.error);
    r.readAsDataURL(blob);
  });
}

/***********************
 * Chat render helpers
 ***********************/
function clearChatDOM(){
  revokeAllFileUrls();
  Array.from(chatwrap.children).forEach(ch=>{
    if (ch !== emptyState) ch.remove();
  });
}
function showEmpty(show){
  emptyState.style.display = show ? "" : "none";
}

/* Create a bubble with header actions */
function createBubble({
  roleClass,
  kindClass,
  label,
  text,
  msgId,
  part,
  allowTranslate,
  allowRetry,
  allowContinue
}){
  const b = document.createElement('div');
  b.className = `bubble ${roleClass} ${kindClass || ""}`.trim();
  b.dataset.msgId = msgId || "";
  b.dataset.part = part || "";
  b.dataset.kind = kindClass || "";
  b.dataset.showZh = "0";

  const top = document.createElement("div");
  top.className = "bubbleTop";

  const lab = document.createElement("div");
  lab.className = "bubbleLabel";

  if (kindClass === "thinking") {
    const caret = document.createElement("span");
    caret.className = "caret";
    caret.textContent = "▾";
    lab.appendChild(caret);

    const t = document.createElement("span");
    t.textContent = label || "thinking";
    lab.appendChild(t);

    lab.style.cursor = "pointer";
    lab.addEventListener("click", ()=>{
      b.classList.toggle("collapsed");
      caret.textContent = b.classList.contains("collapsed") ? "▸" : "▾";
    });
  } else {
    lab.textContent = label || "";
  }

  const actions = document.createElement("div");
  actions.className = "bubbleActions";

  const mkBtn = (title, svgOrText) => {
    const btn = document.createElement("button");
    btn.className = "actionBtn";
    btn.title = title;
    btn.setAttribute("aria-label", title);
    btn.innerHTML = svgOrText;
    return btn;
  };

  const copyBtn = mkBtn("Copy", `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M9 9h10v12H9V9Z" stroke="rgba(0,0,0,.72)" stroke-width="2" />
      <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="rgba(0,0,0,.60)" stroke-width="2" />
    </svg>
  `);

  const editBtn = mkBtn("Edit", `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-3L16.5 4.5a2 2 0 0 0-3 0L3 15v5Z" stroke="rgba(0,0,0,.72)" stroke-width="2" stroke-linejoin="round"/>
      <path d="M13.5 6.5l4 4" stroke="rgba(0,0,0,.72)" stroke-width="2" stroke-linecap="round"/>
    </svg>
  `);

  let translateBtn = null;
  if (allowTranslate) {
    translateBtn = mkBtn("Translate to Chinese (Shift+Click to choose model)", `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M4 5h10M9 5v14M6 9h6" stroke="rgba(0,0,0,.72)" stroke-width="2" stroke-linecap="round"/>
        <path d="M14 19s3-2 3-7m0 0s3 5 3 7m-3-7v-2" stroke="rgba(0,0,0,.62)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `);
  }

  let retryBtn = null;
  if (allowRetry) {
    retryBtn = mkBtn("Regenerate", `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="rgba(0,0,0,.70)" stroke-width="2" stroke-linecap="round"/>
        <path d="M20 4v6h-6" stroke="rgba(0,0,0,.70)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `);
  }

  let contBtn = null;
  if (allowContinue) {
    contBtn = mkBtn("Continue", `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M8 5l11 7-11 7V5Z" stroke="rgba(0,0,0,.72)" stroke-width="2" stroke-linejoin="round"/>
      </svg>
    `);
  }

  actions.appendChild(copyBtn);
  actions.appendChild(editBtn);
  if (translateBtn) actions.appendChild(translateBtn);
  if (retryBtn) actions.appendChild(retryBtn);
  if (contBtn) actions.appendChild(contBtn);

  top.appendChild(lab);
  top.appendChild(actions);

  const body = document.createElement("div");
  body.className = "bubbleBody";
  body.dataset.raw = text || "";
  body.innerHTML = renderMarkdown(text || "");

  b.appendChild(top);
  b.appendChild(body);

  copyBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    const shown = b.dataset.showZh === "1";
    const raw = shown ? (b.dataset.zhText || body.dataset.raw || "") : (body.dataset.raw || "");
    copyToClipboard(raw);
  });

  editBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    startInlineEdit(b);
  });

  if (translateBtn) {
    translateBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      handleTranslate(b, e);
    });
  }

  if (retryBtn) {
    retryBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      handleRegenerate(b);
    });
  }

  if (contBtn) {
    contBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      handleContinue(b);
    });
  }

  chatwrap.appendChild(b);
  return { bubble: b, bodyEl: body };
}

async function renderAttachmentsInto(container, attachments){
  if (!attachments || !attachments.length) return;
  const list = document.createElement("div");
  list.className = "attachList";

  for (const a of attachments){
    const card = document.createElement("div");
    card.className = "attachCard";

    if (a.isImage){
      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = a.name || "image";
      img.src = "";
      card.appendChild(img);
      getFileUrl(a.id).then(url=>{
        if (url) img.src = url;
      });
    } else {
      const icon = document.createElement("div");
      icon.style.width = "38px";
      icon.style.height = "38px";
      icon.style.borderRadius = "12px";
      icon.style.border = "1px solid rgba(0,0,0,.10)";
      icon.style.display = "grid";
      icon.style.placeItems = "center";
      icon.style.background = "rgba(255,255,255,.55)";
      icon.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M7 3h7l3 3v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="rgba(0,0,0,.6)" stroke-width="2"/>
          <path d="M14 3v4h4" stroke="rgba(0,0,0,.6)" stroke-width="2"/>
        </svg>`;
      card.appendChild(icon);
    }

    const meta = document.createElement("div");
    meta.className = "meta";
    const fn = document.createElement("div");
    fn.className = "fn";
    fn.textContent = a.name || "file";
    const sz = document.createElement("div");
    sz.className = "sz";
    sz.textContent = bytesToSize(a.size || 0);
    meta.appendChild(fn);
    meta.appendChild(sz);

    const link = document.createElement("a");
    link.href = "javascript:void(0)";
    link.textContent = "下载";
    link.addEventListener("click", async ()=>{
      const url = await getFileUrl(a.id);
      if (!url) return;
      const aEl = document.createElement("a");
      aEl.href = url;
      aEl.download = a.name || "file";
      document.body.appendChild(aEl);
      aEl.click();
      aEl.remove();
    });

    card.appendChild(meta);
    card.appendChild(link);
    list.appendChild(card);
  }

  container.appendChild(list);
}

/***********************
 * Render chat
 ***********************/
function renderChat(forceScrollToBottom=false){
  const chat = getActiveChat();

  const wasNear = isNearBottom(chatwrap, 80) || forceScrollToBottom;

  clearChatDOM();

  if (!chat || !chat.messages || chat.messages.length === 0) {
    showEmpty(true);
    return;
  }

  showEmpty(false);

  const msgs = chat.messages;
  const total = msgs.length;
  const from = Math.max(0, total - chatWindowLimit);
  const slice = msgs.slice(from);

  if (from > 0) {
    const wrap = document.createElement("div");
    wrap.className = "loadEarlier";
    const btn = document.createElement("button");
    btn.textContent = `加载更早消息（剩余 ${from}）`;
    btn.addEventListener("click", ()=>{
      chatWindowLimit = Math.min(total, chatWindowLimit + WINDOW_STEP);
      renderChat(false);
    });
    wrap.appendChild(btn);
    chatwrap.appendChild(wrap);
  }

  for (const msg of slice) {
    if (msg.role === "user") {
      const { bubble } = createBubble({
        roleClass: "user",
        kindClass: "user",
        label: "you",
        text: msg.content || "",
        msgId: msg.id,
        part: "content",
        allowTranslate: false,
        allowRetry: false,
        allowContinue: false
      });
      if (msg.attachments?.length) renderAttachmentsInto(bubble, msg.attachments);
    } else if (msg.role === "assistant") {
      const showThinkingBubble = !!(msg.thinking && (msg.pending || (msg.reasoning && msg.reasoning.trim())));
      if (showThinkingBubble) {
        createBubble({
          roleClass: "assistant",
          kindClass: "thinking",
          label: "thinking",
          text: msg.reasoning || (msg.pending ? "（生成中…）" : ""),
          msgId: msg.id,
          part: "reasoning",
          allowTranslate: true,
          allowRetry: false,
          allowContinue: false
        });
      }

      const allowRetry = !msg.pending;
      const allowContinue = !!msg.interrupted;

      createBubble({
        roleClass: "assistant",
        kindClass: "output",
        label: "output",
        text: msg.content || (msg.pending ? "…" : ""),
        msgId: msg.id,
        part: "content",
        allowTranslate: true,
        allowRetry,
        allowContinue
      });
    }
  }

  if (wasNear) scrollToBottom();
}

/***********************
 * Inline Edit
 ***********************/
function startInlineEdit(bubbleEl){
  if (isStreaming) {
    showToast("生成中，暂不支持编辑");
    return;
  }
  const chat = getActiveChat();
  const msgId = bubbleEl.dataset.msgId;
  const part = bubbleEl.dataset.part;
  const msg = findMsg(chat, msgId);
  if (!msg) return;

  const body = bubbleEl.querySelector(".bubbleBody");
  if (!body) return;

  if (bubbleEl.querySelector(".editWrap")) return;

  const currentText = (part === "reasoning" ? (msg.reasoning || "") : (msg.content || ""));

  const wrap = document.createElement("div");
  wrap.className = "editWrap";

  const ta = document.createElement("textarea");
  ta.className = "editArea";
  ta.value = currentText;

  const actions = document.createElement("div");
  actions.className = "editActions";

  const cancel = document.createElement("button");
  cancel.className = "smallBtn";
  cancel.textContent = "取消";

  const save = document.createElement("button");
  save.className = "smallBtn primary";
  save.textContent = "保存";

  actions.appendChild(cancel);
  actions.appendChild(save);

  wrap.appendChild(ta);
  wrap.appendChild(actions);

  body.style.display = "none";
  bubbleEl.appendChild(wrap);

  cancel.addEventListener("click", ()=>{
    wrap.remove();
    body.style.display = "";
  });

  save.addEventListener("click", ()=>{
    const v = (ta.value || "").toString();
    if (part === "reasoning") {
      msg.reasoning = v;
      msg.reasoningZh = "";
    } else {
      msg.content = v;
      msg.contentZh = "";
    }
    const chat = getActiveChat();
    touchChat(chat);
    maybeUpdateTitle(chat);
    schedulePersistChat(chat);
    renderSidebar();
    renderChat(false);
    showToast("已保存");
  });
}

/***********************
 * Translate
 ***********************/
async function translateTextToZh(text, model){
  const apiKey = getApiKey();
  if(!apiKey){
    openSettings();
    throw new Error("Missing API key（请先在设置里填写 Key）");
  }
  const sys =
`你是翻译引擎。
把用户提供的文本翻译为简体中文。
要求：
- 保留原有 Markdown/代码块/列表/换行结构
- 不要解释，不要加前缀，只输出翻译结果`;

  const res = await fetch(`${VE_BASE_URL}/chat/completions`, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model,
      stream: false,
      messages: [
        { role: "system", content: sys },
        { role: "user", content: text }
      ]
    })
  });

  if (!res.ok) {
    const txt = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
  }
  const json = await res.json().catch(()=> ({}));
  const out = json?.choices?.[0]?.message?.content ?? "";
  return (out || "").trim();
}

async function handleTranslate(bubbleEl, evt){
  if (isStreaming) {
    showToast("生成中，暂不支持翻译");
    return;
  }

  const chat = getActiveChat();
  const msgId = bubbleEl.dataset.msgId;
  const part = bubbleEl.dataset.part;
  const msg = findMsg(chat, msgId);
  if (!msg) return;

  const body = bubbleEl.querySelector(".bubbleBody");
  if (!body) return;

  const original = (part === "reasoning") ? (msg.reasoning || "") : (msg.content || "");
  if (!original.trim()) {
    showToast("没有可翻译内容");
    return;
  }

  if (bubbleEl.dataset.showZh === "1") {
    bubbleEl.dataset.showZh = "0";
    body.dataset.raw = original;
    body.innerHTML = renderMarkdown(original);
    showToast("已切回原文");
    return;
  }

  const zhKey = (part === "reasoning") ? "reasoningZh" : "contentZh";
  if (msg[zhKey] && String(msg[zhKey]).trim()) {
    bubbleEl.dataset.showZh = "1";
    bubbleEl.dataset.zhText = msg[zhKey];
    body.dataset.raw = msg[zhKey];
    body.innerHTML = renderMarkdown(msg[zhKey]);
    showToast("已显示中文翻译");
    return;
  }

  let model = getTranslateModel();
  if (evt && evt.shiftKey) {
    const picked = window.prompt("临时翻译模型 ID（仅本次）", model);
    if (picked === null) return;
    model = (picked || "").trim() || model;
  }

  try{
    showToast("翻译中…");
    const translated = await translateTextToZh(original, model);
    msg[zhKey] = translated;
    touchChat(chat);
    schedulePersistChat(chat);

    bubbleEl.dataset.showZh = "1";
    bubbleEl.dataset.zhText = translated;
    body.dataset.raw = translated;
    body.innerHTML = renderMarkdown(translated);

    renderSidebar();
    showToast("翻译完成");
  }catch(err){
    showToast("翻译失败");
    console.error(err);
  }
}

/***********************
 * Extract thinking
 ***********************/
function extractThinkingFromText(fullText){
  if (typeof fullText !== "string") return { clean: fullText || "", thinking: "" };
  const m = fullText.match(/<(thinking|analysis)>([\s\S]*?)<\/\1>/i);
  if (!m) return { clean: fullText, thinking: "" };
  const thinking = (m[2] || "").trim();
  const clean = fullText.replace(m[0], "").trim();
  return { clean, thinking };
}

/***********************
 * Build API messages (multimodal for images)
 ***********************/
function formatTextAttachmentsForModel(attachments){
  if (!attachments || !attachments.length) return "";
  const texts = attachments.filter(a => !a.isImage && a.text && a.text.trim());
  const others = attachments.filter(a => !a.isImage && !(a.text && a.text.trim()));
  if (!texts.length && !others.length) return "";

  const lines = [];
  lines.push("\n\n[附件]");
  for (const a of texts){
    lines.push(`- ${a.name || "file"} (${bytesToSize(a.size || 0)})`);
    lines.push("```");
    lines.push(a.text);
    lines.push("```");
  }
  for (const a of others){
    lines.push(`- ${a.name || "file"} (${bytesToSize(a.size || 0)})`);
  }
  return lines.join("\n");
}

async function buildUserMessageContent(userMsg, { includeImages=true } = {}){
  const attachments = userMsg.attachments || [];
  const hasImages = includeImages && attachments.some(a => a.isImage);

  const textSuffix = formatTextAttachmentsForModel(attachments);
  const baseText = (userMsg.content || "") + textSuffix;

  if (!hasImages) {
    return baseText;
  }

  const parts = [{ type: "text", text: baseText || " " }];

  for (const a of attachments.filter(x => x.isImage)){
    const blob = await getFileBlob(a.id);
    if (!blob) continue;
    try{
      const dataUrl = await blobToDataURL(blob);
      if (typeof dataUrl === "string" && dataUrl.length < 8_000_000){
        parts.push({ type: "image_url", image_url: { url: dataUrl } });
      }
    }catch{}
  }

  return parts;
}

async function buildApiMessagesAsync(chat, { excludeAssistantId = "", includeImages=true } = {}){
  const all = (chat.messages || [])
    .filter(m => !(m.role === "assistant" && m.pending))
    .filter(m => !(excludeAssistantId && m.role === "assistant" && m.id === excludeAssistantId));

  const slice = all.slice(Math.max(0, all.length - CONTEXT_MAX_MESSAGES));

  const out = [];
  for (const m of slice){
    if (m.role === "user"){
      const content = await buildUserMessageContent(m, { includeImages });
      out.push({ role: "user", content });
    } else {
      out.push({ role: m.role, content: m.content || "" });
    }
  }
  return out;
}

/***********************
 * Streaming SSE (robust + abort)
 ***********************/
async function streamChatCompletion({ model, messages, signal, onDelta, onDone }){
  const apiKey = getApiKey();
  if(!apiKey){
    openSettings();
    throw new Error("Missing API key（请先在设置里填写 Key）");
  }

  const res = await fetch(`${VE_BASE_URL}/chat/completions`, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({ model, messages, stream: true }),
    signal
  });

  if (!res.ok) {
    const txt = await res.text().catch(()=> "");
    const err = new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
    err.status = res.status;
    err.bodyText = txt || "";
    throw err;
  }
  if (!res.body) throw new Error("Stream body not available");

  const reader = res.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let buffer = "";

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });

    const events = buffer.split("\n\n");
    buffer = events.pop() || "";

    for (const evt of events) {
      const lines = evt.split("\n");
      let dataPayloads = [];
      for (const ln of lines){
        const line = ln.trimEnd();
        if (line.startsWith("data:")){
          dataPayloads.push(line.slice(5).trim());
        }
      }
      if (!dataPayloads.length) continue;

      const dataStrJoined = dataPayloads.join("\n").trim();
      if (dataStrJoined === "[DONE]") {
        onDone?.();
        return;
      }

      let json;
      try { json = JSON.parse(dataStrJoined); } catch { continue; }

      const choice = json?.choices?.[0];
      const delta = choice?.delta || {};
      const contentDelta = delta.content ?? "";
      const reasoningDelta = delta.reasoning_content ?? delta.reasoning ?? "";

      if (contentDelta || reasoningDelta) {
        onDelta?.({ contentDelta, reasoningDelta });
      }
    }
  }
  onDone?.();
}

/***********************
 * Composer enable/disable + send button mode
 ***********************/
function setSendModeStop(isStop){
  sendBtn.classList.toggle("stop", !!isStop);
  sendBtn.title = isStop ? "Stop" : "Send";
  sendBtn.setAttribute("aria-label", isStop ? "Stop" : "Send");
  sendIcon.innerHTML = isStop
    ? `<path d="M7 7h10v10H7V7Z" stroke="rgba(255,255,255,.92)" stroke-width="2.2" />`
    : `<path d="M12 4l7 7-7 7" stroke="rgba(0,0,0,.65)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 11h13" stroke="rgba(0,0,0,.65)" stroke-width="2.2" stroke-linecap="round"/>`;
}

function setComposerDisabled(disabled){
  if (disabled) {
    promptEl.disabled = true;
    modelBtn.disabled = true;
    plusBtn.disabled = true;
    clockBtn.disabled = true;
    webBtn.disabled = true;

    sendBtn.disabled = false;
    setSendModeStop(true);
  } else {
    promptEl.disabled = false;
    modelBtn.disabled = false;
    plusBtn.disabled = false;
    webBtn.disabled = false;

    const m = getModelById(selectedModelId);
    const can = m ? (m.thinkingOnly || modelSupportsThinkingToggle(m)) : false;
    clockBtn.disabled = !can;

    setSendModeStop(false);
    syncSendState();
  }
}

function syncSendState(){
  if (isStreaming) {
    sendBtn.disabled = false;
    return;
  }
  const hasText = promptEl.value.trim().length > 0;
  const hasAttach = draftAttachments.length > 0;
  sendBtn.disabled = !(hasText || hasAttach);
}
promptEl.addEventListener('input', syncSendState);

/***********************
 * Stop generation
 ***********************/
function stopGeneration(){
  if (!isStreaming) return;
  try{ abortCtl?.abort(); }catch{}
  showToast("已停止");
}

/***********************
 * Send / Retry / Continue
 ***********************/
async function finalizeAssistantMessage({ chatId, msgId, effThinking, rawText, reasoning, interrupted=false }){
  const c = getChatById(chatId);
  const m = findMsg(c, msgId);
  if (!m) return;

  let finalAnswer = rawText;
  let finalReasoning = reasoning;

  if (!finalReasoning || !finalReasoning.trim()) {
    const ext = extractThinkingFromText(rawText);
    finalAnswer = ext.clean;
    finalReasoning = ext.thinking;
  } else {
    const ext = extractThinkingFromText(rawText);
    finalAnswer = ext.clean;
  }

  m.pending = false;
  m.content = (finalAnswer || "").trim() || "（空响应）";
  m.reasoning = (finalReasoning || "").trim();
  m.thinking = !!effThinking;
  m.interrupted = !!interrupted;

  touchChat(c);
  maybeUpdateTitle(c);
  schedulePersistChat(c);
  renderSidebar();

  if (store.activeId === chatId) renderChat(false);
}

/***********************
 * ✅ 流式更新 DOM：默认不自动滚动（只有开启 streamAutoScroll 才滚）
 ***********************/
function updateDOMStreamingVisible({ assistantMsgId, reasoning, rawText }){
  if (!activeStream) return null;
  if (store.activeId !== activeStream.chatId) return null;

  const answerBody = chatwrap.querySelector(`.bubble.assistant.output[data-msg-id="${assistantMsgId}"] .bubbleBody`);
  const thinkBody  = chatwrap.querySelector(`.bubble.assistant.thinking[data-msg-id="${assistantMsgId}"] .bubbleBody`);
  if (thinkBody) {
    thinkBody.dataset.raw = reasoning || "（生成中…）";
    thinkBody.innerHTML = renderMarkdown(reasoning || "（生成中…）");
  }
  if (answerBody) {
    answerBody.dataset.raw = rawText || "…";
    answerBody.innerHTML = renderMarkdown(rawText || "…");
  }

  // ✅ 不自动滚动（除非设置开启，且用户在底部附近）
  if (streamAutoScroll && isNearBottom(chatwrap, 40)) {
    scrollToBottom();
  }
}

async function send({ overrideUserText = "", excludeAssistantId = "" } = {}){
  if (isStreaming) return;

  const chat = getActiveChat();
  if (!chat) return;

  const text = (overrideUserText || promptEl.value || "").trim();
  const hasAttach = draftAttachments.length > 0;
  if (!text && !hasAttach) return;

  const effThinking = effectiveThinking();
  showEmpty(false);

  const attachments = [];
  if (hasAttach){
    for (const a of draftAttachments){
      try{
        await putFileRecord(a);
        attachments.push({
          id: a.id,
          name: a.name,
          type: a.type,
          size: a.size,
          lastModified: a.lastModified,
          isImage: !!a.isImage,
          text: a.text || ""
        });
      }catch(e){
        console.error("putFileRecord failed", e);
      }
    }
  }

  const userMsgId = uid();
  const asstMsgId = uid();

  const userContent = text || (hasAttach ? "（发送了附件）" : "");
  chat.messages.push({ id:userMsgId, role:"user", content:userContent, attachments });

  chat.messages.push({
    id: asstMsgId,
    role:"assistant",
    content:"",
    reasoning:"",
    thinking: effThinking,
    pending: true,
    contentZh: "",
    reasoningZh: "",
    attachments: [],
    interrupted: false
  });

  draftAttachments = [];
  renderAttachBar();
  promptEl.value = "";
  syncSendState();

  touchChat(chat);
  maybeUpdateTitle(chat);
  schedulePersistChat(chat);
  renderChatsList();

  const u = createBubble({
    roleClass: "user",
    kindClass: "user",
    label: "you",
    text: userContent,
    msgId: userMsgId,
    part: "content",
    allowTranslate: false,
    allowRetry: false,
    allowContinue: false
  });
  if (attachments.length) renderAttachmentsInto(u.bubble, attachments);

  if (effThinking) {
    createBubble({
      roleClass: "assistant",
      kindClass: "thinking",
      label: "thinking",
      text: "（生成中…）",
      msgId: asstMsgId,
      part: "reasoning",
      allowTranslate: true,
      allowRetry: false,
      allowContinue: false
    });
  }

  createBubble({
    roleClass: "assistant",
    kindClass: "output",
    label: "output",
    text: "…",
    msgId: asstMsgId,
    part: "content",
    allowTranslate: true,
    allowRetry: false,
    allowContinue: false
  });

  // ✅ 发送时：只在用户本来就在底部时滚一次（不是流式跟随滚）
  if (isNearBottom(chatwrap, 80)) scrollToBottom();

  isStreaming = true;
  activeStream = { chatId: chat.id, assistantMsgId: asstMsgId, effThinking };
  abortCtl = new AbortController();
  setComposerDisabled(true);

  const baseSys = getSystemPrompt();
  const modeLine =
`\n\n[UI_MODE]
thinking_mode=${effThinking ? "on" : "off"}
当 thinking_mode=on 时，请按 system 规则输出 <thinking>...</thinking>；off 则不要输出 <thinking>。`;

  const modelToUse = isWebSearch ? getSearchModel() : currentModelId();

  let rawText = "";
  let reasoning = "";
  let gotAnyDelta = false;

  const hadImages = attachments.some(a => a.isImage) || chat.messages.some(m => (m.attachments||[]).some(a=>a.isImage));
  let includeImages = true;
  let attempt = 0;

  try{
    while (true){
      const reqMessages = [
        { role:"system", content: (baseSys + modeLine).trim() },
        ...(await buildApiMessagesAsync(chat, { excludeAssistantId, includeImages }))
      ];

      try{
        await streamChatCompletion({
          model: modelToUse,
          messages: reqMessages,
          signal: abortCtl.signal,
          onDelta: ({ contentDelta, reasoningDelta }) => {
            gotAnyDelta = gotAnyDelta || !!(contentDelta || reasoningDelta);

            const c = getChatById(activeStream.chatId);
            const m = findMsg(c, activeStream.assistantMsgId);
            if (!m) return;

            if (reasoningDelta) {
              reasoning += reasoningDelta;
              m.reasoning = reasoning;
            }
            if (contentDelta) {
              rawText += contentDelta;
              m.content = rawText;
            }

            schedulePersistChat(c);
            updateDOMStreamingVisible({ assistantMsgId: activeStream.assistantMsgId, reasoning, rawText });
          },
          onDone: () => {}
        });
        break;
      }catch(err){
        if (err?.name === "AbortError") throw err;

        if (hadImages && includeImages && (err.status === 400 || err.status === 422) && attempt === 0) {
          includeImages = false;
          attempt++;
          showToast("接口不支持图片输入，已降级为文本");
          continue;
        }

        attempt++;
        if (!gotAnyDelta && attempt <= 1) {
          continue;
        }
        throw err;
      }
    }

    await finalizeAssistantMessage({
      chatId: activeStream.chatId,
      msgId: activeStream.assistantMsgId,
      effThinking,
      rawText,
      reasoning,
      interrupted: false
    });

  }catch(err){
    if (err?.name === "AbortError") {
      await finalizeAssistantMessage({
        chatId: activeStream.chatId,
        msgId: activeStream.assistantMsgId,
        effThinking,
        rawText,
        reasoning,
        interrupted: false
      });
    } else {
      await finalizeAssistantMessage({
        chatId: activeStream.chatId,
        msgId: activeStream.assistantMsgId,
        effThinking,
        rawText: rawText || `连接中断：${err?.message || String(err)}`,
        reasoning,
        interrupted: true
      });
      showToast("连接中断");
      console.error(err);
    }
  }finally{
    isStreaming = false;
    activeStream = null;
    abortCtl = null;
    setComposerDisabled(false);
    syncSendState();
  }
}

/***********************
 * Regenerate / Continue actions
 ***********************/
function handleRegenerate(bubbleEl){
  if (isStreaming) return;
  const chat = getActiveChat();
  if (!chat) return;

  const msgId = bubbleEl.dataset.msgId;
  const msg = findMsg(chat, msgId);
  if (!msg || msg.role !== "assistant") return;

  const idx = chat.messages.findIndex(m => m.id === msgId);
  if (idx <= 0) return;

  const prev = chat.messages[idx - 1];
  if (!prev || prev.role !== "user") return;

  chat.messages = chat.messages.filter(m => m.id !== msgId);

  touchChat(chat);
  schedulePersistChat(chat);
  renderSidebar();
  renderChat(false);

  send({ overrideUserText: "请重新回答上一条。", excludeAssistantId: "" });
}

function handleContinue(bubbleEl){
  if (isStreaming) return;
  send({ overrideUserText: "继续。" });
}

/***********************
 * Send button behavior
 ***********************/
sendBtn.addEventListener('click', ()=>{
  if (isStreaming) stopGeneration();
  else send();
});

promptEl.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    if (isStreaming) return;
    send();
  }
});

/***********************
 * Settings modal
 ***********************/
function openSettings(){
  keyInput.value = getApiKey();
  translateModelInput.value = getTranslateModel();
  searchModelInput.value = getSearchModel();
  sysInput.value = localStorage.getItem(SYS_PROMPT_STORAGE) || DEFAULT_SYSTEM_PROMPT;

  fontSizeRange.value = String(fontSize);
  fontSizeVal.textContent = String(fontSize);

  // ✅ 新增
  bgColorInput.value = theme.bg;
  textColorInput.value = theme.ink;
  streamScrollToggle.checked = !!streamAutoScroll;

  settingsModal.classList.add("show");
}
function closeSettings(){ settingsModal.classList.remove("show"); }

settingsBtn.addEventListener('click', ()=>{
  if (isStreaming) return;
  openSettings();
});
settingsCancel.addEventListener('click', closeSettings);
settingsModal.addEventListener('click', (e)=>{
  if (e.target === settingsModal) closeSettings();
});

fontSizeRange.addEventListener("input", ()=>{
  fontSize = Number(fontSizeRange.value);
  applyFontSize();
});

resetSysBtn.addEventListener('click', ()=>{ sysInput.value = DEFAULT_SYSTEM_PROMPT; });
clearKeyBtn.addEventListener('click', ()=>{ keyInput.value = ""; });

clearAllChatsBtn.addEventListener('click', async ()=>{
  if (isStreaming) return;
  store = { activeId:"", chats:[] };
  await idbClear("chats");
  await idbClear("files");
  await idbPut("meta", { key: "activeId", value: "" });
  createNewChat();
  closeSettings();
  showToast("已清空");
});

settingsSave.addEventListener('click', ()=>{
  const k = (keyInput.value || "").trim();
  const s = (sysInput.value || "").trim();
  const tm = (translateModelInput.value || "").trim();
  const sm = (searchModelInput.value || "").trim();

  if(!k) localStorage.removeItem(VE_KEY_STORAGE);
  else localStorage.setItem(VE_KEY_STORAGE, k);

  if(!tm) localStorage.removeItem(TRANSLATE_MODEL_STORAGE);
  else localStorage.setItem(TRANSLATE_MODEL_STORAGE, tm);

  if(!sm) localStorage.removeItem(SEARCH_MODEL_STORAGE);
  else localStorage.setItem(SEARCH_MODEL_STORAGE, sm);

  if(!s) localStorage.removeItem(SYS_PROMPT_STORAGE);
  else localStorage.setItem(SYS_PROMPT_STORAGE, s);

  // ✅ 保存主题
  theme.bg = (bgColorInput.value || DEFAULT_THEME.bg).trim();
  theme.ink = (textColorInput.value || DEFAULT_THEME.ink).trim();
  saveTheme();
  applyTheme();

  // ✅ 保存流式滚动开关
  streamAutoScroll = !!streamScrollToggle.checked;
  saveUIState();

  applyFontSize();
  closeSettings();
  showToast("已保存");
});

exportBtn.addEventListener("click", async ()=>{
  const payload = {
    version: 2,
    exportedAt: nowTs(),
    chats: store.chats,
    activeId: store.activeId,
    customModels,
    modelAliases,
    ui: { selectedModelId, isThinking, isWebSearch, fontSize, streamAutoScroll },
    theme,
    translateModel: getTranslateModel(),
    searchModel: getSearchModel(),
    systemPrompt: localStorage.getItem(SYS_PROMPT_STORAGE) || DEFAULT_SYSTEM_PROMPT
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ve_export_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
  showToast("已导出");
});

importBtn.addEventListener("click", ()=>{
  importFile.value = "";
  importFile.click();
});

importFile.addEventListener("change", async ()=>{
  const f = importFile.files?.[0];
  if (!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if (!data || !Array.isArray(data.chats)) throw new Error("Invalid file");

    await idbClear("chats");
    await idbClear("files");
    store.chats = data.chats.map(normalizeChat);
    store.chats.sort((a,b)=> b.updatedAt - a.updatedAt);
    store.activeId = (data.activeId && store.chats.find(c=>c.id===data.activeId)) ? data.activeId : (store.chats[0]?.id || "");
    for (const c of store.chats) await idbPut("chats", c);
    await idbPut("meta", { key: "activeId", value: store.activeId || "" });

    if (Array.isArray(data.customModels)) {
      customModels = data.customModels.map(m=>({
        id: String(m.id || "").trim(),
        label: String(m.label || "Model").trim(),
        thinkingId: String(m.thinkingId || "").trim(),
        thinkingOnly: !!m.thinkingOnly,
        builtin: false
      })).filter(m=>m.id);
      localStorage.setItem(CUSTOM_MODELS_KEY, JSON.stringify(customModels));
    }
    if (data.modelAliases && typeof data.modelAliases === "object") {
      modelAliases = data.modelAliases;
      localStorage.setItem(MODEL_ALIASES_KEY, JSON.stringify(modelAliases));
    }
    if (data.ui && typeof data.ui === "object") {
      selectedModelId = data.ui.selectedModelId || selectedModelId;
      isThinking = !!data.ui.isThinking;
      isWebSearch = !!data.ui.isWebSearch;
      if (typeof data.ui.fontSize === "number") fontSize = data.ui.fontSize;
      if (typeof data.ui.streamAutoScroll === "boolean") streamAutoScroll = data.ui.streamAutoScroll;
      saveUIState();
    }

    // ✅ 导入主题
    if (data.theme && typeof data.theme === "object"){
      if (typeof data.theme.bg === "string") theme.bg = data.theme.bg;
      if (typeof data.theme.ink === "string") theme.ink = data.theme.ink;
      saveTheme();
    }

    if (typeof data.translateModel === "string") localStorage.setItem(TRANSLATE_MODEL_STORAGE, data.translateModel);
    if (typeof data.searchModel === "string") localStorage.setItem(SEARCH_MODEL_STORAGE, data.searchModel);
    if (typeof data.systemPrompt === "string") localStorage.setItem(SYS_PROMPT_STORAGE, data.systemPrompt);

    renderSidebar();
    renderModelDropdown();
    applyModelCapabilities();
    applyWebSearchState();
    applyFontSize();
    applyTheme();
    renderAttachBar();
    renderChat(true);
    showToast("已导入");
  }catch(e){
    console.error(e);
    showToast("导入失败");
  }
});

/***********************
 * Model manager modal
 ***********************/
function openModelManager(){
  renderModelManager();
  modelManagerModal.classList.add("show");
}
function closeModelManager(){
  modelManagerModal.classList.remove("show");
}
modelsBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  openModelManager();
});
mmCloseManagerBtn.addEventListener("click", closeModelManager);
modelManagerModal.addEventListener("click", (e)=>{
  if (e.target === modelManagerModal) closeModelManager();
});
mmAddBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  openModelModalAdd();
});

/***********************
 * Model editor modal
 ***********************/
function openModelModal(){ modelModal.classList.add("show"); }
function closeModelModal(){ modelModal.classList.remove("show"); }
modelModal.addEventListener("click", (e)=>{ if (e.target === modelModal) closeModelModal(); });
mmCancelBtn.addEventListener("click", closeModelModal);

function openModelModalAdd(){
  modelModalMode = "add";
  modelModalTargetId = "";
  modelModalIsBuiltin = false;

  modelModalTitle.textContent = "Add model";
  modelModalDesc.textContent = "新增自定义模型。";
  mmDeleteBtn.style.display = "none";

  mmLabel.value = "";
  mmBaseId.value = "";
  mmThinkingId.value = "";
  mmThinkingOnly.checked = false;

  mmBaseId.disabled = false;
  mmThinkingId.disabled = false;
  mmThinkingOnly.disabled = false;

  openModelModal();
}

function openModelModalEdit(m){
  modelModalMode = "edit";
  modelModalTargetId = m.id;
  modelModalIsBuiltin = !!m.builtin;

  modelModalTitle.textContent = modelModalIsBuiltin ? "Rename model" : "Edit model";
  modelModalDesc.textContent = modelModalIsBuiltin ? "仅修改显示名称。" : "编辑或删除自定义模型。";

  mmLabel.value = getModelLabel(m);
  mmBaseId.value = m.id;
  mmThinkingId.value = m.thinkingId || "";
  mmThinkingOnly.checked = !!m.thinkingOnly;

  mmBaseId.disabled = modelModalIsBuiltin;
  mmThinkingId.disabled = modelModalIsBuiltin;
  mmThinkingOnly.disabled = modelModalIsBuiltin;

  mmDeleteBtn.style.display = modelModalIsBuiltin ? "none" : "";
  openModelModal();
}

mmDeleteBtn.addEventListener("click", ()=>{
  if (modelModalMode !== "edit") return;
  if (modelModalIsBuiltin) return;

  const id = modelModalTargetId;
  customModels = customModels.filter(m => m.id !== id);

  if (selectedModelId === id) {
    selectedModelId = BUILTIN_MODELS[0].id;
    isThinking = false;
  }

  saveModels();
  closeModelModal();
  applyModelCapabilities();
  renderModelDropdown();
  renderModelManager();
});

mmSaveBtn.addEventListener("click", ()=>{
  const label = (mmLabel.value || "").trim() || "Model";
  const baseId = (mmBaseId.value || "").trim();
  const thinkingId = (mmThinkingId.value || "").trim();
  const thinkingOnly = !!mmThinkingOnly.checked;

  if (modelModalMode === "add") {
    if (!baseId) { alert("请填写模型 ID（Base）。"); return; }
    const existingBuiltin = BUILTIN_MODELS.find(x => x.id === baseId);
    const existingCustom = customModels.find(x => x.id === baseId);
    if (existingBuiltin || existingCustom) { alert("该模型 ID 已存在。"); return; }

    customModels.unshift({
      id: baseId,
      label,
      thinkingId: thinkingOnly ? "" : thinkingId,
      thinkingOnly: thinkingOnly,
      builtin: false
    });

    saveModels();
    selectedModelId = baseId;
    isThinking = thinkingOnly ? true : isThinking;

    closeModelModal();
    applyModelCapabilities();
    renderModelDropdown();
    renderModelManager();
    showToast("已保存");
    return;
  }

  if (modelModalIsBuiltin) {
    modelAliases[modelModalTargetId] = label;
    saveModels();
    closeModelModal();
    applyModelCapabilities();
    renderModelDropdown();
    renderModelManager();
    showToast("已保存");
    return;
  }

  if (!baseId) { alert("模型 ID（Base）不能为空。"); return; }

  const oldId = modelModalTargetId;
  if (baseId !== oldId) {
    const collisionBuiltin = BUILTIN_MODELS.find(x => x.id === baseId);
    const collisionCustom = customModels.find(x => x.id === baseId);
    if (collisionBuiltin || collisionCustom) { alert("新的模型 ID 与现有模型冲突。"); return; }
  }

  customModels = customModels.map(m => {
    if (m.id !== oldId) return m;
    return {
      id: baseId,
      label,
      thinkingId: thinkingOnly ? "" : thinkingId,
      thinkingOnly,
      builtin: false
    };
  });

  if (selectedModelId === oldId) selectedModelId = baseId;

  saveModels();
  closeModelModal();
  applyModelCapabilities();
  renderModelDropdown();
  renderModelManager();
  showToast("已保存");
});

/***********************
 * Top right plus = new chat
 ***********************/
topPlusBtn.addEventListener('click', ()=>{ createNewChat(); });

/***********************
 * Init
 ***********************/
async function init(){
  loadTheme();
  applyTheme();

  loadModels();
  loadUIState();

  await openDB();
  await migrateLegacyLocalStorageIfNeeded();
  await loadStoreFromDB();

  if (!getModelById(selectedModelId)) {
    selectedModelId = BUILTIN_MODELS[0].id;
    isThinking = false;
  }

  renderSidebar();
  renderModelDropdown();
  applyModelCapabilities();
  applyWebSearchState();
  applyFontSize();

  renderAttachBar();
  renderChat(true);
  syncSendState();
}
init();
</script>

</body>
</html>
