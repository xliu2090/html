<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI Chat Client · Pro UI</title>
  <style>
    :root{
      --bg: #F7F4EE;
      --panel: rgba(255,255,255,.75);
      --panel-solid: #FFFFFF;
      --ink: #1f1f1f;
      --muted: rgba(0,0,0,.52);
      --hairline: rgba(0,0,0,.10);
      --hairline2: rgba(0,0,0,.08);
      --shadow: 0 14px 34px rgba(0,0,0,.10);
      --shadow-soft: 0 10px 28px rgba(0,0,0,.08);
      --accent: #D98A70;
      --accent2: #B96C55;
      --ok: #2BA36A;
      --warn: #E0A100;
      --err: #DD3D3D;

      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;

      --serif: ui-serif, "Iowan Old Style", "Palatino Linotype", Palatino, Georgia, "Times New Roman", serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --bubble-font: 15px;
      --prompt-font: 18px;
      --sidebar-item: 15px;
      --sidebar-title: 28px;
      --sidebar-sub: 12px;

      --topbar-h: 56px;
      --composer-gap: 12px;
    }

    /* Dark theme variables (applied via data-theme="dark") */
    :root[data-theme="dark"]{
      --bg: #0E0F12;
      --panel: rgba(20,21,27,.70);
      --panel-solid: #151723;
      --ink: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.55);
      --hairline: rgba(255,255,255,.10);
      --hairline2: rgba(255,255,255,.08);
      --shadow: 0 18px 44px rgba(0,0,0,.40);
      --shadow-soft: 0 12px 34px rgba(0,0,0,.34);
      --accent: #D98A70;
      --accent2: #F0A58E;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(217,138,112,.25), transparent 60%),
                  radial-gradient(900px 600px at 110% 20%, rgba(217,138,112,.18), transparent 55%),
                  var(--bg);
      color: var(--ink);
      font-family: var(--sans);
      overflow:hidden;
    }

    .app{
      height:100dvh;
      height:100vh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      display:flex;
      flex-direction:column;
      position:relative;
      touch-action: pan-y;
    }

    /* Topbar */
    .topbar{
      height: var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px;
      gap:10px;
      flex: 0 0 auto;
      position: relative;
      z-index: 20;
    }
    .topbar .left, .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 120px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      min-width: 0;
    }
    .brand .logo{
      width: 34px; height:34px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(217,138,112,.55), rgba(217,138,112,.18));
      border: 1px solid var(--hairline);
      box-shadow: var(--shadow-soft);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .brand .title{
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 18px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 46vw;
    }
    .brand .sub{
      font-size: 12px;
      font-weight: 850;
      color: var(--muted);
      margin-top: -2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 46vw;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .statusDot{
      width:10px;height:10px;
      border-radius: 99px;
      background: var(--warn);
      box-shadow: 0 0 0 6px rgba(224,161,0,.12);
      flex:0 0 auto;
    }
    .statusDot.ok{
      background: var(--ok);
      box-shadow: 0 0 0 6px rgba(43,163,106,.12);
    }
    .statusDot.err{
      background: var(--err);
      box-shadow: 0 0 0 6px rgba(221,61,61,.12);
    }

    .iconbtn{
      width:40px;
      height:40px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      color: var(--ink);
    }
    :root[data-theme="dark"] .iconbtn{ background: rgba(255,255,255,.06); }
    .iconbtn:hover{ background: rgba(255,255,255,.28); }
    :root[data-theme="dark"] .iconbtn:hover{ background: rgba(255,255,255,.10); }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Main */
    .main{
      flex:1;
      min-height:0;
      display:flex;
      justify-content:center;
      padding: 0 12px 10px;
      position: relative;
      z-index: 10;
    }
    .chatwrap{
      width:100%;
      max-width: 820px;
      min-height:0;
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 6px 2px 0;
      scroll-behavior: smooth;
    }

    /* Empty */
    .empty{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-family: var(--serif);
      font-size: 32px;
      letter-spacing: .2px;
      user-select:none;
      padding: 18px;
      text-align:center;
      opacity: .9;
    }

    /* Load earlier */
    .loadEarlier{
      width: 100%;
      display:flex;
      justify-content:center;
      padding: 10px 0 6px;
    }
    .loadEarlier button{
      height: 40px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.25);
      cursor:pointer;
      font-weight: 950;
      user-select:none;
      box-shadow: var(--shadow-soft);
      color: var(--ink);
    }
    :root[data-theme="dark"] .loadEarlier button{ background: rgba(255,255,255,.08); }

    /* Bubbles */
    .bubble{
      width: fit-content;
      max-width: 92%;
      padding: 12px 14px;
      border-radius: 18px;
      margin: 8px 0;
      border: 1px solid var(--hairline2);
      background: rgba(255,255,255,.30);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
      word-break: break-word;
      font-size: var(--bubble-font);
      line-height: 1.60;
      position: relative;
    }
    :root[data-theme="dark"] .bubble{ background: rgba(255,255,255,.06); }

    .bubble.user{
      margin-left:auto;
      background: rgba(255,255,255,.48);
      border-color: var(--hairline);
    }
    :root[data-theme="dark"] .bubble.user{ background: rgba(255,255,255,.10); }

    .bubble.assistant{ margin-right:auto; }

    .bubble.output{
      border-left: 3px solid rgba(217,138,112,.45);
    }
    .bubble.thinking{
      background: rgba(0,0,0,.03);
      border-left: 3px solid rgba(0,0,0,.10);
    }
    :root[data-theme="dark"] .bubble.thinking{
      background: rgba(255,255,255,.06);
      border-left: 3px solid rgba(255,255,255,.12);
    }

    .bubble.thinking .bubbleBody{
      font-family: var(--mono);
      font-size: var(--bubble-font);
      color: var(--muted);
    }
    .bubble.thinking.collapsed .bubbleBody{ display:none; }

    /* Bubble header */
    .bubbleTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .bubbleLabel{
      font-size: 12px;
      font-weight: 950;
      color: var(--muted);
      user-select:none;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
    }
    .bubbleLabel .caret{
      display:inline-block;
      width: 12px;
      opacity:.7;
      transform: translateY(-1px);
    }
    .bubbleActions{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
    }
    .actionBtn{
      width:34px;
      height:34px;
      border-radius: 13px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.18);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, opacity .15s ease;
      user-select:none;
      padding:0;
      color: var(--ink);
    }
    :root[data-theme="dark"] .actionBtn{ background: rgba(255,255,255,.06); }
    .actionBtn:hover{ background: rgba(255,255,255,.30); }
    :root[data-theme="dark"] .actionBtn:hover{ background: rgba(255,255,255,.10); }
    .actionBtn:active{ transform: scale(.98); }
    .actionBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .bubbleBody{ white-space: normal; word-break: break-word; }

    /* Markdown rendering */
    .bubbleBody p{ margin: 0 0 10px; }
    .bubbleBody p:last-child{ margin-bottom: 0; }
    .bubbleBody h1,.bubbleBody h2,.bubbleBody h3,.bubbleBody h4,.bubbleBody h5,.bubbleBody h6{
      margin: 8px 0 10px;
      line-height: 1.25;
    }
    .bubbleBody h1{ font-size: 1.35em; }
    .bubbleBody h2{ font-size: 1.25em; }
    .bubbleBody h3{ font-size: 1.15em; }
    .bubbleBody ul,.bubbleBody ol{ margin: 6px 0 10px 22px; padding:0; }
    .bubbleBody li{ margin: 3px 0; }
    .bubbleBody a{ color: inherit; text-decoration: underline; text-underline-offset: 3px; opacity: .9; }
    .bubbleBody code{
      font-family: var(--mono);
      font-size: 0.95em;
      background: rgba(0,0,0,.05);
      border: 1px solid var(--hairline);
      padding: 1px 6px;
      border-radius: 10px;
    }
    :root[data-theme="dark"] .bubbleBody code{ background: rgba(255,255,255,.08); }
    .bubbleBody pre{
      margin: 8px 0 10px;
      padding: 10px 10px;
      border-radius: 16px;
      overflow:auto;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.03);
    }
    :root[data-theme="dark"] .bubbleBody pre{ background: rgba(255,255,255,.06); }
    .bubbleBody pre code{
      border: none;
      background: transparent;
      padding: 0;
      border-radius: 0;
      display:block;
      white-space: pre;
    }
    .bubbleBody blockquote{
      margin: 6px 0 10px;
      padding: 6px 10px;
      border-left: 3px solid rgba(217,138,112,.55);
      background: rgba(217,138,112,.08);
      border-radius: 14px;
    }
    :root[data-theme="dark"] .bubbleBody blockquote{
      background: rgba(217,138,112,.12);
    }
    .bubbleBody hr{
      border:0;
      height:1px;
      background: var(--hairline);
      margin: 10px 0;
    }
    .highlight{
      background: rgba(217,138,112,.28);
      border-radius: 8px;
      padding: 0 2px;
    }

    /* Inline editor */
    .editWrap{ margin-top: 10px; }
    .editArea{
      width:100%;
      min-height: 100px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      outline:none;
      font-size: 14px;
      font-family: var(--sans);
      resize: vertical;
      background: var(--panel-solid);
      color: var(--ink);
    }
    .editActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .smallBtn{
      height:40px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.04);
      cursor:pointer;
      font-weight: 950;
      user-select:none;
      color: var(--ink);
    }
    :root[data-theme="dark"] .smallBtn{ background: rgba(255,255,255,.06); }
    .smallBtn.primary{
      background: rgba(217,138,112,.22);
      border-color: rgba(217,138,112,.45);
    }

    /* Attachments */
    .attachBar{
      display:none;
      gap:8px;
      flex-wrap: wrap;
      padding: 6px 2px 2px;
      align-items:center;
    }
    .attachBar.show{ display:flex; }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 8px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.03);
      max-width: 100%;
      color: var(--ink);
    }
    :root[data-theme="dark"] .chip{ background: rgba(255,255,255,.06); }
    .chip .name{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      max-width: 240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip .x{
      width:26px;height:26px;
      border-radius: 12px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.30);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
    }
    :root[data-theme="dark"] .chip .x{ background: rgba(255,255,255,.08); }
    .thumb{
      width:40px;height:40px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      object-fit: cover;
      background: rgba(255,255,255,.25);
    }

    /* Attachments in bubble */
    .attachList{
      margin-top: 10px;
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }
    .attachCard{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.20);
      max-width: 100%;
    }
    :root[data-theme="dark"] .attachCard{ background: rgba(255,255,255,.06); }
    .attachCard .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .attachCard .fn{
      font-size: 12px;
      font-weight: 950;
      color: rgba(0,0,0,.72);
      max-width: 280px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    :root[data-theme="dark"] .attachCard .fn{ color: rgba(255,255,255,.82); }
    .attachCard .sz{
      font-size: 11px;
      font-weight: 850;
      color: var(--muted);
    }
    .attachCard a{
      font-size: 12px;
      font-weight: 950;
      color: inherit;
      text-decoration: underline;
      user-select:none;
      white-space: nowrap;
      opacity: .9;
    }

    /* Composer */
    .composer{
      flex: 0 0 auto;
      display:flex;
      justify-content:center;
      padding: 0 12px 12px;
      position: relative;
      z-index: 30;
    }
    .composerCard{
      width:100%;
      max-width: 820px;
      background: var(--panel);
      border-radius: var(--radius-xl);
      border: 1px solid var(--hairline);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px 14px;
      backdrop-filter: blur(12px);
    }

    .promptWrap{
      display:flex;
      gap: 12px;
      align-items:flex-end;
    }
    textarea.prompt{
      width:100%;
      border:0;
      outline:none;
      font-size: var(--prompt-font);
      padding: 8px 8px 8px;
      color: var(--ink);
      background: transparent;
      font-family: var(--sans);
      resize: none;
      line-height: 1.45;
      max-height: 160px;
      overflow:auto;
    }
    textarea.prompt::placeholder{ color: var(--muted); opacity: .7; }

    .composerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--composer-gap);
      padding-top: 8px;
      flex-wrap: wrap;
    }
    .composerLeft, .composerRight{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .miniBtn{
      width:46px;height:46px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.04);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: background .15s ease, transform .08s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      color: var(--ink);
    }
    :root[data-theme="dark"] .miniBtn{ background: rgba(255,255,255,.06); }
    .miniBtn:hover{ background: rgba(0,0,0,.06); }
    :root[data-theme="dark"] .miniBtn:hover{ background: rgba(255,255,255,.10); }
    .miniBtn:active{ transform: scale(.98); }
    .miniBtn.active{
      background: rgba(217,138,112,.20);
      border-color: rgba(217,138,112,.55);
    }
    .miniBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .modelSelect{ position:relative; min-width: 0; }
    .modelBtn{
      height:46px;
      padding: 0 12px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: transparent;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
      font-weight: 900;
      white-space: nowrap;
      transition: opacity .15s ease, background .15s ease;
      max-width: min(340px, 70vw);
      min-width: 0;
    }
    .modelBtn:hover{ background: rgba(0,0,0,.03); }
    :root[data-theme="dark"] .modelBtn:hover{ background: rgba(255,255,255,.06); }
    .modelBtn:disabled{ opacity:.55; cursor:not-allowed; }
    #modelText{
      display:inline-block;
      max-width: 240px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: bottom;
    }
    .chev{ opacity:.65; flex: 0 0 auto; }

    .sendBtn{
      width:46px;height:46px;
      border-radius: 16px;
      border:0;
      cursor:pointer;
      display:grid;
      place-items:center;
      background: rgba(217,138,112,.62);
      box-shadow: 0 10px 22px rgba(217,138,112,.22);
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
      flex: 0 0 auto;
    }
    .sendBtn:hover{ filter: saturate(1.1); }
    .sendBtn:active{ transform: scale(.98); }
    .sendBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .sendBtn.stop{
      background: rgba(0,0,0,.78);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    :root[data-theme="dark"] .sendBtn.stop{
      background: rgba(255,255,255,.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
    }

    .dropdown{
      position:absolute;
      right:0;
      bottom: 56px;
      width: min(360px, 92vw);
      background: var(--panel-solid);
      border:1px solid var(--hairline);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index: 60;
    }
    .dropdown.open{ display:block; }
    .ddItem{
      padding: 12px 12px;
      font-size: 14px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .ddItem:hover{ background: rgba(0,0,0,.04); }
    :root[data-theme="dark"] .ddItem:hover{ background: rgba(255,255,255,.06); }
    .ddItem .meta{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .ddItem .name{ font-weight:900; color: rgba(0,0,0,.78); }
    :root[data-theme="dark"] .ddItem .name{ color: rgba(255,255,255,.88); }
    .ddItem .id{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 250px;
    }
    .tag{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      white-space:nowrap;
      opacity:.9;
    }
    .ddDivider{
      height:1px;
      background: var(--hairline);
      margin: 0 12px;
    }
    .ddFooter{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
      color: rgba(0,0,0,.72);
      font-weight: 950;
    }
    :root[data-theme="dark"] .ddFooter{ color: rgba(255,255,255,.86); }
    .ddFooter:hover{ background: rgba(0,0,0,.04); }
    :root[data-theme="dark"] .ddFooter:hover{ background: rgba(255,255,255,.06); }

    /* Drawer */
    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.28);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 80;
    }
    .backdrop.show{ opacity:1; pointer-events:auto; }

    .drawer{
      position:absolute;
      top:0; left:0;
      height:100%;
      width: min(86vw, 390px);
      background: linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.12));
      backdrop-filter: blur(14px);
      border-right: 1px solid var(--hairline);
      transform: translateX(-102%);
      transition: transform .22s ease;
      z-index: 90;
      display:flex;
      flex-direction:column;
      padding-top: env(safe-area-inset-top);
    }
    :root[data-theme="dark"] .drawer{
      background: linear-gradient(180deg, rgba(20,21,27,.78), rgba(20,21,27,.60));
    }
    .drawer.open{ transform: translateX(0); }

    .drawerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px 10px;
      gap: 10px;
    }
    .drawerHeader .title{
      font-family: var(--serif);
      font-size: var(--sidebar-title);
      font-weight: 900;
      letter-spacing:.2px;
      user-select:none;
    }
    .drawerBody{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 4px 10px 14px;
    }

    .navRow{
      display:flex;
      gap:10px;
      padding: 10px 8px 8px;
      align-items:center;
    }
    .navInput{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.16);
      outline:none;
      font-size: 13px;
      font-weight: 850;
      color: var(--ink);
    }
    :root[data-theme="dark"] .navInput{ background: rgba(255,255,255,.06); }
    .navInput::placeholder{ color: var(--muted); }

    .navItem{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 10px;
      border-radius: 16px;
      cursor:pointer;
      user-select:none;
      color: rgba(0,0,0,.78);
    }
    :root[data-theme="dark"] .navItem{ color: rgba(255,255,255,.90); }
    .navItem:hover{ background: rgba(0,0,0,.04); }
    :root[data-theme="dark"] .navItem:hover{ background: rgba(255,255,255,.06); }
    .navItem .label{ font-size: var(--sidebar-item); font-weight: 950; }

    .sectionTitle{
      margin: 14px 10px 8px;
      font-size: var(--sidebar-sub);
      letter-spacing: .8px;
      color: var(--muted);
      font-weight: 950;
      user-select:none;
      text-transform: uppercase;
    }

    .divider{
      height:1px;
      background: var(--hairline);
      margin: 10px 10px;
    }

    /* Chat list items */
    .chatItem{
      padding: 10px 10px;
      border-radius: 16px;
      cursor:pointer;
      user-select:none;
      border: 1px solid transparent;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .chatItem:hover{ background: rgba(0,0,0,.04); }
    :root[data-theme="dark"] .chatItem:hover{ background: rgba(255,255,255,.06); }
    .chatItem.active{
      background: rgba(217,138,112,.14);
      border-color: rgba(217,138,112,.35);
    }
    .chatLeft{ min-width: 0; }
    .chatTitle{
      font-size: var(--sidebar-item);
      font-weight: 950;
      color: rgba(0,0,0,.82);
      line-height: 1.1;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 260px;
    }
    :root[data-theme="dark"] .chatTitle{ color: rgba(255,255,255,.90); }
    .chatMeta{
      font-size: 11px;
      font-weight: 850;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .chatActions{
      display:flex;
      gap: 6px;
      flex: 0 0 auto;
    }
    .chatTinyBtn{
      width:32px;height:32px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }
    :root[data-theme="dark"] .chatTinyBtn{ background: rgba(255,255,255,.06); }
    .chatTinyBtn:hover{ background: rgba(255,255,255,.24); }
    :root[data-theme="dark"] .chatTinyBtn:hover{ background: rgba(255,255,255,.10); }

    /* Modal */
    .modalBackdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.30);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 120;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(760px, 94vw);
      background: var(--panel-solid);
      border:1px solid var(--hairline);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      max-height: min(86vh, 760px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      color: var(--ink);
    }
    .modal h3{
      margin: 6px 0 8px;
      font-size: 16px;
      font-weight: 950;
    }
    .modal p{
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .modal label{
      display:block;
      margin: 10px 0 6px;
      font-size: 12px;
      font-weight: 950;
      color: var(--muted);
    }
    .modal input, .modal textarea, .modal select{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      outline:none;
      font-size: 14px;
      font-family: var(--sans);
      resize: vertical;
      background: rgba(0,0,0,.03);
      color: var(--ink);
    }
    :root[data-theme="dark"] .modal input,
    :root[data-theme="dark"] .modal textarea,
    :root[data-theme="dark"] .modal select{
      background: rgba(255,255,255,.06);
    }
    .modalRow{
      display:flex;
      gap:10px;
      margin-top: 12px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .btn{
      height:42px;
      padding: 0 14px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.04);
      cursor:pointer;
      font-weight: 950;
      user-select:none;
      color: var(--ink);
    }
    :root[data-theme="dark"] .btn{ background: rgba(255,255,255,.06); }
    .btn.primary{
      background: rgba(217,138,112,.22);
      border-color: rgba(217,138,112,.45);
    }
    .row2{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .row2 > div{ flex:1; min-width: 220px; }

    .toggleRow{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.03);
      user-select:none;
    }
    :root[data-theme="dark"] .toggleRow{ background: rgba(255,255,255,.06); }
    .toggleRow strong{ font-weight: 950; color: rgba(0,0,0,.78); }
    :root[data-theme="dark"] .toggleRow strong{ color: rgba(255,255,255,.90); }
    .toggleRow small{ color: var(--muted); font-weight: 850; }
    .toggleRow input{ transform: scale(1.15); }

    .rangeRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,.03);
      margin-top: 10px;
    }
    :root[data-theme="dark"] .rangeRow{ background: rgba(255,255,255,.06); }
    .rangeRow .val{
      font-weight: 950;
      color: var(--muted);
      min-width: 44px;
      text-align:right;
      user-select:none;
    }
    .rangeRow input[type="range"]{ width: 100%; }

    .sr{ position:absolute; left:-9999px; }

    /* Toast */
    .toast{
      position:absolute;
      left: 50%;
      bottom: calc(86px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.82);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 200;
      max-width: min(92vw, 520px);
      text-align:center;
      user-select:none;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Floating "to bottom" button */
    .toBottom{
      position:absolute;
      right: 18px;
      bottom: calc(116px + env(safe-area-inset-bottom));
      width: 46px; height:46px;
      border-radius: 18px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,.22);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow-soft);
      display:none;
      place-items:center;
      cursor:pointer;
      z-index: 140;
      user-select:none;
    }
    :root[data-theme="dark"] .toBottom{ background: rgba(255,255,255,.07); }
    .toBottom.show{ display:grid; }
    .kbdHint{
      font-size: 11px;
      color: var(--muted);
      font-weight: 850;
      user-select:none;
      padding-left: 2px;
    }

    @media (max-width: 420px){
      .empty{ font-size: 28px; }
      .composer{ padding-bottom: max(12px, env(safe-area-inset-bottom)); }
      :root{ --sidebar-title: 26px; }
      #modelText{ max-width: 180px; }
      .chip .name{ max-width: 160px; }
      .attachCard .fn{ max-width: 210px; }
      .brand .title, .brand .sub{ max-width: 44vw; }
    }
  </style>
</head>

<body>
  <div class="app" id="app">

    <!-- Drawer + backdrop -->
    <div class="backdrop" id="backdrop" aria-hidden="true"></div>

    <aside class="drawer" id="drawer" aria-label="Side menu">
      <div class="drawerHeader">
        <div class="title">Chats</div>
        <button class="iconbtn" id="drawerClose" aria-label="Close menu" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 6.5h16M4 12h16M4 17.5h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="navRow">
        <input class="navInput" id="chatSearchInput" placeholder="搜索会话标题…" autocomplete="off" />
      </div>

      <div class="drawerBody">
        <div class="navItem" id="newChatBtn">
          <div class="miniBtn" style="width:38px;height:38px;border-radius:14px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="label">New chat</div>
        </div>

        <div class="navItem" id="openSearchInChatBtn">
          <div class="miniBtn" style="width:38px;height:38px;border-radius:14px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="label">Search in chat</div>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">Recents</div>
        <div id="chatList"></div>

        <div class="divider"></div>

        <div class="navItem" id="settingsBtnInDrawer">
          <div class="miniBtn" style="width:38px;height:38px;border-radius:14px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
              <path d="M19.4 15a8 8 0 0 0 .1-1l2-1.3-2-3.4-2.3.8a7.9 7.9 0 0 0-1.7-1L15 6h-6l-.5 2.8a7.9 7.9 0 0 0-1.7 1L4.5 9l-2 3.4 2 1.3a8 8 0 0 0 .1 1 8 8 0 0 0-.1 1l-2 1.3 2 3.4 2.3-.8a7.9 7.9 0 0 0 1.7 1L9 22h6l.5-2.8a7.9 7.9 0 0 0 1.7-1l2.3.8 2-3.4-2-1.3a8 8 0 0 0-.1-1Z"
                    stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="label">Settings</div>
        </div>

        <div style="height:18px;"></div>
      </div>
    </aside>

    <!-- Settings modal -->
    <div class="modalBackdrop" id="settingsModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
        <h3>设置</h3>
        <p>聊天与附件保存于本机（IndexedDB）。导出/导入默认不含附件 Blob。</p>

        <label for="baseUrlInput">API Base URL</label>
        <input id="baseUrlInput" placeholder="https://api.vectorengine.ai/v1" autocomplete="off" />

        <label for="keyInput">API Key</label>
        <input id="keyInput" placeholder="sk-..." autocomplete="off" />

        <div class="row2">
          <div>
            <label for="translateModelInput">翻译模型</label>
            <input id="translateModelInput" placeholder="gemini-2.5-flash-lite" autocomplete="off" />
          </div>
          <div>
            <label for="searchModelInput">联网搜索模型</label>
            <input id="searchModelInput" placeholder="gpt-5-search-api" autocomplete="off" />
          </div>
        </div>

        <div class="row2">
          <div>
            <label for="themeSelect">主题</label>
            <select id="themeSelect">
              <option value="system">跟随系统</option>
              <option value="light">浅色</option>
              <option value="dark">深色</option>
            </select>
          </div>
          <div>
            <label for="fontSizeRange">字体大小</label>
            <div class="rangeRow">
              <input id="fontSizeRange" type="range" min="13" max="20" step="1" />
              <div class="val" id="fontSizeVal">15</div>
            </div>
          </div>
        </div>

        <label for="sysInput">System 指令</label>
        <textarea id="sysInput" rows="7"></textarea>

        <div class="modalRow">
          <button class="btn" id="exportBtn">导出</button>
          <button class="btn" id="importBtn">导入</button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />

          <button class="btn" id="modelsBtn">模型管理</button>
          <button class="btn" id="clearAllChatsBtn">清空会话</button>
          <button class="btn" id="clearKeyBtn">清空 Key</button>
          <button class="btn" id="resetSysBtn">重置 System</button>

          <button class="btn" id="settingsCancel">关闭</button>
          <button class="btn primary" id="settingsSave">保存</button>
        </div>
      </div>
    </div>

    <!-- Model manager modal -->
    <div class="modalBackdrop" id="modelManagerModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Models">
        <h3>模型管理</h3>
        <p>选择 / 新增 / 改名 / 删除模型。支持 Base/Thinking 双 ID 或 Thinking-only。</p>
        <div id="modelManagerList"></div>
        <div class="modalRow">
          <button class="btn" id="mmAddBtn">新增模型</button>
          <button class="btn" id="mmCloseManagerBtn">关闭</button>
        </div>
      </div>
    </div>

    <!-- Model editor modal -->
    <div class="modalBackdrop" id="modelModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Model Editor">
        <h3 id="modelModalTitle">Model</h3>
        <p id="modelModalDesc">新增/编辑模型。</p>

        <div class="row2">
          <div>
            <label for="mmLabel">显示名称</label>
            <input id="mmLabel" placeholder="例如：Opus 4.5 / Gemini 3 Pro" />
          </div>
          <div>
            <label for="mmBaseId">模型 ID（Base）</label>
            <input id="mmBaseId" placeholder="例如：claude-sonnet-... 或 gpt-..." />
          </div>
        </div>

        <label for="mmThinkingId">Thinking 模型 ID（可选）</label>
        <input id="mmThinkingId" placeholder="例如：...-thinking（没有就留空）" />

        <div class="toggleRow">
          <div>
            <strong>Thinking-only</strong><br/>
            <small>开启后：该模型永远视为 Thinking（不展示切换开关）</small>
          </div>
          <input type="checkbox" id="mmThinkingOnly" />
        </div>

        <div class="modalRow">
          <button class="btn" id="mmDeleteBtn" style="display:none;">删除</button>
          <button class="btn" id="mmCancelBtn">关闭</button>
          <button class="btn primary" id="mmSaveBtn">保存</button>
        </div>
      </div>
    </div>

    <!-- Search in chat modal -->
    <div class="modalBackdrop" id="searchModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Search in chat">
        <h3>搜索当前会话</h3>
        <p>支持高亮 + 上一个/下一个跳转。不会改动原始内容。</p>
        <label for="searchInput">关键词</label>
        <input id="searchInput" placeholder="例如：函数名 / 报错信息 / 关键句…" autocomplete="off" />

        <div class="modalRow">
          <button class="btn" id="searchPrevBtn">上一个</button>
          <button class="btn" id="searchNextBtn">下一个</button>
          <button class="btn" id="searchClearBtn">清除高亮</button>
          <button class="btn primary" id="searchCloseBtn">关闭</button>
        </div>
      </div>
    </div>

    <!-- Top bar -->
    <header class="topbar">
      <div class="left">
        <button class="iconbtn" id="menuBtn" aria-label="Open menu" title="Menu">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 6.5h16M4 12h16M4 17.5h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M8 12.2l2.4 2.4L16.5 8.5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
              <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="1.8" opacity=".9"/>
            </svg>
          </div>
          <div class="brandText">
            <div class="title">AI Chat Client</div>
            <div class="sub"><span class="statusDot" id="statusDot"></span> <span id="statusText">Not configured</span></div>
          </div>
        </div>
      </div>

      <div class="right">
        <button class="iconbtn" id="searchBtn" aria-label="Search in chat" title="Search in chat (Ctrl/⌘+F)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
            <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>

        <button class="iconbtn" id="themeBtn" aria-label="Toggle theme" title="Toggle theme">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 3v2.2M12 18.8V21M4.2 12H3M21 12h-1.2M6 6l-1.6-1.6M19.6 19.6 18 18M18 6l1.6-1.6M4.4 19.6 6 18"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10Z" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>

        <button class="iconbtn" id="settingsBtn" aria-label="Settings" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
            <path d="M19.4 15a8 8 0 0 0 .1-1l2-1.3-2-3.4-2.3.8a7.9 7.9 0 0 0-1.7-1L15 6h-6l-.5 2.8a7.9 7.9 0 0 0-1.7 1L4.5 9l-2 3.4 2 1.3a8 8 0 0 0 .1 1 8 8 0 0 0-.1 1l-2 1.3 2 3.4 2.3-.8a7.9 7.9 0 0 0 1.7 1L9 22h6l.5-2.8a7.9 7.9 0 0 0 1.7-1l2.3.8 2-3.4-2-1.3a8 8 0 0 0-.1-1Z"
                  stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
          </svg>
        </button>

        <button class="iconbtn" id="topPlusBtn" aria-label="New chat" title="New chat">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main -->
    <main class="main">
      <div class="chatwrap" id="chatwrap" aria-label="Chat messages">
        <div class="empty" id="emptyState">
          Hello, night owl<br/>
          <span class="kbdHint">Ctrl/⌘+F 搜索会话 · Ctrl/⌘+K 打开抽屉</span>
        </div>
      </div>

      <button class="toBottom" id="toBottomBtn" aria-label="Back to bottom" title="Back to bottom">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 14l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </main>

    <!-- Composer -->
    <footer class="composer">
      <div class="composerCard">
        <div class="attachBar" id="attachBar"></div>

        <div class="promptWrap">
          <label class="sr" for="prompt">Prompt</label>
          <textarea id="prompt" class="prompt" rows="1" placeholder="How can I help you today?（Enter 发送 / Shift+Enter 换行）" autocomplete="off"></textarea>
        </div>

        <div class="composerRow">
          <div class="composerLeft">
            <button class="miniBtn" id="plusBtn" aria-label="Upload" title="Upload">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
              </svg>
            </button>

            <button class="miniBtn" id="clockBtn" aria-label="Thinking toggle" title="Thinking">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 8v5l3 2" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2" opacity=".85"/>
              </svg>
            </button>

            <button class="miniBtn" id="webBtn" aria-label="Web Search toggle" title="Web Search（Shift+Click 设置搜索模型）">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 21a9 9 0 1 0-9-9 9 9 0 0 0 9 9Z" stroke="currentColor" stroke-width="2" opacity=".85"/>
                <path d="M3 12h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".85"/>
                <path d="M12 3c3 3 3 15 0 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".85"/>
                <path d="M12 3c-3 3-3 15 0 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".85"/>
              </svg>
            </button>

            <input id="filePicker" type="file" multiple
              accept="image/*,.txt,.md,.json,.csv,.log,.pdf,.doc,.docx,.ppt,.pptx"
              style="display:none;" />
          </div>

          <div class="composerRight">
            <div class="modelSelect">
              <button class="modelBtn" id="modelBtn" aria-haspopup="listbox" aria-expanded="false">
                <span id="modelText">Model</span>
                <svg class="chev" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".75"/>
                </svg>
              </button>
              <div class="dropdown" id="dropdown" role="listbox" aria-label="Model select"></div>
            </div>

            <button class="sendBtn" id="sendBtn" aria-label="Send" title="Send" disabled>
              <svg id="sendIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 4l7 7-7 7" stroke="rgba(0,0,0,.70)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 11h13" stroke="rgba(0,0,0,.70)" stroke-width="2.2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </footer>

    <div class="toast" id="toast">已复制</div>
  </div>

  <script>
/***********************
 * Pro UI Chat Client
 * - Single-file, no build tool
 ***********************/

/***********************
 * Config + Storage Keys
 ***********************/
const DEFAULT_BASE_URL = "https://api.vectorengine.ai/v1";
const VE_BASE_URL_KEY = "ve_base_url";
const VE_KEY_STORAGE = "ve_api_key";
const SYS_PROMPT_STORAGE = "ve_system_prompt";

const CUSTOM_MODELS_KEY = "ve_custom_models_v2";
const MODEL_ALIASES_KEY = "ve_model_aliases_v2";
const UI_STATE_KEY = "ve_ui_state_v6";
const TRANSLATE_MODEL_STORAGE = "ve_translate_model";
const SEARCH_MODEL_STORAGE = "ve_search_model";

const DEFAULT_TRANSLATE_MODEL = "gemini-2.5-flash-lite";
const DEFAULT_SEARCH_MODEL = "gpt-5-search-api";

const DEFAULT_FONT_SIZE = 15;
const CONTEXT_MAX_MESSAGES = 40; // 发送到模型的上下文条数（含 user/assistant，不含 system）
const WINDOW_STEP = 70;          // 渲染窗口：每次加载更早的数量

/***********************
 * IndexedDB
 ***********************/
const DB_NAME = "ve_chat_db_pro_v1";
const DB_VER  = 1;
let _db = null;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains("chats")) db.createObjectStore("chats", { keyPath: "id" });
      if (!db.objectStoreNames.contains("files")) db.createObjectStore("files", { keyPath: "id" });
      if (!db.objectStoreNames.contains("meta"))  db.createObjectStore("meta",  { keyPath: "key" });
    };
    req.onsuccess = () => { _db = req.result; resolve(_db); };
    req.onerror = () => reject(req.error);
  });
}
function os(name, mode="readonly"){ return _db.transaction(name, mode).objectStore(name); }

function idbGet(store, key){
  return new Promise((resolve, reject)=>{
    const req = os(store).get(key);
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
function idbPut(store, value){
  return new Promise((resolve, reject)=>{
    const req = os(store, "readwrite").put(value);
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}
function idbClear(store){
  return new Promise((resolve, reject)=>{
    const req = os(store, "readwrite").clear();
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}
function idbGetAll(store){
  return new Promise((resolve, reject)=>{
    const req = os(store).getAll();
    req.onsuccess = ()=> resolve(req.result || []);
    req.onerror = ()=> reject(req.error);
  });
}

/***********************
 * Models
 ***********************/
const BUILTIN_MODELS = [
  { id:"claude-sonnet-4-5-20250929", label:"Sonnet 4.5", thinkingId:"claude-sonnet-4-5-20250929-thinking", thinkingOnly:false, builtin:true },
  { id:"claude-opus-4-5-20251101",   label:"Opus 4.5",   thinkingId:"claude-opus-4-5-20251101-thinking",   thinkingOnly:false, builtin:true },
  { id:"gemini-3-pro-preview-thinking", label:"Gemini 3 Pro (Preview)", thinkingId:"", thinkingOnly:true, builtin:true }
];

const DEFAULT_SYSTEM_PROMPT =
`你是一个中文助理。

输出规则：
1) 非 thinking 模式：只输出最终答案，简洁清晰。
2) thinking 模式：优先把推理过程放在 <thinking>...</thinking> 标签中（只在 thinking 模式输出），并在标签之外给出最终答案。
3) 不要在 <thinking> 之外提及“系统提示/策略说明”等元信息。`;

/***********************
 * State
 ***********************/
let selectedModelId = BUILTIN_MODELS[0].id;
let isThinking = false;
let isWebSearch = false;
let isStreaming = false;

let themeMode = "system"; // system | light | dark
let fontSize = DEFAULT_FONT_SIZE;

let abortCtl = null;
let activeStream = null; // { chatId, assistantMsgId, effThinking }
let autoScrollAllowed = true;

let chatWindowLimit = WINDOW_STEP;

let store = { activeId: "", chats: [] };
let customModels = [];
let modelAliases = {};

let draftAttachments = []; // [{id,name,type,size,lastModified,isImage,blob:File,text?:string}]

let fileUrlCache = new Map(); // fileId -> url

// search-in-chat state
let searchMatches = []; // [{bubbleEl, idx}]
let searchCursor = -1;

/***********************
 * DOM
 ***********************/
const appEl = document.getElementById("app");

const drawer = document.getElementById("drawer");
const backdrop = document.getElementById("backdrop");
const menuBtn = document.getElementById("menuBtn");
const drawerClose = document.getElementById("drawerClose");

const chatwrap = document.getElementById("chatwrap");
const emptyState = document.getElementById("emptyState");
const toBottomBtn = document.getElementById("toBottomBtn");

const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");

const promptEl = document.getElementById("prompt");
const sendBtn = document.getElementById("sendBtn");
const sendIcon = document.getElementById("sendIcon");

const plusBtn = document.getElementById("plusBtn");
const filePicker = document.getElementById("filePicker");
const attachBar = document.getElementById("attachBar");

const clockBtn = document.getElementById("clockBtn");
const webBtn = document.getElementById("webBtn");

const modelBtn = document.getElementById("modelBtn");
const dropdown = document.getElementById("dropdown");
const modelText = document.getElementById("modelText");

const topPlusBtn = document.getElementById("topPlusBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settingsBtnInDrawer = document.getElementById("settingsBtnInDrawer");

const chatListEl = document.getElementById("chatList");
const newChatBtn = document.getElementById("newChatBtn");
const chatSearchInput = document.getElementById("chatSearchInput");

const toastEl = document.getElementById("toast");
const themeBtn = document.getElementById("themeBtn");

const searchBtn = document.getElementById("searchBtn");
const openSearchInChatBtn = document.getElementById("openSearchInChatBtn");

/* Settings modal */
const settingsModal = document.getElementById("settingsModal");
const baseUrlInput = document.getElementById("baseUrlInput");
const keyInput = document.getElementById("keyInput");
const translateModelInput = document.getElementById("translateModelInput");
const searchModelInput = document.getElementById("searchModelInput");
const sysInput = document.getElementById("sysInput");
const themeSelect = document.getElementById("themeSelect");

const fontSizeRange = document.getElementById("fontSizeRange");
const fontSizeVal = document.getElementById("fontSizeVal");

const settingsCancel = document.getElementById("settingsCancel");
const settingsSave = document.getElementById("settingsSave");
const resetSysBtn = document.getElementById("resetSysBtn");
const clearAllChatsBtn = document.getElementById("clearAllChatsBtn");
const clearKeyBtn = document.getElementById("clearKeyBtn");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");
const modelsBtn = document.getElementById("modelsBtn");

/* Model manager modal */
const modelManagerModal = document.getElementById("modelManagerModal");
const modelManagerList = document.getElementById("modelManagerList");
const mmAddBtn = document.getElementById("mmAddBtn");
const mmCloseManagerBtn = document.getElementById("mmCloseManagerBtn");

/* Model editor modal */
const modelModal = document.getElementById("modelModal");
const modelModalTitle = document.getElementById("modelModalTitle");
const modelModalDesc = document.getElementById("modelModalDesc");
const mmLabel = document.getElementById("mmLabel");
const mmBaseId = document.getElementById("mmBaseId");
const mmThinkingId = document.getElementById("mmThinkingId");
const mmThinkingOnly = document.getElementById("mmThinkingOnly");
const mmDeleteBtn = document.getElementById("mmDeleteBtn");
const mmCancelBtn = document.getElementById("mmCancelBtn");
const mmSaveBtn = document.getElementById("mmSaveBtn");

let modelModalMode = "add";
let modelModalTargetId = "";
let modelModalIsBuiltin = false;

/* Search modal */
const searchModal = document.getElementById("searchModal");
const searchInput = document.getElementById("searchInput");
const searchPrevBtn = document.getElementById("searchPrevBtn");
const searchNextBtn = document.getElementById("searchNextBtn");
const searchClearBtn = document.getElementById("searchClearBtn");
const searchCloseBtn = document.getElementById("searchCloseBtn");

/***********************
 * Helpers
 ***********************/
function nowTs(){ return Date.now(); }
function uid(){ return "m_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8); }
function safeParseJSON(s, fallback){ try { return JSON.parse(s); } catch { return fallback; } }
function clampTitle(s){
  const t = (s || "").trim().replace(/\s+/g," ");
  if (!t) return "New chat";
  return t.length > 20 ? t.slice(0,20) + "…" : t;
}
function formatTime(ts){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${y}-${m}-${day} ${hh}:${mm}`;
}
function bytesToSize(bytes){
  if (bytes === undefined || bytes === null) return "";
  const units = ["B","KB","MB","GB"];
  let n = bytes, i = 0;
  while (n >= 1024 && i < units.length-1){ n/=1024; i++; }
  return i === 0 ? `${n} ${units[i]}` : `${n.toFixed(1)} ${units[i]}`;
}
function showToast(msg){
  toastEl.textContent = msg || "OK";
  toastEl.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toastEl.classList.remove("show"), 1200);
}
async function copyToClipboard(text){
  const t = (text || "").toString();
  if (!t) return;
  try{
    await navigator.clipboard.writeText(t);
    showToast("已复制");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = t;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try { document.execCommand("copy"); showToast("已复制"); }
    catch { showToast("复制失败"); }
    ta.remove();
  }
}

function isNearBottom(el, threshold=90){
  return (el.scrollHeight - el.scrollTop - el.clientHeight) < threshold;
}
function scrollToBottom(){
  chatwrap.scrollTop = chatwrap.scrollHeight;
}
function updateToBottomButton(){
  const show = !isNearBottom(chatwrap, 220);
  toBottomBtn.classList.toggle("show", show);
}

/***********************
 * Theme
 ***********************/
function getSystemTheme(){
  return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
}
function applyTheme(){
  let t = themeMode;
  if (t === "system") t = getSystemTheme();
  document.documentElement.dataset.theme = t;
}
function loadTheme(){
  const ui = safeParseJSON(localStorage.getItem(UI_STATE_KEY) || "{}", {});
  if (ui && typeof ui.themeMode === "string") themeMode = ui.themeMode;
  applyTheme();
}
function toggleThemeQuick(){
  // quick cycle: system -> light -> dark -> system
  themeMode = (themeMode === "system") ? "light" : (themeMode === "light") ? "dark" : "system";
  applyTheme();
  saveUIState();
  showToast(`主题：${themeMode === "system" ? "跟随系统" : (themeMode === "light" ? "浅色" : "深色")}`);
}
themeBtn.addEventListener("click", ()=> {
  if (isStreaming) return;
  toggleThemeQuick();
});
if (window.matchMedia){
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ()=>{
    if (themeMode === "system") applyTheme();
  });
}

/***********************
 * Base URL / Key / System prompt
 ***********************/
function getBaseUrl(){ return (localStorage.getItem(VE_BASE_URL_KEY) || "").trim() || DEFAULT_BASE_URL; }
function getApiKey(){ return (localStorage.getItem(VE_KEY_STORAGE) || "").trim(); }
function getSystemPrompt(){
  const v = (localStorage.getItem(SYS_PROMPT_STORAGE) || "").trim();
  return v || DEFAULT_SYSTEM_PROMPT;
}
function getTranslateModel(){
  const v = (localStorage.getItem(TRANSLATE_MODEL_STORAGE) || "").trim();
  return v || DEFAULT_TRANSLATE_MODEL;
}
function getSearchModel(){
  const v = (localStorage.getItem(SEARCH_MODEL_STORAGE) || "").trim();
  return v || DEFAULT_SEARCH_MODEL;
}
function updateStatusBar(){
  const hasKey = !!getApiKey();
  if (!hasKey){
    statusDot.className = "statusDot err";
    statusText.textContent = "No API Key";
    return;
  }
  statusDot.className = "statusDot ok";
  statusText.textContent = `${getBaseUrl().replace(/^https?:\/\//,"")} · Ready`;
}

/***********************
 * Font size apply
 ***********************/
function applyFontSize(){
  const fs = Math.max(13, Math.min(20, Number(fontSize) || DEFAULT_FONT_SIZE));
  fontSize = fs;

  document.documentElement.style.setProperty("--bubble-font", fs + "px");
  document.documentElement.style.setProperty("--prompt-font", (fs + 3) + "px");
  document.documentElement.style.setProperty("--sidebar-item", fs + "px");

  fontSizeRange.value = String(fs);
  fontSizeVal.textContent = String(fs);

  saveUIState();
}

/***********************
 * Markdown renderer (safe)
 ***********************/
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function safeLinkUrl(url){
  try{
    const u = new URL(url, location.href);
    if (u.protocol === "http:" || u.protocol === "https:") return u.href;
    return "";
  }catch{ return ""; }
}
function renderInline(md){
  let s = escapeHtml(md);

  // links [text](url)
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, text, url)=>{
    const safe = safeLinkUrl(url.trim());
    if (!safe) return text;
    return `<a href="${escapeHtml(safe)}" target="_blank" rel="noopener noreferrer">${text}</a>`;
  });

  // inline code
  s = s.replace(/`([^`]+)`/g, (_, code)=> `<code>${escapeHtml(code)}</code>`);

  // bold / italic (simple)
  s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
  s = s.replace(/(^|[^\*])\*([^*\n]+)\*([^\*]|$)/g, "$1<em>$2</em>$3");

  // hr
  s = s.replace(/^\s*---\s*$/gm, "<hr/>");

  return s;
}
function renderMarkdown(md){
  const text = (md ?? "").toString().replace(/\r\n/g, "\n");
  if (!text.trim()) return "";

  const parts = text.split("```");
  let html = "";

  for (let i = 0; i < parts.length; i++){
    const chunk = parts[i];
    const isCode = i % 2 === 1;

    if (isCode){
      const lines = chunk.replace(/^\n/,"").split("\n");
      // first line may be language
      const code = lines.length > 1 ? lines.slice(1).join("\n") : lines[0];
      html += `<pre><code>${escapeHtml(code)}</code></pre>`;
      continue;
    }

    const lines = chunk.split("\n");
    let inUl = false, inOl = false, inBq = false;
    let para = [];

    const flushPara = ()=>{
      if (para.length){
        const p = renderInline(para.join("\n")).replace(/\n/g,"<br/>");
        html += `<p>${p}</p>`;
        para = [];
      }
    };
    const closeLists = ()=>{
      if (inUl){ html += `</ul>`; inUl = false; }
      if (inOl){ html += `</ol>`; inOl = false; }
    };
    const closeBq = ()=>{
      if (inBq){ html += `</blockquote>`; inBq = false; }
    };

    for (const ln of lines){
      const raw = ln;
      const trimmed = raw.trimEnd();

      if (!trimmed.trim()){
        flushPara();
        closeLists();
        closeBq();
        continue;
      }

      const hm = trimmed.match(/^(#{1,6})\s+(.*)$/);
      if (hm){
        flushPara(); closeLists(); closeBq();
        const level = hm[1].length;
        html += `<h${level}>${renderInline(hm[2])}</h${level}>`;
        continue;
      }

      const bqm = trimmed.match(/^>\s?(.*)$/);
      if (bqm){
        flushPara(); closeLists();
        if (!inBq){ html += `<blockquote>`; inBq = true; }
        html += `<p>${renderInline(bqm[1])}</p>`;
        continue;
      } else {
        closeBq();
      }

      const ulm = trimmed.match(/^[-*]\s+(.*)$/);
      if (ulm){
        flushPara();
        if (inOl){ html += `</ol>`; inOl = false; }
        if (!inUl){ html += `<ul>`; inUl = true; }
        html += `<li>${renderInline(ulm[1])}</li>`;
        continue;
      }

      const olm = trimmed.match(/^\d+\.\s+(.*)$/);
      if (olm){
        flushPara();
        if (inUl){ html += `</ul>`; inUl = false; }
        if (!inOl){ html += `<ol>`; inOl = true; }
        html += `<li>${renderInline(olm[1])}</li>`;
        continue;
      }

      closeLists();
      para.push(raw);
    }

    flushPara();
    closeLists();
    closeBq();
  }

  return html;
}

/***********************
 * Models: load/save/merge
 ***********************/
function loadModels(){
  customModels = safeParseJSON(localStorage.getItem(CUSTOM_MODELS_KEY) || "[]", []);
  if (!Array.isArray(customModels)) customModels = [];
  customModels = customModels
    .filter(m => m && typeof m === "object" && (m.id || "").trim())
    .map(m => ({
      id: String(m.id).trim(),
      label: String(m.label || "Custom Model").trim(),
      thinkingId: String(m.thinkingId || "").trim(),
      thinkingOnly: !!m.thinkingOnly,
      builtin: false
    }));

  modelAliases = safeParseJSON(localStorage.getItem(MODEL_ALIASES_KEY) || "{}", {});
  if (!modelAliases || typeof modelAliases !== "object") modelAliases = {};
}
function saveModels(){
  localStorage.setItem(CUSTOM_MODELS_KEY, JSON.stringify(customModels));
  localStorage.setItem(MODEL_ALIASES_KEY, JSON.stringify(modelAliases));
}
function getAllModels(){
  const map = new Map();
  for (const b of BUILTIN_MODELS) map.set(b.id, { ...b });
  for (const c of customModels) map.set(c.id, { ...c });
  return Array.from(map.values());
}
function getModelById(id){
  const all = getAllModels();
  return all.find(m => m.id === id) || null;
}
function getModelLabel(m){
  if (!m) return "Model";
  if (m.builtin && modelAliases[m.id]) return String(modelAliases[m.id]).trim() || m.label;
  return m.label || "Model";
}
function modelSupportsThinkingToggle(m){
  return !!(m && !m.thinkingOnly && m.thinkingId && m.thinkingId.trim());
}
function effectiveThinking(){
  const m = getModelById(selectedModelId);
  if (!m) return false;
  if (m.thinkingOnly) return true;
  if (modelSupportsThinkingToggle(m)) return !!isThinking;
  return false;
}
function currentModelId(){
  const m = getModelById(selectedModelId);
  if (!m) return selectedModelId;
  if (m.thinkingOnly) return m.id;
  if (modelSupportsThinkingToggle(m)) return isThinking ? m.thinkingId : m.id;
  return m.id;
}
function refreshModelText(){
  const m = getModelById(selectedModelId);
  const name = getModelLabel(m);
  const t = effectiveThinking() ? " · Thinking" : "";
  const s = isWebSearch ? " · Search" : "";
  modelText.textContent = name + t + s;
}
function applyModelCapabilities(){
  const m = getModelById(selectedModelId);

  if (!m){
    isThinking = false;
    clockBtn.disabled = true;
    clockBtn.classList.remove("active");
  } else if (m.thinkingOnly){
    isThinking = true;
    clockBtn.disabled = true;
    clockBtn.classList.add("active");
  } else if (modelSupportsThinkingToggle(m)){
    clockBtn.disabled = false;
    clockBtn.classList.toggle("active", !!isThinking);
  } else {
    isThinking = false;
    clockBtn.disabled = true;
    clockBtn.classList.remove("active");
  }

  refreshModelText();
  saveUIState();
}

/***********************
 * UI State
 ***********************/
function loadUIState(){
  const ui = safeParseJSON(localStorage.getItem(UI_STATE_KEY) || "{}", {});
  if (ui && typeof ui === "object") {
    if (typeof ui.selectedModelId === "string") selectedModelId = ui.selectedModelId;
    if (typeof ui.isThinking === "boolean") isThinking = ui.isThinking;
    if (typeof ui.isWebSearch === "boolean") isWebSearch = ui.isWebSearch;
    if (typeof ui.fontSize === "number") fontSize = ui.fontSize;
    if (typeof ui.themeMode === "string") themeMode = ui.themeMode;
  }
  if (!getModelById(selectedModelId)){
    selectedModelId = BUILTIN_MODELS[0].id;
    isThinking = false;
  }
}
function saveUIState(){
  localStorage.setItem(UI_STATE_KEY, JSON.stringify({ selectedModelId, isThinking, isWebSearch, fontSize, themeMode }));
}

/***********************
 * Store ops
 ***********************/
function normalizeChat(c){
  const chat = c && typeof c === "object" ? c : {};
  if (!Array.isArray(chat.messages)) chat.messages = [];
  chat.messages = chat.messages.map(m => ({
    id: m.id || uid(),
    role: m.role || "user",
    content: m.content || "",
    reasoning: m.reasoning || "",
    thinking: !!m.thinking,
    pending: !!m.pending,
    contentZh: m.contentZh || "",
    reasoningZh: m.reasoningZh || "",
    attachments: Array.isArray(m.attachments) ? m.attachments : [],
    interrupted: !!m.interrupted
  }));
  chat.title = chat.title || "New chat";
  chat.createdAt = chat.createdAt || nowTs();
  chat.updatedAt = chat.updatedAt || nowTs();
  chat.id = chat.id || ("c_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8));
  return chat;
}

async function loadStoreFromDB(){
  const chats = (await idbGetAll("chats")).map(normalizeChat);
  chats.sort((a,b)=> b.updatedAt - a.updatedAt);
  store.chats = chats;

  const active = (await idbGet("meta", "activeId"))?.value || "";
  store.activeId = active && store.chats.find(c => c.id === active) ? active : (store.chats[0]?.id || "");

  if (!store.activeId) createNewChat();
}

let _persistTimer = null;
let _persistQueue = new Set();
function schedulePersistChat(chat){
  if (!chat || !chat.id) return;
  _persistQueue.add(chat.id);
  if (_persistTimer) return;

  _persistTimer = setTimeout(async ()=>{
    _persistTimer = null;
    const ids = Array.from(_persistQueue);
    _persistQueue.clear();
    try{
      for (const id of ids){
        const c = store.chats.find(x => x.id === id);
        if (c) await idbPut("chats", c);
      }
      await idbPut("meta", { key: "activeId", value: store.activeId || "" });
    }catch(e){
      console.error("persist failed", e);
    }
  }, 350);
}

function getActiveChat(){ return store.chats.find(c => c.id === store.activeId) || null; }
function getChatById(id){ return store.chats.find(c => c.id === id) || null; }

function touchChat(chat){
  chat.updatedAt = nowTs();
  store.chats = [chat, ...store.chats.filter(c => c.id !== chat.id)];
}
function maybeUpdateTitle(chat){
  if (chat.title && chat.title !== "New chat") return;
  const firstUser = chat.messages.find(m => m.role === "user" && (m.content||"").trim());
  if (firstUser) chat.title = clampTitle(firstUser.content);
}
function findMsg(chat, msgId){
  return (chat?.messages || []).find(m => m.id === msgId) || null;
}

function createNewChat(){
  const id = "c_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  const chat = normalizeChat({ id, title:"New chat", createdAt: nowTs(), updatedAt: nowTs(), messages: [] });
  store.chats.unshift(chat);
  store.activeId = id;
  chatWindowLimit = WINDOW_STEP;

  schedulePersistChat(chat);
  renderSidebar();
  renderChat(true);
}

function setActiveChat(id){
  const chat = store.chats.find(c => c.id === id);
  if (!chat) return;
  store.activeId = id;
  chatWindowLimit = WINDOW_STEP;
  schedulePersistChat(chat);
  renderSidebar();
  renderChat(true);
  closeDrawer();
}

/***********************
 * Drawer open/close
 ***********************/
function openDrawer(){ drawer.classList.add("open"); backdrop.classList.add("show"); }
function closeDrawer(){ drawer.classList.remove("open"); backdrop.classList.remove("show"); }

menuBtn.addEventListener("click", openDrawer);
drawerClose.addEventListener("click", closeDrawer);
backdrop.addEventListener("click", closeDrawer);

newChatBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  createNewChat();
  closeDrawer();
});

/***********************
 * Swipe gestures
 * left-swipe opens drawer, right-swipe closes
 ***********************/
(function setupSwipe(){
  let sx=0, sy=0, st=0, tracking=false;

  function isInteractiveTarget(t){
    if (!t) return false;
    const tag = (t.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "button" || t.closest?.(".dropdown") || t.closest?.(".modal") || t.closest?.("a");
  }

  appEl.addEventListener("touchstart", (e)=>{
    if (!e.touches || e.touches.length !== 1) return;
    const t = e.target;
    if (isInteractiveTarget(t)) return;
    tracking = true;
    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
    st = Date.now();
  }, { passive:true });

  appEl.addEventListener("touchend", (e)=>{
    if (!tracking) return;
    tracking = false;
    if (!e.changedTouches || e.changedTouches.length !== 1) return;

    const dx = e.changedTouches[0].clientX - sx;
    const dy = e.changedTouches[0].clientY - sy;
    const dt = Date.now() - st;

    const adx = Math.abs(dx);
    const ady = Math.abs(dy);

    if (adx < 70) return;
    if (adx < ady * 1.4) return;
    if (dt > 800) return;

    const drawerOpen = drawer.classList.contains("open");
    if (!drawerOpen && dx < -70) openDrawer();
    else if (drawerOpen && dx > 70) closeDrawer();
  }, { passive:true });
})();

/***********************
 * Sidebar list render (with search)
 ***********************/
function renderChatsList(){
  chatListEl.innerHTML = "";
  const q = (chatSearchInput.value || "").trim().toLowerCase();
  const chats = [...store.chats].sort((a,b)=> b.updatedAt - a.updatedAt)
    .filter(c => !q || String(c.title || "").toLowerCase().includes(q));

  if (!chats.length){
    const div = document.createElement("div");
    div.style.padding = "10px";
    div.style.color = "var(--muted)";
    div.style.fontWeight = "850";
    div.textContent = q ? "No results" : "No chats yet";
    chatListEl.appendChild(div);
    return;
  }

  for (const c of chats){
    const item = document.createElement("div");
    item.className = "chatItem" + (c.id === store.activeId ? " active" : "");
    item.addEventListener("click", ()=> setActiveChat(c.id));

    const left = document.createElement("div");
    left.className = "chatLeft";

    const t = document.createElement("div");
    t.className = "chatTitle";
    t.textContent = c.title || "New chat";

    const meta = document.createElement("div");
    meta.className = "chatMeta";
    const ms = document.createElement("span");
    ms.textContent = `${c.messages?.length || 0} msgs`;
    const tm = document.createElement("span");
    tm.textContent = formatTime(c.updatedAt);
    meta.appendChild(ms);
    meta.appendChild(tm);

    left.appendChild(t);
    left.appendChild(meta);

    const actions = document.createElement("div");
    actions.className = "chatActions";

    const mkTiny = (title, svg) => {
      const b = document.createElement("button");
      b.className = "chatTinyBtn";
      b.title = title;
      b.innerHTML = svg;
      b.addEventListener("click", (e)=> e.stopPropagation());
      return b;
    };

    const renameBtn = mkTiny("Rename", `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-3L16.5 4.5a2 2 0 0 0-3 0L3 15v5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M13.5 6.5l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    `);
    renameBtn.addEventListener("click", ()=>{
      const nv = window.prompt("重命名会话", c.title || "New chat");
      if (nv === null) return;
      c.title = (nv || "").trim() || "New chat";
      touchChat(c);
      schedulePersistChat(c);
      renderSidebar();
    });

    const delBtn = mkTiny("Delete", `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M6 7h12M9 7V5h6v2M8 7l1 14h6l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `);
    delBtn.addEventListener("click", async ()=>{
      if (!confirm("确定删除该会话？")) return;
      store.chats = store.chats.filter(x => x.id !== c.id);
      if (store.activeId === c.id){
        store.activeId = store.chats[0]?.id || "";
      }
      await idbClear("chats");
      for (const ch of store.chats) await idbPut("chats", ch);
      await idbPut("meta", { key:"activeId", value: store.activeId || "" });

      if (!store.activeId) createNewChat();
      renderSidebar();
      renderChat(true);
    });

    actions.appendChild(renameBtn);
    actions.appendChild(delBtn);

    item.appendChild(left);
    item.appendChild(actions);
    chatListEl.appendChild(item);
  }
}
function renderSidebar(){ renderChatsList(); }
chatSearchInput.addEventListener("input", renderChatsList);

/***********************
 * Dropdown render
 ***********************/
function renderModelDropdown(){
  dropdown.innerHTML = "";
  const models = getAllModels();

  for (const m of models){
    const item = document.createElement("div");
    item.className = "ddItem";
    item.dataset.modelId = m.id;

    const meta = document.createElement("div");
    meta.className = "meta";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = getModelLabel(m) + (m.id === selectedModelId ? " ✓" : "");

    const id = document.createElement("div");
    id.className = "id";
    id.textContent = m.id;

    meta.appendChild(name);
    meta.appendChild(id);

    const tag = document.createElement("div");
    tag.className = "tag";
    if (m.thinkingOnly) tag.textContent = "Thinking-only";
    else if (m.thinkingId) tag.textContent = "Base/Thinking";
    else tag.textContent = "Base only";

    item.appendChild(meta);
    item.appendChild(tag);

    item.addEventListener("click", ()=>{
      if (isStreaming) return;
      selectedModelId = m.id;
      dropdown.classList.remove("open");
      modelBtn.setAttribute("aria-expanded","false");
      applyModelCapabilities();
      renderModelDropdown();
    });

    dropdown.appendChild(item);
  }

  const div = document.createElement("div");
  div.className = "ddDivider";
  dropdown.appendChild(div);

  const manage = document.createElement("div");
  manage.className = "ddFooter";
  manage.innerHTML = `<span>模型管理…</span><span style="opacity:.55;">›</span>`;
  manage.addEventListener("click", ()=>{
    dropdown.classList.remove("open");
    modelBtn.setAttribute("aria-expanded","false");
    openModelManager();
  });
  dropdown.appendChild(manage);
}

function toggleDropdown(){
  if (isStreaming) return;
  const isOpen = dropdown.classList.toggle("open");
  modelBtn.setAttribute("aria-expanded", String(isOpen));
}
modelBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  toggleDropdown();
});
document.addEventListener("click", ()=>{
  dropdown.classList.remove("open");
  modelBtn.setAttribute("aria-expanded","false");
});

/***********************
 * Thinking toggle
 ***********************/
clockBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  const m = getModelById(selectedModelId);
  if (!m) return;

  if (m.thinkingOnly){
    isThinking = true;
    applyModelCapabilities();
    return;
  }
  if (!modelSupportsThinkingToggle(m)){
    isThinking = false;
    applyModelCapabilities();
    return;
  }
  isThinking = !isThinking;
  applyModelCapabilities();
});

/***********************
 * Web Search toggle
 ***********************/
function applyWebSearchState(){
  webBtn.classList.toggle("active", !!isWebSearch);
  refreshModelText();
  saveUIState();
}
webBtn.addEventListener("click", (e)=>{
  if (isStreaming) return;
  if (e.shiftKey){
    const cur = getSearchModel();
    const picked = window.prompt("联网搜索模型 ID（保存到设置）", cur);
    if (picked === null) return;
    const val = (picked || "").trim() || cur;
    localStorage.setItem(SEARCH_MODEL_STORAGE, val);
    showToast("已保存搜索模型");
  } else {
    isWebSearch = !isWebSearch;
  }
  applyWebSearchState();
});

/***********************
 * Attachments
 ***********************/
function renderAttachBar(){
  attachBar.innerHTML = "";
  attachBar.classList.toggle("show", draftAttachments.length > 0);

  for (const a of draftAttachments){
    const chip = document.createElement("div");
    chip.className = "chip";

    if (a.isImage){
      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = a.name || "image";
      img.src = URL.createObjectURL(a.blob);
      setTimeout(()=> { try{ URL.revokeObjectURL(img.src); }catch{} }, 2000);
      chip.appendChild(img);
    } else {
      const icon = document.createElement("div");
      icon.style.width = "40px";
      icon.style.height = "40px";
      icon.style.borderRadius = "14px";
      icon.style.border = "1px solid var(--hairline)";
      icon.style.display = "grid";
      icon.style.placeItems = "center";
      icon.style.background = "rgba(255,255,255,.18)";
      icon.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M7 3h7l3 3v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2"/>
          <path d="M14 3v4h4" stroke="currentColor" stroke-width="2"/>
        </svg>`;
      chip.appendChild(icon);
    }

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = a.name || "file";

    const x = document.createElement("div");
    x.className = "x";
    x.title = "Remove";
    x.textContent = "×";
    x.addEventListener("click", ()=>{
      draftAttachments = draftAttachments.filter(x => x.id !== a.id);
      renderAttachBar();
      syncSendState();
    });

    chip.appendChild(name);
    chip.appendChild(x);
    attachBar.appendChild(chip);
  }
}

plusBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  filePicker.value = "";
  filePicker.click();
});

filePicker.addEventListener("change", async ()=>{
  const files = Array.from(filePicker.files || []);
  if (!files.length) return;

  for (const f of files){
    const id = "f_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
    const isImage = /^image\//.test(f.type || "");

    let text = "";
    const isTextLike =
      /^(text\/|application\/json)/.test(f.type || "") ||
      /\.(txt|md|json|csv|log)$/i.test(f.name || "");

    if (isTextLike && f.size <= 220 * 1024){
      try{
        text = await f.text();
        if (text.length > 22000) text = text.slice(0,22000) + "\n…(truncated)";
      }catch{}
    }

    draftAttachments.push({
      id,
      name: f.name || "file",
      type: f.type || "",
      size: f.size || 0,
      lastModified: f.lastModified || 0,
      isImage,
      blob: f,
      text
    });
  }

  renderAttachBar();
  syncSendState();
});

/***********************
 * Files in IndexedDB
 ***********************/
async function putFileRecord(att){
  const rec = {
    id: att.id,
    name: att.name,
    type: att.type,
    size: att.size,
    lastModified: att.lastModified,
    blob: att.blob
  };
  await idbPut("files", rec);
}
function revokeAllFileUrls(){
  for (const url of fileUrlCache.values()){
    try{ URL.revokeObjectURL(url); }catch{}
  }
  fileUrlCache.clear();
}
async function getFileBlob(fileId){
  const rec = await idbGet("files", fileId);
  return rec?.blob || null;
}
async function getFileUrl(fileId){
  if (fileUrlCache.has(fileId)) return fileUrlCache.get(fileId);
  const blob = await getFileBlob(fileId);
  if (!blob) return "";
  const url = URL.createObjectURL(blob);
  fileUrlCache.set(fileId, url);
  return url;
}
function blobToDataURL(blob){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = ()=> reject(r.error);
    r.readAsDataURL(blob);
  });
}

/***********************
 * Render helpers
 ***********************/
function clearChatDOM(){
  revokeAllFileUrls();
  Array.from(chatwrap.children).forEach(ch=>{
    if (ch !== emptyState) ch.remove();
  });
}
function showEmpty(show){
  emptyState.style.display = show ? "" : "none";
}

function iconSvg(kind){
  if (kind === "copy") return `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M9 9h10v12H9V9Z" stroke="currentColor" stroke-width="2"/>
      <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="currentColor" stroke-width="2" opacity=".75"/>
    </svg>`;
  if (kind === "edit") return `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-3L16.5 4.5a2 2 0 0 0-3 0L3 15v5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="M13.5 6.5l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>`;
  if (kind === "translate") return `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M4 5h10M9 5v14M6 9h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M14 19s3-2 3-7m0 0s3 5 3 7m-3-7v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".8"/>
    </svg>`;
  if (kind === "retry") return `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
  if (kind === "cont") return `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M8 5l11 7-11 7V5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </svg>`;
  return "";
}

/* Create bubble */
function createBubble({ roleClass, kindClass, label, text, msgId, part, allowTranslate, allowRetry, allowContinue }){
  const b = document.createElement("div");
  b.className = `bubble ${roleClass} ${kindClass || ""}`.trim();
  b.dataset.msgId = msgId || "";
  b.dataset.part = part || "";
  b.dataset.kind = kindClass || "";
  b.dataset.showZh = "0";

  const top = document.createElement("div");
  top.className = "bubbleTop";

  const lab = document.createElement("div");
  lab.className = "bubbleLabel";

  if (kindClass === "thinking"){
    const caret = document.createElement("span");
    caret.className = "caret";
    caret.textContent = "▾";
    lab.appendChild(caret);

    const t = document.createElement("span");
    t.textContent = label || "thinking";
    lab.appendChild(t);

    lab.style.cursor = "pointer";
    lab.addEventListener("click", ()=>{
      b.classList.toggle("collapsed");
      caret.textContent = b.classList.contains("collapsed") ? "▸" : "▾";
    });
  } else {
    lab.textContent = label || "";
  }

  const actions = document.createElement("div");
  actions.className = "bubbleActions";

  const mkBtn = (title, kind) => {
    const btn = document.createElement("button");
    btn.className = "actionBtn";
    btn.title = title;
    btn.setAttribute("aria-label", title);
    btn.innerHTML = iconSvg(kind);
    return btn;
  };

  const copyBtn = mkBtn("Copy", "copy");
  const editBtn = mkBtn("Edit", "edit");

  let translateBtn = null;
  if (allowTranslate) translateBtn = mkBtn("Translate to Chinese (Shift 临时选择模型)", "translate");

  let retryBtn = null;
  if (allowRetry) retryBtn = mkBtn("Regenerate", "retry");

  let contBtn = null;
  if (allowContinue) contBtn = mkBtn("Continue", "cont");

  actions.appendChild(copyBtn);
  actions.appendChild(editBtn);
  if (translateBtn) actions.appendChild(translateBtn);
  if (retryBtn) actions.appendChild(retryBtn);
  if (contBtn) actions.appendChild(contBtn);

  top.appendChild(lab);
  top.appendChild(actions);

  const body = document.createElement("div");
  body.className = "bubbleBody";
  body.dataset.raw = text || "";
  body.innerHTML = renderMarkdown(text || "");

  b.appendChild(top);
  b.appendChild(body);
  chatwrap.appendChild(b);

  // actions
  copyBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    const shown = b.dataset.showZh === "1";
    const raw = shown ? (b.dataset.zhText || body.dataset.raw || "") : (body.dataset.raw || "");
    copyToClipboard(raw);
  });

  editBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    startInlineEdit(b);
  });

  if (translateBtn){
    translateBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      handleTranslate(b, e);
    });
  }

  if (retryBtn){
    retryBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      regenerateAssistant(msgId);
    });
  }

  if (contBtn){
    contBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      continueFromAssistant(msgId);
    });
  }

  return { bubble: b, bodyEl: body };
}

async function renderAttachmentsInto(container, attachments){
  if (!attachments || !attachments.length) return;
  const list = document.createElement("div");
  list.className = "attachList";

  for (const a of attachments){
    const card = document.createElement("div");
    card.className = "attachCard";

    if (a.isImage){
      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = a.name || "image";
      img.src = "";
      card.appendChild(img);
      getFileUrl(a.id).then(url=>{ if (url) img.src = url; });
    } else {
      const icon = document.createElement("div");
      icon.style.width = "40px";
      icon.style.height = "40px";
      icon.style.borderRadius = "14px";
      icon.style.border = "1px solid var(--hairline)";
      icon.style.display = "grid";
      icon.style.placeItems = "center";
      icon.style.background = "rgba(255,255,255,.18)";
      icon.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M7 3h7l3 3v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2"/>
          <path d="M14 3v4h4" stroke="currentColor" stroke-width="2"/>
        </svg>`;
      card.appendChild(icon);
    }

    const meta = document.createElement("div");
    meta.className = "meta";
    const fn = document.createElement("div");
    fn.className = "fn";
    fn.textContent = a.name || "file";
    const sz = document.createElement("div");
    sz.className = "sz";
    sz.textContent = bytesToSize(a.size || 0);
    meta.appendChild(fn);
    meta.appendChild(sz);

    const link = document.createElement("a");
    link.href = "javascript:void(0)";
    link.textContent = "下载";
    link.addEventListener("click", async ()=>{
      const url = await getFileUrl(a.id);
      if (!url) return;
      const aEl = document.createElement("a");
      aEl.href = url;
      aEl.download = a.name || "file";
      document.body.appendChild(aEl);
      aEl.click();
      aEl.remove();
    });

    card.appendChild(meta);
    card.appendChild(link);
    list.appendChild(card);
  }

  container.appendChild(list);
}

/***********************
 * Render chat
 ***********************/
function renderChat(forceScrollToBottom=false){
  const chat = getActiveChat();
  const wasNear = isNearBottom(chatwrap, 120) || forceScrollToBottom;

  clearChatDOM();

  if (!chat || !chat.messages || chat.messages.length === 0){
    showEmpty(true);
    updateToBottomButton();
    return;
  }

  showEmpty(false);

  const msgs = chat.messages;
  const total = msgs.length;
  const from = Math.max(0, total - chatWindowLimit);
  const slice = msgs.slice(from);

  if (from > 0){
    const wrap = document.createElement("div");
    wrap.className = "loadEarlier";
    const btn = document.createElement("button");
    btn.textContent = `加载更早消息（剩余 ${from}）`;
    btn.addEventListener("click", ()=>{
      chatWindowLimit = Math.min(total, chatWindowLimit + WINDOW_STEP);
      renderChat(false);
    });
    wrap.appendChild(btn);
    chatwrap.appendChild(wrap);
  }

  for (const msg of slice){
    if (msg.role === "user"){
      const { bubble } = createBubble({
        roleClass: "user",
        kindClass: "user",
        label: "you",
        text: msg.content || "",
        msgId: msg.id,
        part: "content",
        allowTranslate: false,
        allowRetry: false,
        allowContinue: false
      });
      if (msg.attachments?.length) renderAttachmentsInto(bubble, msg.attachments);
    } else if (msg.role === "assistant"){
      const showThinkingBubble = !!(msg.thinking && (msg.pending || (msg.reasoning && msg.reasoning.trim())));
      if (showThinkingBubble){
        createBubble({
          roleClass: "assistant",
          kindClass: "thinking",
          label: "thinking",
          text: msg.reasoning || (msg.pending ? "（生成中…）" : ""),
          msgId: msg.id,
          part: "reasoning",
          allowTranslate: true,
          allowRetry: false,
          allowContinue: false
        });
      }

      const allowRetry = !msg.pending;
      const allowContinue = !!msg.interrupted;

      createBubble({
        roleClass: "assistant",
        kindClass: "output",
        label: "output",
        text: msg.content || (msg.pending ? "…" : ""),
        msgId: msg.id,
        part: "content",
        allowTranslate: true,
        allowRetry,
        allowContinue
      });
    }
  }

  if (wasNear) scrollToBottom();
  updateToBottomButton();
}

/***********************
 * Inline Edit
 ***********************/
function startInlineEdit(bubbleEl){
  if (isStreaming){
    showToast("生成中，暂不支持编辑");
    return;
  }
  const chat = getActiveChat();
  const msgId = bubbleEl.dataset.msgId;
  const part = bubbleEl.dataset.part;
  const msg = findMsg(chat, msgId);
  if (!msg) return;

  const body = bubbleEl.querySelector(".bubbleBody");
  if (!body) return;
  if (bubbleEl.querySelector(".editWrap")) return;

  const currentText = (part === "reasoning") ? (msg.reasoning || "") : (msg.content || "");

  const wrap = document.createElement("div");
  wrap.className = "editWrap";

  const ta = document.createElement("textarea");
  ta.className = "editArea";
  ta.value = currentText;

  const actions = document.createElement("div");
  actions.className = "editActions";

  const cancel = document.createElement("button");
  cancel.className = "smallBtn";
  cancel.textContent = "取消";

  const save = document.createElement("button");
  save.className = "smallBtn primary";
  save.textContent = "保存";

  actions.appendChild(cancel);
  actions.appendChild(save);

  wrap.appendChild(ta);
  wrap.appendChild(actions);

  body.style.display = "none";
  bubbleEl.appendChild(wrap);

  cancel.addEventListener("click", ()=>{
    wrap.remove();
    body.style.display = "";
  });

  save.addEventListener("click", ()=>{
    const v = (ta.value || "").toString();
    if (part === "reasoning"){
      msg.reasoning = v;
      msg.reasoningZh = "";
    } else {
      msg.content = v;
      msg.contentZh = "";
    }
    touchChat(chat);
    maybeUpdateTitle(chat);
    schedulePersistChat(chat);
    renderSidebar();
    renderChat(false);
    showToast("已保存");
  });
}

/***********************
 * Translate
 ***********************/
async function translateTextToZh(text, model){
  const apiKey = getApiKey();
  if (!apiKey){
    openSettings();
    throw new Error("Missing API key（请先在设置里填写 Key）");
  }

  const sys =
`你是翻译引擎。
把用户提供的文本翻译为简体中文。
要求：
- 保留原有 Markdown/代码块/列表/换行结构
- 不要解释，不要加前缀，只输出翻译结果`;

  const res = await fetch(`${getBaseUrl()}/chat/completions`, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model,
      stream: false,
      messages: [
        { role: "system", content: sys },
        { role: "user", content: text }
      ]
    })
  });

  if (!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
  }
  const json = await res.json().catch(()=> ({}));
  const out = json?.choices?.[0]?.message?.content ?? "";
  return (out || "").trim();
}

async function handleTranslate(bubbleEl, evt){
  if (isStreaming){
    showToast("生成中，暂不支持翻译");
    return;
  }

  const chat = getActiveChat();
  const msgId = bubbleEl.dataset.msgId;
  const part = bubbleEl.dataset.part;
  const msg = findMsg(chat, msgId);
  if (!msg) return;

  const body = bubbleEl.querySelector(".bubbleBody");
  if (!body) return;

  const original = (part === "reasoning") ? (msg.reasoning || "") : (msg.content || "");
  if (!original.trim()){
    showToast("没有可翻译内容");
    return;
  }

  // toggle back
  if (bubbleEl.dataset.showZh === "1"){
    bubbleEl.dataset.showZh = "0";
    body.dataset.raw = original;
    body.innerHTML = renderMarkdown(original);
    showToast("已切回原文");
    return;
  }

  const zhKey = (part === "reasoning") ? "reasoningZh" : "contentZh";
  if (msg[zhKey] && String(msg[zhKey]).trim()){
    bubbleEl.dataset.showZh = "1";
    bubbleEl.dataset.zhText = msg[zhKey];
    body.dataset.raw = msg[zhKey];
    body.innerHTML = renderMarkdown(msg[zhKey]);
    showToast("已显示中文翻译");
    return;
  }

  let model = getTranslateModel();
  if (evt && evt.shiftKey){
    const picked = window.prompt("临时翻译模型 ID（仅本次）", model);
    if (picked === null) return;
    model = (picked || "").trim() || model;
  }

  try{
    showToast("翻译中…");
    const translated = await translateTextToZh(original, model);
    msg[zhKey] = translated;

    touchChat(chat);
    schedulePersistChat(chat);

    bubbleEl.dataset.showZh = "1";
    bubbleEl.dataset.zhText = translated;
    body.dataset.raw = translated;
    body.innerHTML = renderMarkdown(translated);

    renderSidebar();
    showToast("翻译完成");
  }catch(err){
    console.error(err);
    showToast("翻译失败");
  }
}

/***********************
 * Extract thinking
 ***********************/
function extractThinkingFromText(fullText){
  if (typeof fullText !== "string") return { clean: fullText || "", thinking: "" };
  const m = fullText.match(/<(thinking|analysis)>([\s\S]*?)<\/\1>/i);
  if (!m) return { clean: fullText, thinking: "" };
  const thinking = (m[2] || "").trim();
  const clean = fullText.replace(m[0], "").trim();
  return { clean, thinking };
}

/***********************
 * Build API messages (supports images)
 ***********************/
function formatTextAttachmentsForModel(attachments){
  if (!attachments || !attachments.length) return "";
  const texts = attachments.filter(a => !a.isImage && a.text && a.text.trim());
  const others = attachments.filter(a => !a.isImage && !(a.text && a.text.trim()));
  if (!texts.length && !others.length) return "";

  const lines = [];
  lines.push("\n\n[附件]");
  for (const a of texts){
    lines.push(`- ${a.name || "file"} (${bytesToSize(a.size || 0)})`);
    lines.push("");
    lines.push(a.text);
    lines.push("");
  }
  for (const a of others){
    lines.push(`- ${a.name || "file"} (${bytesToSize(a.size || 0)})`);
  }
  return lines.join("\n");
}

async function buildUserMessageContent(userMsg, { includeImages=true } = {}){
  const attachments = userMsg.attachments || [];
  const hasImages = includeImages && attachments.some(a => a.isImage);

  const textSuffix = formatTextAttachmentsForModel(attachments);
  const baseText = (userMsg.content || "") + textSuffix;

  if (!hasImages){
    return baseText;
  }

  // OpenAI-style content parts
  const parts = [{ type: "text", text: baseText || " " }];

  for (const a of attachments.filter(x => x.isImage)){
    const blob = await getFileBlob(a.id);
    if (!blob) continue;
    try{
      const dataUrl = await blobToDataURL(blob);
      if (typeof dataUrl === "string" && dataUrl.length < 8_000_000){
        parts.push({ type:"image_url", image_url:{ url: dataUrl } });
      }
    }catch{}
  }
  return parts;
}

async function buildApiMessagesAsync(chat, { excludeAssistantId = "", includeImages=true } = {}){
  const all = (chat.messages || [])
    .filter(m => !(m.role === "assistant" && m.pending))
    .filter(m => !(excludeAssistantId && m.role === "assistant" && m.id === excludeAssistantId));

  const slice = all.slice(Math.max(0, all.length - CONTEXT_MAX_MESSAGES));

  const out = [];
  for (const m of slice){
    if (m.role === "user"){
      const content = await buildUserMessageContent(m, { includeImages });
      out.push({ role:"user", content });
    } else {
      out.push({ role:m.role, content: m.content || "" });
    }
  }
  return out;
}

/***********************
 * Streaming SSE
 ***********************/
async function streamChatCompletion({ model, messages, signal, onDelta, onDone }){
  const apiKey = getApiKey();
  if (!apiKey){
    openSettings();
    throw new Error("Missing API key（请先在设置里填写 Key）");
  }

  const res = await fetch(`${getBaseUrl()}/chat/completions`, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({ model, messages, stream:true }),
    signal
  });

  if (!res.ok){
    const txt = await res.text().catch(()=> "");
    const err = new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
    err.status = res.status;
    err.bodyText = txt || "";
    throw err;
  }
  if (!res.body) throw new Error("Stream body not available");

  const reader = res.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let buffer = "";

  while (true){
    const { value, done } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream:true });

    const events = buffer.split("\n\n");
    buffer = events.pop() || "";

    for (const evt of events){
      const lines = evt.split("\n");
      const dataPayloads = [];
      for (const ln of lines){
        const line = ln.trimEnd();
        if (line.startsWith("data:")) dataPayloads.push(line.slice(5).trim());
      }
      if (!dataPayloads.length) continue;

      const joined = dataPayloads.join("\n").trim();
      if (joined === "[DONE]"){
        onDone?.();
        return;
      }

      let json;
      try{ json = JSON.parse(joined); } catch { continue; }

      const choice = json?.choices?.[0];
      const delta = choice?.delta || {};
      const contentDelta = delta.content ?? "";
      const reasoningDelta = delta.reasoning_content ?? delta.reasoning ?? "";

      if (contentDelta || reasoningDelta){
        onDelta?.({ contentDelta, reasoningDelta });
      }
    }
  }

  onDone?.();
}

/***********************
 * Send / Stop / Regenerate / Continue
 ***********************/
function setSendModeStop(isStop){
  sendBtn.classList.toggle("stop", !!isStop);
  sendBtn.title = isStop ? "Stop" : "Send";
  sendBtn.setAttribute("aria-label", isStop ? "Stop" : "Send");
  sendIcon.innerHTML = isStop
    ? `<path d="M7 7h10v10H7V7Z" stroke="rgba(255,255,255,.92)" stroke-width="2.2" />`
    : `<path d="M12 4l7 7-7 7" stroke="rgba(0,0,0,.70)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
       <path d="M5 11h13" stroke="rgba(0,0,0,.70)" stroke-width="2.2" stroke-linecap="round"/>`;
}

function setComposerDisabled(disabled){
  if (disabled){
    promptEl.disabled = true;
    modelBtn.disabled = true;
    plusBtn.disabled = true;
    clockBtn.disabled = true;
    webBtn.disabled = true;

    sendBtn.disabled = false;
    setSendModeStop(true);
  } else {
    promptEl.disabled = false;
    modelBtn.disabled = false;
    plusBtn.disabled = false;
    webBtn.disabled = false;

    const m = getModelById(selectedModelId);
    const can = m ? (m.thinkingOnly || modelSupportsThinkingToggle(m)) : false;
    clockBtn.disabled = !can;

    setSendModeStop(false);
    syncSendState();
  }
}

function syncSendState(){
  if (isStreaming){
    sendBtn.disabled = false;
    return;
  }
  const hasText = (promptEl.value || "").trim().length > 0;
  const hasAttach = draftAttachments.length > 0;
  sendBtn.disabled = !(hasText || hasAttach);
}
promptEl.addEventListener("input", ()=> {
  autosizeTextarea(promptEl);
  syncSendState();
});

function stopGeneration(){
  if (!isStreaming) return;
  try{ abortCtl?.abort(); }catch{}
  showToast("已停止");
}

function updateDOMStreamingVisible({ assistantMsgId, reasoning, rawText }){
  if (!activeStream) return;
  if (store.activeId !== activeStream.chatId) return;

  const answerBody = chatwrap.querySelector(`.bubble.assistant.output[data-msg-id="${assistantMsgId}"] .bubbleBody`);
  const thinkBody  = chatwrap.querySelector(`.bubble.assistant.thinking[data-msg-id="${assistantMsgId}"] .bubbleBody`);

  if (thinkBody){
    thinkBody.dataset.raw = reasoning || "（生成中…）";
    thinkBody.innerHTML = renderMarkdown(reasoning || "（生成中…）");
  }
  if (answerBody){
    answerBody.dataset.raw = rawText || "…";
    answerBody.innerHTML = renderMarkdown(rawText || "…");
  }

  if (autoScrollAllowed) scrollToBottom();
  updateToBottomButton();
}

// Only auto-scroll if user stays near bottom
chatwrap.addEventListener("scroll", ()=>{
  if (!isStreaming){
    updateToBottomButton();
    return;
  }
  autoScrollAllowed = isNearBottom(chatwrap, 60);
  updateToBottomButton();
}, { passive:true });

toBottomBtn.addEventListener("click", ()=> scrollToBottom());

async function finalizeAssistantMessage({ chatId, msgId, effThinking, rawText, reasoning, interrupted=false }){
  const c = getChatById(chatId);
  const m = findMsg(c, msgId);
  if (!m) return;

  let finalAnswer = rawText;
  let finalReasoning = reasoning;

  // if server put thinking inside tags, extract
  if (!finalReasoning || !finalReasoning.trim()){
    const ext = extractThinkingFromText(rawText);
    finalAnswer = ext.clean;
    finalReasoning = ext.thinking;
  } else {
    const ext = extractThinkingFromText(rawText);
    finalAnswer = ext.clean;
  }

  m.pending = false;
  m.content = (finalAnswer || "").trim() || "（空响应）";
  m.reasoning = (finalReasoning || "").trim();
  m.thinking = !!effThinking;
  m.interrupted = !!interrupted;

  touchChat(c);
  maybeUpdateTitle(c);
  schedulePersistChat(c);
  renderSidebar();

  if (store.activeId === chatId) renderChat(false);
}

async function generateAssistant({ chat, assistantMsgId, effThinking, excludeAssistantId="" }){
  const baseSys = getSystemPrompt();
  const modeLine =
`\n\n[UI_MODE]
thinking_mode=${effThinking ? "on" : "off"}
当 thinking_mode=on 时，请按 system 规则输出 <thinking>...</thinking>；off 则不要输出 <thinking>。`;

  const modelToUse = isWebSearch ? getSearchModel() : currentModelId();

  let rawText = "";
  let reasoning = "";
  let gotAnyDelta = false;

  // attempt: multimodal -> fallback to text-only if server rejects
  const hadImages = (chat.messages || []).some(m => (m.attachments||[]).some(a => a.isImage));
  let includeImages = true;
  let attempt = 0;

  isStreaming = true;
  activeStream = { chatId: chat.id, assistantMsgId, effThinking };
  abortCtl = new AbortController();
  autoScrollAllowed = isNearBottom(chatwrap, 120);

  setComposerDisabled(true);

  // throttle DOM updates to ~30fps
  let lastPaint = 0;
  const paint = ()=>{
    const now = performance.now();
    if (now - lastPaint < 33) return;
    lastPaint = now;
    updateDOMStreamingVisible({ assistantMsgId, reasoning, rawText });
  };

  try{
    while (true){
      const reqMessages = [
        { role:"system", content: (baseSys + modeLine).trim() },
        ...(await buildApiMessagesAsync(chat, { excludeAssistantId, includeImages }))
      ];

      try{
        await streamChatCompletion({
          model: modelToUse,
          messages: reqMessages,
          signal: abortCtl.signal,
          onDelta: ({ contentDelta, reasoningDelta })=>{
            gotAnyDelta = gotAnyDelta || !!(contentDelta || reasoningDelta);

            const c = getChatById(activeStream.chatId);
            const m = findMsg(c, activeStream.assistantMsgId);
            if (!m) return;

            if (reasoningDelta){
              reasoning += reasoningDelta;
              m.reasoning = reasoning;
            }
            if (contentDelta){
              rawText += contentDelta;
              m.content = rawText;
            }

            schedulePersistChat(c);
            paint();
          },
          onDone: ()=>{}
        });
        break;
      }catch(err){
        if (err?.name === "AbortError") throw err;

        // fallback: server may reject image parts
        if (hadImages && includeImages && (err.status === 400 || err.status === 422) && attempt === 0){
          includeImages = false;
          attempt++;
          showToast("接口不支持图片输入，已降级为文本");
          continue;
        }

        attempt++;
        if (!gotAnyDelta && attempt <= 1) continue;
        throw err;
      }
    }

    await finalizeAssistantMessage({
      chatId: chat.id,
      msgId: assistantMsgId,
      effThinking,
      rawText,
      reasoning,
      interrupted: false
    });

  }catch(err){
    if (err?.name === "AbortError"){
      // Keep partial output
      await finalizeAssistantMessage({
        chatId: chat.id,
        msgId: assistantMsgId,
        effThinking,
        rawText,
        reasoning,
        interrupted: true
      });
    } else {
      await finalizeAssistantMessage({
        chatId: chat.id,
        msgId: assistantMsgId,
        effThinking,
        rawText: rawText || `连接中断：${err?.message || String(err)}`,
        reasoning,
        interrupted: true
      });
      console.error(err);
      showToast("连接中断");
    }
  }finally{
    isStreaming = false;
    activeStream = null;
    abortCtl = null;
    setComposerDisabled(false);
    syncSendState();
    updateStatusBar();
  }
}

async function send(){
  if (isStreaming) return;

  const chat = getActiveChat();
  if (!chat) return;

  const text = (promptEl.value || "").trim();
  const hasAttach = draftAttachments.length > 0;
  if (!text && !hasAttach) return;

  const effThinking = effectiveThinking();
  showEmpty(false);

  // persist attachments
  const attachments = [];
  if (hasAttach){
    for (const a of draftAttachments){
      try{
        await putFileRecord(a);
        attachments.push({
          id: a.id,
          name: a.name,
          type: a.type,
          size: a.size,
          lastModified: a.lastModified,
          isImage: !!a.isImage,
          text: a.text || ""
        });
      }catch(e){
        console.error("putFileRecord failed", e);
      }
    }
  }

  const userMsgId = uid();
  const asstMsgId = uid();
  const userContent = text || (hasAttach ? "（发送了附件）" : "");

  chat.messages.push({ id:userMsgId, role:"user", content:userContent, attachments });
  chat.messages.push({
    id: asstMsgId,
    role:"assistant",
    content:"",
    reasoning:"",
    thinking: effThinking,
    pending: true,
    contentZh:"",
    reasoningZh:"",
    attachments: [],
    interrupted: false
  });

  // clear draft
  draftAttachments = [];
  renderAttachBar();
  promptEl.value = "";
  autosizeTextarea(promptEl);
  syncSendState();

  touchChat(chat);
  maybeUpdateTitle(chat);
  schedulePersistChat(chat);
  renderSidebar();

  // fast append to UI
  const u = createBubble({
    roleClass:"user", kindClass:"user", label:"you",
    text:userContent, msgId:userMsgId, part:"content",
    allowTranslate:false, allowRetry:false, allowContinue:false
  });
  if (attachments.length) renderAttachmentsInto(u.bubble, attachments);

  if (effThinking){
    createBubble({
      roleClass:"assistant", kindClass:"thinking", label:"thinking",
      text:"（生成中…）", msgId:asstMsgId, part:"reasoning",
      allowTranslate:true, allowRetry:false, allowContinue:false
    });
  }
  createBubble({
    roleClass:"assistant", kindClass:"output", label:"output",
    text:"…", msgId:asstMsgId, part:"content",
    allowTranslate:true, allowRetry:false, allowContinue:false
  });

  if (isNearBottom(chatwrap, 160)) scrollToBottom();

  await generateAssistant({ chat, assistantMsgId: asstMsgId, effThinking, excludeAssistantId: "" });
}

async function regenerateAssistant(asstMsgId){
  if (isStreaming) return;
  const chat = getActiveChat();
  if (!chat) return;

  const idx = chat.messages.findIndex(m => m.id === asstMsgId);
  if (idx < 0) return;
  const asst = chat.messages[idx];
  if (!asst || asst.role !== "assistant") return;

  // Must have previous user msg
  const prev = chat.messages[idx - 1];
  if (!prev || prev.role !== "user") return;

  // remove old assistant
  chat.messages = chat.messages.filter(m => m.id !== asstMsgId);

  // add new pending assistant
  const newId = uid();
  const effThinking = effectiveThinking();
  chat.messages.push({
    id: newId,
    role:"assistant",
    content:"",
    reasoning:"",
    thinking: effThinking,
    pending:true,
    contentZh:"",
    reasoningZh:"",
    attachments:[],
    interrupted:false
  });

  touchChat(chat);
  schedulePersistChat(chat);
  renderSidebar();
  renderChat(false);

  await generateAssistant({ chat, assistantMsgId: newId, effThinking, excludeAssistantId: "" });
}

async function continueFromAssistant(asstMsgId){
  if (isStreaming) return;
  const chat = getActiveChat();
  if (!chat) return;

  // just add a user "继续" then generate
  promptEl.value = "继续。";
  autosizeTextarea(promptEl);
  await send();
}

/***********************
 * Send button behavior
 ***********************/
sendBtn.addEventListener("click", ()=>{
  if (isStreaming) stopGeneration();
  else send();
});

/***********************
 * Autosize textarea
 ***********************/
function autosizeTextarea(el){
  if (!el) return;
  el.style.height = "0px";
  const h = Math.min(el.scrollHeight, 160);
  el.style.height = h + "px";
}
autosizeTextarea(promptEl);

promptEl.addEventListener("keydown", (e)=>{
  // Enter to send, Shift+Enter newline
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    if (isStreaming) return;
    send();
  }
});

/***********************
 * Settings modal
 ***********************/
function openSettings(){
  baseUrlInput.value = getBaseUrl();
  keyInput.value = getApiKey();
  translateModelInput.value = getTranslateModel();
  searchModelInput.value = getSearchModel();
  sysInput.value = localStorage.getItem(SYS_PROMPT_STORAGE) || DEFAULT_SYSTEM_PROMPT;
  themeSelect.value = themeMode;

  fontSizeRange.value = String(fontSize);
  fontSizeVal.textContent = String(fontSize);

  settingsModal.classList.add("show");
}
function closeSettings(){ settingsModal.classList.remove("show"); }

settingsBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  openSettings();
});
settingsBtnInDrawer.addEventListener("click", ()=>{
  if (isStreaming) return;
  openSettings();
  closeDrawer();
});

settingsCancel.addEventListener("click", closeSettings);
settingsModal.addEventListener("click", (e)=>{
  if (e.target === settingsModal) closeSettings();
});

resetSysBtn.addEventListener("click", ()=>{ sysInput.value = DEFAULT_SYSTEM_PROMPT; });
clearKeyBtn.addEventListener("click", ()=>{ keyInput.value = ""; });

fontSizeRange.addEventListener("input", ()=>{
  fontSize = Number(fontSizeRange.value);
  applyFontSize();
});

themeSelect.addEventListener("change", ()=>{
  themeMode = themeSelect.value;
  applyTheme();
  saveUIState();
});

clearAllChatsBtn.addEventListener("click", async ()=>{
  if (isStreaming) return;
  if (!confirm("确定清空所有会话与附件？")) return;

  store = { activeId:"", chats:[] };
  await idbClear("chats");
  await idbClear("files");
  await idbPut("meta", { key:"activeId", value:"" });

  createNewChat();
  closeSettings();
  showToast("已清空");
});

settingsSave.addEventListener("click", ()=>{
  const base = (baseUrlInput.value || "").trim() || DEFAULT_BASE_URL;
  const k = (keyInput.value || "").trim();
  const s = (sysInput.value || "").trim();
  const tm = (translateModelInput.value || "").trim();
  const sm = (searchModelInput.value || "").trim();

  localStorage.setItem(VE_BASE_URL_KEY, base);

  if (!k) localStorage.removeItem(VE_KEY_STORAGE);
  else localStorage.setItem(VE_KEY_STORAGE, k);

  if (!tm) localStorage.removeItem(TRANSLATE_MODEL_STORAGE);
  else localStorage.setItem(TRANSLATE_MODEL_STORAGE, tm);

  if (!sm) localStorage.removeItem(SEARCH_MODEL_STORAGE);
  else localStorage.setItem(SEARCH_MODEL_STORAGE, sm);

  if (!s) localStorage.removeItem(SYS_PROMPT_STORAGE);
  else localStorage.setItem(SYS_PROMPT_STORAGE, s);

  themeMode = themeSelect.value;
  applyTheme();
  applyFontSize();
  closeSettings();
  updateStatusBar();
  showToast("已保存");
});

/***********************
 * Export / Import
 ***********************/
exportBtn.addEventListener("click", async ()=>{
  const payload = {
    version: 3,
    exportedAt: nowTs(),
    chats: store.chats,
    activeId: store.activeId,
    customModels,
    modelAliases,
    ui: { selectedModelId, isThinking, isWebSearch, fontSize, themeMode },
    translateModel: getTranslateModel(),
    searchModel: getSearchModel(),
    systemPrompt: localStorage.getItem(SYS_PROMPT_STORAGE) || DEFAULT_SYSTEM_PROMPT,
    baseUrl: getBaseUrl()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ve_export_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
  showToast("已导出");
});

importBtn.addEventListener("click", ()=>{
  importFile.value = "";
  importFile.click();
});

importFile.addEventListener("change", async ()=>{
  const f = importFile.files?.[0];
  if (!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if (!data || !Array.isArray(data.chats)) throw new Error("Invalid file");

    await idbClear("chats");
    await idbClear("files"); // 导入默认不包含附件 blob

    store.chats = data.chats.map(normalizeChat);
    store.chats.sort((a,b)=> b.updatedAt - a.updatedAt);
    store.activeId = (data.activeId && store.chats.find(c => c.id === data.activeId)) ? data.activeId : (store.chats[0]?.id || "");

    for (const c of store.chats) await idbPut("chats", c);
    await idbPut("meta", { key:"activeId", value: store.activeId || "" });

    if (Array.isArray(data.customModels)){
      customModels = data.customModels.map(m=>({
        id: String(m.id || "").trim(),
        label: String(m.label || "Model").trim(),
        thinkingId: String(m.thinkingId || "").trim(),
        thinkingOnly: !!m.thinkingOnly,
        builtin: false
      })).filter(m => m.id);
      localStorage.setItem(CUSTOM_MODELS_KEY, JSON.stringify(customModels));
    }
    if (data.modelAliases && typeof data.modelAliases === "object"){
      modelAliases = data.modelAliases;
      localStorage.setItem(MODEL_ALIASES_KEY, JSON.stringify(modelAliases));
    }
    if (data.ui && typeof data.ui === "object"){
      selectedModelId = data.ui.selectedModelId || selectedModelId;
      isThinking = !!data.ui.isThinking;
      isWebSearch = !!data.ui.isWebSearch;
      if (typeof data.ui.fontSize === "number") fontSize = data.ui.fontSize;
      if (typeof data.ui.themeMode === "string") themeMode = data.ui.themeMode;
      saveUIState();
    }
    if (typeof data.translateModel === "string") localStorage.setItem(TRANSLATE_MODEL_STORAGE, data.translateModel);
    if (typeof data.searchModel === "string") localStorage.setItem(SEARCH_MODEL_STORAGE, data.searchModel);
    if (typeof data.systemPrompt === "string") localStorage.setItem(SYS_PROMPT_STORAGE, data.systemPrompt);
    if (typeof data.baseUrl === "string") localStorage.setItem(VE_BASE_URL_KEY, data.baseUrl);

    loadModels();
    renderSidebar();
    renderModelDropdown();
    applyModelCapabilities();
    applyWebSearchState();
    applyFontSize();
    applyTheme();
    renderChat(true);
    updateStatusBar();
    showToast("已导入");
  }catch(e){
    console.error(e);
    showToast("导入失败");
  }
});

/***********************
 * Model manager modal
 ***********************/
function openModelManager(){
  renderModelManager();
  modelManagerModal.classList.add("show");
}
function closeModelManager(){
  modelManagerModal.classList.remove("show");
}
modelsBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  openModelManager();
});
mmCloseManagerBtn.addEventListener("click", closeModelManager);
modelManagerModal.addEventListener("click", (e)=>{
  if (e.target === modelManagerModal) closeModelManager();
});
mmAddBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  openModelModalAdd();
});

function renderModelManager(){
  modelManagerList.innerHTML = "";
  const models = getAllModels();

  for (const m of models){
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.style.gap = "10px";
    row.style.padding = "10px 10px";
    row.style.borderRadius = "16px";
    row.style.border = "1px solid var(--hairline)";
    row.style.background = (m.id === selectedModelId) ? "rgba(217,138,112,.14)" : "rgba(0,0,0,.02)";
    row.style.margin = "8px 0";
    row.style.cursor = "pointer";

    row.addEventListener("click", ()=>{
      if (isStreaming) return;
      selectedModelId = m.id;
      applyModelCapabilities();
      renderModelManager();
      renderModelDropdown();
      showToast("已切换模型");
    });

    const left = document.createElement("div");
    left.style.minWidth = "0";

    const name = document.createElement("div");
    name.style.fontWeight = "950";
    name.style.color = "var(--ink)";
    name.textContent = getModelLabel(m) + (m.id === selectedModelId ? " ✓" : "");

    const id = document.createElement("div");
    id.style.fontSize = "12px";
    id.style.fontWeight = "850";
    id.style.color = "var(--muted)";
    id.style.whiteSpace = "nowrap";
    id.style.overflow = "hidden";
    id.style.textOverflow = "ellipsis";
    id.textContent = m.id + (m.thinkingOnly ? "  (thinking-only)" : (m.thinkingId ? "" : "  (no thinking)"));

    left.appendChild(name);
    left.appendChild(id);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flex = "0 0 auto";

    const mk = (title, svg) => {
      const b = document.createElement("button");
      b.className = "actionBtn";
      b.title = title;
      b.innerHTML = svg;
      b.addEventListener("click", (e)=> e.stopPropagation());
      return b;
    };

    const editBtn = mk("Edit", iconSvg("edit"));
    editBtn.addEventListener("click", ()=> openModelModalEdit(m));
    right.appendChild(editBtn);

    if (!m.builtin){
      const delBtn = mk("Delete", `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M6 7h12M9 7V5h6v2M8 7l1 14h6l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `);
      delBtn.addEventListener("click", ()=> openModelModalEdit(m));
      right.appendChild(delBtn);
    }

    row.appendChild(left);
    row.appendChild(right);
    modelManagerList.appendChild(row);
  }
}

/***********************
 * Model editor modal
 ***********************/
function openModelModal(){ modelModal.classList.add("show"); }
function closeModelModal(){ modelModal.classList.remove("show"); }
modelModal.addEventListener("click", (e)=>{ if (e.target === modelModal) closeModelModal(); });
mmCancelBtn.addEventListener("click", closeModelModal);

function openModelModalAdd(){
  modelModalMode = "add";
  modelModalTargetId = "";
  modelModalIsBuiltin = false;

  modelModalTitle.textContent = "Add model";
  modelModalDesc.textContent = "新增自定义模型。";
  mmDeleteBtn.style.display = "none";

  mmLabel.value = "";
  mmBaseId.value = "";
  mmThinkingId.value = "";
  mmThinkingOnly.checked = false;

  mmBaseId.disabled = false;
  mmThinkingId.disabled = false;
  mmThinkingOnly.disabled = false;

  openModelModal();
}

function openModelModalEdit(m){
  modelModalMode = "edit";
  modelModalTargetId = m.id;
  modelModalIsBuiltin = !!m.builtin;

  modelModalTitle.textContent = modelModalIsBuiltin ? "Rename model" : "Edit model";
  modelModalDesc.textContent = modelModalIsBuiltin ? "仅修改显示名称。" : "编辑或删除自定义模型。";

  mmLabel.value = getModelLabel(m);
  mmBaseId.value = m.id;
  mmThinkingId.value = m.thinkingId || "";
  mmThinkingOnly.checked = !!m.thinkingOnly;

  mmBaseId.disabled = modelModalIsBuiltin;
  mmThinkingId.disabled = modelModalIsBuiltin;
  mmThinkingOnly.disabled = modelModalIsBuiltin;

  mmDeleteBtn.style.display = modelModalIsBuiltin ? "none" : "";
  openModelModal();
}

mmDeleteBtn.addEventListener("click", ()=>{
  if (modelModalMode !== "edit") return;
  if (modelModalIsBuiltin) return;

  const id = modelModalTargetId;
  if (!confirm("确定删除该自定义模型？")) return;

  customModels = customModels.filter(m => m.id !== id);

  if (selectedModelId === id){
    selectedModelId = BUILTIN_MODELS[0].id;
    isThinking = false;
  }

  saveModels();
  closeModelModal();
  applyModelCapabilities();
  renderModelDropdown();
  renderModelManager();
  showToast("已删除");
});

mmSaveBtn.addEventListener("click", ()=>{
  const label = (mmLabel.value || "").trim() || "Model";
  const baseId = (mmBaseId.value || "").trim();
  const thinkingId = (mmThinkingId.value || "").trim();
  const thinkingOnly = !!mmThinkingOnly.checked;

  if (modelModalMode === "add"){
    if (!baseId){ alert("请填写模型 ID（Base）。"); return; }
    const existingBuiltin = BUILTIN_MODELS.find(x => x.id === baseId);
    const existingCustom = customModels.find(x => x.id === baseId);
    if (existingBuiltin || existingCustom){ alert("该模型 ID 已存在。"); return; }

    customModels.unshift({
      id: baseId,
      label,
      thinkingId: thinkingOnly ? "" : thinkingId,
      thinkingOnly,
      builtin: false
    });

    saveModels();
    selectedModelId = baseId;
    isThinking = thinkingOnly ? true : isThinking;

    closeModelModal();
    applyModelCapabilities();
    renderModelDropdown();
    renderModelManager();
    showToast("已保存");
    return;
  }

  if (modelModalIsBuiltin){
    modelAliases[modelModalTargetId] = label;
    saveModels();
    closeModelModal();
    applyModelCapabilities();
    renderModelDropdown();
    renderModelManager();
    showToast("已保存");
    return;
  }

  if (!baseId){ alert("模型 ID（Base）不能为空。"); return; }

  const oldId = modelModalTargetId;
  if (baseId !== oldId){
    const collisionBuiltin = BUILTIN_MODELS.find(x => x.id === baseId);
    const collisionCustom = customModels.find(x => x.id === baseId);
    if (collisionBuiltin || collisionCustom){ alert("新的模型 ID 与现有模型冲突。"); return; }
  }

  customModels = customModels.map(m => {
    if (m.id !== oldId) return m;
    return {
      id: baseId,
      label,
      thinkingId: thinkingOnly ? "" : thinkingId,
      thinkingOnly,
      builtin:false
    };
  });

  if (selectedModelId === oldId) selectedModelId = baseId;

  saveModels();
  closeModelModal();
  applyModelCapabilities();
  renderModelDropdown();
  renderModelManager();
  showToast("已保存");
});

/***********************
 * Search in chat
 ***********************/
function openSearchModal(){
  searchModal.classList.add("show");
  setTimeout(()=> searchInput.focus(), 0);
}
function closeSearchModal(){
  searchModal.classList.remove("show");
}
function clearSearchHighlights(){
  // re-render current chat to restore original HTML (safe, fast enough)
  searchMatches = [];
  searchCursor = -1;
  renderChat(false);
  showToast("已清除高亮");
}
function applySearch(query){
  // simple: highlight inside bubbleBody innerHTML by text matching (safe because we re-render from raw)
  searchMatches = [];
  searchCursor = -1;

  const q = (query || "").trim();
  if (!q){
    renderChat(false);
    return;
  }

  // re-render to ensure baseline
  renderChat(false);

  const bodies = Array.from(chatwrap.querySelectorAll(".bubble .bubbleBody"));
  const needle = q.toLowerCase();

  for (const body of bodies){
    const raw = body.dataset.raw || "";
    const rawLower = raw.toLowerCase();
    if (!rawLower.includes(needle)) continue;

    // create highlighted markdown by injecting <span> AFTER rendering: do it on raw text before renderInline? too complex
    // Here: safe approach: highlight on final HTML by replacing escaped text.
    // We'll highlight on plain text occurrences by re-rendering markdown then post-process on the HTML text nodes.
    // To keep it simple: wrap matches on body.innerHTML (works well for most cases).
    // Note: not perfect across tags, but practical.

    const html = body.innerHTML;
    // escape regex
    const re = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "gi");
    body.innerHTML = html.replace(re, (m)=> `<span class="highlight">${m}</span>`);

    const bubble = body.closest(".bubble");
    if (bubble) searchMatches.push(bubble);
  }

  if (!searchMatches.length){
    showToast("未找到匹配");
    return;
  }
  showToast(`找到 ${searchMatches.length} 处`);
  searchCursor = 0;
  jumpToSearchCursor();
}
function jumpToSearchCursor(){
  if (!searchMatches.length) return;
  searchCursor = Math.max(0, Math.min(searchMatches.length - 1, searchCursor));
  const bubble = searchMatches[searchCursor];
  bubble.scrollIntoView({ behavior:"smooth", block:"center" });
}
searchBtn.addEventListener("click", ()=> openSearchModal());
openSearchInChatBtn.addEventListener("click", ()=> { openSearchModal(); closeDrawer(); });

searchModal.addEventListener("click", (e)=>{ if (e.target === searchModal) closeSearchModal(); });
searchCloseBtn.addEventListener("click", closeSearchModal);

searchInput.addEventListener("input", ()=>{
  applySearch(searchInput.value);
});
searchPrevBtn.addEventListener("click", ()=>{
  if (!searchMatches.length) return;
  searchCursor = (searchCursor - 1 + searchMatches.length) % searchMatches.length;
  jumpToSearchCursor();
});
searchNextBtn.addEventListener("click", ()=>{
  if (!searchMatches.length) return;
  searchCursor = (searchCursor + 1) % searchMatches.length;
  jumpToSearchCursor();
});
searchClearBtn.addEventListener("click", clearSearchHighlights);

/***********************
 * Keyboard shortcuts
 ***********************/
document.addEventListener("keydown", (e)=>{
  const isMac = navigator.platform.toLowerCase().includes("mac");
  const mod = isMac ? e.metaKey : e.ctrlKey;

  // Ctrl/⌘+F open search in chat
  if (mod && e.key.toLowerCase() === "f"){
    e.preventDefault();
    openSearchModal();
    return;
  }

  // Ctrl/⌘+K toggle drawer
  if (mod && e.key.toLowerCase() === "k"){
    e.preventDefault();
    if (drawer.classList.contains("open")) closeDrawer();
    else openDrawer();
    return;
  }

  // Esc closes modals/drawer
  if (e.key === "Escape"){
    if (dropdown.classList.contains("open")){
      dropdown.classList.remove("open");
      modelBtn.setAttribute("aria-expanded","false");
      return;
    }
    if (searchModal.classList.contains("show")) { closeSearchModal(); return; }
    if (modelModal.classList.contains("show")) { closeModelModal(); return; }
    if (modelManagerModal.classList.contains("show")) { closeModelManager(); return; }
    if (settingsModal.classList.contains("show")) { closeSettings(); return; }
    if (drawer.classList.contains("open")) { closeDrawer(); return; }
  }
});

/***********************
 * Search modal open via top search icon
 ***********************/
searchBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  openSearchModal();
});

/***********************
 * Top right plus = new chat
 ***********************/
topPlusBtn.addEventListener("click", ()=>{
  if (isStreaming) return;
  createNewChat();
});

/***********************
 * Compose stop / send state
 ***********************/
syncSendState();

/***********************
 * Settings buttons from drawer
 ***********************/
settingsBtnInDrawer.addEventListener("click", ()=>{
  if (isStreaming) return;
  openSettings();
});

/***********************
 * Model dropdown open
 ***********************/
function loadModelsAndUI(){
  loadModels();
  loadUIState();
  loadTheme();
  renderModelDropdown();
  applyModelCapabilities();
  applyWebSearchState();
  applyFontSize();
  applyTheme();
}

/***********************
 * Init
 ***********************/
async function init(){
  loadModels();
  loadUIState();
  applyTheme();

  await openDB();
  await loadStoreFromDB();

  if (!getModelById(selectedModelId)){
    selectedModelId = BUILTIN_MODELS[0].id;
    isThinking = false;
  }

  renderSidebar();
  renderModelDropdown();
  applyModelCapabilities();
  applyWebSearchState();
  applyFontSize();
  applyTheme();
  renderAttachBar();
  renderChat(true);
  syncSendState();
  updateStatusBar();
  updateToBottomButton();
}
init();
  </script>
</body>
</html>
