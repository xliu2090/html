<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>Sora è§†é¢‘ç”Ÿæˆå·¥å…·</title>
  <style>
    :root { 
      color-scheme: light dark;
      --primary: #2563eb;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --border: rgba(127,127,127,.25);
      --bg-card: rgba(127,127,127,.06);
    }
    * { box-sizing: border-box; }
    body { 
      margin:0; 
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,PingFang SC,"Helvetica Neue",Arial;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .header {
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,.1);
    }
    .header h1 { 
      margin: 0 0 8px; 
      font-size: 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      background: var(--bg-card);
      border: 1px solid var(--border);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    .main-card {
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(0,0,0,.1);
      margin-bottom: 20px;
    }
    .form-group { margin-bottom: 20px; }
    label { 
      display: block; 
      font-size: 14px; 
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    input, textarea, select {
      width: 100%;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      background: #fff;
      transition: all .2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,.1);
    }
    textarea { min-height: 100px; resize: vertical; font-family: inherit; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .size-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .size-btn {
      padding: 12px;
      border: 2px solid var(--border);
      background: #fff;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s;
      font-weight: 500;
    }
    .size-btn:hover { border-color: var(--primary); background: rgba(37,99,235,.05); }
    .size-btn.active { border-color: var(--primary); background: rgba(37,99,235,.1); color: var(--primary); }
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    button {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }
    button.primary { 
      background: var(--primary); 
      color: #fff;
      box-shadow: 0 4px 12px rgba(37,99,235,.3);
    }
    button.primary:hover { 
      background: #1d4ed8;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(37,99,235,.4);
    }
    button.secondary { background: #f3f4f6; color: #374151; }
    button.secondary:hover { background: #e5e7eb; }
    button.danger { background: rgba(239,68,68,.1); color: var(--danger); border: 2px solid var(--danger); }
    button:disabled { opacity: .5; cursor: not-allowed; transform: none !important; }
    .settings-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,.9);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all .2s;
    }
    .settings-btn:hover { background: #fff; border-color: var(--primary); }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-header h2 { margin: 0; font-size: 22px; }
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #9ca3af;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }
    .close-btn:hover { background: #f3f4f6; color: #374151; }
    .tasks-card {
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,.1);
    }
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .tasks-header h2 { margin: 0; font-size: 20px; }
    .task {
      background: #fff;
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all .2s;
    }
    .task:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    .task-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .task-id {
      font-family: ui-monospace, monospace;
      font-size: 13px;
      color: #6b7280;
      word-break: break-all;
    }
    .task-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .task-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .task-status.completed { background: rgba(34,197,94,.1); color: var(--success); }
    .task-status.processing { background: rgba(245,158,11,.1); color: var(--warning); }
    .task-status.queued { background: rgba(156,163,175,.1); color: #6b7280; }
    .task-status.failed { background: rgba(239,68,68,.1); color: var(--danger); }
    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .task-actions button { 
      flex: none;
      padding: 8px 16px;
      font-size: 13px;
    }
    video {
      width: 100%;
      border-radius: 12px;
      margin-top: 12px;
      background: #000;
    }
    .log {
      background: #1f2937;
      color: #e5e7eb;
      padding: 16px;
      border-radius: 12px;
      font-family: ui-monospace, monospace;
      font-size: 12px;
      line-height: 1.6;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .hint { 
      font-size: 13px; 
      color: #6b7280; 
      margin-top: 6px;
      line-height: 1.5;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 400;
      margin-top: 12px;
      cursor: pointer;
    }
    .checkbox-label input { width: auto; margin: 0; }
    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; }
      .header-actions { flex-wrap: wrap; }
      .action-buttons { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ¬ Sora è§†é¢‘ç”Ÿæˆå·¥å…·</h1>
    <p style="margin: 0; color: #6b7280; font-size: 14px;">åŸºäº OpenAI Sora API çš„è§†é¢‘åˆ›ä½œå¹³å°</p>
    <div class="header-actions">
      <div class="status-badge">
        <span class="status-dot"></span>
        <span id="pollStatus">å°±ç»ª</span>
      </div>
      <div class="status-badge">
        <span>ğŸ“¡</span>
        <span id="netStatus">åœ¨çº¿</span>
      </div>
      <button class="settings-btn" onclick="openSettings()">âš™ï¸ è®¾ç½®</button>
    </div>
  </div>

  <div class="main-card">
    <div class="form-group">
      <label>æ¨¡å‹é€‰æ‹©</label>
      <select id="model" onchange="onModelChange()">
        <option value="sora-2">Sora 2 - æ ‡å‡†ç‰ˆ</option>
        <option value="sora-2-pro">Sora 2 Pro - ä¸“ä¸šç‰ˆ</option>
        <option value="custom">è‡ªå®šä¹‰æ¨¡å‹...</option>
      </select>
      <input id="customModel" type="text" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°" style="display:none; margin-top:8px;" />
      <div class="hint" id="modelHint">Sora 2 æ”¯æŒåŸºç¡€åˆ†è¾¨ç‡ï¼Œé€‚åˆå¿«é€Ÿç”Ÿæˆ</div>
    </div>

    <div class="form-group">
      <label>è§†é¢‘æè¿° (Prompt)</label>
      <textarea id="prompt" placeholder="ä¾‹å¦‚ï¼šä¸€åªä¸‰èŠ±çŒ«åœ¨èˆå°ä¸Šå¼¹é’¢ç´ï¼Œèšå…‰ç¯ç…§å°„ï¼Œç”µå½±è´¨æ„Ÿï¼Œ4Kç”»è´¨"></textarea>
    </div>

    <div class="row">
      <div class="form-group">
        <label>è§†é¢‘æ—¶é•¿</label>
        <select id="seconds">
          <option value="4">4 ç§’</option>
          <option value="8" selected>8 ç§’</option>
          <option value="10">10 ç§’</option>
          <option value="12">12 ç§’</option>
          <option value="15">15 ç§’</option>
        </select>
      </div>
      <div class="form-group">
        <label>è§†é¢‘æ–¹å‘</label>
        <select id="orientation" onchange="onOrientationChange()">
          <option value="portrait">ç«–å± (9:16)</option>
          <option value="landscape">æ¨ªå± (16:9)</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>åˆ†è¾¨ç‡</label>
      <div class="size-buttons" id="sizeButtons"></div>
      <input id="size" type="hidden" value="720x1280" />
    </div>

    <div class="form-group">
      <label>å‚è€ƒå›¾ç‰‡ (å¯é€‰)</label>
      <input id="refImage" type="file" accept="image/*" />
    </div>

    <div class="action-buttons">
      <button class="primary" id="btnCreate" onclick="createVideo()">ğŸ¬ å¼€å§‹ç”Ÿæˆ</button>
      <button class="secondary" id="btnTogglePoll" onclick="togglePoll()">â–¶ï¸ å¼€å§‹è½®è¯¢</button>
    </div>

    <div class="log" id="log" style="display:none;"></div>
  </div>

  <div class="tasks-card">
    <div class="tasks-header">
      <h2>ä»»åŠ¡åˆ—è¡¨</h2>
      <div style="display:flex; gap:12px; align-items:center;">
        <span class="status-badge" id="taskCount">0 ä¸ªä»»åŠ¡</span>
        <button class="danger" onclick="clearTasks()" style="flex:none; padding:8px 16px; font-size:13px;">æ¸…ç©º</button>
      </div>
    </div>
    <div id="tasks"></div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>âš™ï¸ è®¾ç½®</h2>
      <button class="close-btn" onclick="closeSettings()">Ã—</button>
    </div>
    
    <div class="form-group">
      <label>API Base URL</label>
      <input id="baseUrl" type="text" value="https://api.openai.com" />
      <div class="hint">OpenAI å®˜æ–¹åœ°å€æˆ–è‡ªå®šä¹‰ä»£ç†åœ°å€</div>
    </div>

    <div class="form-group">
      <label>API Key</label>
      <input id="apiKey" type="password" placeholder="sk-..." />
      <label class="checkbox-label">
        <input id="rememberKey" type="checkbox" />
        <span>è®°ä½ API Key (ä¿å­˜åœ¨æœ¬åœ°)</span>
      </label>
    </div>

    <div class="form-group">
      <label>è½®è¯¢é—´éš” (ç§’)</label>
      <select id="pollSec">
        <option value="5">5 ç§’</option>
        <option value="10" selected>10 ç§’</option>
        <option value="15">15 ç§’</option>
        <option value="20">20 ç§’</option>
        <option value="30">30 ç§’</option>
      </select>
    </div>

    <div class="form-group">
      <label>å¹¶å‘è½®è¯¢æ•°é‡</label>
      <select id="pollBatch">
        <option value="1">1 ä¸ª</option>
        <option value="2">2 ä¸ª</option>
        <option value="3" selected>3 ä¸ª</option>
        <option value="5">5 ä¸ª</option>
      </select>
    </div>

    <label class="checkbox-label">
      <input id="enableNotif" type="checkbox" />
      <span>å®Œæˆåå‘é€é€šçŸ¥</span>
    </label>

    <div class="action-buttons" style="margin-top:24px;">
      <button class="primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      <button class="secondary" onclick="closeSettings()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
const SIZE_CONFIG = {
  "sora-2": {
    portrait: [{ val: "720x1280", label: "æ ‡æ¸… 720x1280" }],
    landscape: [{ val: "1280x720", label: "æ ‡æ¸… 1280x720" }]
  },
  "sora-2-pro": {
    portrait: [
      { val: "720x1280", label: "æ ‡æ¸… 720x1280" },
      { val: "1024x1792", label: "é«˜æ¸… 1024x1792" }
    ],
    landscape: [
      { val: "1280x720", label: "æ ‡æ¸… 1280x720" },
      { val: "1792x1024", label: "é«˜æ¸… 1792x1024" }
    ]
  }
};

let tasks = [];
let pollTimer = null;
let currentModel = "sora-2";
let currentOrientation = "portrait";

const $ = id => document.getElementById(id);

function log(msg, show = true) {
  const t = new Date().toLocaleTimeString();
  $("log").textContent = `[${t}] ${msg}\n` + $("log").textContent;
  if (show) $("log").style.display = "block";
}

function updateNetStatus() {
  $("netStatus").textContent = navigator.onLine ? "åœ¨çº¿" : "ç¦»çº¿";
}

function onModelChange() {
  const model = $("model").value;
  if (model === "custom") {
    $("customModel").style.display = "block";
    $("modelHint").textContent = "è‡ªå®šä¹‰æ¨¡å‹ä¸é™åˆ¶åˆ†è¾¨ç‡ï¼Œè¯·ç¡®è®¤ä½ çš„ API æ”¯æŒ";
    currentModel = "custom";
  } else {
    $("customModel").style.display = "none";
    currentModel = model;
    $("modelHint").textContent = model === "sora-2-pro" 
      ? "Sora 2 Pro æ”¯æŒæ›´é«˜åˆ†è¾¨ç‡å’Œæ›´å¥½çš„è§†é¢‘è´¨é‡" 
      : "Sora 2 æ”¯æŒåŸºç¡€åˆ†è¾¨ç‡ï¼Œé€‚åˆå¿«é€Ÿç”Ÿæˆ";
  }
  updateSizeButtons();
}

function onOrientationChange() {
  currentOrientation = $("orientation").value;
  updateSizeButtons();
}

function updateSizeButtons() {
  const config = SIZE_CONFIG[currentModel];
  const container = $("sizeButtons");
  
  if (!config) {
    container.innerHTML = '<div class="hint">è‡ªå®šä¹‰æ¨¡å‹è¯·æ‰‹åŠ¨è¾“å…¥åˆ†è¾¨ç‡</div>';
    return;
  }
  
  const sizes = config[currentOrientation];
  container.innerHTML = sizes.map((s, i) => 
    `<button type="button" class="size-btn ${i === 0 ? 'active' : ''}" onclick="selectSize('${s.val}')">${s.label}</button>`
  ).join("");
  
  $("size").value = sizes[0].val;
}

function selectSize(val) {
  $("size").value = val;
  document.querySelectorAll(".size-btn").forEach(btn => {
    btn.classList.toggle("active", btn.textContent.includes(val));
  });
}

async function createVideo() {
  try {
    $("btnCreate").disabled = true;
    
    const model = currentModel === "custom" ? $("customModel").value.trim() : currentModel;
    const prompt = $("prompt").value.trim();
    const seconds = $("seconds").value;
    const size = $("size").value;
    
    if (!model) throw new Error("è¯·é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹");
    if (!prompt) throw new Error("è¯·è¾“å…¥è§†é¢‘æè¿°");
    
    const baseUrl = $("baseUrl").value.trim().replace(/\/+$/, "");
    const apiKey = $("apiKey").value.trim();
    if (!apiKey) throw new Error("è¯·åœ¨è®¾ç½®ä¸­å¡«å†™ API Key");
    
    const file = $("refImage").files[0];
    let res, data;
    
    if (file) {
      const fd = new FormData();
      fd.set("model", model);
      fd.set("prompt", prompt);
      fd.set("seconds", seconds);
      fd.set("size", size);
      fd.set("input_reference", file);
      
      res = await fetch(`${baseUrl}/v1/videos`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${apiKey}` },
        body: fd
      });
    } else {
      res = await fetch(`${baseUrl}/v1/videos`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ model, prompt, seconds, size })
      });
    }
    
    data = await res.json();
    if (!res.ok) throw new Error(`åˆ›å»ºå¤±è´¥: ${data.error?.message || res.statusText}`);
    if (!data.id) throw new Error("è¿”å›æ•°æ®ç¼ºå°‘ ID");
    
    tasks.unshift({
      id: data.id,
      status: data.status || "queued",
      progress: data.progress || 0,
      model, size, seconds,
      createdAt: Date.now(),
      videoUrl: ""
    });
    
    log(`âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${data.id}`);
    renderTasks();
    refreshOne(data.id);
    
  } catch (e) {
    log(`âŒ ${e.message}`);
  } finally {
    $("btnCreate").disabled = false;
  }
}

async function refreshOne(id) {
  try {
    const baseUrl = $("baseUrl").value.trim().replace(/\/+$/, "");
    const apiKey = $("apiKey").value.trim();
    
    const res = await fetch(`${baseUrl}/v1/videos/${id}`, {
      headers: { "Authorization": `Bearer ${apiKey}` }
    });
    
    const data = await res.json();
    const task = tasks.find(t => t.id === id);
    if (!task) return;
    
    const prevStatus = task.status;
    task.status = data.status || task.status;
    task.progress = data.progress || task.progress;
    
    renderTasks();
    
    if (prevStatus !== "completed" && task.status === "completed") {
      log(`ğŸ‰ ä»»åŠ¡å®Œæˆ: ${id}`);
      if ($("enableNotif").checked) {
        new Notification("è§†é¢‘ç”Ÿæˆå®Œæˆ", { body: id });
      }
    }
  } catch (e) {
    log(`åˆ·æ–°å¤±è´¥ ${id}: ${e.message}`, false);
  }
}

async function downloadOne(id) {
  try {
    const baseUrl = $("baseUrl").value.trim().replace(/\/+$/, "");
    const apiKey = $("apiKey").value.trim();
    
    const res = await fetch(`${baseUrl}/v1/videos/${id}/content`, {
      headers: { "Authorization": `Bearer ${apiKey}` }
    });
    
    if (!res.ok) throw new Error(`ä¸‹è½½å¤±è´¥: ${res.statusText}`);
    
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const task = tasks.find(t => t.id === id);
    
    if (task) {
      if (task.videoUrl) URL.revokeObjectURL(task.videoUrl);
      task.videoUrl = url;
    }
    
    renderTasks();
    log(`ğŸ“¥ ä¸‹è½½æˆåŠŸ: ${id}`);
  } catch (e) {
    log(`âŒ ${e.message}`);
  }
}

function removeTask(id) {
  const task = tasks.find(t => t.id === id);
  if (task?.videoUrl) URL.revokeObjectURL(task.videoUrl);
  tasks = tasks.filter(t => t.id !== id);
  renderTasks();
  log(`ğŸ—‘ï¸ å·²ç§»é™¤ä»»åŠ¡: ${id}`);
}

function renderTasks() {
  $("taskCount").textContent = `${tasks.length} ä¸ªä»»åŠ¡`;
  
  if (tasks.length === 0) {
    $("tasks").innerHTML = '<div class="hint" style="text-align:center; padding:40px;">æš‚æ— ä»»åŠ¡</div>';
    return;
  }
  
  $("tasks").innerHTML = tasks.map(t => {
    const statusClass = t.status === "completed" ? "completed" : 
                       t.status === "failed" ? "failed" :
                       t.status === "processing" ? "processing" : "queued";
    
    return `
      <div class="task">
        <div class="task-header">
          <div>
            <div class="task-id">${t.id}</div>
            <div class="task-meta">${t.model} Â· ${t.size} Â· ${t.seconds}s</div>
          </div>
          <span class="task-status ${statusClass}">${t.status} ${t.progress}%</span>
        </div>
        <div class="task-actions">
          <button class="secondary" onclick="refreshOne('${t.id}')">ğŸ”„ åˆ·æ–°</button>
          <button class="secondary" onclick="downloadOne('${t.id}')" ${t.status !== 'completed' ? 'disabled' : ''}>ğŸ“¥ ä¸‹è½½</button>
          <button class="danger" onclick="removeTask('${t.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>
        ${t.videoUrl ? `<video controls playsinline src="${t.videoUrl}"></video>` : ''}
      </div>
    `;
  }).join("");
}

async function pollTick() {
  const running = tasks.filter(t => t.status !== "completed" && t.status !== "failed");
  if (running.length === 0) return;
  
  const batch = parseInt($("pollBatch").value);
  for (const t of running.slice(0, batch)) {
    await refreshOne(t.id);
  }
}

function togglePoll() {
  if (pollTimer) {
    clearInterval(pollTimer);
    pollTimer = null;
    $("pollStatus").textContent = "å·²åœæ­¢";
    $("btnTogglePoll").innerHTML = "â–¶ï¸ å¼€å§‹è½®è¯¢";
    log("â¸ï¸ è½®è¯¢å·²åœæ­¢");
  } else {
    const sec = parseInt($("pollSec").value);
    pollTimer = setInterval(pollTick, sec * 1000);
    $("pollStatus").textContent = `è½®è¯¢ä¸­ (${sec}s)`;
    $("btnTogglePoll").innerHTML = "â¸ï¸ åœæ­¢è½®è¯¢";
    log(`â–¶ï¸ å¼€å§‹è½®è¯¢ (æ¯${sec}ç§’)`);
  }
}

function clearTasks() {
  if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿ")) return;
  tasks.forEach(t => { if (t.videoUrl) URL.revokeObjectURL(t.videoUrl); });
  tasks = [];
  renderTasks();
  log("ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡");
}

function openSettings() {
  $("settingsModal").classList.add("show");
}

function closeSettings() {
  $("settingsModal").classList.remove("show");
}

function saveSettings() {
  if ($("rememberKey").checked) {
    localStorage.setItem("SORA_API_KEY", $("apiKey").value);
    localStorage.setItem("SORA_REMEMBER", "1");
  } else {
    localStorage.removeItem("SORA_API_KEY");
    localStorage.setItem("SORA_REMEMBER", "0");
  }
  
  if ($("enableNotif").checked && "Notification" in window) {
    Notification.requestPermission();
  }
  
  closeSettings();
  log("ğŸ’¾ è®¾ç½®å·²ä¿å­˜");
}

// Init
window.addEventListener("online", updateNetStatus);
window.addEventListener("offline", updateNetStatus);

if (localStorage.getItem("SORA_REMEMBER") === "1") {
  const saved = localStorage.getItem("SORA_API_KEY");
  if (saved) {
    $("apiKey").value = saved;
