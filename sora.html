<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>Sora è§†é¢‘ç”Ÿæˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { 
      --bg-main: #0f172a;
      --bg-card: #1e293b;
      --bg-input: #334155;
      --border: #475569;
      --text: #f1f5f9;
      --text-dim: #94a3b8;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    body { 
      background: var(--bg-main);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 16px;
    }
    h1 { font-size: 24px; font-weight: 600; }
    .settings-btn {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .settings-btn:hover { background: var(--border); }
    .settings-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .settings-modal.active { display: flex; }
    .settings-content {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .close-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .grid { 
      display: grid; 
      grid-template-columns: 1fr;
      gap: 20px;
    }
    @media (min-width: 900px) { 
      .grid { grid-template-columns: 1fr 1fr; }
    }
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border);
    }
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    label {
      display: block;
      font-size: 14px;
      color: var(--text-dim);
      margin: 16px 0 8px;
    }
    input, textarea, select {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--primary);
    }
    textarea { min-height: 100px; resize: vertical; font-family: inherit; }
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    .size-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .size-btn {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .size-btn:hover {
      background: var(--border);
      border-color: var(--primary);
    }
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-top: 20px;
    }
    .btn:hover { background: var(--primary-hover); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn.secondary {
      background: var(--bg-input);
      border: 1px solid var(--border);
    }
    .btn.danger {
      background: var(--danger);
    }
    .status-pills {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .pill {
      background: var(--bg-input);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-dim);
      border: 1px solid var(--border);
    }
    .pill.active { background: var(--primary); color: white; border-color: var(--primary); }
    .task-list { display: grid; gap: 16px; margin-top: 16px; }
    .task {
      background: var(--bg-input);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    .task-id {
      font-family: monospace;
      font-size: 12px;
      color: var(--text-dim);
      word-break: break-all;
    }
    .task-meta {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 8px;
    }
    .task-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .task-buttons button {
      padding: 8px 14px;
      font-size: 13px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .task-buttons button:hover { background: var(--border); }
    .task-buttons button:disabled { opacity: 0.5; cursor: not-allowed; }
    .task-buttons button.danger { color: var(--danger); }
    video {
      width: 100%;
      border-radius: 10px;
      margin-top: 12px;
      background: #000;
    }
    .log {
      background: var(--bg-input);
      padding: 12px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      color: var(--text-dim);
      margin-top: 16px;
    }
    .hint {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 6px;
      line-height: 1.4;
    }
    .hint.warning { color: var(--warning); }
    input[type="checkbox"] {
      width: auto;
      margin-right: 6px;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ¬ Sora è§†é¢‘ç”Ÿæˆ</h1>
    <button class="settings-btn" id="settingsBtn">
      <span>âš™ï¸</span>
      <span>è®¾ç½®</span>
    </button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-title">åˆ›å»ºè§†é¢‘</div>
      
      <label>æ¨¡å‹</label>
      <select id="model">
        <option value="sora-2">Sora 2 (æ ‡å‡†)</option>
        <option value="sora-2-pro">Sora 2 Pro (é«˜æ¸…)</option>
        <option value="custom">è‡ªå®šä¹‰æ¨¡å‹...</option>
      </select>
      <input id="customModel" type="text" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹å" style="display:none; margin-top:8px;">

      <label>è§†é¢‘æè¿° (Prompt)</label>
      <textarea id="prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘åœºæ™¯ï¼Œä¾‹å¦‚ï¼šä¸€åªä¸‰èŠ±çŒ«åœ¨èˆå°ä¸Šå¼¹é’¢ç´ï¼Œèšå…‰ç¯ï¼Œç”µå½±æ„Ÿ"></textarea>

      <label>æ—¶é•¿ (ç§’)</label>
      <select id="seconds">
        <option value="4">4 ç§’</option>
        <option value="8">8 ç§’</option>
        <option value="10">10 ç§’</option>
        <option value="12">12 ç§’</option>
        <option value="15">15 ç§’</option>
      </select>

      <label>å°ºå¯¸</label>
      <div class="size-grid">
        <button type="button" class="size-btn" data-size="720x1280">ğŸ“± ç«–å± 720p</button>
        <button type="button" class="size-btn" data-size="1280x720">ğŸ–¥ï¸ æ¨ªå± 720p</button>
        <button type="button" class="size-btn" data-size="1024x1792">ğŸ“± ç«–å± HD</button>
        <button type="button" class="size-btn" data-size="1792x1024">ğŸ–¥ï¸ æ¨ªå± HD</button>
      </div>
      <input id="size" type="text" value="720x1280" readonly style="margin-top:12px; cursor:pointer;">
      <div class="hint" id="sizeHint"></div>

      <label>å‚è€ƒå›¾ç‰‡ (å¯é€‰)</label>
      <input id="refImage" type="file" accept="image/*">

      <button class="btn" id="createBtn">ğŸš€ ç”Ÿæˆè§†é¢‘</button>

      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <div class="card-title">ä»»åŠ¡åˆ—è¡¨</div>
      <div class="status-pills">
        <div class="pill" id="taskCount">0 ä¸ªä»»åŠ¡</div>
        <div class="pill" id="pollStatus">è½®è¯¢æœªå¯åŠ¨</div>
      </div>
      
      <div style="display:flex; gap:10px;">
        <button class="btn secondary" id="togglePollBtn" style="margin-top:0;">å¼€å§‹è½®è¯¢</button>
        <button class="btn danger" id="clearBtn" style="margin-top:0;">æ¸…ç©º</button>
      </div>

      <div class="task-list" id="taskList"></div>
    </div>
  </div>
</div>

<div class="settings-modal" id="settingsModal">
  <div class="settings-content">
    <div class="settings-header">
      <h2>è®¾ç½®</h2>
      <button class="close-btn" id="closeSettings">Ã—</button>
    </div>

    <label>Base URL</label>
    <input id="baseUrl" type="text" value="https://api.openai.com">
    <div class="hint">ç›´è¿ OpenAI æˆ–å¡«å†™ä»£ç†åŸŸå</div>

    <label>API Key</label>
    <input id="apiKey" type="password" placeholder="sk-...">
    <div style="margin-top:12px;">
      <label style="display:inline-flex; align-items:center; margin:0;">
        <input id="rememberKey" type="checkbox">
        <span>è®°ä½ API Key (å­˜å‚¨åœ¨æœ¬åœ°)</span>
      </label>
    </div>

    <label>è½®è¯¢é—´éš” (ç§’)</label>
    <input id="pollInterval" type="number" min="5" value="12">

    <label>å¹¶å‘è½®è¯¢æ•°</label>
    <input id="pollBatch" type="number" min="1" value="3">

    <div style="margin-top:20px;">
      <button class="btn secondary" id="enableNotif">å¼€å¯å®Œæˆé€šçŸ¥</button>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  
  const el = {
    model: $('model'),
    customModel: $('customModel'),
    prompt: $('prompt'),
    seconds: $('seconds'),
    size: $('size'),
    sizeHint: $('sizeHint'),
    refImage: $('refImage'),
    createBtn: $('createBtn'),
    taskList: $('taskList'),
    taskCount: $('taskCount'),
    pollStatus: $('pollStatus'),
    togglePollBtn: $('togglePollBtn'),
    clearBtn: $('clearBtn'),
    log: $('log'),
    settingsBtn: $('settingsBtn'),
    settingsModal: $('settingsModal'),
    closeSettings: $('closeSettings'),
    baseUrl: $('baseUrl'),
    apiKey: $('apiKey'),
    rememberKey: $('rememberKey'),
    pollInterval: $('pollInterval'),
    pollBatch: $('pollBatch'),
    enableNotif: $('enableNotif')
  };

  let tasks = [];
  let pollTimer = null;
  let notifEnabled = false;
  let selectedSize = '720x1280';

  const SIZES_BY_MODEL = {
    'sora-2': ['720x1280', '1280x720'],
    'sora-2-pro': ['720x1280', '1280x720', '1024x1792', '1792x1024']
  };

  function log(msg) {
    const time = new Date().toLocaleTimeString();
    el.log.textContent = `[${time}] ${msg}\n` + el.log.textContent;
  }

  function getModelName() {
    return el.model.value === 'custom' ? el.customModel.value.trim() : el.model.value;
  }

  function updateSizeHint() {
    const model = getModelName();
    const allowed = SIZES_BY_MODEL[model] || Object.values(SIZES_BY_MODEL).flat();
    const sizeMap = {
      '720x1280': 'ç«–å± 720p',
      '1280x720': 'æ¨ªå± 720p',
      '1024x1792': 'ç«–å±é«˜æ¸…',
      '1792x1024': 'æ¨ªå±é«˜æ¸…'
    };
    el.sizeHint.textContent = `å½“å‰æ¨¡å‹æ”¯æŒ: ${allowed.map(s => sizeMap[s] || s).join(', ')}`;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.size-btn').forEach(btn => {
      const size = btn.getAttribute('data-size');
      btn.style.opacity = allowed.includes(size) ? '1' : '0.5';
      btn.disabled = !allowed.includes(size);
    });
  }

  function render() {
    el.taskCount.textContent = `${tasks.length} ä¸ªä»»åŠ¡`;
    el.taskList.innerHTML = tasks.map(t => {
      const statusColor = t.status === 'completed' ? 'var(--success)' : 
                         t.status === 'failed' ? 'var(--danger)' : 'var(--warning)';
      const videoHtml = t.videoUrl ? `<video controls playsinline src="${t.videoUrl}"></video>` : '';
      
      return `
        <div class="task">
          <div class="task-header">
            <div style="flex:1;">
              <div class="task-id">${t.id}</div>
              <div class="task-meta">
                <span style="color:${statusColor}">â— ${t.status}</span> Â· 
                ${t.progress ?? 0}% Â· 
                ${t.model} Â· ${t.size} Â· ${t.seconds}s
              </div>
            </div>
          </div>
          <div class="task-buttons">
            <button data-id="${t.id}" data-action="refresh">åˆ·æ–°</button>
            <button data-id="${t.id}" data-action="download" ${t.status !== 'completed' ? 'disabled' : ''}>ä¸‹è½½</button>
            <button class="danger" data-id="${t.id}" data-action="remove">åˆ é™¤</button>
          </div>
          ${videoHtml}
        </div>
      `;
    }).join('');

    // ç»‘å®šäº‹ä»¶
    el.taskList.querySelectorAll('button[data-action]').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'refresh') await refreshTask(id);
        else if (action === 'download') await downloadTask(id);
        else if (action === 'remove') removeTask(id);
      };
    });
  }

  async function createVideo() {
    const model = getModelName();
    const prompt = el.prompt.value.trim();
    const seconds = el.seconds.value;
    const size = selectedSize;

    if (!prompt) throw new Error('è¯·è¾“å…¥è§†é¢‘æè¿°');
    if (!model) throw new Error('è¯·é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹å');

    const baseUrl = el.baseUrl.value.trim().replace(/\/+$/, '');
    const apiKey = el.apiKey.value.trim();
    if (!apiKey) throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key');

    const file = el.refImage.files?.[0];
    let res;

    if (file) {
      const fd = new FormData();
      fd.set('model', model);
      fd.set('prompt', prompt);
      fd.set('seconds', seconds);
      fd.set('size', size);
      fd.set('input_reference', file);

      res = await fetch(`${baseUrl}/v1/videos`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}` },
        body: fd
      });
    } else {
      res = await fetch(`${baseUrl}/v1/videos`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ model, prompt, seconds, size })
      });
    }

    const data = await res.json();
    if (!res.ok) throw new Error(`åˆ›å»ºå¤±è´¥: ${data.error?.message || res.statusText}`);
    if (!data.id) throw new Error('è¿”å›æ•°æ®ç¼ºå°‘ id');

    tasks.unshift({
      id: data.id,
      status: data.status || 'queued',
      progress: data.progress ?? 0,
      model: data.model || model,
      size: data.size || size,
      seconds: data.seconds || seconds,
      createdAt: Date.now(),
      videoUrl: ''
    });

    log(`âœ… åˆ›å»ºæˆåŠŸ: ${data.id}`);
    render();
    await refreshTask(data.id);
  }

  async function refreshTask(id) {
    const baseUrl = el.baseUrl.value.trim().replace(/\/+$/, '');
    const apiKey = el.apiKey.value.trim();

    const res = await fetch(`${baseUrl}/v1/videos/${encodeURIComponent(id)}`, {
      headers: { 'Authorization': `Bearer ${apiKey}` }
    });

    const data = await res.json();
    if (!res.ok) {
      log(`âŒ åˆ·æ–°å¤±è´¥ ${id}: ${res.statusText}`);
      return;
    }

    const task = tasks.find(t => t.id === id);
    if (!task) return;

    const prevStatus = task.status;
    task.status = data.status || task.status;
    task.progress = data.progress ?? task.progress;
    
    render();
    log(`ğŸ”„ ${id}: ${task.status} (${task.progress}%)`);

    if (notifEnabled && prevStatus !== 'completed' && task.status === 'completed') {
      new Notification('Sora è§†é¢‘å®Œæˆ', { body: id });
    }
  }

  async function downloadTask(id) {
    const baseUrl = el.baseUrl.value.trim().replace(/\/+$/, '');
    const apiKey = el.apiKey.value.trim();

    const res = await fetch(`${baseUrl}/v1/videos/${encodeURIComponent(id)}/content`, {
      headers: { 'Authorization': `Bearer ${apiKey}` }
    });

    if (!res.ok) {
      log(`âŒ ä¸‹è½½å¤±è´¥ ${id}`);
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const task = tasks.find(t => t.id === id);
    if (task) {
      if (task.videoUrl) URL.revokeObjectURL(task.videoUrl);
      task.videoUrl = url;
    }
    render();
    log(`âœ… ä¸‹è½½å®Œæˆ: ${id}`);
  }

  function removeTask(id) {
    const task = tasks.find(t => t.id === id);
    if (task?.videoUrl) URL.revokeObjectURL(task.videoUrl);
    tasks = tasks.filter(t => t.id !== id);
    render();
  }

  function startPolling() {
    const interval = Math.max(5, Number(el.pollInterval.value)) * 1000;
    stopPolling();
    pollTimer = setInterval(async () => {
      const running = tasks.filter(t => t.status !== 'completed' && t.status !== 'failed');
      const batch = Math.max(1, Number(el.pollBatch.value));
      for (const t of running.slice(0, batch)) {
        await refreshTask(t.id);
      }
    }, interval);
    el.pollStatus.textContent = 'è½®è¯¢è¿›è¡Œä¸­';
    el.pollStatus.classList.add('active');
    el.togglePollBtn.textContent = 'åœæ­¢è½®è¯¢';
    log('â–¶ï¸ è½®è¯¢å·²å¯åŠ¨');
  }

  function stopPolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    el.pollStatus.textContent = 'è½®è¯¢æœªå¯åŠ¨';
    el.pollStatus.classList.remove('active');
    el.togglePollBtn.textContent = 'å¼€å§‹è½®è¯¢';
  }

  // äº‹ä»¶ç»‘å®š
  el.settingsBtn.onclick = () => el.settingsModal.classList.add('active');
  el.closeSettings.onclick = () => el.settingsModal.classList.remove('active');
  el.settingsModal.onclick = (e) => {
    if (e.target === el.settingsModal) el.settingsModal.classList.remove('active');
  };

  el.model.onchange = () => {
    el.customModel.style.display = el.model.value === 'custom' ? 'block' : 'none';
    updateSizeHint();
  };

  document.querySelectorAll('.size-btn').forEach(btn => {
    btn.onclick = () => {
      selectedSize = btn.getAttribute('data-size');
      el.size.value = selectedSize;
      document.querySelectorAll('.size-btn').forEach(b => b.style.background = 'var(--bg-input)');
      btn.style.background = 'var(--border)';
    };
  });

  el.createBtn.onclick = async () => {
    try {
      el.createBtn.disabled = true;
      await createVideo();
    } catch (e) {
      log(`âŒ ${e.message}`);
    } finally {
      el.createBtn.disabled = false;
    }
  };

  el.togglePollBtn.onclick = () => pollTimer ? stopPolling() : startPolling();

  el.clearBtn.onclick = () => {
    if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰ä»»åŠ¡ï¼Ÿ')) {
      tasks.forEach(t => t.videoUrl && URL.revokeObjectURL(t.videoUrl));
      tasks = [];
      render();
      log('ğŸ—‘ï¸ å·²æ¸…ç©º');
    }
  };

  el.enableNotif.onclick = async () => {
    if ('Notification' in window) {
      const perm = await Notification.requestPermission();
      notifEnabled = perm === 'granted';
      el.enableNotif.textContent = notifEnabled ? 'âœ… é€šçŸ¥å·²å¼€å¯' : 'å¼€å¯å®Œæˆé€šçŸ¥';
      log(notifEnabled ? 'âœ… é€šçŸ¥å·²å¼€å¯' : 'âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»');
    }
  };

  el.rememberKey.onchange = () => {
    if (el.rememberKey.checked) {
      localStorage.setItem('SORA_KEY', el.apiKey.value);
      localStorage.setItem('SORA_REMEMBER', '1');
    } else {
      localStorage.removeItem('SORA_KEY');
      localStorage.removeItem('SORA_REMEMBER');
    }
  };

  el.apiKey.oninput = () => {
    if (el.rememberKey.checked) {
      localStorage.setItem('SORA_KEY', el.apiKey.value);
    }
  };

  // åˆå§‹åŒ–
  const savedKey = localStorage.getItem('SORA_KEY');
  if (savedKey && localStorage.getItem('SORA_REMEMBER') === '1') {
    el.apiKey.value = savedKey;
    el.rememberKey.checked = true;
  }

  updateSizeHint();
  render();
  log('ğŸ¬ å°±ç»ª');
})();
</script>
</body>
</html>
